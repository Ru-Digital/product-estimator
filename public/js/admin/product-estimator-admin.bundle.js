(()=>{"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(t)}function i(t){var i=function(t){if("object"!=e(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=e(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==e(i)?i:i+""}function n(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,i(a.key),a)}}function a(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function o(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function s(t,e,n){return(e=i(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var r=!1;function l(){var t,e,i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];!r&&null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug?(i?console.groupCollapsed("[ProductEstimator] Logs"):console.group("[ProductEstimator] Logs"),r=!0):null!==(e=window.productEstimatorVars)&&void 0!==e&&e.debug}function c(t){var e="[".concat(t,"]");return{log:function(){var t;if(null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug){var i;l();for(var n=arguments.length,a=new Array(n),o=0;o<n;o++)a[o]=arguments[o];(i=console).log.apply(i,[e].concat(a)),window.debug&&window.debug.trace&&console.trace()}},warn:function(){var t;if(null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug){var i;l();for(var n=arguments.length,a=new Array(n),o=0;o<n;o++)a[o]=arguments[o];(i=console).warn.apply(i,[e].concat(a)),window.debug&&window.debug.trace&&console.trace()}},error:function(){var t;if(null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug){var i;l(!1);for(var n=arguments.length,a=new Array(n),o=0;o<n;o++)a[o]=arguments[o];(i=console).error.apply(i,[e].concat(a)),window.debug&&window.debug.trace&&console.trace()}},group:function(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Details",n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug){l();var a="".concat(e," ").concat(i);n?console.groupCollapsed(a):console.group(a)}},groupEnd:function(){var t;null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug&&r&&console.groupEnd()}}}function d(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function u(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?d(Object(i),!0).forEach((function(e){s(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):d(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var g=c("UtilsAjax");function h(t){var e,i=jQuery,n=u(u({},{url:(null===(e=window.productEstimatorVars)||void 0===e?void 0:e.ajax_url)||("undefined"!=typeof ajaxurl?ajaxurl:"/wp-admin/admin-ajax.php"),type:"POST",dataType:"json"}),t);return new Promise((function(t,e){i.ajax(u(u({},n),{},{success:function(i){if(i.success)t(i.data);else{var n,a=new Error((null===(n=i.data)||void 0===n?void 0:n.message)||"Unknown error");a.data=i.data,e(a)}},error:function(t,i,n){g.error("AJAX error:",i,n),e(new Error(n))}}))}))}function m(t){return!!t&&/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(t).toLowerCase())}function b(t,e){var i=jQuery;if(t){var n=t instanceof jQuery?t:i(t);f(n);var a=i('<span class="field-error">'.concat(e,"</span>"));n.after(a),n.addClass("error")}}function f(t){var e=jQuery;if(t){var i=t instanceof jQuery?t:e(t);i.next(".field-error").remove(),i.removeClass("error")}}c("UtilsDom");var v=function(t){var e;if(null!==(e=window.productEstimatorVars)&&void 0!==e&&e.debug){var i;l();for(var n=arguments.length,a=new Array(n>1?n-1:0),o=1;o<n;o++)a[o-1]=arguments[o];(i=console).log.apply(i,["[".concat(t,"]")].concat(a))}},p=c,w=m,y=b,S=f,T=p("ProductEstimatorAdmin");function _(t,i){if(i&&("object"==e(i)||"function"==typeof i))return i;if(void 0!==i)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function I(t){return I=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},I(t)}function C(){return C="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,i){var n=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=I(t)););return t}(t,e);if(n){var a=Object.getOwnPropertyDescriptor(n,e);return a.get?a.get.call(arguments.length<3?t:i):a.value}},C.apply(null,arguments)}function E(t,e){return E=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},E(t,e)}function M(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&E(t,e)}function k(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function A(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?k(Object(i),!0).forEach((function(e){s(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):k(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}new(function(){return a((function e(){var i=this;t(this,e),jQuery(document).ready((function(){i.initializeVariables(),i.bindEvents(),i.isSettingsPage()||i.initializeTabs()}))}),[{key:"isSettingsPage",value:function(){var t=new URLSearchParams(window.location.search).get("page");return t&&t.indexOf("-settings")>-1}},{key:"initializeVariables",value:function(){this.formChanged=!1,this.currentTab="",this.reportData=null,this.chart=null}},{key:"bindEvents",value:function(){var t=jQuery;this.isSettingsPage()||t(".nav-tab-wrapper").on("click",".nav-tab",this.handleTabClick.bind(this)),this.initializeValidation(),t(window).on("beforeunload",this.handleBeforeUnload.bind(this))}},{key:"initializeTabs",value:function(){var t=jQuery,e=t(".nav-tab:first"),i=e.data("tab")||"tab-1";t(".tab-content").hide(),t("#".concat(i)).show(),e.addClass("nav-tab-active"),this.currentTab=i;var n=new URLSearchParams(window.location.search).get("tab");n&&this.switchTab(n)}},{key:"handleTabClick",value:function(t){t.preventDefault();var e=jQuery(t.currentTarget).data("tab");this.formChanged?confirm(productEstimatorAdmin.i18n.unsavedChanges)&&this.switchTab(e):this.switchTab(e)}},{key:"switchTab",value:function(t){var e=jQuery;e(".nav-tab").removeClass("nav-tab-active"),e('.nav-tab[data-tab="'.concat(t,'"]')).addClass("nav-tab-active"),e(".tab-content").hide(),e("#".concat(t)).show(),this.currentTab=t;var i=new URL(window.location);i.searchParams.set("tab",t),window.history.pushState({},"",i),"reports"!==t||this.reportData||this.loadInitialReport()}},{key:"initializeValidation",value:function(){if(!this.isSettingsPage()){var t=jQuery,e=t(".product-estimator-form");e.find('input[type="email"]').on("change",(function(e){var i=t(e.currentTarget),n=i.val();n&&!w(n)?y(i,productEstimatorAdmin.i18n.invalidEmail):S(i)})),e.find('input[type="number"]').on("change",(function(e){var i=t(e.currentTarget),n=parseInt(i.val()),a=parseInt(i.attr("min")),o=parseInt(i.attr("max"));n<a||n>o?y(i,productEstimatorAdmin.i18n.numberRange.replace("%min%",a).replace("%max%",o)):S(i)}))}}},{key:"handleBeforeUnload",value:function(t){if(this.formChanged)return t.preventDefault(),productEstimatorAdmin.i18n.unsavedChanges}},{key:"loadInitialReport",value:function(){T.log("Loading initial report data")}}])}());var P=function(){return a((function e(){var i=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;t(this,e),this.$=jQuery,this.baseClassLogger=p(this.constructor.name),n&&n.isModule?(this.settingsObjectName=n.settingsObjectName,this.defaultTabId=n.defaultTabId,this._initializeModuleSpecificSettings(this.settingsObjectName,this.defaultTabId),this.$(document).ready((function(){i._finalizeModuleSettings(i.settingsObjectName),"function"==typeof i.moduleInit?i.moduleInit():i.baseClassLogger.warn("Module does not implement moduleInit():",n.settingsObjectName)}))):(this.formChanged=!1,this.currentTab="",this.formChangeTrackers={},this.ensureGlobalVariables(),this.$(document).ready((function(){i.mainInit()})))}),[{key:"_initializeModuleSpecificSettings",value:function(t,e){var i=window[t]||{};this.settings=A({},i),this.settings.ajaxUrl=i.ajaxUrl||("undefined"!=typeof ajaxurl?ajaxurl:"/wp-admin/admin-ajax.php"),this.settings.nonce=i.nonce||window.productEstimatorSettings&&window.productEstimatorSettings.nonce||"";var n=window.productEstimatorSettings&&window.productEstimatorSettings.actions||{};this.settings.actions=A(A({},n),i.actions||{}),!this.settings.actions.save_settings&&e&&(this.settings.actions.save_settings="save_".concat(e,"_settings"));var a=window.productEstimatorSettings&&window.productEstimatorSettings.selectors||{};this.settings.selectors=A(A({},a),i.selectors||{}),this.settings.i18n=A(A({},window.productEstimatorSettings&&window.productEstimatorSettings.i18n),i.i18n||{}),this.settings.tab_id=i.tab_id||e,this.settings.settingsObjectName=t,void 0===this.settings.option_name&&this.baseClassLogger.warn("'option_name' is missing from localizedSettings for ".concat(t,". This is usually critical.")),void 0===i.actions&&this.baseClassLogger.warn("Original 'actions' object was missing from localizedSettings for ".concat(t,". Defaulted/merged.")),void 0===i.selectors&&this.baseClassLogger.warn("Original 'selectors' object was missing from localizedSettings for ".concat(t,". Defaulted/merged.")),this.baseClassLogger.log("Base module settings initialized for ".concat(t,". Effective settings:"),JSON.stringify(this.settings))}},{key:"_finalizeModuleSettings",value:function(t){var e=window[t]||{};e.nonce&&(this.settings.nonce=e.nonce,this.baseClassLogger.log("Nonce updated for ".concat(t," via _finalizeModuleSettings")))}},{key:"ensureGlobalVariables",value:function(){window.featureSwitchesSettings=window.featureSwitchesSettings||{tab_id:"feature_switches",i18n:{}},window.generalSettings=window.generalSettings||{tab_id:"general",i18n:{}},window.netsuiteSettings=window.netsuiteSettings||{tab_id:"netsuite",i18n:{}},window.notificationSettings=window.notificationSettings||{tab_id:"notifications",i18n:{}},window.pricingRulesSettings=window.pricingRulesSettings||{tab_id:"pricing_rules",i18n:{}},window.productAdditionsSettings=window.productAdditionsSettings||{tab_id:"product_additions",i18n:{}},window.productUpgradesSettings=window.productUpgradesSettings||{tab_id:"product_upgrades",i18n:{}},window.similarProductsSettings=window.similarProductsSettings||{tab_id:"similar_products",i18n:{}},window.labelSettings=window.labelSettings||{tab_id:"labels",i18n:{}},window.productEstimatorSettings=window.productEstimatorSettings||{ajax_url:"undefined"!=typeof ajaxurl?ajaxurl:"/wp-admin/admin-ajax.php",nonce:"",i18n:{unsavedChanges:"You have unsaved changes. Are you sure you want to leave this tab?",saveSuccess:"Settings saved successfully.",saveError:"Error saving settings.",saving:"Saving..."}}}},{key:"mainInit",value:function(){v("ProductEstimatorSettings","Initializing Settings Manager Orchestrator...");var t=this.getTabFromUrl();this.currentTab=null!==t?t:"general",this.$(".tab-content").hide(),this.$("#".concat(this.currentTab)).show(),this.$(".nav-tab").removeClass("nav-tab-active"),this.$('.nav-tab[data-tab="'.concat(this.currentTab,'"]')).addClass("nav-tab-active"),this.bindMainEvents(),this.initFormChangeTracking(),this.initializeValidation(),v("ProductEstimatorSettings","Settings manager orchestrator initialized with tab:",this.currentTab)}},{key:"bindMainEvents",value:function(){var t=this;this.$(".nav-tab-wrapper").on("click",".nav-tab",this.handleTabClick.bind(this)),this.$(document).on("submit","form.product-estimator-form",(function(e){var i=t.$(e.currentTarget);i.hasClass("pe-vtabs-tab-form")&&i.attr("data-sub-tab-id")?v("ProductEstimatorSettings","Orchestrator: Form is vtab, letting specialized handler process.",i[0]):(v("ProductEstimatorSettings","Orchestrator: Processing form submission.",i[0]),e.preventDefault(),t.handleAjaxFormSubmit(e,i))})),this.$(window).on("beforeunload",this.handleBeforeUnload.bind(this)),v("ProductEstimatorSettings","Orchestrator events bound")}},{key:"handleAjaxFormSubmit",value:function(t,e){var i=this,n=(e=e||this.$(t.target)).closest(".tab-content").attr("id")||e.data("tab"),a=e.serialize(),o=window.createLogger?window.createLogger("PES-Orchestrator:".concat(n||"unknown_tab")):console;o.log("Serialized form data (orchestrator):",a),e.find('input[type="checkbox"]').each((function(t,e){var n=i.$(e);if(!n.is(":checked")){var o=n.attr("name");if(o){var s=new RegExp("(^|&)".concat(encodeURIComponent(o).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"(?:=[^&]*)?"));null===a.match(s)&&(a+="&".concat(encodeURIComponent(o),"=0"))}}})),a=a.replace(/^&+/,"").replace(/&&+/g,"&"),this.showFormLoading(e),o.log("Submitting form for tab: ".concat(n));var s="save_".concat(n,"_settings"),r=window.productEstimatorSettings||{nonce:"",ajax_url:ajaxurl,i18n:{}},l={action:s,nonce:r.nonce,form_data:a};o.log("Orchestrator sending AJAX with payload:",l),h({url:r.ajax_url,type:"POST",data:l}).then((function(t){i.showNotice(t.message||r.i18n.saveSuccess,"success"),i.formChangeTrackers&&(i.formChangeTrackers[n]=!1),n===i.currentTab&&(i.formChanged=!1),o.log("Settings saved successfully for tab: ".concat(n," (via orchestrator)"))})).catch((function(t){var e=t&&t.message?t.message:r.i18n.saveError;i.showNotice(e,"error"),o.error("Error saving settings for tab ".concat(n," (via orchestrator):"),t)})).finally((function(){i.hideFormLoading(e)}))}},{key:"showFormLoading",value:function(t){var e=t.find(":submit");e.prop("disabled",!0).addClass("loading"),e.data("original-text",e.val());var i=window.productEstimatorSettings&&window.productEstimatorSettings.i18n&&window.productEstimatorSettings.i18n.saving?window.productEstimatorSettings.i18n.saving:"Saving...";e.val(i)}},{key:"hideFormLoading",value:function(t){var e=t.find(":submit");e.prop("disabled",!1).removeClass("loading"),e.data("original-text")&&e.val(e.data("original-text"))}},{key:"initFormChangeTracking",value:function(){var t=this;this.$(".tab-content").each((function(){var e=t.$(this).attr("id");t.formChangeTrackers&&(t.formChangeTrackers[e]=!1),t.$("#".concat(e," :input")).on("change input",(function(){t.formChangeTrackers&&(t.formChangeTrackers[e]=!0),e===t.currentTab&&(t.formChanged=!0)}))})),v("ProductEstimatorSettings","Orchestrator form change tracking initialized")}},{key:"initializeValidation",value:function(){var t=this;this.$(".product-estimator-form").each((function(e,i){var n=t.$(i);n.data("module-managed-validation")||(n.find('input[type="email"]').on("change",(function(e){var i=t.$(e.currentTarget);i.val()&&!m(i.val())?t.showFieldError(i,window.productEstimatorSettings.i18n.invalidEmail||"Invalid email address"):t.clearFieldError(i)})),n.find('input[type="number"]').on("change",(function(e){var i=t.$(e.currentTarget),n=parseInt(i.val(),10),a=parseInt(i.attr("min")||0,10),o=parseInt(i.attr("max")||9999,10),s=window.productEstimatorSettings&&window.productEstimatorSettings.i18n;if(isNaN(n)||n<a||n>o){var r=s&&s.numberRange?s.numberRange.replace("%min%",a).replace("%max%",o):"Value must be between ".concat(a," and ").concat(o);t.showFieldError(i,r)}else t.clearFieldError(i)})))})),v("ProductEstimatorSettings","Orchestrator form validation initialized")}},{key:"getTabFromUrl",value:function(){return new URLSearchParams(window.location.search).get("tab")}},{key:"handleTabClick",value:function(t){t.preventDefault();var e=this.$(t.currentTarget).data("tab"),i=window.productEstimatorSettings&&window.productEstimatorSettings.i18n;this.formChanged&&!confirm(i.unsavedChanges||"You have unsaved changes. Are you sure?")||this.switchTab(e)}},{key:"switchTab",value:function(t){var e=new URL(window.location.href);e.searchParams.set("tab",t),window.history.pushState({},"",e.toString()),this.$(".nav-tab").removeClass("nav-tab-active"),this.$('.nav-tab[data-tab="'.concat(t,'"]')).addClass("nav-tab-active"),this.$(".tab-content").hide(),this.$("#".concat(t)).show();var i=this.currentTab;this.currentTab=t,this.formChanged=this.formChangeTrackers&&this.formChangeTrackers[t]||!1,this.$(document).trigger("product_estimator_tab_changed",[t,i]),v("ProductEstimatorSettings","Orchestrator switched to tab: ".concat(t," from ").concat(i))}},{key:"handleBeforeUnload",value:function(t){var e=!1;if(this.formChangeTrackers)for(var i in this.formChangeTrackers)if(this.formChangeTrackers[i]){e=!0;break}if(e){var n=(window.productEstimatorSettings&&window.productEstimatorSettings.i18n).unsavedChanges||"You have unsaved changes. Are you sure?";return t.returnValue=n,n}}},{key:"clearSubTabFromUrl",value:function(){var t=new URL(window.location.href);t.searchParams.has("sub_tab")&&(t.searchParams.delete("sub_tab"),window.history.replaceState({},"",t.toString()),this.baseClassLogger.log("Cleared sub_tab from URL."))}},{key:"showFieldError",value:function(t,e){b(this.$(t),e)}},{key:"clearFieldError",value:function(t){f(this.$(t))}},{key:"showNotice",value:function(t){!function(t){var e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3,i=jQuery;if(i){for(var n=i('<div class="notice notice-'.concat(arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",' is-dismissible"><p>').concat(t,"</p></div>")),a=[i(".wrap h1"),i(".product-estimator-form-container"),i("#wpbody-content")],o=null,s=0;s<a.length;s++)if(a[s].length){o=a[s];break}if(o?o.after(n):i("body").prepend(n),window.wp&&window.wp.notices)window.wp.notices.init();else{var r=i('<button type="button" class="notice-dismiss"><span class="screen-reader-text">Dismiss this notice.</span></button>');n.append(r),r.on("click",(function(){n.fadeOut(100,(function(){n.remove()}))}))}setTimeout((function(){n.fadeOut(500,(function(){return n.remove()}))}),e)}else alert(t)}(t,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success")}}])}();jQuery(document).ready((function(){window.ProductEstimatorSettingsInstance||(window.ProductEstimatorSettingsInstance=new P)}));const j=P;function O(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(O=function(){return!!t})()}var D=p("VerticalTabbedModule");function x(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return $(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?$(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,r=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return s=t.done,t},e:function(t){r=!0,o=t},f:function(){try{s||null==i.return||i.return()}finally{if(r)throw o}}}}function $(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function B(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function F(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?B(Object(i),!0).forEach((function(e){s(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):B(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function L(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(L=function(){return!!t})()}function N(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(N=function(){return!!t})()}function R(t,e,i,n){var a=C(I(1&n?t.prototype:t),e,i);return 2&n&&"function"==typeof a?function(t){return a.apply(i,t)}:a}var V=function(e){function i(){var e,n,a,o;return t(this,i),n=this,o=[{mainTabId:"similar_products",localizedDataName:"similarProductsSettings"}],a=I(a=i),(e=_(n,N()?Reflect.construct(a,o||[],I(n).constructor):a.apply(n,o))).$(document).on("admin_table_manager_ready_".concat(e.config.mainTabId),(function(){e.logger.log("Base AdminTableManager is ready. Initializing SimilarProducts specifics."),e._cacheSimilarProductsDOM(),e._bindSpecificEvents(),e._initializeSelect2(),e.logger.log("SimilarProducts specific features initialized.")})),e.logger.log("SimilarProducts constructor completed."),e}return M(i,e),a(i,[{key:"_cacheSimilarProductsDOM",value:function(){if(this.settings&&this.settings.selectors){var t=this.settings.selectors;this.dom.sourceCategoriesSelect=this.$container.find(t.sourceCategoriesSelect),this.dom.attributesContainer=this.$container.find(t.attributesContainer),this.dom.attributesList=this.$container.find(t.attributesList),this.dom.attributesLoading=this.$container.find(t.attributesLoading),this.dom.selectedAttributesInput=this.$container.find(t.selectedAttributesInput),this.logger.log("Similar Products specific DOM elements cached.")}else this.logger.warn("Cannot cache Similar Products specific DOM elements: this.settings.selectors not available.")}},{key:"_bindSpecificEvents",value:function(){var t;this.dom.form&&this.dom.form.length?(null===(t=this.dom.sourceCategoriesSelect)||void 0===t||t.on("change.SimilarProducts",this._handleSourceCategoriesChange.bind(this)),this.logger.log("Similar Products specific events bound.")):this.logger.error("SimilarProducts: Form DOM element not found, cannot bind specific events.")}},{key:"_initializeSelect2",value:function(){var t=this;setTimeout((function(){var e,i;e=t.dom.sourceCategoriesSelect,i=t.settings.i18n&&t.settings.i18n.selectCategoryError||"Select source categories",e&&e.length&&t.$.fn.select2?e.select2({placeholder:i,width:"resolve",allowClear:!0,dropdownCssClass:"product-estimator-dropdown"}).val(null).trigger("change"):e&&!e.length?t.logger.warn("Select2 target element not found:",e.selector):e||t.logger.warn("Select2 target element is undefined (likely missing from DOM cache)."),t.logger.log("Select2 components initialized for Similar Products.")}),100)}},{key:"onMainTabActivated",value:function(){R(i,"onMainTabActivated",this,3)([]),this.logger.log("Similar Products main tab activated."),this.dom.sourceCategoriesSelect&&this.dom.sourceCategoriesSelect.hasClass("select2-hidden-accessible")}},{key:"_handleSourceCategoriesChange",value:function(){var t,e=null===(t=this.dom.sourceCategoriesSelect)||void 0===t?void 0:t.val();this.logger.log("Source categories changed to:",e),e&&e.length>0?this._fetchAttributesForCategories(e):this._updateAttributeSelectionField([],[])}},{key:"_updateAttributeSelectionField",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];if(this.dom.attributesList.empty(),!t||0===t.length)return this.dom.attributesLoading.show(),void this.dom.attributesList.hide();this.dom.attributesLoading.hide(),this.dom.attributesList.show(),"string"==typeof e&&(e=e.split(",").filter(Boolean));var i=t.map((function(t){var i=e.includes(t.name)?"checked":"";return'\n        <div class="attribute-item">\n          <label>\n            <input type="checkbox"\n                   name="attribute_checkbox[]"\n                   value="'.concat(t.name,'"\n                   data-label="').concat(t.label,'"\n                   ').concat(i,">\n            ").concat(t.label,"\n          </label>\n        </div>")})).join("");this.dom.attributesList.html(i),this.dom.attributesList.find('input[type="checkbox"]').on("change",this._handleAttributeCheckboxChange.bind(this)),this._updateSelectedAttributesInput()}},{key:"_fetchAttributesForCategories",value:function(t){var e=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.logger.log("Fetching attributes for categories:",t),this.settings.actions&&this.settings.actions.get_attributes){this.dom.attributesLoading.text(this.settings.i18n.loadingAttributes||"Loading attributes..."),this.dom.attributesLoading.show(),this.dom.attributesList.hide();var n=i||this.dom.selectedAttributesInput.val().split(",").filter(Boolean);this.logger.log("Using currently selected attributes:",n),h({url:this.settings.ajaxUrl,data:{action:this.settings.actions.get_attributes,nonce:this.settings.nonce,category_ids:t}}).then((function(t){e.logger.log("Raw response from ajax.ajaxRequest for get_attributes:",t);var i=null;t&&t.success&&t.data&&Array.isArray(t.data.attributes)?i=t.data.attributes:t&&Array.isArray(t.attributes)&&(i=t.attributes),i?(e.logger.log("Attributes data found. Processing attributes array:",i),i.length>0?e._updateAttributeSelectionField(i,n):(e.dom.attributesLoading.text(e.settings.i18n.noAttributes||"No product attributes found for these categories."),e.dom.attributesList.hide())):(e.logger.error("Get Attributes failed or returned invalid/unexpected data structure:",t),e.dom.attributesLoading.text(e.settings.i18n.errorLoading||"Error loading attributes. Please try again."),e.dom.attributesList.hide())})).catch((function(t){e.logger.error("get_attributes AJAX request failed:",t),e.dom.attributesLoading.text(e.settings.i18n.errorLoading||"Error loading attributes. Please try again."),e.dom.attributesList.hide()}))}else this.logger.error("Get Attributes AJAX action not defined in settings.actions.")}},{key:"_handleAttributeCheckboxChange",value:function(){this._updateSelectedAttributesInput()}},{key:"_updateSelectedAttributesInput",value:function(){var t=this,e=[];this.dom.attributesList.find('input[type="checkbox"]:checked').each((function(i,n){e.push(t.$(n).val())})),this.dom.selectedAttributesInput.val(e.join(",")),this.logger.log("Updated selected attributes:",e)}},{key:"resetForm",value:function(){var t;R(i,"resetForm",this,3)([]),null===(t=this.dom.sourceCategoriesSelect)||void 0===t||t.val(null).trigger("change.select2"),this.dom.attributesList.empty(),this.dom.attributesLoading.text(this.settings.i18n.selectCategory||"Select categories to load available attributes..."),this.dom.attributesLoading.show(),this.dom.selectedAttributesInput.val(""),this.logger.log("Similar Products form fields specifically reset.")}},{key:"populateFormWithData",value:function(t){var e=this;R(i,"populateFormWithData",this,3)([t]),this.logger.log("Similar Products form with full item data:",t);var n=t.source_categories||[],a=Array.isArray(t.attributes)?t.attributes:t.attributes?t.attributes.split(","):[];this.dom.selectedAttributesInput.val(a.join(",")),setTimeout((function(){var t;null===(t=e.dom.sourceCategoriesSelect)||void 0===t||t.val(n).trigger("change.select2"),n.length>0&&a.length>0&&(e.logger.log("Manually fetching attributes for edit form with categories:",n),e._fetchAttributesForCategories(n,a)),e.formModified=!1}),150)}},{key:"validateForm",value:function(){var t,e,n=R(i,"validateForm",this,3)([]);this.logger.log("Validating Similar Products form.");var a,o=null===(t=this.dom.sourceCategoriesSelect)||void 0===t?void 0:t.val(),s=this.dom.selectedAttributesInput.val(),r=this.settings.i18n||{};return this.clearFieldError(null===(e=this.dom.sourceCategoriesSelect)||void 0===e?void 0:e.next(".select2-container")),this.clearFieldError(this.dom.attributesList),o&&0!==o.length||(this.showFieldError(null===(a=this.dom.sourceCategoriesSelect)||void 0===a?void 0:a.next(".select2-container"),r.selectCategoryError||"Please select at least one source category."),n=!1),s||(this.showFieldError(this.dom.attributesList,r.selectAttributesError||"Please select at least one attribute."),n=!1),this.logger.log("Similar Products form validation result:",n),n}},{key:"populateColumn_source_categories",value:function(t,e){t.text(e.source_categories_display||"N/A")}},{key:"populateColumn_attributes",value:function(t,e){t.text(e.attributes_display||"None selected")}}])}(function(i){function n(e){var i;t(this,n);var a,o,s,r=F(F({},e),{},{defaultSubTabId:e.mainTabId+"-atm-default-subcontent",ajaxActionPrefix:"atm_form_save_".concat(e.mainTabId)});a=this,s=[r],o=I(o=n),(i=_(a,L()?Reflect.construct(o,s||[],I(a).constructor):o.apply(a,s))).$=jQuery,i.config=e;var l="AdminTableManager:".concat(e.mainTabId||"Generic");return i.logger=p(l),i.logger=p("".concat(e.mainTabId||"Generic")),i.settings&&i.settings.tab_id||i.logger.error("AdminTableManager Critical Error: this.settings.tab_id (mainTabId) is missing after super() call. This indicates a problem with config propagation or parent constructor.",{passedConfigToVTM:r,effectiveSettings:i.settings}),i.formModified=!1,i.isEditMode=!1,i.currentItemId=null,i}return M(n,i),a(n,[{key:"_validateSettings",value:function(){if(!this.settings||void 0===this.settings.tab_id)throw this.logger.error("AdminTableManager Critical Error: this.settings or this.settings.tab_id is undefined. This usually means ProductEstimatorSettings/VerticalTabbedModule constructor failed to initialize it. Config used by AdminTableManager:",{vtmConfigUsedForSuper:this.vtmConfig}),new Error("AdminTableManager: Essential property 'this.settings.tab_id' was not initialized by the parent class. Cannot validate settings.");if(0===Object.keys(this.settings).length){var t="AdminTableManager: Settings (this.settings) is an empty object";throw this.settingsObjectName&&(t+=" (expected from window.".concat(this.settingsObjectName,"). This might happen if the global object is empty or not correctly populated.")),this.logger.error(t),new Error(t+' Cannot proceed with empty settings for tab "'.concat(this.settings.tab_id,'".'))}var e=!0;if(void 0===this.settings.ajaxUrl&&(this.logger.error("Missing required setting: ajaxUrl"),e=!1),void 0===this.settings.nonce&&(this.logger.error("Missing required setting: nonce"),e=!1),void 0===this.settings.option_name&&(this.logger.error("Missing required setting: option_name"),e=!1),this.settings.actions){var i,n=x(["add_item","update_item","delete_item"]);try{for(n.s();!(i=n.n()).done;){var a=i.value;void 0===this.settings.actions[a]&&(this.logger.error("Missing required action: actions.".concat(a," (expected in ").concat(this.settingsObjectName,') for tab "').concat(this.settings.tab_id,'"')),e=!1)}}catch(t){n.e(t)}finally{n.f()}}else this.logger.error("Required setting object 'actions' is missing from settings for tab \"".concat(this.settings.tab_id,'".')),e=!1;if(this.settings.selectors){var o,s=x(["formContainer","form","addButton","listTableBody","editButton","deleteButton","idInput","saveButton","cancelButton","noItemsMessage","formTitle","listItemRow","listTableContainer","listTable"]);try{for(s.s();!(o=s.n()).done;){var r=o.value;void 0===this.settings.selectors[r]&&(this.logger.error("Missing required selector: selectors.".concat(r," (expected in ").concat(this.settingsObjectName,') for tab "').concat(this.settings.tab_id,'"')),e=!1)}}catch(t){s.e(t)}finally{s.f()}}else this.logger.error("Required setting object 'selectors' is missing from settings for tab \"".concat(this.settings.tab_id,'".')),e=!1;if(this.settings.i18n){var l,c=x(["confirmDelete","itemSavedSuccess","itemDeletedSuccess","errorSavingItem","errorDeletingItem","addItemButtonLabel","editItemFormTitle","saving","deleting","editButtonLabel","deleteButtonLabel"]);try{for(c.s();!(l=c.n()).done;){var d=l.value;void 0===this.settings.i18n[d]&&this.logger.warn("Potentially missing i18n string: i18n.".concat(d," (in ").concat(this.settingsObjectName,') for tab "').concat(this.settings.tab_id,'"'))}}catch(t){c.e(t)}finally{c.f()}}else this.logger.error("Required setting object 'i18n' is missing from settings for tab \"".concat(this.settings.tab_id,'".')),e=!1;if(!e)throw new Error('AdminTableManager: Settings validation failed due to missing critical settings in this.settings for tab "'.concat(this.settings.tab_id,'". Check console for details.'));this.logger.log("Settings (this.settings) validated successfully for tab:",this.settings.tab_id)}},{key:"moduleInit",value:function(){var t,e,i;if((t=n,e=this,"function"==typeof(i=C(I(1&3?t.prototype:t),"moduleInit",e))?function(t){return i.apply(e,t)}:i)([]),this.logger.log("AdminTableManager: Overridden moduleInit() called for tab:",this.settings.tab_id),!this.$container||!this.$container.length)return this.logger.error("AdminTableManager: Main container #".concat(this.settings.tab_id," not found after super.moduleInit(). Module will not initialize further.")),void(window.ProductEstimatorSettingsInstance&&"function"==typeof window.ProductEstimatorSettingsInstance.showNotice&&window.ProductEstimatorSettingsInstance.showNotice("Critical error: Table manager UI container #".concat(this.settings.tab_id," missing."),"error"));try{this._validateSettings()}catch(t){return this.logger.error('AdminTableManager: Settings validation failed for tab "'.concat(this.settings.tab_id,'". Halting init.'),t),void(window.ProductEstimatorSettingsInstance&&"function"==typeof window.ProductEstimatorSettingsInstance.showNotice&&window.ProductEstimatorSettingsInstance.showNotice("Error initializing table manager for ".concat(this.settings.tab_id,": Configuration validation failed. Check console. Details: ").concat(t.message),"error"))}if(this.cacheDOM(),this._checkEssentialDOM())this.bindEvents(),this.updateNoItemsMessageVisibility(),this.logger.log("AdminTableManager specific setup completed for tab:",this.settings.tab_id),this.$(document).trigger("admin_table_manager_ready_".concat(this.settings.tab_id),[this]);else if(this.logger.error("AdminTableManager initialization failed: missing essential DOM elements for tab:",this.settings.tab_id),window.ProductEstimatorSettingsInstance&&"function"==typeof window.ProductEstimatorSettingsInstance.showNotice){var a=this.settings.tab_id;window.ProductEstimatorSettingsInstance.showNotice("Error initializing UI components for ".concat(a,". Some parts may not work. Check console for missing DOM elements."),"error")}}},{key:"_checkEssentialDOM",value:function(){var t=!0;if(!this.settings||!this.settings.selectors)return this.logger.error("AdminTableManager _checkEssentialDOM: Invariant violated - this.settings or this.settings.selectors missing after _validateSettings."),!1;for(var e=0,i=["formContainer","form","addButton","listTableBody","listTableContainer","listTable","noItemsMessage","formTitle","idInput","saveButton","cancelButton"];e<i.length;e++){var n=i[e];this.dom[n]&&this.dom[n].length||(this.logger.error("Essential DOM element for AdminTableManager not found using selector key '".concat(n,"': Expected selector string was \"").concat(this.settings.selectors[n],'" within container #').concat(this.settings.tab_id,".")),t=!1)}return t}},{key:"cacheDOM",value:function(){if(this.dom={},this.settings&&this.settings.selectors){if(this.$container&&this.$container.length)for(var t in this.settings.selectors)Object.prototype.hasOwnProperty.call(this.settings.selectors,t)&&(this.dom[t]=this.$container.find(this.settings.selectors[t]));else this.logger.error("AdminTableManager cacheDOM: this.$container is not available or empty. DOM elements cannot be cached.");this.logger.log("DOM elements cached for tab:",this.settings.tab_id)}else this.logger.error("AdminTableManager cacheDOM: Invariant violated - this.settings or this.settings.selectors missing after _validateSettings.")}},{key:"bindEvents",value:function(){var t,e,i,n,a,o,s=this;if(this.dom&&0!==Object.keys(this.dom).length){null===(t=this.dom.addButton)||void 0===t||t.on("click.adminTableManager",this.handleAddNew.bind(this));var r=null===(e=this.settings.selectors)||void 0===e?void 0:e.editButton,l=null===(i=this.settings.selectors)||void 0===i?void 0:i.deleteButton;this.dom.listTableBody&&this.dom.listTableBody.length?(r?this.dom.listTableBody.on("click.adminTableManager",r,this.handleEdit.bind(this)):this.logger.warn("Edit button selector (settings.selectors.editButton) is undefined. Skipping bind for edit."),l?this.dom.listTableBody.on("click.adminTableManager",l,this.handleDelete.bind(this)):this.logger.warn("Delete button selector (settings.selectors.deleteButton) is undefined. Skipping bind for delete."),this.bindCustomActionButtons()):this.logger.warn("listTableBody DOM element not found for tab:",this.settings.tab_id,"- Edit/delete events for items not bound."),null===(n=this.dom.form)||void 0===n||n.on("submit.adminTableManager",this.handleSubmit.bind(this)),null===(a=this.dom.cancelButton)||void 0===a||a.on("click.adminTableManager",this.handleCancel.bind(this)),null===(o=this.dom.form)||void 0===o||o.on("change.adminTableManager input.adminTableManager",":input",(function(){s.formModified=!0})),this.logger.log("AdminTableManager common events bound for tab:",this.settings.tab_id)}else this.logger.error("AdminTableManager bindEvents: DOM elements not cached (this.dom is empty/undefined). Cannot bind events.")}},{key:"bindCustomActionButtons",value:function(){}},{key:"handleAddNew",value:function(t){var e,i,n,a;t.preventDefault(),this.logger.log("Add New clicked for tab:",this.settings.tab_id),this.isEditMode=!1,this.currentItemId=null,this.resetForm(),null===(e=this.dom.formTitle)||void 0===e||e.text(this.settings.i18n.addItemFormTitle||"Add New Item"),null===(i=this.dom.saveButton)||void 0===i||i.text(this.settings.i18n.addItemButtonLabel||this.settings.i18n.saveChangesButton||"Save Item"),null===(n=this.dom.formContainer)||void 0===n||n.slideDown(),null===(a=this.dom.addButton)||void 0===a||a.hide()}},{key:"handleEdit",value:function(t){var i,n,a=this;t.preventDefault();var o=this.$(t.currentTarget),s=o.closest(this.settings.selectors.listItemRow).data("id");if(this.logger.log("Edit clicked for item ID:",s,"on tab:",this.settings.tab_id),!s)return this.logger.error("Could not find item ID for editing on tab:",this.settings.tab_id),void this.showNotice("Error: Could not determine the item to edit.","error");if(this.isEditMode=!0,this.currentItemId=s,this.resetForm(),this.dom.idInput&&this.dom.idInput.length?this.dom.idInput.val(this.currentItemId):this.logger.warn("Hidden ID input (dom.idInput) not found in form. Item ID might not be set correctly for submission during edit."),null===(i=this.dom.formTitle)||void 0===i||i.text(this.settings.i18n.editItemFormTitle||"Edit Item #".concat(s)),null===(n=this.dom.saveButton)||void 0===n||n.text(this.settings.i18n.updateChangesButton||"Update Item"),this.settings.actions&&this.settings.actions.get_item)this.showFormLoadingSpinner(!0,this.dom.saveButton),h({url:this.settings.ajaxUrl,data:{action:this.settings.actions.get_item,nonce:this.settings.nonce,item_id:s,option_name:this.settings.option_name,tab_id:this.settings.tab_id}}).then((function(t){if(t&&t.item&&"object"===e(t.item)){var i,n;a.populateFormWithData(t.item),null===(i=a.dom.formContainer)||void 0===i||i.slideDown(),null===(n=a.dom.addButton)||void 0===n||n.hide()}else{var o=t&&t.message?t.message:a.settings.i18n.errorLoadingItem||"Error loading item details.";a.showNotice(o,"error"),a.logger.error("Error loading item details for edit:",t)}})).catch((function(t){a.showNotice(t.message||a.settings.i18n.errorLoadingItem||"AJAX error loading item.","error"),a.logger.error("AJAX error loading item for editing:",t)})).finally((function(){a.showFormLoadingSpinner(!1,a.dom.saveButton)}));else{var r,l;this.logger.warn("No 'get_item' action defined in settings.actions for tab \"".concat(this.settings.tab_id,'".'));var c=o.data();Object.keys(c).length>1?(c.id=s,this.populateFormWithData(c)):(this.logger.log("Button data attributes did not yield sufficient data for form population."),this.showNotice("Note: Full item details might not be loaded. Displaying basic form for editing.","info")),null===(r=this.dom.formContainer)||void 0===r||r.slideDown(),null===(l=this.dom.addButton)||void 0===l||l.hide()}}},{key:"handleDelete",value:function(t){var e=this;t.preventDefault();var i=this.$(t.currentTarget),n=i.closest(this.settings.selectors.listItemRow),a=n.data("id");if(this.logger.log("Delete clicked for item ID:",a,"on tab:",this.settings.tab_id),!a)return this.logger.error("Could not find item ID for deletion on tab:",this.settings.tab_id),void this.showNotice("Error: Could not determine item to delete.","error");if(confirm(this.settings.i18n.confirmDelete||"Are you sure you want to delete this item?")){var o=i.text();i.prop("disabled",!0).text(this.settings.i18n.deleting||"Deleting..."),h({url:this.settings.ajaxUrl,data:{action:this.settings.actions.delete_item,nonce:this.settings.nonce,item_id:a,option_name:this.settings.option_name,tab_id:this.settings.tab_id}}).then((function(t){t&&(!0===t.success||t.itemId&&t.message)?(e.showNotice(t.data&&t.data.message||t.message||e.settings.i18n.itemDeletedSuccess||"Item deleted.","success"),n.fadeOut(300,(function(){n.remove(),e.updateNoItemsMessageVisibility()}))):(e.showNotice(t&&t.message||t&&t.data&&t.data.message||e.settings.i18n.errorDeletingItem||"Error deleting item.","error"),i.prop("disabled",!1).text(o))})).catch((function(t){e.showNotice(t.message||e.settings.i18n.errorDeletingItem||"AJAX error deleting item.","error"),e.logger.error("AJAX error deleting item:",t),i.prop("disabled",!1).text(o)}))}}},{key:"handleSubmit",value:function(t){var i=this;if(t.preventDefault(),this.logger.log("Form submitted. Edit mode:",this.isEditMode,"Current Item ID:",this.currentItemId),!this.validateForm())return this.logger.warn("Form validation failed for tab:",this.settings.tab_id),void this.showNotice(this.settings.i18n.validationFailed||"Please correct the errors in the form.","error");this.showFormLoadingSpinner(!0,this.dom.saveButton);var n=this.isEditMode?this.settings.actions.update_item:this.settings.actions.add_item;if(!n)return this.logger.error("Form submission action (add_item or update_item) is not defined in settings.actions for tab:",this.settings.tab_id),this.showNotice(this.settings.i18n.errorSavingItem||"Configuration error: Save action not defined.","error"),void this.showFormLoadingSpinner(!1,this.dom.saveButton);var a={action:n,nonce:this.settings.nonce,option_name:this.settings.option_name,tab_id:this.settings.tab_id,item_data:{}};this.dom.form.serializeArray().forEach((function(t){var e=t.name,i=t.value;if(e.endsWith("[]")){var n=e.slice(0,-2);a.item_data[n]||(a.item_data[n]=[]),a.item_data[n].push(i)}else a.item_data[e]=i})),this.isEditMode&&this.currentItemId&&(a.item_id=this.currentItemId),this.logger.log("AJAX data payload for save:",a),h({url:this.settings.ajaxUrl,data:a}).then((function(t){if(i.logger.log("AJAX save response received:",t),!t)return i.logger.error("Empty response received from server"),void i.showNotice(i.settings.i18n.errorSavingItem||"Error: Empty response from server","error");if(i.logger.log("Response structure:",{hasItemProperty:!!t.item,itemType:t.item?e(t.item):"N/A",itemKeys:t.item?Object.keys(t.item):"N/A",message:t.message||"No message"}),t&&t.item){var n,a;i.showNotice(t.message||i.settings.i18n.itemSavedSuccess||"Item saved.","success");var o=!i.dom.listTableBody.find("tr").length;i.logger.log("Is this the first item?",o),i.isEditMode?i.updateTableRow(t.item):(i.addTableRow(t.item),o&&(i.logger.log("FIRST ITEM ADDED - Ensuring table visibility"),i.dom.listTable.show(),i.dom.noItemsMessage.hide(),i.dom.listTable[0].offsetHeight)),null===(n=i.dom.formContainer)||void 0===n||n.slideUp(),null===(a=i.dom.addButton)||void 0===a||a.show(),i.resetForm(),i.isEditMode=!1,i.currentItemId=null,i.formModified=!1}else{var s=t&&t.message?t.message:i.settings.i18n.errorSavingItem||"Error saving item or response format incorrect.",r=t&&t.errors?"<br><pre>".concat(JSON.stringify(t.errors,null,2),"</pre>"):"";i.showNotice(s+r,"error"),i.logger.error("Error saving item or item data missing/invalid in response structure:",t)}})).catch((function(t){var e=t.message||i.settings.i18n.errorSavingItem||"AJAX error during save.";i.showNotice(e,"error"),i.logger.error("AJAX error during save operation:",t)})).finally((function(){i.showFormLoadingSpinner(!1,i.dom.saveButton)}))}},{key:"handleCancel",value:function(t){var e,i;t.preventDefault(),this.logger.log("Cancel form clicked for tab:",this.settings.tab_id),this.formModified&&!confirm(this.settings.i18n.confirmCancelEditing||"You have unsaved changes. Are you sure you want to cancel?")||(null===(e=this.dom.formContainer)||void 0===e||e.slideUp(),null===(i=this.dom.addButton)||void 0===i||i.show(),this.resetForm(),this.isEditMode=!1,this.currentItemId=null,this.formModified=!1)}},{key:"resetForm",value:function(){var t,e,i;null===(t=this.dom.form[0])||void 0===t||t.reset(),this.dom.idInput&&this.dom.idInput.length&&this.dom.idInput.val(""),this.formModified=!1,null===(e=this.dom.form)||void 0===e||e.find(".error").removeClass("error"),null===(i=this.dom.form)||void 0===i||i.find(".field-error").remove(),this.logger.log("Form reset for tab:",this.settings.tab_id)}},{key:"populateFormWithData",value:function(t){this.logger.log("Populating form with data (base method) for tab:",this.settings.tab_id,"Item Data:",t),t&&t.id?this.dom.idInput&&this.dom.idInput.length?this.dom.idInput.val(t.id):this.logger.warn("AdminTableManager: dom.idInput (hidden item ID field) not found during populateFormWithData."):this.logger.warn("AdminTableManager: populateFormWithData called without itemData or itemData.id. Hidden ID field not populated.",t),this.formModified=!1}},{key:"validateForm",value:function(){var t,e,i,n=this;this.logger.log("Validating form (base method) for tab:",this.settings.tab_id);var a=!0;return null===(t=this.dom.form)||void 0===t||t.find(".error").removeClass("error"),null===(e=this.dom.form)||void 0===e||e.find(".field-error").remove(),null===(i=this.dom.form)||void 0===i||i.find('[data-is-required="true"], .is-required').each((function(t,e){var i=n.$(e),o=i.val();i.is(":checkbox")?i.is(":checked")||(n.showFieldError(i.closest("label").length?i.closest("label"):i,n.settings.i18n.fieldRequired||"This field must be checked."),a=!1):("string"==typeof o&&(o=o.trim()),(null==o||""===o||i.is("select")&&!o)&&(n.showFieldError(i,n.settings.i18n.fieldRequired||"This field is required."),a=!1))})),a}},{key:"addTableRow",value:function(t){var e,i,n,a,o,s;this.logger.log("Adding table row for tab:",this.settings.tab_id,t);var r={hasListTable:!(null===(e=this.dom.listTable)||void 0===e||!e.length),hasListTableBody:!(null===(i=this.dom.listTableBody)||void 0===i||!i.length),tableSelector:(null===(n=this.dom.listTable)||void 0===n?void 0:n.selector)||"N/A",tableBodySelector:(null===(a=this.dom.listTableBody)||void 0===a?void 0:a.selector)||"N/A",isTableVisible:null===(o=this.dom.listTable)||void 0===o?void 0:o.is(":visible"),existingRows:(null===(s=this.dom.listTableBody)||void 0===s?void 0:s.find("tr").length)||0};this.logger.log("Pre-add table state:",r);var l=this.createTableRow(t);if(this.logger.log("Created row:",l&&l.length?"Successfully":"Failed"),l&&this.dom.listTableBody&&this.dom.listTableBody.length){var c,d,u;this.dom.listTableBody.append(l),this.logger.log("Row appended to table body"),this.dom.listTable&&(this.logger.log("Making table visible after row added"),this.dom.listTable.show()),this.dom.noItemsMessage&&(this.logger.log("Hiding no items message after row added"),this.dom.noItemsMessage.hide());var g={isTableVisible:null===(c=this.dom.listTable)||void 0===c?void 0:c.is(":visible"),rowCount:(null===(d=this.dom.listTableBody)||void 0===d?void 0:d.find("tr").length)||0,isNoItemsVisible:null===(u=this.dom.noItemsMessage)||void 0===u?void 0:u.is(":visible")};this.logger.log("Post-add table state:",g)}else this.logger.error("Failed to add table row: createTableRow returned invalid value or listTableBody not found for tab:",this.settings.tab_id)}},{key:"updateTableRow",value:function(t){var e;if(this.logger.log("Updating table row for tab:",this.settings.tab_id,t),t.id)if(this.settings.selectors&&this.settings.selectors.listItemRow){var i=null===(e=this.dom.listTableBody)||void 0===e?void 0:e.find("".concat(this.settings.selectors.listItemRow,'[data-id="').concat(t.id,'"]'));if(i&&i.length){var n=this.createTableRow(t);n?i.replaceWith(n):this.logger.error("Failed to update table row: createTableRow returned null for tab:",this.settings.tab_id)}else this.logger.warn("Could not find row to update with ID:",t.id,"- Appending as new for tab:",this.settings.tab_id),this.addTableRow(t)}else this.logger.error("Cannot update table row: listItemRow selector missing in settings.selectors.");else this.logger.error("Cannot update table row: itemData missing ID for tab:",this.settings.tab_id,t)}},{key:"createTableRow",value:function(t){var e=this;if(this.logger.log("AdminTableManager: Creating table row with data:",t),!t||!t.id){var i;this.logger.error("Cannot create table row: itemData or itemData.id is missing.");var n=(null===(i=this.dom.listTable)||void 0===i?void 0:i.find("thead th").length)||4;return this.$('<tr><td colspan="'.concat(n,'">Error: Invalid item data provided to createTableRow.</td></tr>'))}var a=this.settings.table_columns||{};if(0===Object.keys(a).length){var s;this.logger.error("Table columns data is missing in settings. Settings must include table_columns data.");var r=(null===(s=this.dom.listTable)||void 0===s?void 0:s.find("thead th").length)||4;return this.$('<tr><td colspan="'.concat(r,'">Error: table_columns data missing in settings for ').concat(this.settings.tab_id,".</td></tr>"))}var l=this.settings.selectors||{},c=l.listItemRow||"tr",d=(l.editButton||".pe-edit-item-button").replace(/^\./,""),u=(l.deleteButton||".pe-delete-item-button").replace(/^\./,""),g=this.settings.i18n||{},h=c.split(".")[0].replace(/\[(.*?)\]/g,""),m=this.$("<".concat(h,' data-id="').concat(t.id,'"></').concat(h,">"));return this.logger.log('Creating row with tag: "'.concat(h,'", selector was: "').concat(c,'"')),c.includes(".")&&m.addClass(c.substring(c.indexOf(".")+1).replace(/\./g," ")),this.logger.log("Creating row for item ID ".concat(t.id," with columns:"),Object.keys(a)),Object.entries(a).forEach((function(i){var n,a,s=(a=2,function(t){if(Array.isArray(t))return t}(n=i)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,a,o,s,r=[],l=!0,c=!1;try{if(o=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;l=!1}else for(;!(l=(n=o.call(i)).done)&&(r.push(n.value),r.length!==e);l=!0);}catch(t){c=!0,a=t}finally{try{if(!l&&null!=i.return&&(s=i.return(),Object(s)!==s))return}finally{if(c)throw a}}return r}}(n,a)||function(t,e){if(t){if("string"==typeof t)return o(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?o(t,e):void 0}}(n,a)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),r=s[0],l=s[1],c=e.$("<td></td>").addClass("column-".concat(r)).attr("data-colname",l);e.logger.log('Creating column "'.concat(r,'" for row ').concat(t.id));var h="populateColumn_".concat(r.replace(/[^a-zA-Z0-9_]/g,"_"));if("function"==typeof e[h])e.logger.log("Using custom handler ".concat(h,' for column "').concat(r,'"')),e[h](c,t,r);else if("item_actions"===r||r.endsWith("_actions")){e.logger.log("Creating actions column with default buttons"),c.addClass("actions");var b=e.$("<button></button>").attr("type","button").addClass("button button-small ".concat(d)).text(g.editButtonLabel||"Edit").data("id",t.id),f=e.$("<button></button>").attr("type","button").addClass("button button-small ".concat(u)).text(g.deleteButtonLabel||"Delete").data("id",t.id);c.append(b," ",f)}else{var v="".concat(r,"_display"),p=t[v]||t[r]||"";e.logger.log('Setting text for column "'.concat(r,'": "').concat(p,'"')),c.text(p)}m.append(c)})),this.logger.log("Final row structure for item ".concat(t.id,":"),{html:m.prop("outerHTML"),cellCount:m.find("td").length}),"function"==typeof this.afterRowCreated&&this.afterRowCreated(m,t),m}},{key:"updateNoItemsMessageVisibility",value:function(){var t,e,i;if(this.settings.selectors&&this.settings.selectors.listItemRow){var n={hasNoItemsMessage:!(null===(t=this.dom.noItemsMessage)||void 0===t||!t.length),hasListTableBody:!(null===(e=this.dom.listTableBody)||void 0===e||!e.length),hasListTable:!(null===(i=this.dom.listTable)||void 0===i||!i.length),listItemRowSelector:this.settings.selectors.listItemRow,tableBodyContent:this.dom.listTableBody?this.dom.listTableBody.html():"N/A",rowsFound:this.dom.listTableBody?this.dom.listTableBody.find(this.settings.selectors.listItemRow).length:-1};if(this.logger.log("updateNoItemsMessageVisibility debug info:",n),this.dom.noItemsMessage&&this.dom.noItemsMessage.length&&this.dom.listTableBody&&this.dom.listTable){var a=this.settings.selectors.listItemRow,o=this.dom.listTableBody.find(a),s=o.length>0;this.logger.log('Looking for rows matching "'.concat(a,'" in table body - found: ').concat(o.length)),s?(this.dom.noItemsMessage.hide(),this.dom.listTable.show()):(this.dom.noItemsMessage.show(),this.dom.listTable.hide()),this.logger.log('"No items" message visibility updated for tab:',this.settings.tab_id,"Has items:",s)}else this.logger.warn('Cannot update "no items" message visibility: one or more DOM elements (noItemsMessage, listTableBody, listTable) are missing for tab:',this.settings.tab_id)}else this.logger.warn('Cannot update "no items" message: listItemRow selector missing in settings.selectors.')}},{key:"showFormLoadingSpinner",value:function(t,e){var i=e||this.dom.saveButton;if(i&&i.length){var n="original-text",a=this.settings.i18n&&this.settings.i18n.saving||"Saving...";if(t){if(i.prop("disabled",!0).addClass("pe-loading"),!i.data(n)){var o=i.is("input, textarea, select")?i.val():i.text();i.data(n,o)}i.is("input, textarea, select")?i.val(a):i.text(a)}else if(i.prop("disabled",!1).removeClass("pe-loading"),i.data(n)){var s=i.data(n);i.is("input, textarea, select")?i.val(s):i.text(s),i.removeData(n)}}}}])}(function(i){function n(e){var i,a,o,s;return t(this,n),a=this,o=n,s=[{isModule:!0,settingsObjectName:e.localizedDataName,defaultTabId:e.mainTabId}],o=I(o),(i=_(a,O()?Reflect.construct(o,s||[],I(a).constructor):o.apply(a,s))).vtmConfig={defaultSubTabId:e.defaultSubTabId,ajaxActionPrefix:e.ajaxActionPrefix},i.$container=null,i.vtmConfig.defaultSubTabId&&i.vtmConfig.ajaxActionPrefix||D.error("VerticalTabbedModule: Missing critical VTM-specific configuration (defaultSubTabId or ajaxActionPrefix). Halting initialization for this instance.",i.vtmConfig),i}return M(n,i),a(n,[{key:"moduleInit",value:function(){var t=this;if(this.$container=this.$("#".concat(this.settings.tab_id)),!this.$container.length)return D.error("VerticalTabbedModule: Main container #".concat(this.settings.tab_id," not found. Module not initialized further.")),void(window.ProductEstimatorSettingsInstance&&window.ProductEstimatorSettingsInstance.showNotice("Error: UI container for '".concat(this.settings.tab_id,"' settings not found. Some features might be unavailable."),"error"));D.log("VerticalTabbedModule: moduleInit() called for main tab #".concat(this.settings.tab_id,".")),this.bindCommonVTMEvents(),this.bindModuleSpecificEvents();var e=window.ProductEstimatorSettingsInstance;e&&e.currentTab===this.settings.tab_id&&(D.log("VerticalTabbedModule: Main tab #".concat(this.settings.tab_id," is currently active. Setting up vertical tabs and calling onMainTabActivated.")),setTimeout((function(){t.setupVerticalTabs(),t.onMainTabActivated()}),100))}},{key:"bindCommonVTMEvents",value:function(){this.$(document).on("product_estimator_tab_changed",this.handleMainTabChanged.bind(this)),this.$container.on("submit.vtm","form.pe-vtabs-tab-form",this.handleVTMFormSubmit.bind(this));var t=this.settings.selectors.verticalTabNav||".pe-vtabs-nav-list, .vertical-tabs-nav";this.$container.on("click.vtm","".concat(t," a"),this.handleVerticalTabClick.bind(this)),D.log("[".concat(this.settings.tab_id,"] Common VTM events bound using shared selectors."))}},{key:"bindModuleSpecificEvents",value:function(){D.log("[".concat(this.settings.tab_id,"] Base bindModuleSpecificEvents() called."))}},{key:"onMainTabActivated",value:function(){D.log("[".concat(this.settings.tab_id,"] Base onMainTabActivated() called."))}},{key:"onMainTabDeactivated",value:function(){D.log("[".concat(this.settings.tab_id,"] Base onMainTabDeactivated() called."))}},{key:"setupVerticalTabs",value:function(){if(this.$container&&this.$container.length){D.log("[".concat(this.settings.tab_id,"] Setting up vertical tabs."));var t=this.settings.selectors.verticalTabNav||".pe-vtabs-nav-list, .vertical-tabs-nav",e=this.settings.selectors.verticalTabPane||".pe-vtabs-tab-panel, .vertical-tab-content",i=this.$container.find(t),n=this.$container.find(e);if(i.length&&n.length){var a=this.vtmConfig.defaultSubTabId,o=new URLSearchParams(window.location.search).get("sub_tab");if(o&&i.find('a[data-tab="'.concat(o,'"]')).length)a=o;else{var s=i.find(".pe-vtabs-nav-item.active a, .tab-item.active a");s.length&&(a=s.data("tab"))}if(!i.find('a[data-tab="'.concat(a,'"]')).length){D.warn("[".concat(this.settings.tab_id,'] Determined active/default sub-tab "').concat(a,'" not valid. Falling back to first available.'));var r=i.find("a[data-tab]").first();if(!r.length)return void D.error("[".concat(this.settings.tab_id,"] No valid sub-tabs found. Cannot initialize vertical tabs."));a=r.data("tab")}D.log("[".concat(this.settings.tab_id,"] Initial active sub-tab ID to show: ").concat(a)),this.showVerticalTab(a,!1),this.adjustTabContentHeight(),this.$(window).off("resize.vtm.".concat(this.settings.tab_id)).on("resize.vtm.".concat(this.settings.tab_id),this.adjustTabContentHeight.bind(this))}else D.warn("[".concat(this.settings.tab_id,"] Vertical tab navigation or content panels not found. Vertical tabs may not function."))}else D.warn("[".concat(this.settings.tab_id,"] Cannot setup vertical tabs, $container not found."))}},{key:"handleVerticalTabClick",value:function(t){t.preventDefault();var e=this.$(t.currentTarget).data("tab");e?this.showVerticalTab(e,!0):D.warn("[".concat(this.settings.tab_id,"] Vertical tab link clicked but no subTabId found in data-tab attribute."))}},{key:"adjustTabContentHeight",value:function(){if(this.$container&&this.$container.length){var t=this.settings.selectors.verticalTabNavArea||".pe-vtabs-nav-area, .vertical-tabs",e=this.settings.selectors.verticalTabContentArea||".pe-vtabs-content-area, .vertical-tabs-content",i=this.$container.find(t),n=this.$container.find(e);if(i.length&&n.length){var a=i.outerHeight();a&&n.css("min-height",a+"px")}}}},{key:"showVerticalTab",value:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.$container&&this.settings.tab_id&&t){var i=this.settings.selectors.verticalTabNav||".pe-vtabs-nav-list, .vertical-tabs-nav",n=this.settings.selectors.verticalTabPane||".pe-vtabs-tab-panel, .vertical-tab-content",a=this.settings.selectors.verticalTabNavItem||".pe-vtabs-nav-item, .tab-item",o=this.$container.find(i),s=this.$container.find(n);o.find(a).removeClass("active"),o.find('a[data-tab="'.concat(t,'"]')).closest(a).addClass("active"),s.hide().removeClass("active");var r=this.$container.find("#".concat(t.replace(/[^a-zA-Z0-9-_]/g,"")));if(r.length?r.show().addClass("active"):D.warn("[".concat(this.settings.tab_id,'] Content panel for sub-tab ID "').concat(t,'" not found.')),e){var l=new URL(window.location.href);l.searchParams.set("page",l.searchParams.get("page")||"product-estimator-settings"),l.searchParams.set("tab",this.settings.tab_id),l.searchParams.set("sub_tab",t),window.history.pushState({mainTabId:this.settings.tab_id,subTabId:t},"",l.toString())}this.$(document).trigger("pe_sub_tab_changed_".concat(this.settings.tab_id),[t])}else{var c;D.warn("VerticalTabbedModule: Cannot show vertical tab due to missing container, mainTabId, or subTabId.",{containerExists:!(null===(c=this.$container)||void 0===c||!c.length),mainTabId:this.settings.tab_id,subTabId:t})}}},{key:"handleMainTabChanged",value:function(t,e,i){var n=this;e===this.settings.tab_id?(D.log("VerticalTabbedModule: Main tab #".concat(this.settings.tab_id," activated.")),this.$container&&this.$container.length||(this.$container=this.$("#".concat(this.settings.tab_id))),this.$container.length?setTimeout((function(){n.setupVerticalTabs(),n.onMainTabActivated()}),100):D.warn("VerticalTabbedModule: Main container #".concat(this.settings.tab_id," not found when trying to reactivate tab."))):i===this.settings.tab_id&&(D.log("VerticalTabbedModule: Main tab #".concat(this.settings.tab_id," deactivated.")),this.onMainTabDeactivated())}},{key:"handleVTMFormSubmit",value:function(t){var i=this,n=this.$(t.currentTarget);t.preventDefault(),D.log('VTM Form submission for main tab "'.concat(this.settings.tab_id,'", form:'),n[0]);var a=n.find('.save-settings, button[type="submit"], input[type="submit"]'),o=n.find(".spinner").first();"undefined"!=typeof tinyMCE&&n.find(".wp-editor-area").each((function(t,e){var n=tinyMCE.get(i.$(e).attr("id"));n&&n.save()}));var s=n.serialize(),r=n.attr("data-sub-tab-id");if(!r||""===String(r).trim())return D.error("[".concat(this.settings.tab_id,"] CRITICAL - 'data-sub-tab-id' attribute is missing or empty on the submitted form. Form:"),n[0]),void this.showNotice('Error: Could not save settings. Form configuration is missing "data-sub-tab-id".',"error");n.find('input[type="checkbox"]').each((function(t,e){var n=i.$(e),a=n.attr("name");a&&!n.is(":checked")&&(new RegExp("(^|&)".concat(encodeURIComponent(a).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"=")).test(s)||(s+="&".concat(encodeURIComponent(a),"=0")))})),s=s.replace(/^&+/,"").replace(/&&+/g,"&"),a.prop("disabled",!0),o.addClass("is-active");var l={action:"".concat(this.vtmConfig.ajaxActionPrefix,"_settings"),nonce:this.settings.nonce,form_data:s,sub_tab_id:r.trim(),main_tab_id:this.settings.tab_id};D.log("[".concat(this.settings.tab_id,"] Sending AJAX with payload:"),l),h({url:this.settings.ajaxUrl,type:"POST",data:l}).then((function(t){D.log("[".concat(i.settings.tab_id,"] AJAX success response:"),t);var n=t&&t.message||i.settings.i18n&&i.settings.i18n.saveSuccess||"Settings saved successfully.";i.showNotice(n,"success");var a=window.ProductEstimatorSettingsInstance;a&&"object"===e(a.formChangeTrackers)&&(a.formChangeTrackers[i.settings.tab_id]=!1,a.currentTab===i.settings.tab_id&&(a.formChanged=!1))})).catch((function(t){D.error("[".concat(i.settings.tab_id,"] AJAX error response:"),t);var e=t&&t.message?t.message:i.settings.i18n&&i.settings.i18n.saveError||"Error saving settings.";i.showNotice(e,"error")})).finally((function(){a.prop("disabled",!1),o.removeClass("is-active"),D.log("[".concat(i.settings.tab_id,"] AJAX request finalized."))}))}}])}(j)));jQuery(document).ready((function(t){var e="similar_products",i="similarProductsSettings";if(t("#".concat(e)).length)if(window[i]){if(!window.SimilarProductsSettingsModuleInstance)try{window.SimilarProductsSettingsModuleInstance=new V,p("SimilarProductsInit").log("SimilarProductsSettingsModuleInstance instance initiated.")}catch(t){p("SimilarProductsInit").error("Error instantiating SimilarProductsSettingsModuleInstance:",t),window.ProductEstimatorSettingsInstance&&"function"==typeof window.ProductEstimatorSettingsInstance.showNotice&&window.ProductEstimatorSettingsInstance.showNotice("Failed to initialize Similar Products settings. Check console for errors.","error")}}else p("SimilarProductsInit").error('Localized data object "'.concat(i,'" not found for tab: ').concat(e,". Module cannot be initialized.")),window.ProductEstimatorSettingsInstance&&"function"==typeof window.ProductEstimatorSettingsInstance.showNotice&&window.ProductEstimatorSettingsInstance.showNotice('Configuration data for Similar Products ("'.concat(i,'") is missing. Module disabled.'),"error");else p("SimilarProductsInit").warn("Main container #".concat(e," not found. SimilarProductsSettingsModule will not be initialized."))})),console.log("Product Estimator Admin initialized")})();
//# sourceMappingURL=product-estimator-admin.bundle.js.map