(()=>{"use strict";var t,e={600:(t,e,o)=>{var i=o(29),n=o(901),s=o(470),a=o(690),r=o(723);function l(t){var e;if(null!==(e=window.productEstimatorVars)&&void 0!==e&&e.debug){for(var o,i=arguments.length,n=new Array(i>1?i-1:0),s=1;s<i;s++)n[s-1]=arguments[s];(o=console).log.apply(o,["[".concat(t,"]")].concat(n))}}s.ajaxRequest,s.debounce,a.createElement,a.createElementFromHTML,a.closest,a.toggleVisibility,a.forceElementVisibility,a.findParentBySelector,a.insertAfter,a.removeElement,a.addEventListenerOnce,r.validateEmail,r.validateNumber,r.validateRequired,r.showFieldError,r.clearFieldError,r.showNotice;var c=o(75),d=function(){return(0,n.A)((function t(){var e,o,n,s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if((0,i.A)(this,t),window._dataServiceInstance)return l("DataService","Using existing DataService instance"),window._dataServiceInstance;this.config=Object.assign({debug:!1,ajaxUrl:(null===(e=window.productEstimatorVars)||void 0===e?void 0:e.ajax_url)||"/wp-admin/admin-ajax.php",nonce:(null===(o=window.productEstimatorVars)||void 0===o?void 0:o.nonce)||"",i18n:(null===(n=window.productEstimatorVars)||void 0===n?void 0:n.i18n)||{}},s),this.cache={estimatesData:null,estimatesList:null,rooms:{},suggestedProducts:{}},window._dataServiceLogged||(this.log("DataService initialized"),window._dataServiceLogged=!0),window._dataServiceInstance=this}),[{key:"request",value:function(t){var e=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.log("Making request to '".concat(t,"'"),o),new Promise((function(i,n){var s=new FormData;s.append("action",t),s.append("nonce",e.config.nonce),Object.entries(o).forEach((function(t){var e=(0,c.A)(t,2),o=e[0],i=e[1];null!=i&&s.append(o,String(i))})),e.config.debug&&console.log("Request details:",{url:e.config.ajaxUrl,action:t,nonce:e.config.nonce,data:Object.fromEntries(s)}),fetch(e.config.ajaxUrl,{method:"POST",credentials:"same-origin",body:s}).then((function(t){if(!t.ok)throw console.error("Network response error (".concat(t.status,"): ").concat(t.statusText)),new Error("Network response was not ok: ".concat(t.status));return t.json()})).then((function(o){if(o.success)e.log("Request '".concat(t,"' succeeded:"),o.data),i(o.data);else{var s,a=new Error((null===(s=o.data)||void 0===s?void 0:s.message)||"Unknown error");a.data=o.data,e.log("Request '".concat(t,"' failed:"),a),n(a)}})).catch((function(o){e.log("Request '".concat(t,"' error:"),o);var i=new Error("AJAX request failed: ".concat(o.message));i.originalError=o,i.action=t,n(i)}))}))}},{key:"checkEstimatesExist",value:function(){return this.request("check_estimates_exist").then((function(t){return!!t.has_estimates}))}},{key:"bindCreateEstimateButton",value:function(){var t=this,e=this.modal.querySelector("#create-estimate-btn");e&&(console.log("Found Create Estimate button, binding event handler"),this._createEstimateBtnHandler&&e.removeEventListener("click",this._createEstimateBtnHandler),this._createEstimateBtnHandler=function(e){e.preventDefault(),console.log("Create Estimate button clicked"),t.showNewEstimateForm()},e.addEventListener("click",this._createEstimateBtnHandler))}},{key:"getEstimatesList",value:function(){var t=this;return arguments.length>0&&void 0!==arguments[0]&&arguments[0]||!this.cache.estimatesList?this.request("get_estimates_list").then((function(e){return t.cache.estimatesList=e.html,setTimeout((function(){return t.bindCreateEstimateButton()}),100),e.html})):(this.log("Returning cached estimates list"),setTimeout((function(){return t.bindCreateEstimateButton()}),100),Promise.resolve(this.cache.estimatesList))}},{key:"getEstimatesData",value:function(){var t=this;return arguments.length>0&&void 0!==arguments[0]&&arguments[0]||!this.cache.estimatesData?this.request("get_estimates_data").then((function(e){return t.cache.estimatesData=e.estimates,e.estimates})):(this.log("Returning cached estimates data"),Promise.resolve(this.cache.estimatesData))}},{key:"getRoomsForEstimate",value:function(t){var e=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n="estimate_".concat(t);return!i&&this.cache.rooms[n]?(this.log("Returning cached rooms for estimate ".concat(t)),Promise.resolve(this.cache.rooms[n])):this.request("get_rooms_for_estimate",{estimate_id:t,product_id:o||""}).then((function(t){return e.cache.rooms[n]=t,t}))}},{key:"addProductToRoom",value:function(t,e){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;console.log("DataService: Adding product to room",{roomId:t,productId:e,estimateId:i});var n={room_id:t,product_id:e};return null!==i&&(n.estimate_id=i),this.request("add_product_to_room",n).then((function(t){return console.log("DataService: Product added successfully",t),o.invalidateCache(),t})).catch((function(t){throw console.error("DataService: Error adding product to room",t),t}))}},{key:"addNewEstimate",value:function(t){var e=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i={form_data:s.formatFormData(t)};return o&&(i.product_id=o),this.request("add_new_estimate",i).then((function(t){return e.invalidateCache(),t}))}},{key:"addNewRoom",value:function(t,e){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;console.log("DataService: Adding new room",{estimateId:e,productId:i,formData:t instanceof FormData?Object.fromEntries(t):t});var n={form_data:s.formatFormData(t),estimate_id:e};return i&&(n.product_id=i),this.request("add_new_room",n).then((function(t){return console.log("DataService: Room added successfully",t),o.invalidateCache(),t})).catch((function(t){throw console.error("DataService: Error adding room",t),t}))}},{key:"removeProductFromRoom",value:function(t,e,o){var i=this;return this.request("remove_product_from_room",{estimate_id:t,room_id:e,product_index:o}).then((function(t){return i.invalidateCache(),t}))}},{key:"removeRoom",value:function(t,e){var o=this;console.log("DataService: Removing room",{estimateId:t,roomId:e});var i={estimate_id:String(t),room_id:String(e)};return this.request("remove_room",i).then((function(t){return console.log("DataService: Room removed successfully",t),o.invalidateCache(),t})).catch((function(t){throw console.error("DataService: Error removing room",t),t}))}},{key:"removeEstimate",value:function(t){var e=this;return this.request("remove_estimate",{estimate_id:t}).then((function(t){return e.invalidateCache(),t}))}},{key:"getSuggestedProducts",value:function(t,e){var o=this,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n="estimate_".concat(t,"_room_").concat(e);return!i&&this.cache.suggestedProducts[n]?(this.log("Returning cached suggestions for room ".concat(e)),Promise.resolve(this.cache.suggestedProducts[n])):this.request("get_suggested_products",{estimate_id:t,room_id:e}).then((function(t){return o.cache.suggestedProducts[n]=t.suggestions,t.suggestions}))}},{key:"addSuggestionToRoom",value:function(t,e,o){var i=this;return this.request("add_product_to_room",{estimate_id:t,room_id:e,product_id:o}).then((function(t){return i.invalidateCache(),t}))}},{key:"getVariationEstimator",value:function(t){return this.request("get_variation_estimator",{variation_id:t})}},{key:"invalidateCache",value:function(){this.log("Invalidating caches"),this.cache.estimatesData=null,this.cache.estimatesList=null,this.cache.rooms={},this.cache.suggestedProducts={}}},{key:"log",value:function(){if(this.config.debug){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];l.apply(void 0,["DataService"].concat(e))}}}])}();const u=d;var m=o(284),h=o(467);function g(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.push.apply(o,i)}return o}function v(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?g(Object(o),!0).forEach((function(e){(0,h.A)(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):g(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}var p=function(){return(0,n.A)((function t(){(0,i.A)(this,t),this.dialog=null,this.backdropElement=null,this.initialized=!1,this.callbacks={confirm:null,cancel:null},this.init()}),[{key:"init",value:function(){this.initialized||(this.createDialogElements(),this.bindEvents(),this.initialized=!0,this.log("Initialized"))}},{key:"createDialogElements",value:function(){this.backdropElement=a.createElement("div",{className:"pe-dialog-backdrop"}),this.dialog=a.createElement("div",{className:"pe-confirmation-dialog",attributes:{role:"dialog","aria-modal":"true"}}),this.dialog.innerHTML='\n    <div class="dialog-content">\n      <div class="pe-dialog-header">\n        <h3 class="pe-dialog-title">Confirm Action</h3>\n        <button type="button" class="pe-dialog-close" aria-label="Close">\n          <span aria-hidden="true">&times;</span>\n        </button>\n      </div>\n      <div class="pe-dialog-body">\n        <p class="pe-dialog-message">Are you sure you want to proceed?</p>\n      </div>\n      <div class="pe-dialog-footer">\n        <button type="button" class="pe-dialog-btn pe-dialog-cancel">Cancel</button>\n        <button type="button" class="pe-dialog-btn pe-dialog-confirm">Confirm</button>\n      </div>\n    </div>\n  ';var t=document.querySelector(".pe-dialog-backdrop"),e=document.querySelector(".pe-confirmation-dialog");t&&t.remove(),e&&e.remove(),document.body.appendChild(this.backdropElement),document.body.appendChild(this.dialog)}},{key:"bindEvents",value:function(){var t=this,e=this.dialog.querySelector(".pe-dialog-close"),o=this.dialog.querySelector(".pe-dialog-cancel"),i=this.dialog.querySelector(".pe-dialog-confirm");e.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),t.hide(),"function"==typeof t.callbacks.cancel&&t.callbacks.cancel()})),o.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),t.hide(),"function"==typeof t.callbacks.cancel&&t.callbacks.cancel()})),i.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),t.hide(),"function"==typeof t.callbacks.confirm&&t.callbacks.confirm()})),this.backdropElement.addEventListener("click",(function(e){e.preventDefault(),e.stopPropagation(),e.target===t.backdropElement&&(t.hide(),"function"==typeof t.callbacks.cancel&&t.callbacks.cancel())})),this.dialog.addEventListener("click",(function(t){t.stopPropagation()})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&t.isVisible()&&(e.preventDefault(),e.stopPropagation(),t.hide(),"function"==typeof t.callbacks.cancel&&t.callbacks.cancel())}))}},{key:"show",value:function(){var t,e=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=(null===(t=window.productEstimatorVars)||void 0===t?void 0:t.i18n)||{},n=v(v({},{title:"Confirm Action",message:"Are you sure you want to proceed?",type:"",confirmText:i.confirm||"Confirm",cancelText:i.cancel||"Cancel",onConfirm:null,onCancel:null}),o);this.callbacks.confirm=n.onConfirm,this.callbacks.cancel=n.onCancel;var s=this.dialog.querySelector(".pe-dialog-title"),a=this.dialog.querySelector(".pe-dialog-message"),r=this.dialog.querySelector(".pe-dialog-confirm"),l=this.dialog.querySelector(".pe-dialog-cancel");s&&(s.textContent=n.title),a&&(a.textContent=n.message),r&&(r.textContent=n.confirmText),l&&(l.textContent=n.cancelText),this.dialog.classList.remove("pe-dialog-type-product","pe-dialog-type-room","pe-dialog-type-estimate"),n.type&&this.dialog.classList.add("pe-dialog-type-".concat(n.type)),this.backdropElement&&(this.backdropElement.style.display="block"),this.dialog&&(this.dialog.style.display="block"),this.dialog&&this.dialog.classList.add("active"),setTimeout((function(){var t=e.dialog.querySelector(".pe-dialog-cancel");t&&t.focus()}),100)}},{key:"hide",value:function(){this.backdropElement&&(this.backdropElement.style.display="none"),this.dialog&&(this.dialog.classList.remove("active"),this.dialog.style.display="none")}},{key:"isVisible",value:function(){return this.dialog&&"block"===this.dialog.style.display}},{key:"log",value:function(){if(window.productEstimatorVars&&window.productEstimatorVars.debug){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];l.apply(void 0,["ConfirmationDialog"].concat(e))}}}])}();const f=new p;var y=function(){return(0,n.A)((function t(e){(0,i.A)(this,t),this.id="carousel_"+Math.random().toString(36).substr(2,9),this.container=e,this.itemsContainer=e.querySelector(".suggestions-container"),this.items=e.querySelectorAll(".suggestion-item"),this.prevBtn=e.querySelector(".suggestions-nav.prev"),this.nextBtn=e.querySelector(".suggestions-nav.next"),this.isSimilarProducts=e.classList.contains("similar-products-carousel"),l("SuggestionsCarousel","[".concat(this.id,"] Initializing carousel with ").concat(this.items.length," items, isSimilarProducts: ").concat(this.isSimilarProducts)),this.itemsContainer&&this.items.length?(e.carouselInstance=this,this.isSimilarProducts?(this.itemWidth=130,this.itemGap=5):(this.itemWidth=200,this.itemGap=15),this.visibleItems=this.calculateVisibleItems(),this.currentPosition=0,this.maxPosition=Math.max(0,this.items.length-this.visibleItems),this.setContainerSize(),this.bindEvents(),this.updateButtons()):l("SuggestionsCarousel","[".concat(this.id,"] Carousel missing items container or has no items"))}),[{key:"getContainerWidth",value:function(){if(this.isSimilarProducts){var t=this.container.closest(".product-item");if(t){var e=t.offsetWidth;return l("SuggestionsCarousel","[".concat(this.id,"] Found product-item parent: ").concat(e,"px")),e-10}}var o=this.container.offsetWidth;return l("SuggestionsCarousel","[".concat(this.id,"] Using container width: ").concat(o,"px")),o}},{key:"setContainerSize",value:function(){if(this.isSimilarProducts){var t=this.container.closest(".product-item");if(t){var e=t.offsetWidth;l("SuggestionsCarousel","[".concat(this.id,"] Similar products parent width: ").concat(e,"px")),this.container.style.maxWidth="".concat(e-10,"px")}Array.from(this.items).forEach((function(t){t.style.flexShrink="0",t.style.flexGrow="0"})),this.itemsContainer.style.gap="".concat(this.itemGap,"px")}}},{key:"calculateVisibleItems",value:function(){var t=this.getContainerWidth(),e=t-50,o=(this.isSimilarProducts?130:this.itemWidth)+(this.isSimilarProducts?5:this.itemGap),i=Math.max(1,Math.floor(e/o));return l("SuggestionsCarousel","[".concat(this.id,"] Container width: ").concat(t,"px, available: ").concat(e,"px, visible items: ").concat(i)),i}},{key:"bindEvents",value:function(){var t=this;this.handlePrevClick=this.handlePrevClick.bind(this),this.handleNextClick=this.handleNextClick.bind(this),this.handleResize=this.handleResize.bind(this),this.prevBtn&&(this.prevBtn.removeEventListener("click",this.handlePrevClick),this.prevBtn.addEventListener("click",this.handlePrevClick)),this.nextBtn&&(this.nextBtn.removeEventListener("click",this.handleNextClick),this.nextBtn.addEventListener("click",this.handleNextClick)),this.resizeTimeout=null,window.addEventListener("resize",(function(){clearTimeout(t.resizeTimeout),t.resizeTimeout=setTimeout(t.handleResize,150)})),l("SuggestionsCarousel","[".concat(this.id,"] Events bound"))}},{key:"handlePrevClick",value:function(t){t.preventDefault(),t.stopPropagation(),l("SuggestionsCarousel","[".concat(this.id,"] Prev button clicked, current position: ").concat(this.currentPosition)),this.currentPosition>0&&(this.currentPosition--,this.updatePosition(),this.updateButtons())}},{key:"handleNextClick",value:function(t){t.preventDefault(),t.stopPropagation(),l("SuggestionsCarousel","[".concat(this.id,"] Next button clicked, current position: ").concat(this.currentPosition,", max: ").concat(this.maxPosition)),this.currentPosition<this.maxPosition&&(this.currentPosition++,this.updatePosition(),this.updateButtons())}},{key:"handleResize",value:function(){this.setContainerSize(),this.visibleItems,this.visibleItems=this.calculateVisibleItems(),this.maxPosition=Math.max(0,this.items.length-this.visibleItems),l("SuggestionsCarousel","[".concat(this.id,"] Window resized, visible items: ").concat(this.visibleItems,", max position: ").concat(this.maxPosition)),this.currentPosition>this.maxPosition&&(this.currentPosition=this.maxPosition),this.updatePosition(),this.updateButtons()}},{key:"getAvailableWidth",value:function(){var t=this.container.clientWidth-50;if(this.isSimilarProducts){var e=this.container.closest(".product-item");if(e){var o=window.getComputedStyle(e),i=e.clientWidth-(parseFloat(o.paddingLeft)+parseFloat(o.paddingRight));t=Math.min(t,i),l("SuggestionsCarousel","Product item width: ".concat(i,"px, Available width: ").concat(t,"px"))}}else{var n=this.container.closest(".accordion-content");if(n){var s=n.clientWidth-30;t=Math.min(t,s),l("SuggestionsCarousel","Accordion content width: ".concat(s,"px, Available width: ").concat(t,"px"))}}return Math.max(t,100)}},{key:"updatePosition",value:function(){if(this.itemsContainer){var t=this.itemWidth+this.itemGap,e=-this.currentPosition*t;this.itemsContainer.style.transition="transform 0.3s ease",this.itemsContainer.style.transform="translateX(".concat(e,"px)"),l("SuggestionsCarousel","[".concat(this.id,"] Position updated to ").concat(this.currentPosition,", translateX: ").concat(e,"px"))}}},{key:"updateButtons",value:function(){this.prevBtn&&(this.currentPosition<=0?(this.prevBtn.classList.add("disabled"),this.prevBtn.setAttribute("aria-disabled","true")):(this.prevBtn.classList.remove("disabled"),this.prevBtn.removeAttribute("aria-disabled"))),this.nextBtn&&(this.currentPosition>=this.maxPosition?(this.nextBtn.classList.add("disabled"),this.nextBtn.setAttribute("aria-disabled","true")):(this.nextBtn.classList.remove("disabled"),this.nextBtn.removeAttribute("aria-disabled"))),l("SuggestionsCarousel","[".concat(this.id,"] Buttons updated - prev ").concat(this.prevBtn?this.prevBtn.classList.contains("disabled")?"disabled":"enabled":"missing",", next ").concat(this.nextBtn?this.nextBtn.classList.contains("disabled")?"disabled":"enabled":"missing"))}},{key:"destroy",value:function(){this.prevBtn&&this.prevBtn.removeEventListener("click",this.handlePrevClick),this.nextBtn&&this.nextBtn.removeEventListener("click",this.handleNextClick),window.removeEventListener("resize",this.handleResize),this.container&&delete this.container.carouselInstance,l("SuggestionsCarousel","[".concat(this.id,"] Carousel destroyed"))}}])}();function E(){l("SuggestionsCarousel","Initializing all suggestion carousels");var t=document.querySelectorAll(".suggestions-carousel");l("SuggestionsCarousel","Found ".concat(t.length," carousel containers")),t.forEach((function(t){t.carouselInstance&&t.carouselInstance.destroy()}));var e=[];return t.forEach((function(t){var o=new y(t);e.push(o)})),e}function w(){var t=document.querySelectorAll(".accordion-header");l("SuggestionsCarousel","Setting up ".concat(t.length," accordion headers for carousel initialization")),t.forEach((function(t){t.removeEventListener("click",b),t.addEventListener("click",b)}))}function b(t){setTimeout((function(){var e=a.closest(t.currentTarget,".accordion-item");if(e){var o=e.querySelector(".accordion-content");if(o&&"none"!==window.getComputedStyle(o).display){l("SuggestionsCarousel","Accordion opened, checking for carousels to initialize");var i=o.querySelectorAll(".suggestions-carousel");l("SuggestionsCarousel","Found ".concat(i.length," carousels in opened accordion")),i.forEach((function(t){t.carouselInstance&&t.carouselInstance.destroy(),new y(t)}))}}}),300)}document.addEventListener("DOMContentLoaded",(function(){l("SuggestionsCarousel","DOM loaded, initializing carousels"),E(),w()}));var S=function(){return(0,n.A)((function t(){var e,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;(0,i.A)(this,t),this.config=Object.assign({debug:!1,selectors:{modalContainer:"#product-estimator-modal",estimatorButtons:".product-estimator-button, .single_add_to_estimator_button",modalOverlay:".product-estimator-modal-overlay",closeButton:".product-estimator-modal-close",contentContainer:".product-estimator-modal-form-container",loadingIndicator:".product-estimator-modal-loading",estimatesList:"#estimates",estimateSelection:"#estimate-selection-wrapper",roomSelection:"#room-selection-form-wrapper",newEstimateForm:"#new-estimate-form-wrapper",newRoomForm:"#new-room-form-wrapper"},i18n:(null===(e=window.productEstimatorVars)||void 0===e?void 0:e.i18n)||{}},o),this.dataService=n,this.modal=null,this.overlay=null,this.closeButton=null,this.contentContainer=null,this.loadingIndicator=null,this.estimatesList=null,this.estimateSelection=null,this.estimateSelectionForm=null,this.roomSelectionForm=null,this.newEstimateForm=null,this.newRoomForm=null,this.isOpen=!1,this.currentView=null,this.currentProductId=null,this.initialized=!1,this.eventHandlers={},this.escKeyHandler=null,this.init()}),[{key:"init",value:function(){var t=this;this.initialized?l("ModalManager","ModalManager already initialized"):(this.modal=document.querySelector(this.config.selectors.modalContainer),this.modal?l("ModalManager","Found existing modal in DOM, initializing elements"):l("ModalManager","Warning: Modal element not found in DOM. The PHP partial may not be included."),this.modal&&(this.initializeElements(),this.bindEvents(),this.setupLoaderSafety(),setTimeout((function(){t.ensureLoaderHidden()}),500)),this.initializeJQueryAccordions(),this.initialized=!0,l("ModalManager","ModalManager initialized"))}},{key:"initializeElements",value:function(){this.modal?(this.overlay=this.modal.querySelector(this.config.selectors.modalOverlay),this.closeButton=this.modal.querySelector(this.config.selectors.closeButton),this.contentContainer=this.modal.querySelector(this.config.selectors.contentContainer),this.loadingIndicator=this.modal.querySelector(this.config.selectors.loadingIndicator),this.loadingIndicator||(console.warn("[ModalManager] Loading indicator not found, creating one"),this.loadingIndicator=a.createElement("div",{className:"product-estimator-modal-loading"},[a.createElement("div",{className:"loading-spinner"}),a.createElement("div",{className:"loading-text",textContent:this.config.i18n.loading||"Loading..."})]),this.modal.appendChild(this.loadingIndicator)),this.estimatesList=this.modal.querySelector("#estimates"),this.estimateSelection=this.modal.querySelector("#estimate-selection-wrapper"),this.estimateSelectionForm=this.modal.querySelector("#estimate-selection-form-wrapper"),this.roomSelectionForm=this.modal.querySelector("#room-selection-form-wrapper"),this.newEstimateForm=this.modal.querySelector("#new-estimate-form-wrapper"),this.newRoomForm=this.modal.querySelector("#new-room-form-wrapper"),!this.estimateSelection&&this.contentContainer&&(console.warn("Creating estimate selection container"),this.estimateSelection=a.createElement("div",{id:"estimate-selection-wrapper"}),this.contentContainer.appendChild(this.estimateSelection),this.estimateSelectionForm||(this.estimateSelectionForm=a.createElement("div",{id:"estimate-selection-form-wrapper"}),this.estimateSelection.appendChild(this.estimateSelectionForm))),!this.roomSelectionForm&&this.contentContainer&&(console.warn("Creating room selection form container"),this.roomSelectionForm=a.createElement("div",{id:"room-selection-form-wrapper",style:{display:"none"}}),this.contentContainer.appendChild(this.roomSelectionForm)),this.bindExistingForms()):console.error("[ModalManager] Modal element not available for initializing elements")}},{key:"showLoading",value:function(){if(this.loadingIndicator)this.loadingIndicator.style.display="flex";else if(console.warn("Loading indicator not available - creating one"),this.modal){var t=a.createElement("div",{className:"product-estimator-modal-loading",style:{display:"flex"}},[a.createElement("div",{className:"loading-spinner"}),a.createElement("div",{className:"loading-text",textContent:this.config.i18n.loading||"Loading..."})]);this.modal.appendChild(t),this.loadingIndicator=t}else console.error("Cannot create loading indicator - modal not available")}},{key:"hideLoading",value:function(){this.loadingStartTime=0,this.loadingIndicator?(this.loadingIndicator.style.display="none",console.log("Loading indicator hidden at:",(new Date).toISOString())):console.warn("Loading indicator not available during hide operation")}},{key:"initializeCarousels",value:function(){console.log("Initializing carousels in modal");var t=this.modal.querySelectorAll(".suggestions-carousel");if(t.length>0){console.log("Found ".concat(t.length," carousel containers in modal"));var e=this.modal.querySelectorAll(".product-suggestions .suggestions-carousel").length,o=this.modal.querySelectorAll(".product-similar-products .suggestions-carousel").length;console.log("Carousel types: ".concat(e," suggestion carousels, ").concat(o," similar product carousels")),E()}else console.log("No carousel containers found in modal")}},{key:"bindExistingForms",value:function(){var t=this;if(this.newRoomForm){var e=this.newRoomForm.querySelector("form#new-room-form");if(e){console.log("Found existing room form, binding event handlers"),this._newRoomFormSubmitHandler&&e.removeEventListener("submit",this._newRoomFormSubmitHandler),this._newRoomFormSubmitHandler=function(o){o.preventDefault(),console.log("Existing room form submitted"),t.handleNewRoomSubmission(e,o)},e.addEventListener("submit",this._newRoomFormSubmitHandler);var o=e.querySelector(".cancel-btn");o&&o.addEventListener("click",(function(){t.cancelForm("room")}))}}if(this.newEstimateForm){var i=this.newEstimateForm.querySelector("form#new-estimate-form");i&&(this._estimateFormSubmitHandler&&i.removeEventListener("submit",this._estimateFormSubmitHandler),this._estimateFormSubmitHandler=function(e){e.preventDefault(),t.handleNewEstimateSubmission(i,e)},i.addEventListener("submit",this._estimateFormSubmitHandler))}this.bindRoomSelectionFormEvents()}},{key:"bindEvents",value:function(){var t=this;if(this.modal){this._modalClickHandler&&this.modal.removeEventListener("click",this._modalClickHandler),this._modalClickHandler=function(e){e.target.closest(t.config.selectors.closeButton)&&(e.preventDefault(),e.stopPropagation(),l("ModalManager","Close button clicked"),t.closeModal()),e.target.classList.contains("product-estimator-modal-overlay")&&(e.preventDefault(),e.stopPropagation(),l("ModalManager","Overlay clicked"),t.closeModal())},this.modal.addEventListener("click",this._modalClickHandler);var e=function(e){"Escape"===e.key&&t.isOpen&&(l("ModalManager","Escape key pressed"),t.closeModal())};document.removeEventListener("keydown",this.escKeyHandler),document.addEventListener("keydown",e),this.escKeyHandler=e,l("ModalManager","Modal events bound")}else l("ModalManager","Modal element not available, cannot bind events")}},{key:"openModal",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];console.log("MODAL OPEN CALLED WITH:",{productId:e,forceListView:o,typeOfProductId:(0,m.A)(e)}),this.modal?(this.resetModalState(),this.currentProductId=e,e?this.modal.dataset.productId=e:delete this.modal.dataset.productId,this.showLoading(),this.modal.style.display="block",document.body.classList.add("modal-open"),this.isOpen=!0,console.log("FLOW DECISION:",{hasProductId:!!e,forceListView:o,willShowProductFlow:!!e&&!o,willShowListView:!e||o}),e&&!o?(console.log("STARTING PRODUCT FLOW with product ID:",e),this.estimatesList&&(this.estimatesList.style.display="none","undefined"!=typeof jQuery&&jQuery(this.estimatesList).hide()),this.dataService.checkEstimatesExist().then((function(e){console.log("Has estimates check result:",e),e?t.showEstimateSelection():(t.showNewEstimateForm(),t.hideLoading())})).catch((function(e){console.error("Error checking estimates:",e),t.showError("Error checking estimates. Please try again."),t.hideLoading()}))):(console.log("STARTING LIST VIEW FLOW"),this.estimatesList&&(this.estimatesList.style.display="block"),this.estimateSelection&&(this.estimateSelection.style.display="none"),this.newEstimateForm&&(this.newEstimateForm.style.display="none"),this.newRoomForm&&(this.newRoomForm.style.display="none"),this.loadEstimatesList().then((function(){var e=t.modal.querySelector("#create-estimate-btn");e&&(t._createEstimateBtnHandler&&e.removeEventListener("click",t._createEstimateBtnHandler),t._createEstimateBtnHandler=function(){t.showNewEstimateForm()},e.addEventListener("click",t._createEstimateBtnHandler),console.log("Updated event handler for list view create estimate button"))})).catch((function(e){console.error("Error loading estimates list:",e),t.showError("Error loading estimates list.")})).finally((function(){t.hideLoading()})))):console.error("Cannot open modal - not found in DOM")}},{key:"showEstimateSelection",value:function(){var t=this;console.log("Showing estimate selection"),this.estimatesList&&(this.estimatesList.style.display="none"),this.estimateSelection?(a.forceElementVisibility(this.estimateSelection),this.estimateSelectionForm&&a.forceElementVisibility(this.estimateSelectionForm),this.estimateSelectionForm&&this.estimateSelectionForm.querySelector("form")?(this.loadEstimatesData(),this.bindEstimateSelectionFormEvents(),this.hideLoading()):this.loadEstimateSelectionForm().then((function(){t.bindEstimateSelectionFormEvents()})).catch((function(t){console.error("Error loading form:",t)}))):console.error("Estimate selection container not found")}},{key:"closeModal",value:function(){this.isOpen&&(this.modal?(this.modal.style.display="none",delete this.modal.dataset.productId,this.ensureLoaderHidden(),document.body.classList.remove("modal-open"),this.isOpen=!1,this.currentProductId=null,this.currentView=null,this.resetModalState(),this.emit("modal:closed")):l("ModalManager","Cannot close modal - element not found"))}},{key:"setupLoaderSafety",value:function(){var t=this;setInterval((function(){if(t.isOpen&&t.loadingIndicator&&"none"!==window.getComputedStyle(t.loadingIndicator).display){var e=t.loadingStartTime||0,o=(new Date).getTime();e&&o-e>1e4&&(console.warn("Loading indicator has been visible for more than 10 seconds, hiding it."),t.hideLoading(),t.showError("The operation is taking longer than expected or may have failed silently."))}}),2e3);var e=this.showLoading;this.showLoading=function(){return t.loadingStartTime=(new Date).getTime(),e.call(t)};var o=this.hideLoading;this.hideLoading=function(){return t.loadingStartTime=0,o.call(t)},console.log("Loader safety system installed")}},{key:"ensureLoaderHidden",value:function(){this.loadingIndicator&&"none"!==window.getComputedStyle(this.loadingIndicator).display&&(console.log("Force hiding loader that was left visible"),this.hideLoading());var t=document.querySelectorAll(".product-estimator-modal-loading");if(t.length>1){console.warn("Found ".concat(t.length," loading indicators, cleaning up duplicates"));for(var e=1;e<t.length;e++)t[e].remove()}t.forEach((function(t){t.style.display="none"}))}},{key:"resetModalState",value:function(){console.log("Resetting modal state");var t=function(t){t&&(t.style.display="none","undefined"!=typeof jQuery&&jQuery(t).hide())};t(this.estimatesList),t(this.estimateSelection),t(this.estimateSelectionForm),t(this.roomSelectionForm),t(this.newEstimateForm),t(this.newRoomForm),this.roomSelectionForm&&this.roomSelectionForm.removeAttribute("data-estimate-id"),this.newRoomForm&&(this.newRoomForm.removeAttribute("data-estimate-id"),this.newRoomForm.removeAttribute("data-product-id"))}},{key:"loadEstimatesList",value:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return new Promise((function(i,n){t.showLoading(),t.estimatesList?(t.estimatesList.style.display="block",console.log("Loading estimates list with expansion params - Room: ".concat(e,", Estimate: ").concat(o)),s.ajaxRequest({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_estimates_list",nonce:productEstimatorVars.nonce}}).then((function(s){if(s.html)t.estimatesList.innerHTML=s.html,setTimeout((function(){if(o&&!t.modal.querySelector('.estimate-section[data-estimate-id="'.concat(o,'"]'))){var i=t.modal.querySelectorAll(".estimate-section");console.log("Adding missing data-estimate-id attributes to ".concat(i.length," estimates")),i.forEach((function(t,e){if(!t.dataset.estimateId){var o=t.querySelector(".remove-estimate");o&&o.dataset.estimateId?(t.dataset.estimateId=o.dataset.estimateId,console.log("Added estimate ID ".concat(o.dataset.estimateId," to section"))):(t.dataset.estimateId=String(e),console.log("Added fallback estimate ID ".concat(e," to section")))}}))}setTimeout((function(){t.updateEstimatesList(e,o)}),150),t.initializeAccordions(e,o),t.bindProductRemovalEvents(),t.bindRoomRemovalEvents(),t.bindEstimateRemovalEvents(),t.bindEstimateListEventHandlers(),w(),t.initializeCarousels(),t.bindSuggestedProductButtons()}),150),i(s.html);else{var a=new Error("Failed to load estimates list");console.error(a),n(a)}})).catch((function(t){console.error("Error loading estimates list:",t),n(t)})).finally((function(){t.hideLoading()}))):n(new Error("Estimates list container not found"))}))}},{key:"handleProductRemoval",value:function(t,e,o){var i=this;this.showLoading(),console.log("Removing product at index ".concat(o," from room ").concat(e," in estimate ").concat(t)),this.dataService.removeProductFromRoom(t,e,o).then((function(o){return i.loadEstimatesList(e,t).then((function(){console.log("Estimates list refreshed, attempting to expand room ".concat(e," in estimate ").concat(t));var o=i.modal.querySelector('.estimate-section[data-estimate-id="'.concat(t,'"]'));if(o){o.classList.remove("collapsed");var n=o.querySelector(".estimate-content");n&&(n.style.display="block")}var s=i.modal.querySelector('.accordion-item[data-room-id="'.concat(e,'"][data-estimate-id="').concat(t,'"]'));if(s||(console.log("Using fallback room selector"),s=i.modal.querySelector('.accordion-item[data-room-id="'.concat(e,'"]'))),s){console.log("Found room element, expanding it");var a=s.querySelector(".accordion-header"),r=s.querySelector(".accordion-content");a&&a.classList.add("active"),r&&(r.style.display="block"),setTimeout((function(){s.scrollIntoView({behavior:"smooth",block:"center"})}),200)}else console.warn("Could not find room element for room ID ".concat(e));i.showMessage("Product removed successfully","success")}))})).catch((function(t){console.error("Error removing product:",t),i.showError(t.message||"Error removing product. Please try again.")})).finally((function(){i.hideLoading()}))}},{key:"handleAddSuggestedProduct",value:function(t,e,o,i){var n=this;this.showLoading(),i&&(i.disabled=!0,i.classList.add("loading"),i.innerHTML='<span class="loading-dots">Adding...</span>'),console.log("Adding suggested product ".concat(t," to room ").concat(o," in estimate ").concat(e)),s.ajaxRequest({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"add_product_to_room",nonce:productEstimatorVars.nonce,product_id:t,room_id:o,estimate_id:e}}).then((function(t){console.log("Add suggested product response:",t),n.loadEstimatesList(o,e).then((function(){setTimeout((function(){var t=n.modal.querySelector('.accordion-item[data-room-id="'.concat(o,'"]'));if(t){var e=t.querySelector(".accordion-header");e&&!e.classList.contains("active")&&e.click()}}),300),n.showMessage("Product added successfully!","success")})).catch((function(t){console.error("Error refreshing estimates list:",t),n.showError("Error refreshing list. Please try again.")}))})).catch((function(t){var e;null!==(e=t.data)&&void 0!==e&&e.duplicate?(console.log("Duplicate suggested product detected:",t.data),n.showMessage(t.data.message||"This product already exists in this room.","error")):(console.error("AJAX error:",t),n.showError("Error adding product. Please try again."))})).finally((function(){i&&(i.disabled=!1,i.classList.remove("loading"),i.textContent="Add"),n.hideLoading()}))}},{key:"bindSuggestedProductButtons",value:function(){var t=this;console.log("Binding suggested product buttons");var e=this.modal.querySelectorAll(".add-suggestion-to-room");e.length?(console.log("Found ".concat(e.length," suggestion buttons to bind")),e.forEach((function(e){e._suggestionButtonHandler&&e.removeEventListener("click",e._suggestionButtonHandler),e._suggestionButtonHandler=function(o){o.preventDefault(),o.stopPropagation();var i=e.dataset.productId,n=e.dataset.estimateId,s=e.dataset.roomId;console.log("Add suggestion button clicked:",{productId:i,estimateId:n,roomId:s}),i&&n&&s?t.handleAddSuggestedProduct(i,n,s,e):console.error("Missing required data attributes for adding suggested product")},e.addEventListener("click",e._suggestionButtonHandler)})),console.log("Suggestion buttons bound successfully")):console.log("No suggestion buttons found to bind")}},{key:"handleRoomRemoval",value:function(t,e){var o,i=this,n=this.modal.querySelector('.accordion-item[data-room-id="'.concat(e,'"]')),s=n&&(null===(o=n.querySelector(".room-name"))||void 0===o?void 0:o.textContent)||"room";this.showLoading(),console.log("Removing room with parameters:",{estimate_id:t,room_id:e}),this.dataService.removeRoom(t,e).then((function(e){console.log("Room removal response:",e),i.loadEstimatesList(null,t).then((function(){if(i.showMessage("".concat(s," removed successfully"),"success"),!1===e.has_rooms){console.log("Estimate has no rooms left after removal");var o=i.modal.querySelector('.estimate-section[data-estimate-id="'.concat(t,'"] .add-room'));o&&(o.classList.add("highlight-btn"),setTimeout((function(){o.classList.remove("highlight-btn")}),2e3))}})).catch((function(t){l("ModalManager","Error refreshing estimates list:",t),i.showError("Error refreshing estimates list. Please try again.")}))})).catch((function(t){l("ModalManager","Error removing room:",t),i.showError(t.message||"Error removing room. Please try again.")})).finally((function(){i.hideLoading()}))}},{key:"handleEstimateRemoval",value:function(t){var e=this;this.showLoading(),this.dataService.removeEstimate(t).then((function(){e.loadEstimatesList().then((function(){e.showMessage("Estimate removed successfully","success")})).catch((function(t){l("ModalManager","Error refreshing estimates list:",t),e.showError("Error refreshing estimates list. Please try again.")}))})).catch((function(t){l("ModalManager","Error removing estimate:",t),e.showError(t.message||"Error removing estimate. Please try again.")})).finally((function(){e.hideLoading()}))}},{key:"bindProductRemovalEvents",value:function(){var t=this;console.log("Binding product removal events"),this.estimatesList&&(this._productRemovalHandler&&this.estimatesList.removeEventListener("click",this._productRemovalHandler),this._productRemovalHandler=function(e){var o=e.target.closest(".remove-product");if(o){e.preventDefault(),e.stopPropagation();var i=o.dataset.estimateId,n=o.dataset.roomId,s=o.dataset.productIndex;console.log("Remove product button clicked:",{estimateId:i,roomId:n,productIndex:s}),i&&n&&void 0!==s?t.confirmDelete("product",i,n,s):console.error("Missing data attributes for product removal")}},this.estimatesList.addEventListener("click",this._productRemovalHandler)),console.log("Product removal events bound with duplicate prevention")}},{key:"bindRoomRemovalEvents",value:function(){var t=this;this.estimatesList&&(this._roomRemovalHandler&&this.estimatesList.removeEventListener("click",this._roomRemovalHandler),this._roomRemovalHandler=function(e){var o=e.target.closest(".remove-room");if(o){e.preventDefault(),e.stopPropagation();var i=o.dataset.estimateId,n=o.dataset.roomId;console.log("Remove room button clicked:",{estimateId:i,roomId:n}),i&&n&&t.confirmDelete("room",i,n)}},this.estimatesList.addEventListener("click",this._roomRemovalHandler))}},{key:"bindEstimateRemovalEvents",value:function(){var t=this;this.estimatesList&&(this._estimateRemovalHandler&&this.estimatesList.removeEventListener("click",this._estimateRemovalHandler),this._estimateRemovalHandler=function(e){var o=e.target.closest(".remove-estimate");if(o){e.preventDefault(),e.stopPropagation();var i=o.dataset.estimateId;console.log("Remove estimate button clicked:",{estimateId:i}),i&&t.confirmDelete("estimate",i)}},this.estimatesList.addEventListener("click",this._estimateRemovalHandler))}},{key:"confirmDelete",value:function(t,e,o,i){var n,s=this,a=(null===(n=window.productEstimatorVars)||void 0===n?void 0:n.i18n)||{},r=a.dialog_titles||{},c=a.dialog_messages||{},d="",u="",m="";switch(t){case"estimate":d=r.estimate||"Delete Estimate",u=c.estimate||"Are you sure you want to delete this estimate and all its rooms?",m=a.delete||"Delete";break;case"room":d=r.room||"Delete Room",u=c.room||"Are you sure you want to delete this room and all its products?",m=a.delete||"Delete";break;case"product":d=r.product||"Remove Product",u=c.product||"Are you sure you want to remove this product from the room?",m=a.remove||"Remove"}l("ModalManager","Confirming deletion of ".concat(t," - ID: ").concat("product"===t?i:"room"===t?o:e)),f.show({title:d,message:u,type:t,confirmText:m,onConfirm:function(){switch(l("ModalManager","User confirmed deletion of ".concat(t)),t){case"estimate":s.handleEstimateRemoval(e);break;case"room":s.handleRoomRemoval(e,o);break;case"product":s.handleProductRemoval(e,o,i)}},onCancel:function(){l("ModalManager","User cancelled deletion of ".concat(t))}})}},{key:"loadEstimateSelectionForm",value:function(){var t=this;return new Promise((function(e,o){t.estimateSelectionForm?(t.showLoading(),s.ajaxRequest({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_estimate_selection_form",nonce:productEstimatorVars.nonce}}).then((function(i){i.html?(t.estimateSelectionForm.innerHTML=i.html,t.loadEstimatesData(),t.bindEstimateSelectionFormEvents(),e(i.html)):o(new Error("Failed to load estimate selection form"))})).catch((function(t){console.error("Error loading estimate selection form:",t),o(t)})).finally((function(){t.hideLoading()}))):o(new Error("Estimate selection form container not found"))}))}},{key:"bindEstimateSelectionFormEvents",value:function(){var t=this;console.log("Binding estimate selection form events");var e=this.estimateSelectionForm.querySelector("form");if(e){console.log("Form found:",e),this._estimateFormSubmitHandler&&e.removeEventListener("submit",this._estimateFormSubmitHandler),this._estimateFormSubmitHandler=function(o){o.preventDefault(),console.log("Estimate selection form submitted"),t.handleEstimateSelection(e)},e.addEventListener("submit",this._estimateFormSubmitHandler);var o=e.querySelector("#create-estimate-btn");o&&(this._createEstimateHandler&&o.removeEventListener("click",this._createEstimateHandler),this._createEstimateHandler=function(e){console.log("Create estimate button clicked"),t.showNewEstimateForm()},o.addEventListener("click",this._createEstimateHandler)),console.log("Form events bound successfully")}else console.error("Cannot bind events - form not found in estimate selection form")}},{key:"loadEstimatesData",value:function(){var t=this;this.showLoading(),this.dataService.getEstimatesData().then((function(e){t.estimateSelectionForm.querySelector("#estimate-dropdown")?(t.populateEstimateDropdown(e),t.hideLoading()):t.loadEstimateSelectionForm().then((function(){return t.populateEstimateDropdown(e)})).catch((function(e){l("ModalManager","Error loading estimate selection form:",e),t.showError("Error loading estimate selection form. Please try again.")})).finally((function(){t.hideLoading()}))})).catch((function(e){l("ModalManager","Error loading estimates data:",e),t.showError("Error loading estimates data. Please try again."),t.hideLoading()}))}},{key:"populateEstimateDropdown",value:function(t){var e=this.estimateSelectionForm?this.estimateSelectionForm.querySelector("#estimate-dropdown"):null;if(e){e.innerHTML="";var o=a.createElement("option",{value:"",textContent:productEstimatorVars.i18n.select_estimate||"-- Select an Estimate --"});e.appendChild(o),Array.isArray(t)&&t.forEach((function(t){if(t){var o=t.rooms?Object.keys(t.rooms).length:0,i=1===o?"1 room":"".concat(o," rooms"),n=a.createElement("option",{value:t.id,textContent:"".concat(t.name||"Unnamed Estimate"," (").concat(i,")")});e.appendChild(n)}})),l("ModalManager","Populated dropdown with ".concat(t?t.length:0," estimates"))}else l("ModalManager","Estimate dropdown not found, cannot populate")}},{key:"showNewEstimateForm",value:function(){var t=this;this.estimatesList&&(this.estimatesList.style.display="none"),this.estimateSelection&&(this.estimateSelection.style.display="none"),a.forceElementVisibility(this.newEstimateForm),this.newEstimateForm.querySelector("form")?(this.hideLoading(),this.bindCancelButton(this.newEstimateForm,"estimate")):this.loadNewEstimateForm().finally((function(){t.hideLoading(),t.bindCancelButton(t.newEstimateForm,"estimate")}))}},{key:"bindCancelButton",value:function(t,e){var o=this;if(t){var i=t.querySelector(".cancel-btn");i?(i.removeEventListener("click",this._cancelFormHandler),this._cancelFormHandler=function(){console.log("Cancel button clicked for ".concat(e," form")),o.cancelForm(e)},i.addEventListener("click",this._cancelFormHandler),console.log("Cancel button bound for ".concat(e," form"))):console.warn("No cancel button found in ".concat(e," form"))}}},{key:"loadNewEstimateForm",value:function(){var t=this;return new Promise((function(e,o){t.showLoading(),s.ajaxRequest({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_new_estimate_form",nonce:productEstimatorVars.nonce}}).then((function(i){if(i.html){t.newEstimateForm.innerHTML=i.html,window.productEstimator&&window.productEstimator.core&&window.productEstimator.core.customerDetailsManager&&setTimeout((function(){window.productEstimator.core.customerDetailsManager.init()}),100);var n=t.newEstimateForm.querySelector("form");if(n){n.addEventListener("submit",(function(e){e.preventDefault(),t.handleNewEstimateSubmission(n)}));var s=n.querySelector(".cancel-btn");s&&s.addEventListener("click",(function(){t.cancelForm("estimate")}))}document.dispatchEvent(new CustomEvent("product_estimator_modal_loaded")),e(i.html)}else o(new Error("Failed to load new estimate form"))})).catch((function(t){console.error("Error loading new estimate form:",t),o(t)})).finally((function(){t.hideLoading()}))}))}},{key:"showNewRoomForm",value:function(t){if(console.log("Showing new room form for estimate:",t),this.newRoomForm){this.newRoomForm.dataset.estimateId=t;var e=this.newRoomForm.querySelector("form");e&&(e.dataset.estimateId=t)}if(this.estimatesList&&(this.estimatesList.style.display="none"),this.estimateSelection&&(this.estimateSelection.style.display="none"),this.roomSelectionForm&&(this.roomSelectionForm.style.display="none"),a.forceElementVisibility(this.newRoomForm),this.newRoomForm.querySelector("form")){var o=this.newRoomForm.querySelector("form");o&&(o.dataset.estimateId=t)}else this.loadNewRoomForm(t)}},{key:"loadNewRoomForm",value:function(t){var e=this;return new Promise((function(o,i){e.showLoading(),s.ajaxRequest({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_new_room_form",nonce:productEstimatorVars.nonce}}).then((function(n){if(n.html){e.newRoomForm.innerHTML=n.html;var s=e.newRoomForm.querySelector("form");if(s){s.dataset.estimateId=t,e._newRoomFormSubmitHandler&&s.removeEventListener("submit",e._newRoomFormSubmitHandler),e._newRoomFormSubmitHandler=function(t){t.preventDefault(),console.log("New room form submitted"),e.handleNewRoomSubmission(s)},s.addEventListener("submit",e._newRoomFormSubmitHandler);var a=s.querySelector(".cancel-btn");a&&a.addEventListener("click",(function(){e.cancelForm("room")}))}o(n.html)}else i(new Error("Failed to load new room form"))})).catch((function(t){console.error("Error loading new room form:",t),i(t)})).finally((function(){e.hideLoading()}))}))}},{key:"bindEstimateListEventHandlers",value:function(){var t=this;this.estimatesList?(this._addRoomButtonHandler&&this.estimatesList.removeEventListener("click",this._addRoomButtonHandler),this._addRoomButtonHandler=function(e){var o=e.target.closest(".add-room");if(o){e.preventDefault(),e.stopPropagation();var i=o.dataset.estimate;console.log("Add room button clicked for estimate:",i),i?t.showNewRoomForm(i):console.error("No estimate ID found for add room button")}},this.estimatesList.addEventListener("click",this._addRoomButtonHandler),console.log("Add room button event handler bound")):console.error("Cannot bind events - estimates list container not found")}},{key:"bindRoomSelectionFormEvents",value:function(){var t=this;console.log("Binding room selection form events");var e=this.roomSelectionForm.querySelector("form");if(e){console.log("Room selection form found:",e),this._roomFormSubmitHandler&&e.removeEventListener("submit",this._roomFormSubmitHandler),this._roomFormSubmitHandler=function(o){o.preventDefault(),console.log("Room selection form submitted"),t.handleRoomSelection(e)},e.addEventListener("submit",this._roomFormSubmitHandler);var o=e.querySelector(".back-btn");o&&(this._backButtonHandler&&o.removeEventListener("click",this._backButtonHandler),this._backButtonHandler=function(){console.log("Back button clicked"),a.forceElementVisibility(t.estimateSelectionForm),a.forceElementVisibility(t.estimateSelection),t.roomSelectionForm.style.display="none"},o.addEventListener("click",this._backButtonHandler));var i=e.querySelector("#add-new-room-from-selection");i?(this._addNewRoomHandler&&i.removeEventListener("click",this._addNewRoomHandler),this._addNewRoomHandler=function(){console.log("Add new room button clicked in form");var e=t.roomSelectionForm.dataset.estimateId;console.log("Estimate ID for new room:",e),e?t.showNewRoomForm(e):console.error("No estimate ID found for new room")},i.addEventListener("click",this._addNewRoomHandler),console.log("Add new room button handler bound")):console.warn("Add new room button not found in room selection form"),console.log("Room selection form events bound successfully")}else console.error("Cannot bind events - form not found in room selection form")}},{key:"showMessage",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=this.contentContainer||document.querySelector(".product-estimator-modal-form-container");if(o){document.querySelectorAll(".modal-message").forEach((function(t){return a.removeElement(t)}));var i=a.createElement("div",{className:"modal-message ".concat("error"===e?"modal-error-message":"modal-success-message"),textContent:t});try{o.prepend(i)}catch(t){console.error("Error adding message to container:",t)}setTimeout((function(){i.parentNode&&a.removeElement(i)}),5e3)}else console.error("Form container not found for message display:",t)}},{key:"showError",value:function(t){this.showMessage(t,"error")}},{key:"on",value:function(t,e){return this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(e),this}},{key:"emit",value:function(t,e){return this.eventHandlers[t]&&this.eventHandlers[t].forEach((function(t){return t(e)})),this}}])}();const _=S,k=function(){return(0,n.A)((function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,i.A)(this,t),this.config=Object.assign({debug:!0,selectors:{variationsForm:".variations_form",estimatorButton:".single_add_to_estimator_button, .button.alt.open-estimator-modal, .product-estimator-button, [data-product-id]",variationIdInput:'input[name="variation_id"]'}},e),this.variationsForm=document.querySelector(this.config.selectors.variationsForm),this.estimatorButton=document.querySelector(this.config.selectors.estimatorButton),this.variationIdInput=this.variationsForm?this.variationsForm.querySelector(this.config.selectors.variationIdInput):null,this.variationsData=window.product_estimator_variations||{},this.currentVariationId=null,this.initialized=!1,this.eventHandlers={},this.variationsForm?this.init():this.log("No variations form found, VariationHandler not initialized")}),[{key:"init",value:function(){if(this.initialized)return this.log("VariationHandler already initialized"),this;if(this.log("Initializing VariationHandler with variations data:",this.variationsData),this.log("Estimator button found:",!!this.estimatorButton),this.estimatorButton){this.log("Initial button data-product-id:",this.estimatorButton.dataset.productId);var t=this.estimatorButton.dataset.productId;t&&this.isParentEstimatorEnabled(t)&&(this.log("Parent product has estimator enabled, ensuring button is visible"),this.estimatorButton.style.display="",this.estimatorButton.classList.remove("hidden"))}return this.bindEvents(),this.checkCurrentVariation(),this.initialized=!0,this.log("VariationHandler initialized"),this.emit("initialized"),this}},{key:"ensureEstimatorButton",value:function(t){if(this.log("Ensuring estimator button exists for variation: ".concat(t)),document.querySelector(this.config.selectors.estimatorButton))return this.log("Estimator button already exists, updating visibility"),void this.updateEstimatorButton(!0,t);if(this.isEstimatorEnabled(t)){this.log("Creating estimator button dynamically");var e=document.querySelector(".single_add_to_cart_button");if(e){var o=a.createElement("button",{type:"button",className:"single_add_to_estimator_button button alt open-estimator-modal",dataset:{productId:t},textContent:"Add to Estimate"});a.insertAfter(o,e),this.log("Estimator button created and inserted")}else this.log("Cannot find add to cart button to insert after")}else this.log("Estimator not enabled for this variation, not creating button")}},{key:"isParentEstimatorEnabled",value:function(t){if(document.querySelector(".single_add_to_estimator_button"))return!0;var e=document.querySelector('input[name="_enable_estimator"], [data-enable-estimator]');return!!e&&("yes"===e.value||"yes"===e.dataset.enableEstimator)}},{key:"bindEvents",value:function(){var t=this;this.variationsForm&&(this.log("Binding variation events"),this.variationsForm.addEventListener("found_variation",this.handleFoundVariation.bind(this)),this.variationsForm.addEventListener("reset_data",this.handleResetVariation.bind(this)),this.variationsForm.addEventListener("check_variations",this.handleCheckVariations.bind(this)),document.addEventListener("woocommerce_variation_has_changed",this.checkCurrentVariation.bind(this)),this.variationIdInput&&this.variationIdInput.addEventListener("change",(function(){var e=t.variationIdInput.value;if(e){t.log("Variation ID input changed to: ".concat(e)),t.currentVariationId=e;var o=t.isEstimatorEnabled(e);t.updateEstimatorButton(o,e)}})),"undefined"!=typeof jQuery&&jQuery(this.variationsForm).on("change",'input[name="variation_id"]',(function(e){var o=e.target.value;if(o){t.log("jQuery variation ID change detected: ".concat(o)),t.currentVariationId=o;var i=t.isEstimatorEnabled(o);t.updateEstimatorButton(i,o)}})),this.log("Variation events bound"))}},{key:"handleFoundVariation",value:function(t){var e=void 0!==t.detail?t.detail:t.target.variation;if(e&&e.variation_id){var o=e.variation_id;this.currentVariationId=o,this.log("Found variation: ".concat(o));var i=this.isEstimatorEnabled(o);this.log("Variation ".concat(o," has estimator enabled: ").concat(i)),this.ensureEstimatorButton(o),this.updateEstimatorButton(i,o),this.emit("variation:changed",{variationId:o,enableEstimator:i,variation:e})}else this.log("Found variation event received but no valid variation data")}},{key:"handleResetVariation",value:function(){this.log("Reset variation"),this.currentVariationId=null,this.updateEstimatorButton(!1),this.emit("variation:reset")}},{key:"handleCheckVariations",value:function(){this.log("Check variations"),this.checkCurrentVariation()}},{key:"checkCurrentVariation",value:function(){var t=this;if(this.variationsForm){var e=document.querySelectorAll(this.config.selectors.estimatorButton);this.log("Found ".concat(e.length," estimator buttons during checkCurrentVariation")),e.length>1&&(this.log("WARNING: Found multiple estimator buttons - this may cause issues. Check for duplicates."),e.forEach((function(e,o){t.log("Button ".concat(o+1," HTML: ").concat(e.outerHTML))})));var o=this.getCurrentVariation();if(o){this.log("Current variation detected: ".concat(o.variation_id)),this.currentVariationId=o.variation_id;var i=this.isEstimatorEnabled(o.variation_id);this.updateEstimatorButton(i,o.variation_id)}else this.log("No current variation detected"),this.currentVariationId=null,this.updateEstimatorButton(this.isParentProductEstimatorEnabled())}}},{key:"isParentProductEstimatorEnabled",value:function(){return void 0===window.product_estimator_variations||!window.product_estimator_variations._parent_enabled||"yes"===window.product_estimator_variations._parent_enabled}},{key:"getCurrentVariation",value:function(){if(!this.variationsForm)return null;if(this.variationsForm.currentVariation)return this.variationsForm.currentVariation;var t=this.variationsForm.querySelector('input[name="variation_id"]');if(t&&t.value)return{variation_id:t.value};var e=this.variationsForm.dataset.productVariations;if(e)return{variation_id:e};if("undefined"!=typeof jQuery){var o=jQuery(this.variationsForm),i=(o.data("product_variations"),o.find('input[name="variation_id"]').val());if(i)return{variation_id:i}}return null}},{key:"isEstimatorEnabled",value:function(t){if(!t)return!1;if(this.log("Checking if estimator is enabled for variation: ".concat(t)),this.log("Available variations data:",this.variationsData),this.variationsData[t]){var e="yes"===this.variationsData[t].enable_estimator;return this.log("Found variation data, estimator enabled: ".concat(e)),e}var o=document.querySelector(".single_add_to_estimator_button[data-product-id]:not([data-variation-id])");if(o){var i=!o.classList.contains("hidden")&&"none"!==getComputedStyle(o).display;return this.log("Using parent product as fallback, estimator enabled: ".concat(i)),i}return this.log("No variation or parent data found, estimator disabled by default"),!1}},{key:"updateEstimatorButton",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=document.querySelector(".single_add_to_estimator_button");o?(this.log("Updating button visibility: ".concat(t?"show":"hide",", variation ID: ").concat(e)),t?(a.toggleVisibility(o,!0),e&&(this.log("Setting button data-product-id to variation ID: ".concat(e)),o.dataset.productId=e)):(a.toggleVisibility(o,!1),this.log("Hiding estimator button"))):this.log("Estimator button not found")}},{key:"on",value:function(t,e){return this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(e),this}},{key:"emit",value:function(t,e){return this.eventHandlers[t]&&this.eventHandlers[t].forEach((function(t){return t(e)})),this}},{key:"log",value:function(){if(this.config.debug){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];l.apply(void 0,["VariationHandler"].concat(e))}}}])}();var L=function(){return(0,n.A)((function t(){var e,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;(0,i.A)(this,t),this.config=Object.assign({debug:!1,selectors:{editButton:"#edit-customer-details-btn",deleteButton:"#delete-customer-details-btn",saveButton:"#save-customer-details-btn",cancelButton:"#cancel-edit-customer-details-btn",detailsContainer:".saved-customer-details",detailsHeader:".customer-details-header",editForm:".customer-details-edit-form",formContainer:".product-estimator-modal-form-container"},i18n:(null===(e=window.productEstimatorVars)||void 0===e?void 0:e.i18n)||{}},o),this.dataService=n,this.initialized=!1,this.eventHandlers={},!1!==o.autoInit&&this.init()}),[{key:"init",value:function(){return this.initialized?(this.log("CustomerDetailsManager already initialized"),this):(this.bindEvents(),document.addEventListener("customer_details_updated",this.onCustomerDetailsUpdated.bind(this)),this.initialized=!0,this.log("CustomerDetailsManager initialized"),this)}},{key:"onCustomerDetailsUpdated",value:function(t){t.detail&&t.detail.details&&(this.log("Received customer_details_updated event",t.detail),this.updateDisplayedDetails(t.detail.details),this.checkAndUpdateEmailField(t.detail.details))}},{key:"checkAndUpdateEmailField",value:function(t){var e=t&&t.email&&""!==t.email.trim();this.log("Checking for email field updates: hasEmail=".concat(e));var o=document.querySelector(this.config.selectors.editForm);if(o&&e){var i=o.querySelector("#edit-customer-email");if(!i&&e){this.log("Adding email field to edit form");var n=a.createElement("div",{className:"form-group"}),s=a.createElement("label",{for:"edit-customer-email",textContent:"Email Address"});i=a.createElement("input",{type:"email",id:"edit-customer-email",name:"edit_customer_email",value:t.email}),n.appendChild(s),n.appendChild(i);var r=o.querySelector("#edit-customer-name");if(r){var l=r.closest(".form-group");l?a.insertAfter(n,l):o.querySelector("h4").after(n)}}else i&&e&&(i.value=t.email)}var c=document.querySelector("#new-estimate-form");c&&c.setAttribute("data-has-email",e?"true":"false")}},{key:"bindEvents",value:function(){var t=document.querySelector(this.config.selectors.editButton),e=document.querySelector(this.config.selectors.deleteButton),o=document.querySelector(this.config.selectors.saveButton),i=document.querySelector(this.config.selectors.cancelButton);t?(this.bindButtonWithHandler(t,"click",this.handleEditClick.bind(this)),e&&this.bindButtonWithHandler(e,"click",this.handleDeleteClick.bind(this)),o&&this.bindButtonWithHandler(o,"click",this.handleSaveClick.bind(this)),i&&this.bindButtonWithHandler(i,"click",this.handleCancelClick.bind(this)),this.log("Customer details events bound")):this.log("Edit button not found, skipping event binding")}},{key:"bindButtonWithHandler",value:function(t,e,o){if(t){var i="_".concat(e,"Handler");t[i]&&t.removeEventListener(e,t[i]),t[i]=o,t.addEventListener(e,o)}}},{key:"handleEditClick",value:function(t){t.preventDefault(),t.stopPropagation();var e=document.querySelector(this.config.selectors.detailsContainer),o=document.querySelector(this.config.selectors.detailsHeader),i=document.querySelector(this.config.selectors.editForm);e&&(e.style.display="none"),o&&(o.style.display="none"),i&&(i.style.display="block"),this.log("Edit form displayed")}},{key:"handleCancelClick",value:function(t){t.preventDefault(),t.stopPropagation();var e=document.querySelector(this.config.selectors.detailsContainer),o=document.querySelector(this.config.selectors.detailsHeader),i=document.querySelector(this.config.selectors.editForm);i&&(i.style.display="none"),e&&(e.style.display="block"),o&&(o.style.display="flex"),this.log("Edit form hidden")}},{key:"handleSaveClick",value:function(t){var e,o,i=this;t.preventDefault(),t.stopPropagation();var n=t.target,a=n.textContent;n.textContent=this.config.i18n.saving||"Saving...",n.disabled=!0;var r={name:(null===(e=document.getElementById("edit-customer-name"))||void 0===e?void 0:e.value)||"",postcode:(null===(o=document.getElementById("edit-customer-postcode"))||void 0===o?void 0:o.value)||""},l=document.getElementById("edit-customer-email");l&&(r.email=l.value||"");var c=document.getElementById("edit-customer-phone");c&&(r.phone=c.value||""),this.dataService&&"function"==typeof this.dataService.request?this.dataService.request("update_customer_details",{details:JSON.stringify(r)}).then((function(t){i.handleSaveSuccess(t,r),n.textContent=a,n.disabled=!1})).catch((function(t){i.handleSaveError(t),n.textContent=a,n.disabled=!1})):s.wpAjax("update_customer_details",{details:JSON.stringify(r)}).then((function(t){i.handleSaveSuccess(t,r)})).catch((function(t){i.handleSaveError(t)})).finally((function(){n.textContent=a,n.disabled=!1}))}},{key:"handleSaveSuccess",value:function(t,e){this.updateDisplayedDetails(t.details||e),this.checkAndUpdateEmailField(t.details||e),this.showMessage("success",t.message||"Details updated successfully!");var o=document.querySelector(this.config.selectors.detailsContainer),i=document.querySelector(this.config.selectors.detailsHeader),n=document.querySelector(this.config.selectors.editForm);n&&(n.style.display="none"),o&&(o.style.display="block"),i&&(i.style.display="flex");var s=new CustomEvent("customer_details_updated",{bubbles:!0,detail:{details:t.details||e}});document.dispatchEvent(s),this.log("Customer details updated successfully",t)}},{key:"handleSaveError",value:function(t){this.showMessage("error",t.message||"Error updating details. Please try again."),this.log("Error saving customer details:",t)}},{key:"handleDeleteClick",value:function(t){var e=this;t.preventDefault(),t.stopPropagation(),window.productEstimator&&window.productEstimator.dialog?window.productEstimator.dialog.show({title:this.config.i18n.delete_customer_details||"Delete Customer Details",message:this.config.i18n.confirm_delete_details||"Are you sure you want to delete your saved details?",confirmText:this.config.i18n.delete||"Delete",cancelText:this.config.i18n.cancel||"Cancel",onConfirm:function(){e.deleteCustomerDetails()}}):confirm(this.config.i18n.confirm_delete_details||"Are you sure you want to delete your saved details?")&&this.deleteCustomerDetails()}},{key:"deleteCustomerDetails",value:function(){var t=this,e=document.querySelector(".customer-details-confirmation");e&&e.classList.add("loading"),this.dataService&&"function"==typeof this.dataService.request?this.dataService.request("delete_customer_details").then((function(o){t.handleDeleteSuccess(o,e)})).catch((function(o){t.handleDeleteError(o,e)})):s.wpAjax("delete_customer_details").then((function(o){t.handleDeleteSuccess(o,e)})).catch((function(o){t.handleDeleteError(o,e)}))}},{key:"handleDeleteSuccess",value:function(t,e){if(e&&t.html){var o=a.createElementFromHTML(t.html);e.parentNode.replaceChild(o,e)}this.showMessage("success",t.message||"Details deleted successfully!");var i=document.querySelector("#new-estimate-form");i&&i.setAttribute("data-has-email","false");var n=new CustomEvent("customer_details_deleted",{bubbles:!0});document.dispatchEvent(n),this.log("Customer details deleted")}},{key:"handleDeleteError",value:function(t,e){this.showMessage("error",t.message||"Error deleting details!"),this.log("Error deleting details:",t),e&&e.classList.remove("loading")}},{key:"updateDisplayedDetails",value:function(t){var e=document.querySelector(this.config.selectors.detailsContainer);if(e){var o="<p><strong>".concat(t.name,"</strong><br>");t.email&&(o+="".concat(t.email,"<br>")),t.phone&&(o+="".concat(t.phone,"<br>")),o+="".concat(t.postcode,"</p>"),e.innerHTML=o}}},{key:"showMessage",value:function(t,e){document.querySelectorAll(".modal-message").forEach((function(t){t.parentNode&&t.parentNode.removeChild(t)}));var o=a.createElement("div",{className:"modal-message ".concat("error"===t?"modal-error-message":"modal-success-message"),textContent:e}),i=document.querySelector(this.config.selectors.formContainer);i&&(i.prepend(o),setTimeout((function(){o.parentNode&&o.parentNode.removeChild(o)}),5e3))}},{key:"log",value:function(){if(this.config.debug){for(var t,e=arguments.length,o=new Array(e),i=0;i<e;i++)o[i]=arguments[i];(t=console).log.apply(t,["[CustomerDetailsManager]"].concat(o))}}}])}();const C=L,P=new(function(){return(0,n.A)((function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,i.A)(this,t),this.config=Object.assign({debug:!1,selectors:{estimatorButtons:".product-estimator-button, .single_add_to_estimator_button, .open-estimator-modal",estimatorMenuButtons:".product-estimator-menu-item a, a.product-estimator-menu-item",modalContainer:"#product-estimator-modal"},autoInit:!0},e),this.dataService=null,this.modalManager=null,this.variationHandler=null,this.customerDetailsManager=null,this.initialized=!1,this.eventHandlers={},this.config.autoInit&&this.init()}),[{key:"init",value:function(){var t=this;if(this.initialized)return this.log("EstimatorCore already initialized - aborting"),this;if(window._productEstimatorInitialized&&window.productEstimator&&window.productEstimator.core)return this.log("EstimatorCore detected as already initialized globally - aborting"),this.initialized=!0,this;this.log("Initializing EstimatorCore");try{if("undefined"==typeof jQuery)return console.error("jQuery is not loaded, cannot initialize EstimatorCore"),this;this.dataService||(this.dataService=new u({debug:this.config.debug})),console.log("%c=== PRODUCT ESTIMATOR INITIALIZATION START ===","background: #f0f0f0; color: #333; padding: 3px; border-radius: 3px;");var e=function(){t.modalManager?t.log("Components already initialized - skipping"):(t.modalManager=new _({debug:t.config.debug,selectors:t.config.selectors},t.dataService),t.customerDetailsManager=new C({debug:t.config.debug},t.dataService),t.isWooCommerceProductPage()&&(t.log("WooCommerce product page detected, initializing VariationHandler"),t.variationHandler=new k({debug:t.config.debug})),t.bindGlobalEvents(),t.initialized=!0,t.log("EstimatorCore initialized successfully"),t.emit("core:initialized"),console.log("%c=== PRODUCT ESTIMATOR INITIALIZATION COMPLETE ===","background: #f0f0f0; color: #333; padding: 3px; border-radius: 3px;"))};"complete"===document.readyState?e():window.addEventListener("load",e,{once:!0})}catch(t){console.error("EstimatorCore initialization error:",t)}return this}},{key:"bindGlobalEvents",value:function(){var t=this;try{this._clickHandler&&document.removeEventListener("click",this._clickHandler),this._clickHandler=function(e){var o=e.target.closest(t.config.selectors.estimatorMenuButtons);if(o)return e.preventDefault(),e.stopPropagation(),t.log("Menu button clicked - opening modal in list view"),void(t.modalManager&&t.modalManager.openModal(null,!0));var i=e.target.closest(t.config.selectors.estimatorButtons);if(i&&!o){e.preventDefault(),e.stopPropagation();var n=i.dataset.productId||null;console.log("PRODUCT BUTTON CLICKED:",{productId:n,buttonElement:i,dataAttribute:i.dataset}),t.modalManager&&(console.log("OPENING MODAL WITH:",{productId:n,forceListView:!1}),t.modalManager.openModal(n,!1))}},document.addEventListener("click",this._clickHandler),this.emit("core:eventsbound"),this.log("Global events bound")}catch(t){console.error("Error binding global events:",t)}}},{key:"closeModal",value:function(){this.modalManager&&this.modalManager.closeModal()}},{key:"isWooCommerceProductPage",value:function(){return document.body.classList.contains("single-product")||document.body.classList.contains("product-template-default")||!!document.querySelector(".product.type-product")}},{key:"on",value:function(t,e){return this.eventHandlers[t]||(this.eventHandlers[t]=[]),this.eventHandlers[t].push(e),this}},{key:"emit",value:function(t,e){return this.eventHandlers[t]&&this.eventHandlers[t].forEach((function(t){return t(e)})),this}},{key:"log",value:function(){if(this.config.debug){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];l.apply(void 0,["EstimatorCore"].concat(e))}}}])}())({debug:!0});var I,q,F,D,x,B,A=new(function(){return(0,n.A)((function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,i.A)(this,t),this.config=Object.assign({debug:!1,selectors:{productToggleButton:".product-details-toggle",notesToggleButton:".product-notes-toggle",includesToggleButton:".product-includes-toggle",productItem:".product-item",similarProductsContainer:".similar-products-container",productIncludes:".product-includes",similarProducts:".product-similar-products",productNotes:".product-notes",notesContainer:".notes-container",includesContainer:".includes-container",suggestionsContainer:".suggestions-container"},i18n:{showProducts:"Similar Products",hideProducts:"Similar Products",showNotes:"Product Notes",hideNotes:"Product Notes",showIncludes:"Product Includes",hideIncludes:"Product Includes",showSuggestions:"Suggested Products",hideSuggestions:"Suggested Products",loading:"Loading..."}},e),this.initialized=!1,this.init()}),[{key:"init",value:function(){var t=this;this.initialized?this.log("Already initialized, skipping"):("loading"===document.readyState?document.addEventListener("DOMContentLoaded",(function(){return t.setup()})):this.setup(),document.addEventListener("product_estimator_modal_loaded",(function(){t.log("Modal content loaded, initializing toggles"),t.setup()})),this.setupMutationObserver(),this.initialized=!0,this.log("ProductDetailsToggle initialized"))}},{key:"prepareSuggestionsToggle",value:function(){var t=this,e=document.querySelectorAll(this.config.selectors.accordionContent);this.log("Found ".concat(e.length," accordion content elements to process for suggestions toggle")),e.forEach((function(e){if(!e.classList.contains("suggestions-toggle-processed")){var o=e.querySelector(t.config.selectors.productSuggestions);if(o){t.log("Found suggestions section, processing",o),e.classList.add("has-suggestions");var i=e.querySelector(t.config.selectors.suggestionsContainer);if(!i){if(t.log("Creating new suggestions container"),i=a.createElement("div",{className:"suggestions-container visible"}),o.parentNode!==i){var n=o.cloneNode(!0);i.appendChild(n),o.parentNode.removeChild(o)}e.appendChild(i)}var s=e.querySelector(t.config.selectors.suggestionsToggleButton);s||(t.log("Adding suggestions toggle button to accordion content"),s=a.createElement("button",{className:"product-suggestions-toggle expanded",dataset:{toggleType:"suggestions"},innerHTML:"\n            ".concat(t.config.i18n.hideSuggestions,'\n            <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n          ')}),e.insertBefore(s,i)),i.style.display="block",i.classList.add("visible"),e.classList.add("suggestions-toggle-processed"),t.log("Accordion content processed for suggestions toggle")}else t.log("No suggestions section found for accordion content, skipping",e)}}))}},{key:"setupMutationObserver",value:function(){var t=this;new MutationObserver((function(e){var o=!1;e.forEach((function(e){e.addedNodes.length&&Array.from(e.addedNodes).forEach((function(e){e.nodeType===Node.ELEMENT_NODE&&(e.matches(t.config.selectors.productItem)||e.matches(t.config.selectors.productToggleButton)||e.matches(t.config.selectors.notesToggleButton)||e.querySelector(t.config.selectors.productItem)||e.querySelector(t.config.selectors.productToggleButton)||e.querySelector(t.config.selectors.notesToggleButton))&&(o=!0)}))})),o&&(t.log("New toggle-related content detected, re-initializing"),setTimeout((function(){return t.setup()}),100))})).observe(document.body,{childList:!0,subtree:!0}),this.log("Mutation observer set up")}},{key:"setup",value:function(){this.log("Setting up product details toggles"),this.prepareProductsToggle(),this.prepareNotesToggle(),this.prepareIncludesToggle(),this.prepareSuggestionsToggle(),this.bindEvents(),this.initializeAllCarousels()}},{key:"prepareProductsToggle",value:function(){var t=this,e=document.querySelectorAll(this.config.selectors.productItem);this.log("Found ".concat(e.length," product items to process for similar products toggle")),e.forEach((function(e){if(!e.classList.contains("products-toggle-processed")){var o=e.querySelector(t.config.selectors.similarProducts);if(o){t.log("Found similar products section, processing",o),e.classList.add("has-similar-products");var i=e.querySelector(t.config.selectors.similarProductsContainer);if(!i){if(t.log("Creating new similar products container"),i=a.createElement("div",{className:"similar-products-container visible"}),o.parentNode!==i){var n=o.cloneNode(!0);i.appendChild(n),o.parentNode.removeChild(o)}e.appendChild(i)}var s=e.querySelector(t.config.selectors.productToggleButton);if(s){s.classList.add("expanded");var r=s.querySelector(".toggle-icon");r&&(r.classList.remove("dashicons-arrow-down-alt2"),r.classList.add("dashicons-arrow-up-alt2"))}else t.log("Adding similar products toggle button to product item"),s=a.createElement("button",{className:"product-details-toggle expanded",dataset:{toggleType:"similar-products"},innerHTML:"\n            ".concat(t.config.i18n.hideProducts,'\n            <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n          ')}),e.insertBefore(s,i);i.style.display="block",i.classList.add("visible"),e.classList.add("products-toggle-processed"),t.log("Product item processed for similar products toggle")}else t.log("No similar products section found for product item, skipping",e)}}))}},{key:"prepareNotesToggle",value:function(){var t=this,e=document.querySelectorAll(this.config.selectors.productItem);this.log("Found ".concat(e.length," product items to process for notes toggle")),e.forEach((function(e){if(!e.classList.contains("notes-toggle-processed")){var o=e.querySelector(t.config.selectors.productNotes);if(o){t.log("Found notes section, processing",o),e.classList.add("has-notes");var i=e.querySelector(t.config.selectors.notesContainer);if(!i){if(t.log("Creating new notes container"),i=a.createElement("div",{className:"notes-container visible"}),o.parentNode!==i){var n=o.cloneNode(!0);i.appendChild(n),o.parentNode.removeChild(o)}e.appendChild(i)}var s=e.querySelector(t.config.selectors.notesToggleButton);if(s){s.classList.add("expanded");var r=s.querySelector(".toggle-icon");r&&(r.classList.remove("dashicons-arrow-down-alt2"),r.classList.add("dashicons-arrow-up-alt2"))}else t.log("Adding notes toggle button to product item"),s=a.createElement("button",{className:"product-notes-toggle expanded",dataset:{toggleType:"notes"},innerHTML:"\n            ".concat(t.config.i18n.hideNotes,'\n            <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n          ')}),e.insertBefore(s,i);i.style.display="block",i.classList.add("visible"),e.classList.add("notes-toggle-processed"),t.log("Product item processed for notes toggle")}else t.log("No notes section found for product item, skipping",e)}}))}},{key:"bindEvents",value:function(){var t=this,e=document.querySelectorAll(this.config.selectors.productToggleButton);this.log("Found ".concat(e.length," similar products toggle buttons to bind")),e.forEach((function(e){e._toggleBound||(e._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),t.toggleSimilarProducts(e)},e.addEventListener("click",e._toggleHandler),e._toggleBound=!0)}));var o=document.querySelectorAll(this.config.selectors.notesToggleButton);this.log("Found ".concat(o.length," notes toggle buttons to bind")),o.forEach((function(e){e._toggleBound||(e._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),t.toggleNotes(e)},e.addEventListener("click",e._toggleHandler),e._toggleBound=!0)}));var i=document.querySelectorAll(this.config.selectors.includesToggleButton);this.log("Found ".concat(i.length," includes toggle buttons to bind")),i.forEach((function(e){e._toggleBound||(e._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),t.toggleIncludes(e)},e.addEventListener("click",e._toggleHandler),e._toggleBound=!0)}));var n=document.querySelectorAll(this.config.selectors.suggestionsToggleButton);this.log("Found ".concat(n.length," suggestions toggle buttons to bind")),n.forEach((function(e){e._toggleBound||(e._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),t.toggleSuggestions(e)},e.addEventListener("click",e._toggleHandler),e._toggleBound=!0)})),this.log("All toggle events bound")}},{key:"toggleSuggestions",value:function(t){var e=t.closest(this.config.selectors.accordionContent);if(e){var o=e.querySelector(this.config.selectors.suggestionsContainer);if(o){var i=t.classList.contains("expanded");if(this.log("Suggestions toggle clicked, current expanded state: ".concat(i)),i){o.classList.remove("visible"),o.style.display="none",t.classList.remove("expanded");var n=t.querySelector(".toggle-icon");n&&(n.classList.remove("dashicons-arrow-up-alt2"),n.classList.add("dashicons-arrow-down-alt2")),t.innerHTML=t.innerHTML.replace(this.config.i18n.hideSuggestions,this.config.i18n.showSuggestions),this.log("Suggestions hidden")}else{o.classList.add("visible"),o.style.display="block",t.classList.add("expanded");var s=t.querySelector(".toggle-icon");s&&(s.classList.remove("dashicons-arrow-down-alt2"),s.classList.add("dashicons-arrow-up-alt2")),t.innerHTML=t.innerHTML.replace(this.config.i18n.showSuggestions,this.config.i18n.hideSuggestions),this.initializeCarousels(o),this.log("Suggestions shown")}}else this.log("Suggestions container not found")}else this.log("Accordion content not found for toggle button")}},{key:"toggleSimilarProducts",value:function(t){var e=a.closest(t,this.config.selectors.productItem);if(e){var o=e.querySelector(this.config.selectors.similarProductsContainer);if(o){var i=t.classList.contains("expanded");this.log("Similar products toggle clicked, current expanded state: ".concat(i));var n=t.querySelector(".toggle-icon");i?(o.classList.remove("visible"),o.style.display="none",t.classList.remove("expanded"),n&&(n.classList.remove("dashicons-arrow-up-alt2"),n.classList.add("dashicons-arrow-down-alt2")),this.log("Similar products hidden")):(o.classList.add("visible"),o.style.display="block",t.classList.add("expanded"),n&&(n.classList.remove("dashicons-arrow-down-alt2"),n.classList.add("dashicons-arrow-up-alt2")),this.log("Similar products shown"),this.initializeCarousels(o))}else this.log("Similar products container not found")}else this.log("Product item not found for toggle button")}},{key:"toggleNotes",value:function(t){var e=a.closest(t,this.config.selectors.productItem);if(e){var o=e.querySelector(this.config.selectors.notesContainer);if(o){var i=t.classList.contains("expanded");this.log("Notes toggle clicked, current expanded state: ".concat(i));var n=t.querySelector(".toggle-icon");i?(o.classList.remove("visible"),o.style.display="none",t.classList.remove("expanded"),n&&(n.classList.remove("dashicons-arrow-up-alt2"),n.classList.add("dashicons-arrow-down-alt2")),this.log("Notes hidden")):(o.classList.add("visible"),o.style.display="block",t.classList.add("expanded"),n&&(n.classList.remove("dashicons-arrow-down-alt2"),n.classList.add("dashicons-arrow-up-alt2")),this.log("Notes shown"))}else this.log("Notes container not found")}else this.log("Product item not found for notes toggle button")}},{key:"initializeCarousels",value:function(t){"function"==typeof window.initSuggestionsCarousels?(this.log("Initializing carousels in similar products container"),window.initSuggestionsCarousels()):"function"==typeof initSuggestionsCarousels?(this.log("Using local initSuggestionsCarousels function"),initSuggestionsCarousels()):this.log("Carousel initialization function not found",window.initSuggestionsCarousels)}},{key:"initializeAllCarousels",value:function(){"function"==typeof window.initSuggestionsCarousels?(this.log("Initializing all carousels"),window.initSuggestionsCarousels()):"function"==typeof initSuggestionsCarousels&&initSuggestionsCarousels()}},{key:"prepareIncludesToggle",value:function(){var t=this,e=document.querySelectorAll(this.config.selectors.productItem);this.log("Found ".concat(e.length," product items to process for includes toggle")),e.forEach((function(e){if(!e.classList.contains("includes-toggle-processed")){var o=e.querySelector(t.config.selectors.productIncludes);if(o){t.log("Found includes section, processing",o),e.classList.add("has-includes");var i=e.querySelector(".includes-container");if(!i){if(t.log("Creating new includes container"),i=a.createElement("div",{className:"includes-container visible"}),o.parentNode!==i){var n=o.cloneNode(!0);i.appendChild(n),o.parentNode.removeChild(o)}e.appendChild(i)}var s=e.querySelector(".product-includes-toggle");if(s){s.classList.add("expanded");var r=s.querySelector(".toggle-icon");r&&(r.classList.remove("dashicons-arrow-down-alt2"),r.classList.add("dashicons-arrow-up-alt2"))}else t.log("Adding includes toggle button to product item"),s=a.createElement("button",{className:"product-includes-toggle expanded",dataset:{toggleType:"includes"},innerHTML:"\n            ".concat(t.config.i18n.hideIncludes||"Product Includes",'\n            <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n          ')}),e.insertBefore(s,i);i.style.display="block",i.classList.add("visible"),e.classList.add("includes-toggle-processed"),t.log("Product item processed for includes toggle")}else t.log("No includes section found for product item, skipping",e)}}))}},{key:"toggleIncludes",value:function(t){var e=a.closest(t,this.config.selectors.productItem);if(e){var o=e.querySelector(".includes-container");if(o){var i=t.classList.contains("expanded");this.log("Includes toggle clicked, current expanded state: ".concat(i));var n=t.querySelector(".toggle-icon");i?(o.classList.remove("visible"),o.style.display="none",t.classList.remove("expanded"),n&&(n.classList.remove("dashicons-arrow-up-alt2"),n.classList.add("dashicons-arrow-down-alt2")),this.log("Includes hidden")):(o.classList.add("visible"),o.style.display="block",t.classList.add("expanded"),n&&(n.classList.remove("dashicons-arrow-down-alt2"),n.classList.add("dashicons-arrow-up-alt2")),this.log("Includes shown"))}else this.log("Includes container not found")}else this.log("Product item not found for includes toggle button")}},{key:"log",value:function(){if(this.config.debug){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];l.apply(void 0,["ProductDetailsToggle"].concat(e))}}}])}())({debug:(null===(I=window.productEstimatorVars)||void 0===I?void 0:I.debug)||!1,i18n:{showProducts:(null===(q=window.productEstimatorVars)||void 0===q||null===(q=q.i18n)||void 0===q?void 0:q.showSimilarProducts)||"Similar Products",hideProducts:(null===(F=window.productEstimatorVars)||void 0===F||null===(F=F.i18n)||void 0===F?void 0:F.hideSimilarProducts)||"Similar Products",showNotes:(null===(D=window.productEstimatorVars)||void 0===D||null===(D=D.i18n)||void 0===D?void 0:D.showNotes)||"Product Notes",hideNotes:(null===(x=window.productEstimatorVars)||void 0===x||null===(x=x.i18n)||void 0===x?void 0:x.hideNotes)||"Product Notes",loading:(null===(B=window.productEstimatorVars)||void 0===B||null===(B=B.i18n)||void 0===B?void 0:B.loading)||"Loading..."}});function H(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.push.apply(o,i)}return o}function M(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?H(Object(o),!0).forEach((function(e){(0,h.A)(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):H(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}var R=function(){return(0,n.A)((function t(){var e,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,i.A)(this,t),this.config=Object.assign({debug:!1,selectors:{printButton:".print-estimate",requestContactButton:".request-contact-estimate",requestCopyButton:".request-a-copy",scheduleDesignerButton:".schedule-designer-estimate"},i18n:(null===(e=window.productEstimatorVars)||void 0===e?void 0:e.i18n)||{}},o),this.initialized=!1,this.processing=!1,!1!==o.autoInit&&this.init()}),[{key:"init",value:function(){return this.initialized?(this.log("PrintEstimate already initialized"),this):(this.bindEvents(),this.initialized=!0,this.log("PrintEstimate initialized"),this)}},{key:"bindEvents",value:function(){var t=this;document.addEventListener("click",(function(e){var o=e.target.closest(t.config.selectors.printButton);o&&!t.processing&&(e.preventDefault(),t.handlePrintEstimate(o));var i=e.target.closest(t.config.selectors.requestContactButton);i&&!t.processing&&(e.preventDefault(),t.handleRequestContact(i));var n=e.target.closest(t.config.selectors.requestCopyButton);n&&!t.processing&&(e.preventDefault(),t.handleRequestCopy(n));var s=e.target.closest(t.config.selectors.scheduleDesignerButton);s&&!t.processing&&(e.preventDefault(),t.handleScheduleDesigner(s))})),this.log("Print estimate events bound")}},{key:"handlePrintEstimate",value:function(t){var e=this,o=t.dataset.estimateId;null!=o?(this.log("Print estimate requested for estimate ID: ".concat(o," (type: ").concat((0,m.A)(o),")")),this.processing=!0,this.setButtonLoading(t,!0),this.checkCustomerEmail(o).then((function(i){return i?e.saveAndGeneratePdf(o,t):(e.setButtonLoading(t,!1),e.processing=!1,e.showEmailPrompt(o,t,"print"),Promise.reject(new Error("email_prompt_shown")))})).catch((function(o){"email_prompt_shown"!==o.message&&(e.log("Error in print estimate process:",o),e.setButtonLoading(t,!1),e.processing=!1,e.showError("Error generating PDF. Please try again."))}))):this.showError("No estimate ID provided")}},{key:"checkEstimateStored",value:function(t){var e=this;return new Promise((function(o,i){s.wpAjax("check_estimate_stored",{estimate_id:t}).then((function(i){e.log("Check estimate stored result:",i),o({is_stored:i.is_stored||!1,db_id:i.db_id||null,estimate_id:t})})).catch((function(i){e.log("Error checking if estimate is stored:",i),o({is_stored:!1,db_id:null,estimate_id:t})}))}))}},{key:"openPdfUrl",value:function(t){var e=this;if(t){if(productEstimatorVars.is_admin){var o=window.location.protocol+"//"+window.location.host,i="".concat(o,"/product-estimator/pdf/admin/").concat(t);return this.log("Opening admin PDF URL:",i),void window.open(i,"_blank")}s.wpAjax("get_secure_pdf_url",{estimate_id:t}).then((function(t){if(!t.url)throw new Error(t.message||"Failed to get secure PDF URL");e.log("Opening secure PDF URL:",t.url),window.open(t.url,"_blank")})).catch((function(t){e.log("Error getting secure PDF URL:",t),e.showError("Error generating PDF. Please try again.")}))}else this.log("Cannot open PDF URL: No database ID provided")}},{key:"saveAndGeneratePdf",value:function(t,e){var o=this;return this.storeEstimate(t).then((function(i){return i&&i.estimate_id?(o.openPdfUrl(i.estimate_id),Promise.resolve()):o.generatePdf(t,e)})).finally((function(){o.setButtonLoading(e,!1),o.processing=!1}))}},{key:"handleRequestCopy",value:function(t){var e=this,o=t.dataset.estimateId;null!=o?(this.log("Request copy requested for estimate ID: ".concat(o," (type: ").concat((0,m.A)(o),")")),this.processing=!0,this.setButtonLoading(t,!0),this.checkEstimateStored(o).then((function(i){if(!i.is_stored||!i.db_id)return e.checkCustomerEmail(o).then((function(i){return i?e.storeEstimate(o).then((function(){e.sendEstimateCopy(o,t)})):(e.setButtonLoading(t,!1),e.processing=!1,e.showEmailPrompt(o,t,"copy"),Promise.reject(new Error("email_prompt_shown")))}));e.log("Estimate is stored in DB, sending directly",i),e.sendEstimateCopy(o,t)})).catch((function(o){"email_prompt_shown"!==o.message&&(e.log("Error in request copy process:",o),e.setButtonLoading(t,!1),e.processing=!1,e.showError("Error sending estimate. Please try again."))}))):this.showError("No estimate ID provided")}},{key:"sendEstimateCopy",value:function(t,e){var o=this;s.wpAjax("request_copy_estimate",{estimate_id:t}).then((function(t){o.log("Estimate copy sent successfully",t);var e="";t&&t.email?e=t.email:o._customerDetails&&o._customerDetails.email&&(e=o._customerDetails.email),o.showEmailSentConfirmation(e)})).catch((function(i){if(o.log("AJAX error",i),i.data&&"no_email"===i.data.code)return o.setButtonLoading(e,!1),o.processing=!1,void o.showEmailPrompt(t,e,"copy");o.showError(i.message||"Connection error. Please try again.")})).finally((function(){o.processing=!1,o.setButtonLoading(e,!1)}))}},{key:"checkCustomerEmail",value:function(t){var e=this;return new Promise((function(o,i){var n=String(t);e.log("Checking customer email for estimate: ".concat(n)),s.wpAjax("check_customer_email",{estimate_id:n}).then((function(t){e.log("Customer email check result: ".concat(t.has_email?"Has email":"No email")),t.customer_details&&(e._customerDetails=t.customer_details),o(t.has_email)})).catch((function(t){e.log("AJAX error in checkCustomerEmail:",t),i(t)}))}))}},{key:"showEmailPrompt",value:function(t,e){var o,i,n,s,l,c=this,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"print",u=this._customerDetails||{},m='\n  <div class="email-prompt-overlay"></div>\n  <div class="email-prompt-container">\n    <div class="email-prompt-header">\n      <h3>'.concat((null===(o=productEstimatorVars.i18n)||void 0===o?void 0:o.enter_email)||"Please Enter Your Email",'</h3>\n    </div>\n    <div class="email-prompt-body">\n      <p>').concat((null===(i=productEstimatorVars.i18n)||void 0===i?void 0:i.email_required_message)||"An email address is required to "+("copy"===d?"receive":"print")+" your estimate.",'</p>\n      <div class="form-group">\n        <label for="customer-email-input">').concat((null===(n=productEstimatorVars.i18n)||void 0===n?void 0:n.email_address)||"Email Address",':</label>\n        <input type="email" id="customer-email-input" required\n               value="').concat((null==u?void 0:u.email)||"",'">\n      </div>\n      <div class="email-validation-message"></div>\n    </div>\n    <div class="email-prompt-footer">\n      <button type="button" class="button cancel-email-btn">\n        ').concat((null===(s=productEstimatorVars.i18n)||void 0===s?void 0:s.cancel)||"Cancel",'\n      </button>\n      <button type="button" class="button submit-email-btn">\n        ').concat((null===(l=productEstimatorVars.i18n)||void 0===l?void 0:l.continue)||"Continue","\n      </button>\n    </div>\n  </div>\n"),h=a.createElement("div",{className:"email-prompt-modal",innerHTML:m});document.body.appendChild(h);var g=h.querySelector(".cancel-email-btn"),v=h.querySelector(".submit-email-btn"),p=h.querySelector("#customer-email-input"),f=h.querySelector(".email-validation-message");g.addEventListener("click",(function(){a.removeElement(h,!0)})),v.addEventListener("click",(function(){var o,i,n,s=p.value.trim();s?r.validateEmail(s)?(v.disabled=!0,v.textContent=(null===(o=productEstimatorVars.i18n)||void 0===o?void 0:o.saving)||"Saving...",c.log("Submitting email update:",s,"for estimate:",t),c.updateCustomerEmail(t,s).then((function(o){c.log("Email update successful"),a.removeElement(h,!0),c.notifyEmailUpdated(o),"copy"===d?c.sendEstimateCopy(t,e):(c.setButtonLoading(e,!0),c.processing=!0,c.saveAndGeneratePdf(t,e))})).catch((function(t){var e,o;c.log("Error updating customer email:",t);var i="Error saving email. Please try again.";t.message&&(i+=" ("+t.message+")"),f.textContent=(null===(e=productEstimatorVars.i18n)||void 0===e?void 0:e.email_save_error)||i,f.style.color="red",v.disabled=!1,v.textContent=(null===(o=productEstimatorVars.i18n)||void 0===o?void 0:o.continue)||"Continue"}))):f.textContent=(null===(i=productEstimatorVars.i18n)||void 0===i?void 0:i.invalid_email)||"Please enter a valid email address":f.textContent=(null===(n=productEstimatorVars.i18n)||void 0===n?void 0:n.email_required)||"Email address is required"})),setTimeout((function(){p.focus(),p.addEventListener("keypress",(function(t){"Enter"===t.key&&(t.preventDefault(),v.click())}))}),100)}},{key:"notifyEmailUpdated",value:function(t){if(t){this.log("Dispatching customer_details_updated event",t);var e=new CustomEvent("customer_details_updated",{bubbles:!0,detail:{details:t,source:"print_estimate"}});document.dispatchEvent(e);var o=document.querySelector("#new-estimate-form");o&&t.email&&(o.setAttribute("data-has-email","true"),this.log("Updated new-estimate-form data-has-email attribute to true"))}}},{key:"generatePdf",value:function(t,e){var o=this;return new Promise((function(e,i){s.wpAjax("print_estimate",{estimate_id:t}).then((function(t){o.log("PDF generated successfully",t),t.pdf_url&&window.open(t.pdf_url,"_blank"),t.db_id&&o.log("Estimate now stored with DB ID: ".concat(t.db_id)),e()})).catch((function(t){o.log("AJAX error",t),o.showError(t.message||"Error generating PDF. Please try again."),i(t)}))}))}},{key:"handleRequestContact",value:function(t){var e=t.dataset.estimateId;e?(this.log("Request contact requested for estimate ID: ".concat(e)),this.saveEstimateIfNeeded(e,(function(){alert("Request contact feature will be implemented here")}))):this.showError("No estimate ID provided")}},{key:"handleScheduleDesigner",value:function(t){var e=t.dataset.estimateId;e?(this.log("Schedule designer requested for estimate ID: ".concat(e)),this.saveEstimateIfNeeded(e,(function(){alert("Schedule designer feature will be implemented here")}))):this.showError("No estimate ID provided")}},{key:"saveEstimateIfNeeded",value:function(t,e){var o=this;this.processing=!0,this.checkEstimateStored(t).then((function(i){if(!i.is_stored||!i.db_id)return o.storeEstimate(t).then((function(o){"function"==typeof e&&e(o.estimate_id||t)}));"function"==typeof e&&e(i.db_id)})).catch((function(t){o.log("Error checking/storing estimate",t),o.showError("Error preparing estimate. Please try again.")})).finally((function(){o.processing=!1}))}},{key:"storeEstimate",value:function(t){var e=this._customerDetails||{};return s.wpAjax("store_single_estimate",{estimate_id:t,customer_name:e.name||"",customer_email:e.email||"",customer_phone:e.phone||"",customer_postcode:e.postcode||"",notes:""})}},{key:"setButtonLoading",value:function(t,e){if(t){var o=t.dataset.originalText||t.textContent;e?(t.dataset.originalText||(t.dataset.originalText=t.textContent),t.classList.add("loading"),t.innerHTML='<span class="loading-dots">Processing...</span>',t.disabled=!0):(t.classList.remove("loading"),t.textContent=o,t.disabled=!1)}}},{key:"showError",value:function(t){window.productEstimator&&window.productEstimator.core&&"function"==typeof window.productEstimator.core.showError?window.productEstimator.core.showError(t):alert(t)}},{key:"showSuccess",value:function(t){window.productEstimator&&window.productEstimator.core&&"function"==typeof window.productEstimator.core.showMessage?window.productEstimator.core.showMessage(t,"success"):alert(t)}},{key:"updateCustomerEmail",value:function(t,e){var o=this;return new Promise((function(i,n){var a=M(M({},o._customerDetails||{}),{},{email:e});a.name||(a.name="Customer"),a.postcode||(a.postcode=""),o.log("Updating customer email with details:",a),o.log("Using estimate ID:",t,"Type:",(0,m.A)(t)),s.wpAjax("update_customer_details",{details:JSON.stringify(a)}).then((function(e){o.log("Customer details updated successfully",e),o._customerDetails=e.details||a;var i=String(t);return o.log("Storing estimate with ID:",i),s.wpAjax("store_single_estimate",{estimate_id:i,customer_name:a.name||"Customer",customer_email:a.email,customer_phone:a.phone||"",customer_postcode:a.postcode||"",notes:""})})).then((function(t){o.log("Estimate stored with updated email response:",t),i(o._customerDetails)})).catch((function(t){o.log("Error in updateCustomerEmail:",t),n(t)}))}))}},{key:"showEmailSentConfirmation",value:function(t){var e=this;window.productEstimator&&window.productEstimator.dialog?window.productEstimator.dialog.show({title:this.config.i18n.email_sent_title||"Estimate Sent",message:(this.config.i18n.email_sent_message||"Your estimate has been sent to {email}").replace("{email}",t),type:"success",confirmText:this.config.i18n.ok||"OK",cancelText:"",onConfirm:function(){e.log("Email sent confirmation acknowledged")}}):alert("Your estimate has been sent to "+t)}},{key:"log",value:function(){if(this.config.debug){for(var t=arguments.length,e=new Array(t),o=0;o<t;o++)e[o]=arguments[o];l.apply(void 0,["PrintEstimate"].concat(e))}}}])}();const N=R;function T(){if(console.log("Product Estimator initialization check..."),window._productEstimatorInitialized)console.log("Product Estimator already initialized globally, aborting");else{if(window.productEstimator&&window.productEstimator.initialized)return console.log("Product Estimator initialized property found, aborting"),void(window._productEstimatorInitialized=!0);window._productEstimatorInitialized=!0,console.log("Product Estimator initializing for the first time...");try{z?console.log("Global event handlers already added, skipping"):(console.log("Setting up global event handlers..."),window._productEstimatorCloseHandler=function(t){if(t.target.closest(".product-estimator-modal-close")||t.target.classList.contains("product-estimator-modal-overlay")){console.log("Global close handler triggered");var e=document.querySelector("#product-estimator-modal");e&&(e.style.display="none",document.body.classList.remove("modal-open"),window.productEstimator&&window.productEstimator.core&&window.productEstimator.core.closeModal())}},document.removeEventListener("click",window._productEstimatorCloseHandler),document.addEventListener("click",window._productEstimatorCloseHandler),z=!0,console.log("Global event handlers added")),"undefined"!=typeof jQuery?(window.productEstimator=window.productEstimator||{},window.productEstimator.jQuery=jQuery):console.warn("jQuery not detected, some features may not work");var t=function(){var t=new URLSearchParams(window.location.search);if(t.has("product_estimator_debug")){var e="false"!==t.get("product_estimator_debug");return e?localStorage.setItem("product_estimator_debug","true"):localStorage.removeItem("product_estimator_debug"),e}return"true"===localStorage.getItem("product_estimator_debug")}();"complete"===document.readyState?setTimeout((function(){return O(t)}),10):setTimeout((function(){return O(t)}),500)}catch(t){console.error("Error in Product Estimator initialization:",t)}}}function O(t){try{if(window.productEstimator&&window.productEstimator.initialized)return void console.log("Product Estimator core already initialized, skipping");console.log("Initializing EstimatorCore..."),P.init({debug:t}),window.productEstimator=window.productEstimator||{},window.productEstimator.initialized=!0,window.productEstimator.core=P,window.productEstimator.dialog=f;var e=new N({debug:t});window.productEstimator.printEstimate=e,window.productEstimator.detailsToggle=A,window.initSuggestionsCarousels=E,function(){try{document.addEventListener("click",(function(t){t.target.closest(".accordion-header")&&setTimeout((function(){A&&"function"==typeof A.setup&&(console.log("Accordion clicked, reinitializing product details toggle"),A.setup()),E()}),300)})),document.body.addEventListener("click",(function(t){if(t.target.closest(".product-details-toggle")){var e=t.target.closest(".product-details-toggle"),o=e.closest(".product-item");if(!o)return;var i=e.classList.contains("expanded"),n=o.querySelector(".similar-products-container");if(!n)return;if(i){e.classList.remove("expanded"),n.style.display="none",n.classList.remove("visible");var s=e.querySelector(".toggle-icon");s&&(s.classList.remove("dashicons-arrow-up-alt2"),s.classList.add("dashicons-arrow-down-alt2"))}else{e.classList.add("expanded"),n.style.display="block",n.classList.add("visible");var a=e.querySelector(".toggle-icon");a&&(a.classList.remove("dashicons-arrow-down-alt2"),a.classList.add("dashicons-arrow-up-alt2")),E()}t.preventDefault(),t.stopPropagation()}if(t.target.closest(".product-notes-toggle")){var r=t.target.closest(".product-notes-toggle"),l=r.closest(".product-item");if(!l)return;var c=r.classList.contains("expanded"),d=l.querySelector(".notes-container");if(!d)return;if(c){r.classList.remove("expanded"),d.style.display="none",d.classList.remove("visible");var u=r.querySelector(".toggle-icon");u&&(u.classList.remove("dashicons-arrow-up-alt2"),u.classList.add("dashicons-arrow-down-alt2"))}else{r.classList.add("expanded"),d.style.display="block",d.classList.add("visible");var m=r.querySelector(".toggle-icon");m&&(m.classList.remove("dashicons-arrow-down-alt2"),m.classList.add("dashicons-arrow-up-alt2"))}t.preventDefault(),t.stopPropagation()}if(t.target.closest(".product-includes-toggle")){var h=t.target.closest(".product-includes-toggle"),g=h.closest(".product-item");if(!g)return;var v=h.classList.contains("expanded"),p=g.querySelector(".includes-container");if(!p)return;if(v){h.classList.remove("expanded"),p.style.display="none",p.classList.remove("visible");var f=h.querySelector(".toggle-icon");f&&(f.classList.remove("dashicons-arrow-up-alt2"),f.classList.add("dashicons-arrow-down-alt2"))}else{h.classList.add("expanded"),p.style.display="block",p.classList.add("visible");var y=h.querySelector(".toggle-icon");y&&(y.classList.remove("dashicons-arrow-down-alt2"),y.classList.add("dashicons-arrow-up-alt2"))}t.preventDefault(),t.stopPropagation()}if(t.target.closest(".product-suggestions-toggle")){var w=t.target.closest(".product-suggestions-toggle"),b=w.closest(".accordion-content");if(!b)return;var S=w.classList.contains("expanded"),_=b.querySelector(".suggestions-container");if(!_)return;if(S){w.classList.remove("expanded"),_.style.display="none",_.classList.remove("visible");var k=w.querySelector(".toggle-icon");k&&(k.classList.remove("dashicons-arrow-up-alt2"),k.classList.add("dashicons-arrow-down-alt2"))}else{w.classList.add("expanded"),_.style.display="block",_.classList.add("visible");var L=w.querySelector(".toggle-icon");L&&(L.classList.remove("dashicons-arrow-down-alt2"),L.classList.add("dashicons-arrow-up-alt2")),E()}t.preventDefault(),t.stopPropagation()}})),console.log("ProductDetailsToggle initialization complete")}catch(t){console.error("Error initializing ProductDetailsToggle:",t)}}(),console.log("Product Estimator initialized".concat(t?" (debug mode)":"")),document.dispatchEvent(new CustomEvent("product_estimator_initialized"))}catch(t){console.error("Error during EstimatorCore initialization:",t)}}window._productEstimatorInitialized=window._productEstimatorInitialized||!1,window._setupInitDone||(window._setupInitDone=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",T,{once:!0}):T());var z=!1}},o={};function i(t){var n=o[t];if(void 0!==n)return n.exports;var s=o[t]={exports:{}};return e[t](s,s.exports,i),s.exports}i.m=e,t=[],i.O=(e,o,n,s)=>{if(!o){var a=1/0;for(d=0;d<t.length;d++){for(var[o,n,s]=t[d],r=!0,l=0;l<o.length;l++)(!1&s||a>=s)&&Object.keys(i.O).every((t=>i.O[t](o[l])))?o.splice(l--,1):(r=!1,s<a&&(a=s));if(r){t.splice(d--,1);var c=n();void 0!==c&&(e=c)}}return e}s=s||0;for(var d=t.length;d>0&&t[d-1][2]>s;d--)t[d]=t[d-1];t[d]=[o,n,s]},i.d=(t,e)=>{for(var o in e)i.o(e,o)&&!i.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:e[o]})},i.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),i.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{var t={945:0};i.O.j=e=>0===t[e];var e=(e,o)=>{var n,s,[a,r,l]=o,c=0;if(a.some((e=>0!==t[e]))){for(n in r)i.o(r,n)&&(i.m[n]=r[n]);if(l)var d=l(i)}for(e&&e(o);c<a.length;c++)s=a[c],i.o(t,s)&&t[s]&&t[s][0](),t[s]=0;return i.O(d)},o=self.webpackChunkproduct_estimator=self.webpackChunkproduct_estimator||[];o.forEach(e.bind(null,0)),o.push=e.bind(null,o.push.bind(o))})();var n=i.O(void 0,[76],(()=>i(600)));n=i.O(n)})();