(()=>{"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(e)}function o(e){var o=function(e){if("object"!=t(e)||!e)return e;var o=e[Symbol.toPrimitive];if(void 0!==o){var i=o.call(e,"string");if("object"!=t(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==t(o)?o:o+""}function i(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,o(n.key),n)}}function n(e,t,o){return t&&i(e.prototype,t),o&&i(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,i=Array(t);o<t;o++)i[o]=e[o];return i}function s(e,t){if(e){if("string"==typeof e)return a(e,t);var o={}.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?a(e,t):void 0}}function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var i,n,a,s,r=[],c=!0,l=!1;try{if(a=(o=o.call(e)).next,0===t){if(Object(o)!==o)return;c=!1}else for(;!(c=(i=a.call(o)).done)&&(r.push(i.value),r.length!==t);c=!0);}catch(e){l=!0,n=e}finally{try{if(!c&&null!=o.return&&(s=o.return(),Object(s)!==s))return}finally{if(l)throw n}}return r}}(e,t)||s(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var c="productEstimatorEstimateData";function l(){try{var e=localStorage.getItem(c);if(e){var t=JSON.parse(e);return console.log("EstimateStorage: loadEstimateData - Data loaded:",t),t}var o=sessionStorage.getItem(c);return o?JSON.parse(o):{}}catch(e){return console.error("Error loading estimate data from localStorage:",e),{}}}function d(e){try{localStorage.setItem(c,JSON.stringify(e))}catch(t){console.warn("localStorage not available, using sessionStorage:",t);try{sessionStorage.setItem(c,JSON.stringify(e))}catch(e){console.error("sessionStorage not available:",e)}}}function u(){try{localStorage.removeItem(c)}catch(e){console.warn("localStorage not available:",e)}try{sessionStorage.removeItem(c)}catch(e){console.warn("sessionStorage not available:",e)}}function m(e,t,o){var i=l();if(!(i.estimates&&i.estimates[e]&&i.estimates[e].rooms&&i.estimates[e].rooms[t]))return!1;var n=i.estimates[e].rooms[t];return n.products||(n.products=[]),n.products.push(o),d(i),!0}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,i=Array(t);o<t;o++)i[o]=e[o];return i}var g=function(){return n((function t(){var o,i,n,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e(this,t),window._dataServiceInstance)return console.log("Using existing DataService instance"),window._dataServiceInstance;this.config=Object.assign({debug:!1,ajaxUrl:(null===(o=window.productEstimatorVars)||void 0===o?void 0:o.ajax_url)||"/wp-admin/admin-ajax.php",nonce:(null===(i=window.productEstimatorVars)||void 0===i?void 0:i.nonce)||"",i18n:(null===(n=window.productEstimatorVars)||void 0===n?void 0:n.i18n)||{}},a),this.cache={estimatesData:null,estimatesList:null,rooms:{},suggestedProducts:{}},window._dataServiceLogged||(this.log("DataService initialized"),window._dataServiceLogged=!0),window._dataServiceInstance=this}),[{key:"request",value:function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.log("Making request to '".concat(e,"'"),o),new Promise((function(i,n){var a=new FormData;a.append("action",e),a.append("nonce",t.config.nonce),Object.entries(o).forEach((function(e){var t=r(e,2),o=t[0],i=t[1];null!=i&&a.append(o,String(i))})),t.config.debug&&console.log("Request details:",{url:t.config.ajaxUrl,action:e,nonce:t.config.nonce,data:Object.fromEntries(a)}),fetch(t.config.ajaxUrl,{method:"POST",credentials:"same-origin",body:a}).then((function(e){if(!e.ok)throw console.error("Network response error (".concat(e.status,"): ").concat(e.statusText)),new Error("Network response was not ok: ".concat(e.status));return e.json()})).then((function(o){if(o.success)t.log("Request '".concat(e,"' succeeded:"),o.data),i(o.data);else{var a,s=new Error((null===(a=o.data)||void 0===a?void 0:a.message)||"Unknown error");s.data=o.data,t.log("Request '".concat(e,"' failed:"),s),n(s)}})).catch((function(o){t.log("Request '".concat(e,"' error:"),o);var i=new Error("AJAX request failed: ".concat(o.message));i.originalError=o,i.action=e,n(i)}))}))}},{key:"checkEstimatesExist",value:function(){return this.request("check_estimates_exist").then((function(e){return!!e.has_estimates}))}},{key:"bindCreateEstimateButton",value:function(){var e=this,t=this.modal.querySelector("#create-estimate-btn");t&&(console.log("Found Create Estimate button, binding event handler"),this._createEstimateBtnHandler&&t.removeEventListener("click",this._createEstimateBtnHandler),this._createEstimateBtnHandler=function(t){t.preventDefault(),console.log("Create Estimate button clicked"),e.showNewEstimateForm()},t.addEventListener("click",this._createEstimateBtnHandler))}},{key:"getEstimatesList",value:function(){var e=this;return arguments.length>0&&void 0!==arguments[0]&&arguments[0]||!this.cache.estimatesList?this.request("get_estimates_list").then((function(t){return e.cache.estimatesList=t.html,setTimeout((function(){return e.bindCreateEstimateButton()}),100),t.html})):(this.log("Returning cached estimates list"),setTimeout((function(){return e.bindCreateEstimateButton()}),100),Promise.resolve(this.cache.estimatesList))}},{key:"getEstimatesData",value:function(){var e=this;return arguments.length>0&&void 0!==arguments[0]&&arguments[0]||!this.cache.estimatesData?this.request("get_estimates_data").then((function(t){return e.cache.estimatesData=t.estimates,t.estimates})):(this.log("Returning cached estimates data"),Promise.resolve(this.cache.estimatesData))}},{key:"getRoomsForEstimate",value:function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n="estimate_".concat(e);return!i&&this.cache.rooms[n]?(this.log("Returning cached rooms for estimate ".concat(e)),Promise.resolve(this.cache.rooms[n])):this.request("get_rooms_for_estimate",{estimate_id:e,product_id:o||""}).then((function(e){return t.cache.rooms[n]=e,e}))}},{key:"addProductToRoom",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;console.log("DataService: Adding product to room",{roomId:e,productId:t,estimateId:i});var n=l(),a=n.estimates?n.estimates[i]:null,s=a&&a.rooms?a.rooms[e]:null,r=null,c=null;s?(r=s.width,c=s.length):console.warn("Room ID ".concat(e," not found in local storage for estimate ").concat(i,". Cannot get dimensions for local product data.")),this.request("get_product_data_for_storage",{product_id:t,room_width:r,room_length:c}).then((function(n){if(console.log("DataService: Fetched comprehensive product data for storage:",n),!n.product_data)throw new Error("Failed to get comprehensive product data from server.");var a=n.product_data;try{m(i,e,a)?o.log("Product ID ".concat(t," successfully added to room ").concat(e," in localStorage with comprehensive data.")):console.warn("Failed to add product ID ".concat(t," to room ").concat(e," in localStorage."))}catch(o){console.error("Error adding comprehensive product ID ".concat(t," to room ").concat(e," in localStorage:"),o)}})).catch((function(e){throw console.error("DataService: Error fetching comprehensive product data for storage:",e),e}));var d={room_id:e,product_id:t};return null!==i&&(d.estimate_id=i),this.request("add_product_to_room",d).then((function(e){return console.log("DataService: Product added successfully (server response)",e),o.invalidateCache(),e})).catch((function(e){throw console.error("DataService: Error adding product to room (server response)",e),e}))}},{key:"replaceProductInRoom",value:function(e,o,i,n,a){var s=this,r=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"main";console.log("DataService: Initiating product replacement request",{estimateId:e,roomId:o,oldProductId:i,newProductId:n,parentProductId:a,replaceType:r});var c=l(),u=null,m=null;if(c&&c.estimates&&c.estimates[e]){var h=c.estimates[e];if(h.rooms&&h.rooms[o]){var g=h.rooms[o];u=g.width,m=g.length,console.log("Room ".concat(o," in Estimate ").concat(e," has dimensions: Width = ").concat(u,", Length = ").concat(m))}else console.warn("Room with ID ".concat(o," not found in estimate ").concat(e,"."))}else console.warn("Estimate with ID ".concat(e," not found in localStorage."));this.request("get_product_data_for_storage",{product_id:n,room_width:u,room_length:m}).then((function(c){if(console.log("DataService: Fetched comprehensive product data for storage:",c),!c.product_data)throw new Error("Failed to get comprehensive product data from server.");var u=c.product_data;try{!function(e,o,i,n,a){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"main",r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=l();if(!(c.estimates&&c.estimates[e]&&c.estimates[e].rooms&&c.estimates[e].rooms[o]))return console.warn("Estimate or room not found in storedData."),!1;var u=c.estimates[e].rooms[o];if(console.log("Debugging: State of room.products:",u.products,"(Type: ".concat(t(u.products),")"),"(Is Array: ".concat(Array.isArray(u.products),")")),!u.products)return!1;if(console.log("Debugging: Value of replaceType before check:",s,"(Type: ".concat(t(s),")")),"additional_products"===s&&null!==r){console.log("Starting outer loop for main products...");for(var m=null,h=0;h<u.products.length;h++){var g=u.products[h];if(g.id==r){m=g,console.log("Found parent product:",m);break}}if(m&&m.additional_products&&Array.isArray(m.additional_products)){console.log("Searching additional products for parent product ID: ".concat(r));for(var p=0;p<m.additional_products.length;p++){var f=m.additional_products[p];if(f.id==i||f.replacement_chain&&f.replacement_chain.includes(i))return console.log("  Match found for oldProductId ".concat(i," under parent ").concat(r,"! Replacing...")),f.replacement_chain||(f.replacement_chain=[]),f.replacement_chain.includes(f.id)||f.replacement_chain.push(f.id),a.replacement_chain=f.replacement_chain,u.products.find((function(e){return e.id==r})).additional_products[p]=a,d(c),!0}console.warn("Additional product with oldProductId ".concat(i," not found under parent product ID ").concat(r,"."))}else console.warn("Parent product with ID ".concat(r," not found or has no additional products."));return console.warn("Additional product with oldProductId ".concat(i," not found in any additional_products array.")),!1}if("main"===s){for(var v=!1,y=-1,w=0;w<u.products.length;w++)if(u.products[w].id==i){v=!0,y=w;break}return!!(v&&y>=0)&&(u.products.splice(y,1),u.products.push(a),d(c),!0)}}(e,o,i,n,u,r,a)?console.warn("Product replacement (old ID ".concat(i,") failed in localStorage for room ").concat(o,". Product not found?")):s.log("Product ID ".concat(n," successfully added to room ").concat(o," in localStorage with comprehensive data."))}catch(e){console.error("Error performing local storage product replacement for room ".concat(o,":"),e)}})).catch((function(e){throw console.error("DataService: Error fetching comprehensive product data for storage:",e),e}));var p={estimate_id:e,room_id:o,product_id:n,replace_product_id:i,replace_type:r};return null!==a&&(p.parent_product_id=a),this.request("replace_product_in_room",p).then((function(e){return console.log("DataService: Product replacement successful (server response)",e),s.invalidateCache(),e})).catch((function(e){throw console.error("DataService: Error replacing product (server response)",e),e}))}},{key:"addNewEstimate",value:function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i={form_data:this.formatFormData(e)};o&&(i.product_id=o);var n=e instanceof FormData?e.get("estimate_name"):e.estimate_name||"Unnamed Estimate",a=l().estimates||{},s=Object.keys(a).length,r=function(e){var t=l();t.estimates||(t.estimates={});var o=e.id;return o||(o="estimate_".concat(Date.now())),t.estimates[o]=e,d(t),o}({id:String(s),name:n,rooms:{}});return this.log("Client-side estimate saved to localStorage with sequential ID: ".concat(r)),this.request("add_new_estimate",i).then((function(e){return t.invalidateCache(),e}))}},{key:"addNewRoom",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;console.log("DataService: Adding new room",{estimateId:t,productId:i,formData:e instanceof FormData?Object.fromEntries(e):e});var n=l(),a=n.estimates?n.estimates[t]:null,s=String(Object.keys(a.rooms).length),r=parseFloat(e instanceof FormData?e.get("room_width"):e.room_width)||0,c=parseFloat(e instanceof FormData?e.get("room_length"):e.room_length)||0,u={id:s,name:e instanceof FormData?e.get("room_name")||"Unnamed Room":e.room_name||"Unnamed Room",width:r,length:c,products:[],min_total:0,max_total:0};if(function(e,t){var o=l();if(!o.estimates||!o.estimates[e])return!1;var i=o.estimates[e];i.rooms||(i.rooms={});var n=t.id;n||(n="room_".concat(Date.now())),i.rooms[n]=t,d(o)}(t,u),this.log("Room ID ".concat(u.id," added to localStorage for estimate ").concat(t)),i){var h={id:String(i)};try{m(t,s,h)?this.log("Product ID ".concat(i," successfully added to room ").concat(s," in localStorage.")):console.warn("Failed to add product ID ".concat(i," to room ").concat(s," in localStorage."))}catch(e){console.error("Error adding product ID ".concat(i," to room ").concat(s," in localStorage:"),e)}}var g={form_data:this.formatFormData(e),estimate_id:t};return i&&(g.product_id=i),this.request("add_new_room",g).then((function(e){return console.log("DataService: Room added successfully",e),o.invalidateCache(),e})).catch((function(e){throw console.error("DataService: Error adding room",e),e}))}},{key:"removeProductFromRoom",value:function(e,t,o){var i=this;try{!function(e,t,o){var i=l();return!!(i.estimates&&i.estimates[e]&&i.estimates[e].rooms&&i.estimates[e].rooms[t]&&i.estimates[e].rooms[t].products&&i.estimates[e].rooms[t].products[o])&&(i.estimates[e].rooms[t].products.splice(o,1),d(i),!0)}(e,t,o)?console.warn("Product at index ".concat(o," not found in room ").concat(t," in localStorage during removal attempt.")):this.log("Product at index ".concat(o," successfully removed from room ").concat(t," in localStorage."))}catch(e){console.error("Error removing product at index ".concat(o," from room ").concat(t," in localStorage:"),e)}return this.request("remove_product_from_room",{estimate_id:e,room_id:t,product_index:o}).then((function(e){return i.invalidateCache(),e}))}},{key:"removeRoom",value:function(e,t){var o=this;console.log("DataService: Removing room",{estimateId:e,roomId:t});try{!function(e,t){var o=l();return!!(o.estimates&&o.estimates[e]&&o.estimates[e].rooms&&o.estimates[e].rooms[t])&&(delete o.estimates[e].rooms[t],d(o),!0)}(e,t)?console.warn("Room ID ".concat(t," not found in localStorage for estimate ").concat(e," during removal attempt.")):this.log("Room ID ".concat(t," successfully removed from localStorage for estimate ").concat(e))}catch(e){console.error("Error removing room ID ".concat(t," from localStorage:"),e)}var i={estimate_id:String(e),room_id:String(t)};return this.request("remove_room",i).then((function(e){return console.log("DataService: Room removed successfully",e),o.invalidateCache(),e})).catch((function(e){throw console.error("DataService: Error removing room",e),e}))}},{key:"removeEstimate",value:function(e){var t=this;console.log("DataService: Removing estimate ".concat(e));try{!function(e){var t=l();return!(!t.estimates||!t.estimates[e]||(delete t.estimates[e],d(t),0))}(e)?console.warn("Estimate ID ".concat(e," not found in localStorage during removal attempt.")):this.log("Estimate ID ".concat(e," successfully removed from localStorage."))}catch(t){console.error("Error removing estimate ID ".concat(e," from localStorage:"),t)}return this.request("remove_estimate",{estimate_id:e}).then((function(o){return t.invalidateCache(),console.log("DataService: Successfully removed estimate ".concat(e)),o})).catch((function(t){throw console.error("DataService: Error removing estimate ".concat(e),t),t}))}},{key:"getSuggestedProducts",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n="estimate_".concat(e,"_room_").concat(t);return!i&&this.cache.suggestedProducts[n]?(this.log("Returning cached suggestions for room ".concat(t)),Promise.resolve(this.cache.suggestedProducts[n])):this.request("get_suggested_products",{estimate_id:e,room_id:t}).then((function(e){return o.cache.suggestedProducts[n]=e.suggestions,e.suggestions}))}},{key:"addSuggestionToRoom",value:function(e,t,o){var i=this;return m(e,t,o),this.request("add_product_to_room",{estimate_id:e,room_id:t,product_id:o}).then((function(e){return i.invalidateCache(),e}))}},{key:"getVariationEstimator",value:function(e){return this.request("get_variation_estimator",{variation_id:e})}},{key:"formatFormData",value:function(e){if("string"==typeof e)return e;if(e instanceof FormData){var t,o=new URLSearchParams,i=function(e,t){var o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=function(e,t){if(e){if("string"==typeof e)return h(e,t);var o={}.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?h(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){o&&(e=o);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,r=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return s=e.done,e},e:function(e){r=!0,a=e},f:function(){try{s||null==o.return||o.return()}finally{if(r)throw a}}}}(e.entries());try{for(i.s();!(t=i.n()).done;){var n=r(t.value,2),a=n[0],s=n[1];o.append(a,s)}}catch(e){i.e(e)}finally{i.f()}return o.toString()}return new URLSearchParams(e).toString()}},{key:"invalidateCache",value:function(){this.log("Invalidating caches"),this.cache.estimatesData=null,this.cache.estimatesList=null,this.cache.rooms={},this.cache.suggestedProducts={}}},{key:"log",value:function(){if(this.config.debug){for(var e,t=arguments.length,o=new Array(t),i=0;i<t;i++)o[i]=arguments[i];(e=console).log.apply(e,["[DataService]"].concat(o))}}}])}();const p=g;var f=function(){return n((function t(o){e(this,t),this.id="carousel_"+Math.random().toString(36).substr(2,9),this.container=o,this.itemsContainer=o.querySelector(".suggestions-container"),this.items=o.querySelectorAll(".suggestion-item"),this.prevBtn=o.querySelector(".suggestions-nav.prev"),this.nextBtn=o.querySelector(".suggestions-nav.next"),this.isSimilarProducts=o.classList.contains("similar-products-carousel"),this.itemsContainer&&this.items.length?(o.carouselInstance=this,this.isSimilarProducts?(this.itemWidth=130,this.itemGap=5):(this.itemWidth=200,this.itemGap=15),this.visibleItems=this.calculateVisibleItems(),this.currentPosition=0,this.maxPosition=Math.max(0,this.items.length-this.visibleItems),this.setContainerSize(),this.bindEvents(),this.updateButtons()):console.warn("[".concat(this.id,"] Carousel missing items container or has no items"))}),[{key:"getContainerWidth",value:function(){if(this.isSimilarProducts){var e=this.container.closest(".product-item");if(e)return e.offsetWidth-10}return this.container.offsetWidth}},{key:"setContainerSize",value:function(){if(this.isSimilarProducts){var e=this.container.closest(".product-item");if(e){var t=e.offsetWidth;this.container.style.maxWidth="".concat(t-10,"px")}Array.from(this.items).forEach((function(e){e.style.flexShrink="0",e.style.flexGrow="0"})),this.itemsContainer.style.gap="".concat(this.itemGap,"px")}}},{key:"calculateVisibleItems",value:function(){var e=this.getContainerWidth()-50,t=(this.isSimilarProducts?130:this.itemWidth)+(this.isSimilarProducts?5:this.itemGap);return Math.max(1,Math.floor(e/t))}},{key:"bindEvents",value:function(){var e=this;this.handlePrevClick=this.handlePrevClick.bind(this),this.handleNextClick=this.handleNextClick.bind(this),this.handleResize=this.handleResize.bind(this),this.prevBtn&&(this.prevBtn.removeEventListener("click",this.handlePrevClick),this.prevBtn.addEventListener("click",this.handlePrevClick)),this.nextBtn&&(this.nextBtn.removeEventListener("click",this.handleNextClick),this.nextBtn.addEventListener("click",this.handleNextClick)),this.resizeTimeout=null,window.addEventListener("resize",(function(){clearTimeout(e.resizeTimeout),e.resizeTimeout=setTimeout(e.handleResize,150)}))}},{key:"handlePrevClick",value:function(e){e.preventDefault(),e.stopPropagation(),this.currentPosition>0&&(this.currentPosition--,this.updatePosition(),this.updateButtons())}},{key:"handleNextClick",value:function(e){e.preventDefault(),e.stopPropagation(),this.currentPosition<this.maxPosition&&(this.currentPosition++,this.updatePosition(),this.updateButtons())}},{key:"handleResize",value:function(){this.setContainerSize(),this.visibleItems,this.visibleItems=this.calculateVisibleItems(),this.maxPosition=Math.max(0,this.items.length-this.visibleItems),this.currentPosition>this.maxPosition&&(this.currentPosition=this.maxPosition),this.updatePosition(),this.updateButtons()}},{key:"getAvailableWidth",value:function(){var e=this.container.clientWidth-50;if(this.isSimilarProducts){var t=this.container.closest(".product-item");if(t){var o=window.getComputedStyle(t),i=t.clientWidth-(parseFloat(o.paddingLeft)+parseFloat(o.paddingRight));e=Math.min(e,i)}}else{var n=this.container.closest(".accordion-content");if(n){var a=n.clientWidth-30;e=Math.min(e,a)}}return Math.max(e,100)}},{key:"updatePosition",value:function(){if(this.itemsContainer){var e=this.itemWidth+this.itemGap,t=-this.currentPosition*e;this.itemsContainer.style.transition="transform 0.3s ease",this.itemsContainer.style.transform="translateX(".concat(t,"px)")}}},{key:"updateButtons",value:function(){this.prevBtn&&(this.currentPosition<=0?(this.prevBtn.classList.add("disabled"),this.prevBtn.setAttribute("aria-disabled","true")):(this.prevBtn.classList.remove("disabled"),this.prevBtn.removeAttribute("aria-disabled"))),this.nextBtn&&(this.currentPosition>=this.maxPosition?(this.nextBtn.classList.add("disabled"),this.nextBtn.setAttribute("aria-disabled","true")):(this.nextBtn.classList.remove("disabled"),this.nextBtn.removeAttribute("aria-disabled")))}},{key:"destroy",value:function(){this.prevBtn&&this.prevBtn.removeEventListener("click",this.handlePrevClick),this.nextBtn&&this.nextBtn.removeEventListener("click",this.handleNextClick),window.removeEventListener("resize",this.handleResize),this.container&&delete this.container.carouselInstance}}])}();function v(){var e=document.querySelectorAll(".suggestions-carousel");e.forEach((function(e){e.carouselInstance&&e.carouselInstance.destroy()}));var t=[];return e.forEach((function(e){var o=new f(e);t.push(o)})),t}function y(){document.querySelectorAll(".accordion-header").forEach((function(e){e.removeEventListener("click",w),e.addEventListener("click",w)}))}function w(e){setTimeout((function(){var t=e.currentTarget.closest(".accordion-item");if(t){var o=t.querySelector(".accordion-content");o&&"none"!==window.getComputedStyle(o).display&&o.querySelectorAll(".suggestions-carousel").forEach((function(e){e.carouselInstance&&e.carouselInstance.destroy(),new f(e)}))}}),300)}document.addEventListener("DOMContentLoaded",(function(){v(),y()}));var E="productEstimatorCustomerData";function b(){try{var e=localStorage.getItem(E);if(e)return JSON.parse(e);var t=sessionStorage.getItem(E);return t?JSON.parse(t):{}}catch(e){return console.error("Error loading customer details:",e),{}}}function S(e){try{localStorage.setItem(E,JSON.stringify(e))}catch(t){console.warn("localStorage not available, using sessionStorage:",t);try{sessionStorage.setItem(E,JSON.stringify(e))}catch(e){console.error("sessionStorage not available:",e)}}}function L(){try{localStorage.removeItem(E)}catch(e){console.warn("localStorage not available:",e)}try{sessionStorage.removeItem(E)}catch(e){console.warn("sessionStorage not available:",e)}}function k(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,i=Array(t);o<t;o++)i[o]=e[o];return i}var _=function(){return n((function t(){var o,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;e(this,t),this.config=Object.assign({debug:!1,selectors:{modalContainer:"#product-estimator-modal",estimatorButtons:".product-estimator-button, .single_add_to_estimator_button",modalOverlay:".product-estimator-modal-overlay",closeButton:".product-estimator-modal-close",contentContainer:".product-estimator-modal-form-container",loadingIndicator:".product-estimator-modal-loading",estimatesList:"#estimates",estimateSelection:"#estimate-selection-wrapper",roomSelection:"#room-selection-form-wrapper",newEstimateForm:"#new-estimate-form-wrapper",newRoomForm:"#new-room-form-wrapper"},i18n:(null===(o=window.productEstimatorVars)||void 0===o?void 0:o.i18n)||{}},i),this.dataService=n,this.loadCustomerDetails=b,this.saveCustomerDetails=S,this.clearCustomerDetails=L,this.loadEstimateData=l,this.clearEstimateData=u,this.saveEstimateData=d,this.modal=null,this.overlay=null,this.closeButton=null,this.contentContainer=null,this.loadingIndicator=null,this.estimatesList=null,this.estimateSelection=null,this.estimateSelectionForm=null,this.roomSelectionForm=null,this.newEstimateForm=null,this.newRoomForm=null,this.isOpen=!1,this.currentView=null,this.currentProductId=null,this.initialized=!1,this.eventHandlers={},this.escKeyHandler=null,this.init()}),[{key:"init",value:function(){var e=this;this.initialized?this.log("ModalManager already initialized"):(this.modal=document.querySelector(this.config.selectors.modalContainer),this.modal?this.log("Found existing modal in DOM, initializing elements"):this.log("Warning: Modal element not found in DOM. The PHP partial may not be included."),this.modal&&(this.initializeElements(),this.bindEvents(),this.setupLoaderSafety(),setTimeout((function(){e.ensureLoaderHidden()}),500)),this.initializeJQueryAccordions(),this.initialized=!0,this.log("ModalManager initialized"))}},{key:"initializeElements",value:function(){this.modal?(this.overlay=this.modal.querySelector(this.config.selectors.modalOverlay),this.closeButton=this.modal.querySelector(this.config.selectors.closeButton),this.contentContainer=this.modal.querySelector(this.config.selectors.contentContainer),this.loadingIndicator=this.modal.querySelector(this.config.selectors.loadingIndicator),this.loadingIndicator||(console.warn("[ModalManager] Loading indicator not found, creating one"),this.loadingIndicator=document.createElement("div"),this.loadingIndicator.className="product-estimator-modal-loading",this.loadingIndicator.innerHTML='\n      <div class="loading-spinner"></div>\n      <div class="loading-text">'.concat(this.config.i18n.loading||"Loading...","</div>\n    "),this.modal.appendChild(this.loadingIndicator)),this.estimatesList=this.modal.querySelector("#estimates"),this.estimateSelection=this.modal.querySelector("#estimate-selection-wrapper"),this.estimateSelectionForm=this.modal.querySelector("#estimate-selection-form-wrapper"),this.roomSelectionForm=this.modal.querySelector("#room-selection-form-wrapper"),this.newEstimateForm=this.modal.querySelector("#new-estimate-form-wrapper"),this.newRoomForm=this.modal.querySelector("#new-room-form-wrapper"),!this.estimateSelection&&this.contentContainer&&(console.warn("Creating estimate selection container"),this.estimateSelection=document.createElement("div"),this.estimateSelection.id="estimate-selection-wrapper",this.contentContainer.appendChild(this.estimateSelection),this.estimateSelectionForm||(this.estimateSelectionForm=document.createElement("div"),this.estimateSelectionForm.id="estimate-selection-form-wrapper",this.estimateSelection.appendChild(this.estimateSelectionForm))),!this.roomSelectionForm&&this.contentContainer&&(console.warn("Creating room selection form container"),this.roomSelectionForm=document.createElement("div"),this.roomSelectionForm.id="room-selection-form-wrapper",this.roomSelectionForm.style.display="none",this.contentContainer.appendChild(this.roomSelectionForm)),this.bindExistingForms()):console.error("[ModalManager] Modal element not available for initializing elements")}},{key:"showLoading",value:function(){if(this.loadingIndicator)this.loadingIndicator.style.display="flex";else if(console.warn("Loading indicator not available - creating one"),this.modal){var e=document.createElement("div");e.className="product-estimator-modal-loading",e.style.display="flex",e.innerHTML='\n        <div class="loading-spinner"></div>\n        <div class="loading-text">'.concat(this.config.i18n.loading||"Loading...","</div>\n      "),this.modal.appendChild(e),this.loadingIndicator=e}else console.error("Cannot create loading indicator - modal not available")}},{key:"hideLoading",value:function(){this.loadingStartTime=0,this.loadingIndicator?this.loadingIndicator.style.display="none":console.warn("Loading indicator not available during hide operation")}},{key:"initializeCarousels",value:function(){console.log("Initializing carousels in modal");var e=this.modal.querySelectorAll(".suggestions-carousel");if(e.length>0){console.log("Found ".concat(e.length," carousel containers in modal"));var t=this.modal.querySelectorAll(".product-suggestions .suggestions-carousel").length,o=this.modal.querySelectorAll(".product-similar-products .suggestions-carousel").length;console.log("Carousel types: ".concat(t," suggestion carousels, ").concat(o," similar product carousels")),v()}else console.log("No carousel containers found in modal")}},{key:"bindExistingForms",value:function(){var e=this;if(this.newRoomForm){var t=this.newRoomForm.querySelector("form#new-room-form");if(t){console.log("Found existing room form, binding event handlers"),this._newRoomFormSubmitHandler&&t.removeEventListener("submit",this._newRoomFormSubmitHandler),this._newRoomFormSubmitHandler=function(o){o.preventDefault(),console.log("Existing room form submitted"),e.handleNewRoomSubmission(t,o)},t.addEventListener("submit",this._newRoomFormSubmitHandler);var o=t.querySelector(".cancel-btn");o&&o.addEventListener("click",(function(){e.cancelForm("room")}))}}if(this.newEstimateForm){var i=this.newEstimateForm.querySelector("form#new-estimate-form");i&&(this._estimateFormSubmitHandler&&i.removeEventListener("submit",this._estimateFormSubmitHandler),this._estimateFormSubmitHandler=function(t){t.preventDefault(),e.handleNewEstimateSubmission(i,t)},i.addEventListener("submit",this._estimateFormSubmitHandler))}this.bindRoomSelectionFormEvents()}},{key:"bindEvents",value:function(){var e=this;if(this.modal){this._modalClickHandler&&this.modal.removeEventListener("click",this._modalClickHandler),this._modalClickHandler=function(t){t.target.closest(e.config.selectors.closeButton)&&(t.preventDefault(),t.stopPropagation(),e.log("Close button clicked"),e.closeModal()),t.target.classList.contains("product-estimator-modal-overlay")&&(t.preventDefault(),t.stopPropagation(),e.log("Overlay clicked"),e.closeModal())},this.modal.addEventListener("click",this._modalClickHandler);var t=function(t){"Escape"===t.key&&e.isOpen&&(e.log("Escape key pressed"),e.closeModal())};document.removeEventListener("keydown",this.escKeyHandler),document.addEventListener("keydown",t),this.escKeyHandler=t}else this.log("Modal element not available, cannot bind events")}},{key:"openModal",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.modal?(this.resetModalState(),this.currentProductId=t,t?this.modal.dataset.productId=t:delete this.modal.dataset.productId,this.showLoading(),this.modal.style.display="block",document.body.classList.add("modal-open"),this.isOpen=!0,t&&!o?(console.log("STARTING PRODUCT FLOW with product ID:",t),this.estimatesList&&(this.estimatesList.style.display="none","undefined"!=typeof jQuery&&jQuery(this.estimatesList).hide()),this.dataService.checkEstimatesExist().then((function(t){console.log("Has estimates check result:",t),t?e.showEstimateSelection():(e.showNewEstimateForm(),e.hideLoading())})).catch((function(t){console.error("Error checking estimates:",t),e.showError("Error checking estimates. Please try again."),e.hideLoading()}))):(console.log("STARTING LIST VIEW FLOW"),this.estimatesList&&(this.estimatesList.style.display="block"),this.estimateSelection&&(this.estimateSelection.style.display="none"),this.newEstimateForm&&(this.newEstimateForm.style.display="none"),this.newRoomForm&&(this.newRoomForm.style.display="none"),this.loadEstimatesList().then((function(){var t=e.modal.querySelector("#create-estimate-btn");t&&(e._createEstimateBtnHandler&&t.removeEventListener("click",e._createEstimateBtnHandler),e._createEstimateBtnHandler=function(){e.showNewEstimateForm()},t.addEventListener("click",e._createEstimateBtnHandler),console.log("Updated event handler for list view create estimate button"))})).catch((function(t){console.error("Error loading estimates list:",t),e.showError("Error loading estimates list.")})).finally((function(){e.hideLoading()})))):console.error("Cannot open modal - not found in DOM")}},{key:"showEstimateSelection",value:function(){var e=this;console.log("Showing estimate selection"),this.estimatesList&&(this.estimatesList.style.display="none"),this.estimateSelection?(this.forceElementVisibility(this.estimateSelection),this.estimateSelectionForm&&this.forceElementVisibility(this.estimateSelectionForm),this.estimateSelectionForm&&this.estimateSelectionForm.querySelector("form")?(this.loadEstimatesData(),this.bindEstimateSelectionFormEvents(),this.hideLoading()):this.loadEstimateSelectionForm().then((function(){e.bindEstimateSelectionFormEvents()})).catch((function(e){console.error("Error loading form:",e)}))):console.error("Estimate selection container not found")}},{key:"forceElementVisibility",value:function(e){if(!e)return console.error("Cannot show null element"),null;console.log("Forcing visibility for:",e.id||e.tagName),e.style.cssText+="display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important;",["hidden","hide","invisible","d-none","display-none"].forEach((function(t){e.classList.contains(t)&&e.classList.remove(t)})),e.classList.add("visible","d-block");for(var t=e.parentElement,o=new Set;t&&t!==document.body&&!o.has(t);)o.add(t),"none"===window.getComputedStyle(t).display&&(t.style.cssText+="display: block !important;"),t=t.parentElement;return"undefined"!=typeof jQuery&&jQuery(e).show(),e}},{key:"closeModal",value:function(){this.isOpen&&(this.modal?(this.modal.style.display="none",delete this.modal.dataset.productId,this.ensureLoaderHidden(),document.body.classList.remove("modal-open"),this.isOpen=!1,this.currentProductId=null,this.currentView=null,this.resetModalState(),this.emit("modal:closed")):this.log("Cannot close modal - element not found"))}},{key:"setupLoaderSafety",value:function(){var e=this;setInterval((function(){if(e.isOpen&&e.loadingIndicator&&"none"!==window.getComputedStyle(e.loadingIndicator).display){var t=e.loadingStartTime||0,o=(new Date).getTime();t&&o-t>1e4&&(console.warn("Loading indicator has been visible for more than 10 seconds, hiding it."),e.hideLoading(),e.showError("The operation is taking longer than expected or may have failed silently."))}}),2e3);var t=this.showLoading;this.showLoading=function(){return e.loadingStartTime=(new Date).getTime(),t.call(e)};var o=this.hideLoading;this.hideLoading=function(){return e.loadingStartTime=0,o.call(e)},console.log("Loader safety system installed")}},{key:"ensureLoaderHidden",value:function(){this.loadingIndicator&&"none"!==window.getComputedStyle(this.loadingIndicator).display&&(console.log("Force hiding loader that was left visible"),this.hideLoading());var e=document.querySelectorAll(".product-estimator-modal-loading");if(e.length>1){console.warn("Found ".concat(e.length," loading indicators, cleaning up duplicates"));for(var t=1;t<e.length;t++)e[t].remove()}e.forEach((function(e){e.style.display="none"}))}},{key:"resetModalState",value:function(){var e=function(e){e&&(e.style.display="none","undefined"!=typeof jQuery&&jQuery(e).hide())};e(this.estimatesList),e(this.estimateSelection),e(this.estimateSelectionForm),e(this.roomSelectionForm),e(this.newEstimateForm),e(this.newRoomForm),this.roomSelectionForm&&this.roomSelectionForm.removeAttribute("data-estimate-id"),this.newRoomForm&&(this.newRoomForm.removeAttribute("data-estimate-id"),this.newRoomForm.removeAttribute("data-product-id"))}},{key:"loadEstimatesList",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return console.log("[loadEstimatesList] Function started",{expandRoomId:t,expandEstimateId:o}),new Promise((function(i,n){if(e.showLoading(),!e.estimatesList)return console.error("[loadEstimatesList] Estimates list container not found!"),void n(new Error("Estimates list container not found"));e.estimatesList.style.display="block",jQuery.ajax({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_estimates_list",nonce:productEstimatorVars.nonce},cache:!1,success:function(a){if(a.success&&a.data.html)e.estimatesList.innerHTML=a.data.html,setTimeout((function(){setTimeout((function(){e.updateEstimatesList(t,o)}),150),e.initializeAccordions(t,o),e.bindProductRemovalEvents(),e.bindRoomRemovalEvents(),e.bindEstimateRemovalEvents(),e.bindEstimateListEventHandlers(),y(),e.initializeCarousels(),e.bindSuggestedProductButtons()}),150),i(a.data.html);else{console.error("[loadEstimatesList] AJAX Success but response indicates failure or no HTML",a);var s=new Error("Failed to load estimates list");console.error(s),n(s)}},error:function(e,t,o){console.error("[loadEstimatesList] AJAX Error:",t,o,e),n(new Error("AJAX Error loading estimates list: ".concat(t," ").concat(o)))},complete:function(){e.hideLoading()}})}))}},{key:"handleProductRemoval",value:function(e,t,o){var i=this;this.showLoading(),console.log("Removing product at index ".concat(o," from room ").concat(t," in estimate ").concat(e)),this.dataService.removeProductFromRoom(e,t,o).then((function(o){return i.loadEstimatesList(t,e).then((function(){console.log("Estimates list refreshed, attempting to expand room ".concat(t," in estimate ").concat(e));var o=i.modal.querySelector('.estimate-section[data-estimate-id="'.concat(e,'"]'));if(o){o.classList.remove("collapsed");var n=o.querySelector(".estimate-content");n&&(n.style.display="block")}var a=i.modal.querySelector('.accordion-item[data-room-id="'.concat(t,'"][data-estimate-id="').concat(e,'"]'));if(a||(console.log("Using fallback room selector"),i.modal.querySelector('.accordion-item[data-room-id="'.concat(t,'"]')),function(){throw new TypeError('"roomElement" is read-only')}()),a){console.log("Found room element, expanding it");var s=a.querySelector(".accordion-header"),r=a.querySelector(".accordion-content");s&&s.classList.add("active"),r&&(r.style.display="block"),setTimeout((function(){a.scrollIntoView({behavior:"smooth",block:"center"})}),200)}else console.warn("Could not find room element for room ID ".concat(t));i.showMessage("Product removed successfully","success")}))})).catch((function(e){console.error("Error removing product:",e),i.showError(e.message||"Error removing product. Please try again.")})).finally((function(){i.hideLoading()}))}},{key:"handleAddSuggestedProduct",value:function(e,t,o,i){var n=this;this.showLoading(),i&&(i.disabled=!0,i.classList.add("loading"),i.innerHTML='<span class="loading-dots">Adding...</span>'),console.log("Adding suggested product ".concat(e," to room ").concat(o," in estimate ").concat(t," via DataService")),this.dataService.addProductToRoom(o,e,t).then((function(e){return console.log("Add suggested product response from DataService:",e),n.loadEstimatesList(o,t).then((function(){setTimeout((function(){var e=n.modal.querySelector('.accordion-item[data-room-id="'.concat(o,'"]'));if(e){var t=e.querySelector(".accordion-header");t&&!t.classList.contains("active")&&t.click()}}),300),n.showMessage("Product added successfully!","success")}))})).catch((function(e){var t;console.error("Error adding suggested product via DataService:",e),null!==(t=e.data)&&void 0!==t&&t.duplicate?(console.log("Duplicate suggested product detected by DataService:",e.data),n.showMessage(e.data.message||"This product already exists in this room.","error")):n.showError(e.message||"Error adding product. Please try again.")})).finally((function(){i&&(i.disabled=!1,i.classList.remove("loading"),i.textContent="Add"),n.hideLoading()}))}},{key:"bindSuggestedProductButtons",value:function(){var e=this;console.log("Binding suggested product buttons");var t=this.modal.querySelectorAll(".add-suggestion-to-room");t.length?(console.log("Found ".concat(t.length," suggestion buttons to bind")),t.forEach((function(t){t._suggestionButtonHandler&&t.removeEventListener("click",t._suggestionButtonHandler),t._suggestionButtonHandler=function(o){o.preventDefault(),o.stopPropagation();var i=t.dataset.productId,n=t.dataset.estimateId,a=t.dataset.roomId;console.log("Add suggestion button clicked:",{productId:i,estimateId:n,roomId:a}),i&&n&&a?e.handleAddSuggestedProduct(i,n,a,t):console.error("Missing required data attributes for adding suggested product")},t.addEventListener("click",t._suggestionButtonHandler)})),console.log("Suggestion buttons bound successfully")):console.log("No suggestion buttons found to bind")}},{key:"handleRoomRemoval",value:function(e,t){var o,i=this,n=this.modal.querySelector('.accordion-item[data-room-id="'.concat(t,'"]')),a=n&&(null===(o=n.querySelector(".room-name"))||void 0===o?void 0:o.textContent)||"room";this.showLoading(),console.log("Removing room with parameters:",{estimate_id:e,room_id:t}),this.dataService.removeRoom(e,t).then((function(t){console.log("Room removal response:",t),i.loadEstimatesList(null,e).then((function(){if(i.showMessage("".concat(a," removed successfully"),"success"),!1===t.has_rooms){console.log("Estimate has no rooms left after removal");var o=i.modal.querySelector('.estimate-section[data-estimate-id="'.concat(e,'"] .add-room'));o&&(o.classList.add("highlight-btn"),setTimeout((function(){o.classList.remove("highlight-btn")}),2e3))}})).catch((function(e){i.log("Error refreshing estimates list:",e),i.showError("Error refreshing estimates list. Please try again.")}))})).catch((function(e){i.log("Error removing room:",e),i.showError(e.message||"Error removing room. Please try again.")})).finally((function(){i.hideLoading()}))}},{key:"handleEstimateRemoval",value:function(e){var t=this;this.showLoading(),console.log("Attempting to remove estimate ID: ".concat(e)),this.dataService.removeEstimate(e).then((function(e){console.log("Estimate removal response:",e),t.loadEstimatesList().then((function(){t.showMessage("Estimate removed successfully","success")})).catch((function(e){console.error("Error refreshing estimates list:",e),t.showError("Error refreshing estimates list. Please try again.")}))})).catch((function(e){console.error("Error removing estimate:",e),t.showError(e.message||"Error removing estimate. Please try again.")})).finally((function(){t.hideLoading()}))}},{key:"bindProductRemovalEvents",value:function(){var e=this;console.log("Binding product removal events"),this.estimatesList&&(this._productRemovalHandler&&this.estimatesList.removeEventListener("click",this._productRemovalHandler),this._productRemovalHandler=function(t){var o=t.target.closest(".remove-product");if(o){t.preventDefault(),t.stopPropagation();var i=o.dataset.estimateId,n=o.dataset.roomId,a=o.dataset.productIndex;console.log("Remove product button clicked:",{estimateId:i,roomId:n,productIndex:a}),i&&n&&void 0!==a?e.confirmDelete("product",i,n,a):console.error("Missing data attributes for product removal")}},this.estimatesList.addEventListener("click",this._productRemovalHandler))}},{key:"bindRoomRemovalEvents",value:function(){var e=this;this.estimatesList&&(this._roomRemovalHandler&&this.estimatesList.removeEventListener("click",this._roomRemovalHandler),this._roomRemovalHandler=function(t){var o=t.target.closest(".remove-room");if(o){t.preventDefault(),t.stopPropagation();var i=o.dataset.estimateId,n=o.dataset.roomId;console.log("Remove room button clicked:",{estimateId:i,roomId:n}),i&&n&&e.confirmDelete("room",i,n)}},this.estimatesList.addEventListener("click",this._roomRemovalHandler))}},{key:"bindEstimateRemovalEvents",value:function(){var e=this;this.estimatesList&&(this._estimateRemovalHandler&&this.estimatesList.removeEventListener("click",this._estimateRemovalHandler),this._estimateRemovalHandler=function(t){var o=t.target.closest(".remove-estimate");if(o){t.preventDefault(),t.stopPropagation();var i=o.dataset.estimateId;console.log("Remove estimate button clicked:",{estimateId:i}),i&&e.confirmDelete("estimate",i)}},this.estimatesList.addEventListener("click",this._estimateRemovalHandler))}},{key:"confirmDelete",value:function(e,t,o,i){var n,a=this,s=(null===(n=window.productEstimatorVars)||void 0===n?void 0:n.i18n)||{},r=s.dialog_titles||{},c=s.dialog_messages||{},l="",d="",u="";switch(e){case"estimate":l=r.estimate||"Delete Estimate",d=c.estimate||"Are you sure you want to delete this estimate and all its rooms?",u=s.delete||"Delete";break;case"room":l=r.room||"Delete Room",d=c.room||"Are you sure you want to delete this room and all its products?",u=s.delete||"Delete";break;case"product":l=r.product||"Remove Product",d=c.product||"Are you sure you want to remove this product from the room?",u=s.remove||"Remove"}if(console.log("Confirming deletion of ".concat(e," - ID: ").concat("product"===e?i:"room"===e?o:t)),window.productEstimator&&window.productEstimator.dialog)window.productEstimator.dialog.show({title:l,message:d,type:e,confirmText:u,onConfirm:function(){switch(console.log("User confirmed deletion of ".concat(e)),e){case"estimate":a.handleEstimateRemoval(t);break;case"room":a.handleRoomRemoval(t,o);break;case"product":a.handleProductRemoval(t,o,i)}},onCancel:function(){console.log("User cancelled deletion of ".concat(e))}});else if(confirm(d))switch(e){case"estimate":this.handleEstimateRemoval(t);break;case"room":this.handleRoomRemoval(t,o);break;case"product":this.handleProductRemoval(t,o,i)}}},{key:"loadEstimateSelectionForm",value:function(){var e=this;return new Promise((function(t,o){e.estimateSelectionForm?(e.showLoading(),jQuery.ajax({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_estimate_selection_form",nonce:productEstimatorVars.nonce},success:function(i){if(i.success&&i.data.html)e.estimateSelectionForm.innerHTML=i.data.html,e.loadEstimatesData(),e.bindEstimateSelectionFormEvents(),t(i.data.html);else{var n=new Error("Failed to load estimate selection form");console.error(n),o(n)}},error:function(e){console.error("Error loading estimate selection form:",e),o(e)},complete:function(){e.hideLoading()}})):o(new Error("Estimate selection form container not found"))}))}},{key:"bindEstimateSelectionFormEvents",value:function(){var e=this;console.log("Binding estimate selection form events");var t=this.estimateSelectionForm.querySelector("form");if(t){console.log("Form found:",t),this._estimateFormSubmitHandler&&t.removeEventListener("submit",this._estimateFormSubmitHandler),this._estimateFormSubmitHandler=function(o){o.preventDefault(),console.log("Estimate selection form submitted"),e.handleEstimateSelection(t)},t.addEventListener("submit",this._estimateFormSubmitHandler);var o=t.querySelector("#create-estimate-btn");o&&(this._createEstimateHandler&&o.removeEventListener("click",this._createEstimateHandler),this._createEstimateHandler=function(){console.log("Create estimate button clicked"),e.showNewEstimateForm()},o.addEventListener("click",this._createEstimateHandler)),console.log("Form events bound successfully")}else console.error("Cannot bind events - form not found in estimate selection form")}},{key:"loadEstimatesData",value:function(){var e=this;this.showLoading(),this.dataService.getEstimatesData().then((function(t){e.estimateSelectionForm.querySelector("#estimate-dropdown")?(e.populateEstimateDropdown(t),e.hideLoading()):e.loadEstimateSelectionForm().then((function(){return e.populateEstimateDropdown(t)})).catch((function(t){e.log("Error loading estimate selection form:",t),e.showError("Error loading estimate selection form. Please try again.")})).finally((function(){e.hideLoading()}))})).catch((function(t){e.log("Error loading estimates data:",t),e.showError("Error loading estimates data. Please try again."),e.hideLoading()}))}},{key:"populateEstimateDropdown",value:function(e){var t=this.estimateSelectionForm?this.estimateSelectionForm.querySelector("#estimate-dropdown"):null;if(t){t.innerHTML="";var o=document.createElement("option");o.value="",o.textContent=productEstimatorVars.i18n.select_estimate||"-- Select an Estimate --",t.appendChild(o),Array.isArray(e)&&e.forEach((function(e){if(e){var o=e.rooms?Object.keys(e.rooms).length:0,i=1===o?"1 room":"".concat(o," rooms"),n=document.createElement("option");n.value=e.id,n.textContent="".concat(e.name||"Unnamed Estimate"," (").concat(i,")"),t.appendChild(n)}})),this.log("Populated dropdown with ".concat(e?e.length:0," estimates"))}else this.log("Estimate dropdown not found, cannot populate")}},{key:"showNewEstimateForm",value:function(){var e=this;this.estimatesList&&(this.estimatesList.style.display="none"),this.estimateSelection&&(this.estimateSelection.style.display="none"),this.forceElementVisibility(this.newEstimateForm),this.newEstimateForm.querySelector("form")?(this.hideLoading(),this.bindCancelButton(this.newEstimateForm,"estimate")):this.loadNewEstimateForm().finally((function(){e.hideLoading(),e.bindCancelButton(e.newEstimateForm,"estimate")}))}},{key:"bindCancelButton",value:function(e,t){var o=this;if(e){var i=e.querySelector(".cancel-btn");i?(i.removeEventListener("click",this._cancelFormHandler),this._cancelFormHandler=function(){console.log("Cancel button clicked for ".concat(t," form")),o.cancelForm(t)},i.addEventListener("click",this._cancelFormHandler),console.log("Cancel button bound for ".concat(t," form"))):console.warn("No cancel button found in ".concat(t," form"))}}},{key:"loadNewEstimateForm",value:function(){var e=this;return new Promise((function(t,o){e.showLoading(),jQuery.ajax({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_new_estimate_form",nonce:productEstimatorVars.nonce},success:function(i){if(i.success&&i.data.html){e.newEstimateForm.innerHTML=i.data.html,window.productEstimator&&window.productEstimator.core&&window.productEstimator.core.customerDetailsManager&&setTimeout((function(){window.productEstimator.core.customerDetailsManager.init()}),100);var n=e.newEstimateForm.querySelector("form");if(n){n.addEventListener("submit",(function(t){t.preventDefault(),e.handleNewEstimateSubmission(n)}));var a=n.querySelector(".cancel-btn");a&&a.addEventListener("click",(function(){e.cancelForm("estimate")}))}document.dispatchEvent(new CustomEvent("product_estimator_modal_loaded")),t(i.data.html)}else o(new Error("Failed to load new estimate form"))},error:function(e){console.error("Error loading new estimate form:",e),o(e)},complete:function(){e.hideLoading()}})}))}},{key:"showNewRoomForm",value:function(e){if(console.log("Showing new room form for estimate:",e),this.newRoomForm){this.newRoomForm.dataset.estimateId=e;var t=this.newRoomForm.querySelector("form");t&&(t.dataset.estimateId=e)}if(this.estimatesList&&(this.estimatesList.style.display="none"),this.estimateSelection&&(this.estimateSelection.style.display="none"),this.roomSelectionForm&&(this.roomSelectionForm.style.display="none"),this.forceElementVisibility(this.newRoomForm),this.newRoomForm.querySelector("form")){var o=this.newRoomForm.querySelector("form");o&&(o.dataset.estimateId=e)}else this.loadNewRoomForm(e)}},{key:"loadNewRoomForm",value:function(e){var t=this;return new Promise((function(o,i){t.showLoading(),jQuery.ajax({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_new_room_form",nonce:productEstimatorVars.nonce},success:function(n){if(n.success&&n.data.html){t.newRoomForm.innerHTML=n.data.html;var a=t.newRoomForm.querySelector("form");if(a){a.dataset.estimateId=e,t._newRoomFormSubmitHandler&&a.removeEventListener("submit",t._newRoomFormSubmitHandler),t._newRoomFormSubmitHandler=function(e){e.preventDefault(),console.log("New room form submitted"),t.handleNewRoomSubmission(a)},a.addEventListener("submit",t._newRoomFormSubmitHandler);var s=a.querySelector(".cancel-btn");s&&s.addEventListener("click",(function(){t.cancelForm("room")}))}o(n.data.html)}else i(new Error("Failed to load new room form"))},error:function(e){console.error("Error loading new room form:",e),i(e)},complete:function(){t.hideLoading()}})}))}},{key:"bindEstimateListEventHandlers",value:function(){var e=this;this.estimatesList?(this._addRoomButtonHandler&&this.estimatesList.removeEventListener("click",this._addRoomButtonHandler),this._addRoomButtonHandler=function(t){var o=t.target.closest(".add-room");if(o){t.preventDefault(),t.stopPropagation();var i=o.dataset.estimate;console.log("Add room button clicked for estimate:",i),i?e.showNewRoomForm(i):console.error("No estimate ID found for add room button")}},this.estimatesList.addEventListener("click",this._addRoomButtonHandler),console.log("Add room button event handler bound")):console.error("Cannot bind events - estimates list container not found")}},{key:"bindRoomSelectionFormEvents",value:function(){var e=this;console.log("Binding room selection form events");var t=this.roomSelectionForm.querySelector("form");if(t){console.log("Room selection form found:",t),this._roomFormSubmitHandler&&t.removeEventListener("submit",this._roomFormSubmitHandler),this._roomFormSubmitHandler=function(o){o.preventDefault(),console.log("Room selection form submitted"),e.handleRoomSelection(t)},t.addEventListener("submit",this._roomFormSubmitHandler);var o=t.querySelector(".back-btn");o&&(this._backButtonHandler&&o.removeEventListener("click",this._backButtonHandler),this._backButtonHandler=function(){console.log("Back button clicked"),e.forceElementVisibility(e.estimateSelectionForm),e.forceElementVisibility(e.estimateSelection),e.roomSelectionForm.style.display="none"},o.addEventListener("click",this._backButtonHandler));var i=t.querySelector("#add-new-room-from-selection");i?(this._addNewRoomHandler&&i.removeEventListener("click",this._addNewRoomHandler),this._addNewRoomHandler=function(){console.log("Add new room button clicked in form");var t=e.roomSelectionForm.dataset.estimateId;console.log("Estimate ID for new room:",t),t?e.showNewRoomForm(t):console.error("No estimate ID found for new room")},i.addEventListener("click",this._addNewRoomHandler),console.log("Add new room button handler bound")):console.warn("Add new room button not found in room selection form"),console.log("Room selection form events bound successfully")}else console.error("Cannot bind events - form not found in room selection form")}},{key:"handleEstimateSelection",value:function(e){var t=this,o=e.querySelector("#estimate-dropdown").value,i=this.currentProductId;o?(this.showLoading(),this.dataService.getRoomsForEstimate(o,i).then((function(e){if(t.estimateSelectionForm.style.display="none",e.has_rooms){var n=document.getElementById("room-dropdown");if(n){n.innerHTML="",n.appendChild(new Option("-- Select a Room --","")),e.rooms.forEach((function(e){n.appendChild(new Option("".concat(e.name," (").concat(e.dimensions,")"),e.id))})),t.roomSelectionForm.dataset.estimateId=o;var a=document.getElementById("add-new-room-from-selection");a&&(a.dataset.estimate=o),t.forceElementVisibility(t.roomSelectionForm),t.bindRoomSelectionFormEvents()}else t.loadRoomSelectionForm(o).then((function(){t.roomSelectionForm.dataset.estimateId=o,t.forceElementVisibility(t.roomSelectionForm),t.bindRoomSelectionFormEvents()})).catch((function(e){t.log("Error loading room selection form:",e),t.showError("Error loading room selection form. Please try again.")}))}else t.newRoomForm.dataset.estimateId=o,t.newRoomForm.dataset.productId=i,t.forceElementVisibility(t.newRoomForm)})).catch((function(e){t.log("Error getting rooms:",e),t.showError("Error getting rooms. Please try again.")})).finally((function(){t.hideLoading()}))):this.showError("Please select an estimate")}},{key:"loadRoomSelectionForm",value:function(e){var t=this;return new Promise((function(o,i){t.roomSelectionForm?(t.showLoading(),jQuery.ajax({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_room_selection_form",nonce:productEstimatorVars.nonce,estimate_id:e},success:function(n){if(n.success&&n.data.html)t.roomSelectionForm.innerHTML=n.data.html,t.roomSelectionForm.dataset.estimateId=e,t.bindRoomSelectionFormEvents(),o(n.data.html);else{var a=new Error("Failed to load room selection form");console.error(a),i(a)}},error:function(e){console.error("Error loading room selection form:",e),i(e)},complete:function(){t.hideLoading()}})):i(new Error("Room selection form container not found"))}))}},{key:"onCustomerDetailsUpdated",value:function(e){if(e.detail&&e.detail.details){var t;console.log("Customer details updated:",e.detail.details);var o=null===(t=this.modal)||void 0===t?void 0:t.querySelector("#new-estimate-form");if(o){var i=e.detail.details.email&&""!==e.detail.details.email.trim();o.setAttribute("data-has-email",i?"true":"false")}this.updateCustomerDetailsDisplay(e.detail.details)}}},{key:"updateCustomerDetailsDisplay",value:function(e){var t,o=null===(t=this.modal)||void 0===t?void 0:t.querySelectorAll(".customer-details-confirmation");o&&0!==o.length&&o.forEach((function(t){var o=t.querySelector(".saved-customer-details p");if(o){var i="";e.name&&""!==e.name.trim()&&(i+="<strong>".concat(e.name,"</strong><br>")),e.email&&""!==e.email.trim()&&(i+="".concat(e.email,"<br>")),e.phone&&""!==e.phone.trim()&&(i+="".concat(e.phone,"<br>")),i+=e.postcode||"",o.innerHTML=i;var n=t.querySelector("#edit-customer-name"),a=t.querySelector("#edit-customer-email"),s=t.querySelector("#edit-customer-phone"),r=t.querySelector("#edit-customer-postcode");n&&e.name&&(n.value=e.name),a&&e.email&&(a.value=e.email),s&&e.phone&&(s.value=e.phone),r&&e.postcode&&(r.value=e.postcode)}}))}},{key:"handleRoomSelection",value:function(e){var t=this,o=e.querySelector("#room-dropdown"),i=String(o&&o.value||"").trim(),n=String(this.currentProductId||"").trim(),a=String(this.roomSelectionForm.dataset.estimateId||"").trim();return null==i||""===i?(this.showError("Please select a room"),void console.error("Room selection requires a valid room ID but it was empty or invalid")):null==n||""===n||"0"===n?(this.showError("No product selected"),void console.error("Room selection requires a valid product ID but it was empty or invalid")):(console.log("Room selection validated with:",{roomId:i,productId:n,estimateId:a}),this.showLoading(),void this.dataService.addProductToRoom(i,n,a).then((function(e){console.log("Add product response:",e),t.estimateSelection.style.display="none",t.roomSelectionForm.style.display="none",delete t.modal.dataset.productId,t.currentProductId=null;var o=e.estimate_id||a,n=e.room_id||i;console.log("Product added to estimate ".concat(o,", room ").concat(n)),t.loadEstimatesList(n,o).then((function(){t.showMessage("Product added successfully!","success")})).catch((function(e){console.error("Error refreshing estimates list:",e),t.showError("Error refreshing estimates list. Please try again.")}))})).catch((function(e){var o;if(null!==(o=e.data)&&void 0!==o&&o.duplicate){console.log("Duplicate product detected:",e.data),t.estimateSelection.style.display="none",t.roomSelectionForm.style.display="none",delete t.modal.dataset.productId,t.currentProductId=null;var i=e.data.estimate_id,n=e.data.room_id;t.showError(e.data.message||"This product already exists in the selected room."),t.loadEstimatesList(n,i).then((function(){console.log("Estimates list refreshed to show duplicate product location"),setTimeout((function(){var e=t.modal.querySelector('.estimate-section[data-estimate-id="'.concat(i,'"]'));if(e&&e.classList.contains("collapsed")){e.classList.remove("collapsed");var o=e.querySelector(".estimate-content");o&&("undefined"!=typeof jQuery?jQuery(o).slideDown(200):o.style.display="block")}var a=t.modal.querySelector('.accordion-item[data-room-id="'.concat(n,'"]'));if(a){var s=a.querySelector(".accordion-header");if(s&&!s.classList.contains("active")){s.classList.add("active");var r=a.querySelector(".accordion-content");r&&("undefined"!=typeof jQuery?jQuery(r).slideDown(300,(function(){a[0].scrollIntoView({behavior:"smooth",block:"center"})})):(r.style.display="block",a.scrollIntoView({behavior:"smooth",block:"center"})))}else a.scrollIntoView({behavior:"smooth",block:"center"})}}),300)})).catch((function(e){console.error("Error refreshing estimates list:",e)}))}else{var a=e.message||"Error adding product to room. Please try again.";t.showError(a),console.error("DataService error:",e)}})).finally((function(){t.hideLoading()})))}},{key:"handleNewEstimateSubmission",value:function(e){var t=this,o=new FormData(e),i=this.currentProductId;o.get("estimate_name"),this.showLoading(),console.log("Submitting new estimate form"),console.log(o),this.dataService.addNewEstimate(o,i).then((function(n){console.log("New estimate created with ID:",n.estimate_id);var a={name:o.get("customer_name")||"",email:o.get("customer_email")||"",phone:o.get("customer_phone")||"",postcode:o.get("customer_postcode")||""};if(S(a),t.log("Customer details from new estimate form saved to localStorage:",a),e.reset(),t.newEstimateForm.style.display="none",i){var s=n.estimate_id;console.log("Setting new room form with estimate ID:",s),t.newRoomForm.dataset.estimateId=s;var r=t.newRoomForm.querySelector("form");r?(r.dataset.estimateId=s,console.log("Form dataset updated:",r.dataset)):console.error("Could not find room form element"),t.newRoomForm.dataset.productId=i,t.forceElementVisibility(t.newRoomForm),t.hideLoading()}else t.loadEstimatesList().catch((function(e){t.log("Error refreshing estimates list:",e),t.showError("Error refreshing estimates list. Please try again.")})).finally((function(){t.hideLoading()}))})).catch((function(e){t.log("Error creating estimate:",e),t.showError(e.message||"Error creating estimate. Please try again."),t.hideLoading()}))}},{key:"handleNewRoomSubmission",value:function(e,t){var o=this;if(console.log("Processing new room form submission via DataService"),t?t.preventDefault():void 0!==window.event&&window.event.preventDefault(),!e.checkValidity())return console.error("Form validation failed"),void e.reportValidity();var i=new FormData(e),n=e.dataset.estimateId,a=this.currentProductId||e.dataset.productId;console.log("Room form submission data:",{formElement:e,formDataset:e.dataset,containerDataset:this.newRoomForm.dataset,estimateId:n,productId:a,formData:Object.fromEntries(i)}),null!=n&&""!==n?(this.showLoading(),console.log("Calling DataService.addNewRoom for estimate ID:",n),this.dataService.addNewRoom(i,n,a).then((function(t){console.log("DataService.addNewRoom response:",t),e.reset(),o.newRoomForm.style.display="none",delete o.modal.dataset.productId,o.currentProductId=null;var i=t.estimate_id||n,a=t.room_id||"0";o.loadEstimatesList(a,i).then((function(){o.showMessage("Room added successfully!","success")})).catch((function(e){console.error("Error refreshing estimates list:",e),o.showError("Error refreshing estimates list. Please try again.")}))})).catch((function(e){console.error("Error adding room via DataService:",e),o.showError(e.message||"Error adding room. Please try again.")})).finally((function(){o.hideLoading()}))):this.showError("No estimate selected for this room.")}},{key:"cancelForm",value:function(e){var t=this;switch(console.log("Canceling form type: ".concat(e)),e){case"estimate":this.newEstimateForm&&(this.newEstimateForm.style.display="none"),this.currentProductId?this.dataService.checkEstimatesExist().then((function(e){e?(t.forceElementVisibility(t.estimateSelectionForm),t.forceElementVisibility(t.estimateSelection)):t.forceElementVisibility(t.estimatesList)})).catch((function(e){console.error("Error checking estimates:",e),t.forceElementVisibility(t.estimatesList)})):this.forceElementVisibility(this.estimatesList);break;case"room":this.newRoomForm&&(this.newRoomForm.style.display="none"),this.currentProductId&&this.roomSelectionForm.dataset.estimateId?(this.forceElementVisibility(this.roomSelectionForm),this.forceElementVisibility(this.estimateSelection)):this.forceElementVisibility(this.estimatesList);break;default:console.warn("Unknown form type: ".concat(e)),this.forceElementVisibility(this.estimatesList)}}},{key:"initializeEstimateAccordions",value:function(){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(document.querySelectorAll(".estimate-header").forEach((function(e){e._estimateAccordionHandler&&e.removeEventListener("click",e._estimateAccordionHandler),e._estimateAccordionHandler=function(t){if(!t.target.closest(".remove-estimate")){var o=e.closest(".estimate-section");if(o&&(o.classList.toggle("collapsed"),"undefined"!=typeof jQuery)){var i=o.querySelector(".estimate-content");i&&(o.classList.contains("collapsed")?jQuery(i).slideUp(200):jQuery(i).slideDown(200))}}},e.addEventListener("click",e._estimateAccordionHandler)})),e){var t=document.querySelector('.estimate-section[data-estimate-id="'.concat(e,'"]'));if(t&&t.classList.contains("collapsed")){if(t.classList.remove("collapsed"),"undefined"!=typeof jQuery){var o=t.querySelector(".estimate-content");o&&jQuery(o).slideDown(200)}window.productEstimatorVars&&window.productEstimatorVars.debug&&console.log("Auto-expanded estimate ID: ".concat(e))}}}},{key:"toggleEstimateAccordion",value:function(e){this.log("Toggling estimate accordion");var t=e.closest(".estimate-section");if(t){t.classList.toggle("collapsed");var o=t.querySelector(".estimate-content");o?t.classList.contains("collapsed")?(this.log("Collapsing estimate content"),"undefined"!=typeof jQuery?jQuery(o).slideUp(200):o.style.display="none"):(this.log("Expanding estimate content"),"undefined"!=typeof jQuery?jQuery(o).slideDown(200):o.style.display="block"):this.log("No estimate content found")}else this.log("No parent estimate section found")}},{key:"initializeAccordions",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.modal){if(this.accordionHandler&&this.estimatesList.removeEventListener("click",this.accordionHandler),this.accordionHandler=function(t){var o=t.target.closest(".accordion-header");if(o){t.preventDefault(),t.stopPropagation(),e.log("Accordion header clicked via delegation"),e.toggleAccordionItem(o);var i=o.closest(".accordion-item");if(i){var n=i.querySelector(".accordion-content");n&&"none"!==window.getComputedStyle(n).display&&setTimeout((function(){var t=n.querySelectorAll(".suggestions-carousel");t.length&&(e.log("Found ".concat(t.length," carousels in opened accordion")),v())}),100)}}},this.estimatesList&&(this.estimatesList.addEventListener("click",this.accordionHandler),this.log("Accordion event handler (re)attached"),t)){var i='.accordion-item[data-room-id="'.concat(t,'"]');o&&(i='.estimate-section[data-estimate-id="'.concat(o,'"] ').concat(i));var n=this.modal.querySelector(i);if(n){this.log("Found room element to expand: ".concat(i));var a=n.closest(".estimate-section");a&&(a.style.display="block");var s=n.querySelector(".accordion-header");if(s){s.classList.add("active");var r=n.querySelector(".accordion-content");r&&(r.style.display="block","undefined"!=typeof jQuery&&jQuery(r).show(300),setTimeout((function(){v()}),150)),setTimeout((function(){n.scrollIntoView({behavior:"smooth",block:"center"})}),150),this.log("Auto-expanded room ID: ".concat(t," in estimate: ").concat(o||"any"))}}else{this.log("Room ID ".concat(t," not found for auto-expansion"));var c=this.modal.querySelectorAll(".accordion-item[data-room-id]");this.log("Available rooms: ".concat(Array.from(c).map((function(e){return e.dataset.roomId})).join(", ")))}}}else console.error("[ModalManager] Modal not available for initializing accordions")}},{key:"toggleAccordionItem",value:function(e){this.log("Toggling accordion item"),e.classList.toggle("active");var t=e.closest(".accordion-item");if(t){var o=t.querySelector(".accordion-content");o?e.classList.contains("active")?(this.log("Opening accordion content"),"undefined"!=typeof jQuery?jQuery(o).slideDown(200):o.style.display="block"):(this.log("Closing accordion content"),"undefined"!=typeof jQuery?jQuery(o).slideUp(200):o.style.display="none"):this.log("No accordion content found")}else this.log("No parent accordion item found")}},{key:"initializeJQueryAccordions",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;"undefined"!=typeof jQuery?(jQuery(document).off("click",".accordion-header"),jQuery(document).on("click",".accordion-header",(function(e){e.preventDefault(),e.stopPropagation(),console.log("jQuery accordion handler triggered");var t=jQuery(this);t.toggleClass("active");var o=t.closest(".accordion-item").find(".accordion-content");o.length&&(t.hasClass("active")?o.slideDown(200):o.slideUp(200))})),e&&setTimeout((function(){var o='.accordion-item[data-room-id="'.concat(e,'"]');t&&(o='.estimate-section[data-estimate-id="'.concat(t,'"] ').concat(o)),console.log("Looking for room with selector: ".concat(o));var i=jQuery(o);if(i.length){console.log("Found room element using jQuery: ".concat(o));var n=i.closest(".estimate-section");n.length&&n.show();var a=i.find(".accordion-header");if(a.length){a.addClass("active");var s=i.find(".accordion-content");s.length&&s.slideDown(300,(function(){i[0].scrollIntoView({behavior:"smooth",block:"center"})})),console.log("jQuery auto-expanded room ID: ".concat(e," in estimate: ").concat(t||"any"))}}else console.warn("Room element not found with jQuery using selector: ".concat(o)),console.log("Available room elements:",jQuery(".accordion-item[data-room-id]").map((function(){return jQuery(this).data("roomId")})).get())}),300)):this.log("jQuery not available for fallback")}},{key:"updateEstimatesList",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.modal.querySelector(".estimate-section")){var i=this.modal.querySelector(".no-estimates");i&&(i.style.display="none")}else{var n=this.modal.querySelector(".no-estimates");if(n){n.style.display="block";var a=n.querySelector("#create-estimate-btn");a&&(this._createEstimateBtnHandler&&a.removeEventListener("click",this._createEstimateBtnHandler),this._createEstimateBtnHandler=function(){e.showNewEstimateForm()},a.addEventListener("click",this._createEstimateBtnHandler),console.log("Added event handler to existing create estimate button"))}}this.updateAllSuggestionsVisibility(),this.initializeEstimateAccordions(t,o),this.initializeAccordions(t,o),this.initializeCarousels(),this.bindReplaceProductButtons(),this.bindSuggestedProductButtons()}},{key:"updateSuggestionVisibility",value:function(e,t){var o=this.modal.querySelector('.accordion-item[data-room-id="'.concat(t,'"]'));if(o){var i=o.querySelectorAll(".product-item:not(.product-note-item)").length>0,n=o.querySelector(".product-suggestions");n&&(n.style.display=i?"block":"none")}}},{key:"updateAllSuggestionsVisibility",value:function(){this.modal.querySelectorAll(".accordion-item").forEach((function(e){var t,o=e.dataset.roomId,i=null===(t=e.closest(".estimate-section"))||void 0===t?void 0:t.dataset.estimateId;if(o&&i){var n=e.querySelectorAll(".product-item:not(.product-note-item)").length>0,a=e.querySelector(".product-suggestions");a&&(a.style.display=n?"block":"none")}}))}},{key:"showMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=this.contentContainer||document.querySelector(".product-estimator-modal-form-container");if(o){document.querySelectorAll(".modal-message").forEach((function(e){return e.remove()}));var i="error"===t?"modal-error-message":"modal-success-message",n=document.createElement("div");n.className="modal-message ".concat(i),n.textContent=e;try{o.prepend(n)}catch(e){console.error("Error adding message to container:",e)}setTimeout((function(){n.parentNode&&n.remove()}),5e3)}else console.error("Form container not found for message display:",e)}},{key:"showError",value:function(e){this.showMessage(e,"error")}},{key:"on",value:function(e,t){return this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t),this}},{key:"emit",value:function(e,t){return this.eventHandlers[e]&&this.eventHandlers[e].forEach((function(e){return e(t)})),this}},{key:"checkModalElements",value:function(){console.group("🔍 MODAL ELEMENTS CHECK");var e=function(e,t){var o=document.querySelectorAll(e);return console.log("".concat(t,": ").concat(o.length," elements found")),o.length};e("#product-estimator-modal","Modal container"),e(".product-estimator-modal-form-container","Form container"),e("#estimates","Estimates list"),e("#estimate-selection-wrapper","Estimate selection"),e("#estimate-selection-form-wrapper","Estimate selection form"),e("#new-estimate-form-wrapper","New estimate form");var t=document.querySelector("#estimate-selection-wrapper");t?console.log("Estimate selection container:",{display:t.style.display,computedDisplay:window.getComputedStyle(t).display,visibility:window.getComputedStyle(t).visibility,opacity:window.getComputedStyle(t).opacity,parent:t.parentElement?t.parentElement.tagName:"none"}):console.warn("Estimate selection container not found"),console.groupEnd()}},{key:"bindReplaceProductButtons",value:function(){var e=this,t=this.modal.querySelectorAll(".replace-product-in-room");t.length?(t.forEach((function(t,o){console.log("[BUTTON BINDING] Button #".concat(o+1," attributes:"),{productId:t.dataset.productId,estimateId:t.dataset.estimateId,roomId:t.dataset.roomId,replaceProductId:t.dataset.replaceProductId,replaceType:t.dataset.replaceType||"main"}),t._replaceButtonHandler&&t.removeEventListener("click",t._replaceButtonHandler),t._replaceButtonHandler=function(o){o.preventDefault(),o.stopPropagation();var i=t.dataset.productId,n=t.dataset.estimateId,a=t.dataset.roomId,s=t.dataset.replaceProductId,r=t.dataset.parentProductId||null,c=t.hasAttribute("data-replace-type")?t.getAttribute("data-replace-type"):"main";console.log("[BUTTON CLICKED] Replace product button clicked:",{estimateId:n,roomId:a,oldProductId:s,newProductId:i,replaceType:c}),e.handleReplaceProduct(n,a,s,i,r,t,c)},t.addEventListener("click",t._replaceButtonHandler)})),console.log("[BUTTON BINDING] Replace product buttons bound successfully")):console.log("[BUTTON BINDING] No replace product buttons found to bind")}},{key:"handleReplaceProduct",value:function(e,t,o,i,n,a){var s=this,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"main";console.log("[PRODUCT REPLACEMENT] Starting product replacement process\n    Type: ".concat(r,"\n    Old Product ID: ").concat(o,"\n    New Product ID: ").concat(i,"\n    Parent Product ID: ").concat(n," // Log parent product ID\n    Room ID: ").concat(t,"\n    Estimate ID: ").concat(e,"\n  "));var c="this product",l="the selected product";try{if(a){var d=a.closest(".suggestion-item, .upgrade-tile");if(d){var u=d.querySelector(".suggestion-name, .tile-label");u&&(l=u.textContent.trim())}if("additional_products"===r){console.log("Looking for additional product name to replace");var m=a.closest(".product-item");if(m){var h=m.querySelectorAll(".include-item");console.log("Found ".concat(h.length," include items to search through"));var g,p=function(e,t){var o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=function(e,t){if(e){if("string"==typeof e)return k(e,t);var o={}.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?k(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){o&&(e=o);var i=0,n=function(){};return{s:n,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,r=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return s=e.done,e},e:function(e){r=!0,a=e},f:function(){try{s||null==o.return||o.return()}finally{if(r)throw a}}}}(h);try{for(p.s();!(g=p.n()).done;){var f=g.value,v=f.querySelector(".include-item-name");if(v){var y=f.closest("[data-product-id]");if(y&&y.dataset.productId===o){c=v.textContent.trim(),console.log("Found matching additional product: ".concat(c));break}c=v.textContent.trim()}}}catch(e){p.e(e)}finally{p.f()}}}else{var w=a.closest(".product-item");if(w){var E=w.querySelector(".product-name, .price-title");E&&(c=E.textContent.trim(),console.log("Found main product name: ".concat(c)))}}}}catch(e){console.warn("Could not determine product names for confirmation dialog:",e)}var b='Are you sure you want to replace "'.concat(c,'" with "').concat(l,'"?');window.productEstimator&&window.productEstimator.dialog?window.productEstimator.dialog.show({title:"Confirm Upgrade",message:b,type:"product",action:"upgrade_product",confirmText:"Upgrade",cancelText:"Cancel",onConfirm:function(){s.executeProductReplacement(e,t,o,i,n,a,r)},onCancel:function(){a&&(a.disabled=!1,a.classList.remove("loading"),a.textContent="Upgrade"),console.log("Product upgrade cancelled")}}):confirm(b)?this.executeProductReplacement(e,t,o,i,n,a,r):a&&(a.disabled=!1,a.classList.remove("loading"),a.textContent="Upgrade")}},{key:"reloadAndExpandEstimatesList",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new Promise((function(n,a){o.showLoading(),console.log("Reloading estimates list with expansion params - Room: ".concat(e,", Estimate: ").concat(t,", Product: ").concat(i)),o.loadEstimatesList(e,t).then((function(){setTimeout((function(){var n=o.modal.querySelector('.estimate-section[data-estimate-id="'.concat(t,'"]'));if(n){console.log("Found estimate section: ".concat(t)),n.classList.remove("collapsed");var a=n.querySelector(".estimate-content");a&&(a.style.display="block")}setTimeout((function(){var n=o.modal.querySelector('.accordion-item[data-room-id="'.concat(e,'"][data-estimate-id="').concat(t,'"]'))||o.modal.querySelector('.accordion-item[data-room-id="'.concat(e,'"]'));if(n){console.log("Found and expanding room: ".concat(e));var a=n.querySelector(".accordion-header");a&&a.classList.add("active");var s=n.querySelector(".accordion-content");s&&(s.style.display="block",setTimeout((function(){v(),i?s.querySelectorAll(".product-item").forEach((function(e){(e.dataset.productId===i||e.querySelector('[data-product-id="'.concat(i,'"]')))&&(e.classList.add("highlight-product"),setTimeout((function(){e.classList.remove("highlight-product")}),2e3),e.scrollIntoView({behavior:"smooth",block:"center"}))})):n.scrollIntoView({behavior:"smooth",block:"center"})}),150))}else console.warn("Room ID ".concat(e," not found for auto-expansion"))}),150),console.warn("Estimate ID ".concat(t," not found for auto-expansion"))})),n()})).catch((function(e){console.error("Error reloading estimates list:",e),a(e)})).finally((function(){o.hideLoading()}))}))}},{key:"executeProductReplacement",value:function(e,t,o,i,n,a){var s=this,r=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"main";this.showLoading(),a&&(a.disabled=!0,a.classList.add("loading"),a.innerHTML='<span class="loading-dots">Upgrading...</span>'),console.log("[PRODUCT REPLACEMENT] Executing replacement via DataService:\n  Type: ".concat(r,"\n  Old Product ID: ").concat(o,"\n  New Product ID: ").concat(i,"\n  Room ID: ").concat(t,"\n  Parent Product ID: ").concat(n,"\n  Estimate ID: ").concat(e)),this.dataService.replaceProductInRoom(e,t,o,i,n,r).then((function(n){console.log("[PRODUCT REPLACEMENT] Server response (data payload):",n),window._productReplacementChains=window._productReplacementChains||{},window._productReplacementChains["".concat(t,"_").concat(i)]=n.replacement_chain||[],console.log("[PRODUCT REPLACEMENT] Just stored replacement chain, attempting to load estimates list..."),s.loadEstimatesList(t,e).then((function(){console.log("[PRODUCT REPLACEMENT] Estimates list refreshed");var n=s.modal.querySelector('.estimate-section[data-estimate-id="'.concat(e,'"]'));if(n){n.classList.remove("collapsed");var a=n.querySelector(".estimate-content");a&&("undefined"!=typeof jQuery?jQuery(a).slideDown(200):a.style.display="block")}var c=s.modal.querySelector('.accordion-item[data-room-id="'.concat(t,'"][data-estimate-id="').concat(e,'"]'))||s.modal.querySelector('.accordion-item[data-room-id="'.concat(t,'"]'));if(c){console.log("[PRODUCT REPLACEMENT] Found room element, expanding");var l=c.querySelector(".accordion-header");l&&l.classList.add("active");var d=c.querySelector(".accordion-content");d?("undefined"!=typeof jQuery?jQuery(d).slideDown(300,(function(){c.scrollIntoView({behavior:"smooth",block:"center"})})):(d.style.display="block",c.scrollIntoView({behavior:"smooth",block:"center"})),"additional_products"===r&&s.updateAdditionalProductUpgradeButtons(c,i,o),setTimeout((function(){v(),s.bindReplaceProductButtons(),s.bindSuggestedProductButtons(),s.updateAllReplacementChains(c),s.showMessage("Product upgraded successfully!","success")}),300)):(console.warn("[PRODUCT REPLACEMENT] Room content element not found."),s.showMessage("Product upgraded successfully!","success"))}else console.warn("[PRODUCT REPLACEMENT] Could not find room element for room ID ".concat(t)),s.showMessage("Product upgraded successfully!","success")})).catch((function(e){console.error("[PRODUCT REPLACEMENT] Error refreshing estimates list:",e),s.showError("Error refreshing list after upgrade. Please try again.")}))})).catch((function(e){console.error("[PRODUCT REPLACEMENT] DataService request failed:",e),s.showError(e.message||"Error upgrading product. Please try again.")})).finally((function(){a&&(a.disabled=!1,a.classList.remove("loading"),a.textContent="Upgrade"),s.hideLoading()}))}},{key:"updateAllReplacementChains",value:function(e){e&&window._productReplacementChains&&(console.log("[REPLACEMENT CHAINS] Updating all buttons with replacement chains"),e.querySelectorAll('button.replace-product-in-room[data-replace-type="additional_products"]').forEach((function(e){var t=e.dataset.productId,o=e.dataset.roomId,i=(e.dataset.replaceProductId,"".concat(o,"_").concat(t)),n=window._productReplacementChains[i];n&&(console.log("[REPLACEMENT CHAINS] Found chain for ".concat(i,":"),n),e.dataset.replacementChain=JSON.stringify(n),console.log("[REPLACEMENT CHAINS] Updated button ".concat(e.textContent," with chain data")))})))}},{key:"updateAdditionalProductUpgradeButtons",value:function(e,t,o){if(e){console.log("Updating additional product upgrade buttons: newProductId=".concat(t,", oldProductId=").concat(o));var i=e.querySelectorAll('button.replace-product-in-room[data-replace-product-id="'.concat(o,'"][data-replace-type="additional_products"]'));i.length>0?(console.log("Found ".concat(i.length," additional product upgrade buttons to update")),i.forEach((function(e){console.log("Updating button data-replace-product-id from ".concat(o," to ").concat(t)),e.dataset.replaceProductId=t}))):console.log("No additional product upgrade buttons found that need updating"),e.querySelectorAll('.product-upgrades[data-product-id="'.concat(o,'"]')).forEach((function(e){e.dataset.productId=t,console.log("Updated product-upgrades container data-product-id from ".concat(o," to ").concat(t))}))}}},{key:"updateUpgradeButtonProductIds",value:function(e,t,o){if(e){console.log("Updating upgrade buttons: replacing ".concat(t," with ").concat(o));var i=e.querySelectorAll('button.replace-product-in-room[data-replace-product-id="'.concat(t,'"]'));i.length>0?(console.log("Found ".concat(i.length," upgrade buttons to update")),i.forEach((function(e){e.dataset.replaceProductId=o,console.log("Updated button to use new product ID: ".concat(o))}))):console.log("No upgrade buttons found that need updating")}}},{key:"log",value:function(){if(this.config.debug){for(var e,t=arguments.length,o=new Array(t),i=0;i<t;i++)o[i]=arguments[i];(e=console).log.apply(e,["[EstimatorCore]"].concat(o))}}}])}();const C=_,P=function(){return n((function t(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,t),this.config=Object.assign({debug:!0,selectors:{variationsForm:".variations_form",estimatorButton:".single_add_to_estimator_button, .button.alt.open-estimator-modal, .product-estimator-button, [data-product-id]",variationIdInput:'input[name="variation_id"]'}},o),this.variationsForm=document.querySelector(this.config.selectors.variationsForm),this.estimatorButton=document.querySelector(this.config.selectors.estimatorButton),this.variationIdInput=this.variationsForm?this.variationsForm.querySelector(this.config.selectors.variationIdInput):null,this.variationsData=window.product_estimator_variations||{},this.currentVariationId=null,this.initialized=!1,this.eventHandlers={},this.variationsForm?this.init():this.log("No variations form found, VariationHandler not initialized")}),[{key:"init",value:function(){if(this.initialized)return this.log("VariationHandler already initialized"),this;if(this.log("Initializing VariationHandler with variations data:",this.variationsData),this.log("Estimator button found:",!!this.estimatorButton),this.estimatorButton){this.log("Initial button data-product-id:",this.estimatorButton.dataset.productId);var e=this.estimatorButton.dataset.productId;e&&this.isParentEstimatorEnabled(e)&&(this.log("Parent product has estimator enabled, ensuring button is visible"),this.estimatorButton.style.display="",this.estimatorButton.classList.remove("hidden"))}return this.bindEvents(),this.checkCurrentVariation(),this.initialized=!0,this.log("VariationHandler initialized"),this.emit("initialized"),this}},{key:"ensureEstimatorButton",value:function(e){if(this.log("Ensuring estimator button exists for variation: ".concat(e)),document.querySelector(this.config.selectors.estimatorButton))return this.log("Estimator button already exists, updating visibility"),void this.updateEstimatorButton(!0,e);if(this.isEstimatorEnabled(e)){this.log("Creating estimator button dynamically");var t=document.querySelector(".single_add_to_cart_button");if(t){var o=document.createElement("button");o.type="button",o.className="single_add_to_estimator_button button alt open-estimator-modal",o.dataset.productId=e,o.textContent="Add to Estimate",t.insertAdjacentElement("afterend",o),this.log("Estimator button created and inserted")}else this.log("Cannot find add to cart button to insert after")}else this.log("Estimator not enabled for this variation, not creating button")}},{key:"isParentEstimatorEnabled",value:function(e){if(document.querySelector(".single_add_to_estimator_button"))return!0;var t=document.querySelector('input[name="_enable_estimator"], [data-enable-estimator]');return!!t&&("yes"===t.value||"yes"===t.dataset.enableEstimator)}},{key:"bindEvents",value:function(){var e=this;this.variationsForm&&(this.log("Binding variation events"),this.variationsForm.addEventListener("found_variation",this.handleFoundVariation.bind(this)),this.variationsForm.addEventListener("reset_data",this.handleResetVariation.bind(this)),this.variationsForm.addEventListener("check_variations",this.handleCheckVariations.bind(this)),document.addEventListener("woocommerce_variation_has_changed",this.checkCurrentVariation.bind(this)),this.variationIdInput&&this.variationIdInput.addEventListener("change",(function(){var t=e.variationIdInput.value;if(t){e.log("Variation ID input changed to: ".concat(t)),e.currentVariationId=t;var o=e.isEstimatorEnabled(t);e.updateEstimatorButton(o,t)}})),"undefined"!=typeof jQuery&&jQuery(this.variationsForm).on("change",'input[name="variation_id"]',(function(t){var o=t.target.value;if(o){e.log("jQuery variation ID change detected: ".concat(o)),e.currentVariationId=o;var i=e.isEstimatorEnabled(o);e.updateEstimatorButton(i,o)}})))}},{key:"handleFoundVariation",value:function(e){var t=void 0!==e.detail?e.detail:e.target.variation;if(t&&t.variation_id){var o=t.variation_id;this.currentVariationId=o,this.log("Found variation: ".concat(o));var i=this.isEstimatorEnabled(o);this.log("Variation ".concat(o," has estimator enabled: ").concat(i)),this.ensureEstimatorButton(o),this.updateEstimatorButton(i,o),this.emit("variation:changed",{variationId:o,enableEstimator:i,variation:t})}else this.log("Found variation event received but no valid variation data")}},{key:"handleResetVariation",value:function(){this.log("Reset variation"),this.currentVariationId=null,this.updateEstimatorButton(!1),this.emit("variation:reset")}},{key:"handleCheckVariations",value:function(){this.log("Check variations"),this.checkCurrentVariation()}},{key:"checkCurrentVariation",value:function(){var e=this;if(this.variationsForm){var t=document.querySelectorAll(this.config.selectors.estimatorButton);this.log("Found ".concat(t.length," estimator buttons during checkCurrentVariation")),t.length>1&&(this.log("WARNING: Found multiple estimator buttons - this may cause issues. Check for duplicates."),t.forEach((function(t,o){e.log("Button ".concat(o+1," HTML: ").concat(t.outerHTML))})));var o=this.getCurrentVariation();if(o){this.log("Current variation detected: ".concat(o.variation_id)),this.currentVariationId=o.variation_id;var i=this.isEstimatorEnabled(o.variation_id);this.updateEstimatorButton(i,o.variation_id)}else this.log("No current variation detected"),this.currentVariationId=null,this.updateEstimatorButton(this.isParentProductEstimatorEnabled())}}},{key:"isParentProductEstimatorEnabled",value:function(){return void 0===window.product_estimator_variations||!window.product_estimator_variations._parent_enabled||"yes"===window.product_estimator_variations._parent_enabled}},{key:"getCurrentVariation",value:function(){if(!this.variationsForm)return null;if(this.variationsForm.currentVariation)return this.variationsForm.currentVariation;var e=this.variationsForm.querySelector('input[name="variation_id"]');if(e&&e.value)return{variation_id:e.value};var t=this.variationsForm.dataset.productVariations;if(t)return{variation_id:t};if("undefined"!=typeof jQuery){var o=jQuery(this.variationsForm),i=(o.data("product_variations"),o.find('input[name="variation_id"]').val());if(i)return{variation_id:i}}return null}},{key:"isEstimatorEnabled",value:function(e){if(!e)return!1;if(this.log("Checking if estimator is enabled for variation: ".concat(e)),this.log("Available variations data:",this.variationsData),this.variationsData[e]){var t="yes"===this.variationsData[e].enable_estimator;return this.log("Found variation data, estimator enabled: ".concat(t)),t}var o=document.querySelector(".single_add_to_estimator_button[data-product-id]:not([data-variation-id])");if(o){var i=!o.classList.contains("hidden")&&"none"!==getComputedStyle(o).display;return this.log("Using parent product as fallback, estimator enabled: ".concat(i)),i}return this.log("No variation or parent data found, estimator disabled by default"),!1}},{key:"updateEstimatorButton",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=document.querySelector(".single_add_to_estimator_button");o?(this.log("Updating button visibility: ".concat(e?"show":"hide",", variation ID: ").concat(t)),e?(o.style.display="",t&&(this.log("Setting button data-product-id to variation ID: ".concat(t)),o.dataset.productId=t)):(o.style.display="none",this.log("Hiding estimator button"))):this.log("Estimator button not found")}},{key:"on",value:function(e,t){return this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t),this}},{key:"emit",value:function(e,t){return this.eventHandlers[e]&&this.eventHandlers[e].forEach((function(e){return e(t)})),this}},{key:"log",value:function(){if(this.config.debug){for(var e,t=arguments.length,o=new Array(t),i=0;i<t;i++)o[i]=arguments[i];(e=console).log.apply(e,["[VariationHandler]"].concat(o))}}}])}();var I=function(){return n((function t(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0;e(this,t),this.config=Object.assign({debug:!1,selectors:{editButton:"#edit-customer-details-btn",deleteButton:"#delete-customer-details-btn",saveButton:"#save-customer-details-btn",cancelButton:"#cancel-edit-customer-details-btn",detailsContainer:".saved-customer-details",detailsHeader:".customer-details-header",editForm:".customer-details-edit-form",formContainer:".product-estimator-modal-form-container"},i18n:{}},o),this.dataService=i,this.initialized=!1,this.eventHandlers={},!1!==o.autoInit&&this.init()}),[{key:"init",value:function(){return this.initialized?(this.log("CustomerDetailsManager already initialized"),this):(this.bindEvents(),document.addEventListener("customer_details_updated",this.onCustomerDetailsUpdated.bind(this)),this.initialized=!0,this.log("CustomerDetailsManager initialized"),this)}},{key:"onCustomerDetailsUpdated",value:function(e){e.detail&&e.detail.details&&(this.log("Received customer_details_updated event",e.detail),this.updateDisplayedDetails(e.detail.details),this.checkAndUpdateEmailField(e.detail.details))}},{key:"checkAndUpdateEmailField",value:function(e){var t=this,o=e&&e.email&&""!==e.email.trim();this.log("Checking for email field updates: hasEmail=".concat(o)),document.querySelectorAll(this.config.selectors.editForm).forEach((function(i){var n=i.querySelector("#edit-customer-email");if(!n&&o){t.log("Adding email field to edit form");var a=document.createElement("div");a.className="form-group";var s=document.createElement("label");s.setAttribute("for","edit-customer-email"),s.textContent="Email Address",(n=document.createElement("input")).type="email",n.id="edit-customer-email",n.name="edit_customer_email",n.value=e.email,a.appendChild(s),a.appendChild(n);var r=i.querySelector("#edit-customer-name");if(r){var c=r.closest(".form-group");c?c.parentNode.insertBefore(a,c.nextSibling):i.querySelector("h4").after(a)}}else n&&o&&(n.value=e.email);var l=i.querySelector("#edit-customer-name");l&&e.name&&(l.value=e.name);var d=i.querySelector("#edit-customer-phone");d&&e.phone&&(d.value=e.phone);var u=i.querySelector("#edit-customer-postcode");u&&e.postcode&&(u.value=e.postcode)})),document.querySelectorAll("#new-estimate-form").forEach((function(e){e.setAttribute("data-has-email",o?"true":"false")}))}},{key:"bindEvents",value:function(){var e=document.querySelector(this.config.selectors.editButton),t=document.querySelector(this.config.selectors.deleteButton),o=document.querySelector(this.config.selectors.saveButton),i=document.querySelector(this.config.selectors.cancelButton);e?(this.bindButtonWithHandler(e,"click",this.handleEditClick.bind(this)),t&&this.bindButtonWithHandler(t,"click",this.handleDeleteClick.bind(this)),o&&this.bindButtonWithHandler(o,"click",this.handleSaveClick.bind(this)),i&&this.bindButtonWithHandler(i,"click",this.handleCancelClick.bind(this))):this.log("Edit button not found, skipping event binding")}},{key:"bindButtonWithHandler",value:function(e,t,o){if(e){var i="_".concat(t,"Handler");e[i]&&e.removeEventListener(t,e[i]),e[i]=o,e.addEventListener(t,o)}}},{key:"handleEditClick",value:function(e){e.preventDefault(),e.stopPropagation();var t=document.querySelector(this.config.selectors.detailsContainer),o=document.querySelector(this.config.selectors.detailsHeader),i=document.querySelector(this.config.selectors.editForm);t&&(t.style.display="none"),o&&(o.style.display="none"),i&&(i.style.display="block"),this.log("Edit form displayed")}},{key:"handleCancelClick",value:function(e){e.preventDefault(),e.stopPropagation();var t=document.querySelector(this.config.selectors.detailsContainer),o=document.querySelector(this.config.selectors.detailsHeader),i=document.querySelector(this.config.selectors.editForm);i&&(i.style.display="none"),t&&(t.style.display="block"),o&&(o.style.display="flex"),this.log("Edit form hidden")}},{key:"handleSaveClick",value:function(e){var t,o,i=this;e.preventDefault(),e.stopPropagation();var n=e.target,a=n.textContent;n.textContent=this.config.i18n&&this.config.i18n.saving||"Saving...",n.disabled=!0;var s={name:(null===(t=document.getElementById("edit-customer-name"))||void 0===t?void 0:t.value)||"",postcode:(null===(o=document.getElementById("edit-customer-postcode"))||void 0===o?void 0:o.value)||""},r=document.getElementById("edit-customer-email");r&&(s.email=r.value||"");var c=document.getElementById("edit-customer-phone");c&&(s.phone=c.value||"");try{S(s),this.log("Customer details saved to localStorage:",s),this.dataService.request("update_customer_details",{details:JSON.stringify(s)}).then((function(e){i.log("Customer details updated on server successfully:",e),i.handleSaveSuccess(e,s)})).catch((function(e){i.handleSaveError(e)})).finally((function(){n.textContent=a,n.disabled=!1}))}catch(e){this.log("Error saving to localStorage using imported function:",e),this.showError("Could not save details locally."),this.dataService.request("update_customer_details",{details:JSON.stringify(s)}).then((function(e){i.log("Customer details updated on server successfully (after local storage error):",e),i.handleSaveSuccess(e,s)})).catch((function(e){i.handleSaveError(e)})).finally((function(){n.textContent=a,n.disabled=!1}))}}},{key:"handleSaveSuccess",value:function(e,t){this.updateDisplayedDetails(t),this.checkAndUpdateEmailField(t),this.showMessage("success",e.message||"Details updated successfully!");var o=document.querySelector(this.config.selectors.detailsContainer),i=document.querySelector(this.config.selectors.detailsHeader),n=document.querySelector(this.config.selectors.editForm);n&&(n.style.display="none"),o&&(o.style.display="block"),i&&(i.style.display="flex");var a=new CustomEvent("customer_details_updated",{bubbles:!0,detail:{details:t}});document.dispatchEvent(a),this.log("Customer details updated successfully",e)}},{key:"handleSaveError",value:function(e){this.showMessage("error",e.message||"Error updating details. Please try again."),this.log("Error saving customer details:",e)}},{key:"handleDeleteClick",value:function(e){var t=this;e.preventDefault(),e.stopPropagation(),window.productEstimator&&window.productEstimator.dialog?window.productEstimator.dialog.show({title:this.config.i18n&&this.config.i18n.delete_customer_details||"Delete Customer Details",message:this.config.i18n&&this.config.i18n.confirm_delete_details||"Are you sure you want to delete your saved details?",confirmText:this.config.i18n&&this.config.i18n.delete||"Delete",action:"delete",cancelText:this.config.i18n.cancel||"Cancel",onConfirm:function(){t.deleteCustomerDetails()}}):confirm(this.config.i18n.confirm_delete_details||"Are you sure you want to delete your saved details?")&&this.deleteCustomerDetails()}},{key:"deleteCustomerDetails",value:function(){var e,t,o=this,i=document.querySelector(".customer-details-confirmation");i&&i.classList.add("loading");try{L(),this.log("Customer details removed from localStorage using imported function"),this.handleDeleteSuccess({message:"Details deleted successfully from local storage"},i)}catch(e){this.log("localStorage error on delete using imported function",e)}this.dataService&&"function"==typeof this.dataService.request?this.dataService.request("delete_customer_details").then((function(e){o.handleDeleteSuccess(e,i)})).catch((function(e){o.handleDeleteError(e,i)})):fetch((null===(e=window.productEstimatorVars)||void 0===e?void 0:e.ajax_url)||"/wp-admin/admin-ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"delete_customer_details",nonce:(null===(t=window.productEstimatorVars)||void 0===t?void 0:t.nonce)||""})}).then((function(e){return e.json()})).then((function(e){var t;e.success?o.handleDeleteSuccess(e.data,i):o.handleDeleteError(new Error((null===(t=e.data)||void 0===t?void 0:t.message)||"Error deleting details"),i)})).catch((function(e){o.handleDeleteError(e,i)}))}},{key:"handleDeleteSuccess",value:function(e,t){if(t&&e.html){var o=document.createElement("div");o.innerHTML=e.html,t.parentNode.replaceChild(o.firstElementChild,t)}this.showMessage("success",e.message||"Details deleted successfully!");var i=document.querySelector("#new-estimate-form");i&&i.setAttribute("data-has-email","false");var n=new CustomEvent("customer_details_deleted",{bubbles:!0});document.dispatchEvent(n),this.log("Customer details deleted")}},{key:"handleDeleteError",value:function(e,t){this.showMessage("error",e.message||"Error deleting details!"),this.log("Error deleting details:",e),t&&t.classList.remove("loading")}},{key:"updateDisplayedDetails",value:function(e){var t=document.querySelectorAll(this.config.selectors.detailsContainer);t.length?(this.log("Updating ".concat(t.length," customer details containers")),t.forEach((function(t){var o="<p>";e.name&&""!==e.name.trim()&&(o+="<strong>".concat(e.name,"</strong><br>")),e.email&&""!==e.email.trim()&&(o+="".concat(e.email,"<br>")),e.phone&&""!==e.phone.trim()&&(o+="".concat(e.phone,"<br>")),o+=e.postcode||"",o+="</p>",t.innerHTML=o}))):this.log("No customer details containers found for updating")}},{key:"showMessage",value:function(e,t){document.querySelectorAll(".modal-message").forEach((function(e){return e.remove()}));var o="error"===e?"modal-error-message":"modal-success-message",i=document.createElement("div");i.className="modal-message ".concat(o),i.textContent=t;var n=document.querySelector(this.config.selectors.formContainer);n&&(n.prepend(i),setTimeout((function(){i.remove()}),5e3))}},{key:"log",value:function(){if(this.config.debug){for(var e,t=arguments.length,o=new Array(t),i=0;i<t;i++)o[i]=arguments[i];(e=console).log.apply(e,["[CustomerDetailsManager]"].concat(o))}}}])}();const D=I;var q=function(){return n((function t(){var o,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,t),this.config=Object.assign({debug:!1,selectors:{estimatorButtons:".product-estimator-button, .single_add_to_estimator_button, .open-estimator-modal",estimatorMenuButtons:".product-estimator-menu-item a, a.product-estimator-menu-item",modalContainer:"#product-estimator-modal"},autoInit:!0,i18n:(null===(o=window.productEstimatorVars)||void 0===o?void 0:o.i18n)||{}},i),this.dataService=null,this.modalManager=null,this.variationHandler=null,this.customerDetailsManager=null,this.initialized=!1,this.eventHandlers={},this.config.autoInit&&this.init()}),[{key:"init",value:function(){var e=this;if(this.initialized)return this.log("EstimatorCore already initialized - aborting"),this;if(window._productEstimatorInitialized&&window.productEstimator&&window.productEstimator.core)return this.log("EstimatorCore detected as already initialized globally - aborting"),this.initialized=!0,this;this.log("Initializing EstimatorCore");try{if("undefined"==typeof jQuery)return console.error("jQuery is not loaded, cannot initialize EstimatorCore"),this;this.dataService||(this.dataService=new p({debug:this.config.debug})),console.log("%c=== PRODUCT ESTIMATOR INITIALIZATION START ===","background: #f0f0f0; color: #333; padding: 3px; border-radius: 3px;");var t=function(){e.modalManager?e.log("Components already initialized - skipping"):(e.modalManager=new C({debug:e.config.debug,selectors:e.config.selectors},e.dataService),e.customerDetailsManager=new D({debug:e.config.debug},e.dataService),e.isWooCommerceProductPage()&&(e.log("WooCommerce product page detected, initializing VariationHandler"),e.variationHandler=new P({debug:e.config.debug})),e.bindGlobalEvents(),e.initialized=!0,e.log("EstimatorCore initialized successfully"),e.emit("core:initialized"),console.log("%c=== PRODUCT ESTIMATOR INITIALIZATION COMPLETE ===","background: #f0f0f0; color: #333; padding: 3px; border-radius: 3px;"))};"complete"===document.readyState?t():window.addEventListener("load",t,{once:!0})}catch(e){console.error("EstimatorCore initialization error:",e)}return this}},{key:"bindGlobalEvents",value:function(){var e=this;try{this._clickHandler&&document.removeEventListener("click",this._clickHandler),this._clickHandler=function(t){var o=t.target.closest(e.config.selectors.estimatorMenuButtons);if(o)return t.preventDefault(),t.stopPropagation(),e.log("Menu button clicked - opening modal in list view"),void(e.modalManager&&e.modalManager.openModal(null,!0));var i=t.target.closest(e.config.selectors.estimatorButtons);if(i&&!o){t.preventDefault(),t.stopPropagation();var n=i.dataset.productId||null;console.log("PRODUCT BUTTON CLICKED:",{productId:n,buttonElement:i,dataAttribute:i.dataset}),e.modalManager&&(console.log("OPENING MODAL WITH:",{productId:n,forceListView:!1}),e.modalManager.openModal(n,!1))}},document.addEventListener("click",this._clickHandler),this.emit("core:eventsbound")}catch(e){console.error("Error binding global events:",e)}}},{key:"closeModal",value:function(){this.modalManager&&this.modalManager.closeModal()}},{key:"isWooCommerceProductPage",value:function(){return document.body.classList.contains("single-product")||document.body.classList.contains("product-template-default")||!!document.querySelector(".product.type-product")}},{key:"on",value:function(e,t){return this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t),this}},{key:"emit",value:function(e,t){return this.eventHandlers[e]&&this.eventHandlers[e].forEach((function(e){return e(t)})),this}},{key:"log",value:function(){if(this.config.debug){for(var e,t=arguments.length,o=new Array(t),i=0;i<t;i++)o[i]=arguments[i];(e=console).log.apply(e,["[EstimatorCore]"].concat(o))}}}])}();const F=new q({debug:!0});function R(e,t,i){return(t=o(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function A(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function T(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?A(Object(o),!0).forEach((function(t){R(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):A(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}var x=function(){return n((function t(){e(this,t),this.dialog=null,this.backdropElement=null,this.initialized=!1,this.callbacks={confirm:null,cancel:null},this.init()}),[{key:"init",value:function(){this.initialized||(this.createDialogElements(),this.bindEvents(),this.initialized=!0,productEstimatorVars&&productEstimatorVars.debug)}},{key:"createDialogElements",value:function(){this.backdropElement=document.createElement("div"),this.backdropElement.className="pe-dialog-backdrop",this.dialog=document.createElement("div"),this.dialog.className="pe-confirmation-dialog",this.dialog.setAttribute("role","dialog"),this.dialog.setAttribute("aria-modal","true"),this.dialog.innerHTML='\n    <div class="dialog-content">\n      <div class="pe-dialog-header">\n        <h3 class="pe-dialog-title">Confirm Action</h3>\n        <button type="button" class="pe-dialog-close" aria-label="Close">\n          <span aria-hidden="true">&times;</span>\n        </button>\n      </div>\n      <div class="pe-dialog-body">\n        <p class="pe-dialog-message">Are you sure you want to proceed?</p>\n      </div>\n      <div class="pe-dialog-footer">\n        <button type="button" class="pe-dialog-btn pe-dialog-cancel">Cancel</button>\n        <button type="button" class="pe-dialog-btn pe-dialog-confirm">Confirm</button>\n      </div>\n    </div>\n  ';var e=document.querySelector(".pe-dialog-backdrop"),t=document.querySelector(".pe-confirmation-dialog");e&&e.remove(),t&&t.remove(),document.body.appendChild(this.backdropElement),document.body.appendChild(this.dialog)}},{key:"bindEvents",value:function(){var e=this,t=this.dialog.querySelector(".pe-dialog-close"),o=this.dialog.querySelector(".pe-dialog-cancel"),i=this.dialog.querySelector(".pe-dialog-confirm");t.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation(),e.hide(),"function"==typeof e.callbacks.cancel&&e.callbacks.cancel()})),o.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation(),e.hide(),"function"==typeof e.callbacks.cancel&&e.callbacks.cancel()})),i.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation(),e.hide(),"function"==typeof e.callbacks.confirm&&e.callbacks.confirm()})),this.backdropElement.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation(),t.target===e.backdropElement&&(e.hide(),"function"==typeof e.callbacks.cancel&&e.callbacks.cancel())})),this.dialog.addEventListener("click",(function(e){e.stopPropagation()})),document.addEventListener("keydown",(function(t){"Escape"===t.key&&e.isVisible()&&(t.preventDefault(),t.stopPropagation(),e.hide(),"function"==typeof e.callbacks.cancel&&e.callbacks.cancel())}))}},{key:"show",value:function(){var e,t=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=(null===(e=window.productEstimatorVars)||void 0===e?void 0:e.i18n)||{},n=T(T({},{title:"Confirm Action",message:"Are you sure you want to proceed?",type:"",confirmText:i.confirm||"Confirm",cancelText:i.cancel||"Cancel",onConfirm:null,onCancel:null,action:"delete",showCancel:!0}),o);null!==o.cancelText&&!1!==o.cancelText||(n.showCancel=!1),this.callbacks.confirm=n.onConfirm,this.callbacks.cancel=n.onCancel;var r,c=this.dialog.querySelector(".pe-dialog-title"),l=this.dialog.querySelector(".pe-dialog-message"),d=this.dialog.querySelector(".pe-dialog-confirm"),u=this.dialog.querySelector(".pe-dialog-cancel");c&&(c.textContent=n.title),l&&(l.textContent=n.message),d&&(d.textContent=n.confirmText),u&&(n.showCancel?(u.style.display="",u.textContent=n.cancelText):(u.style.display="none",d&&(d.style.width="100%"))),this.dialog.classList.remove("pe-dialog-type-product","pe-dialog-type-room","pe-dialog-type-estimate","pe-dialog-notification"),(r=this.dialog.classList,function(e){if(Array.isArray(e))return a(e)}(r)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(r)||s(r)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()).forEach((function(e){/^pe-dialog-action-/.test(e)&&t.dialog.classList.remove(e)})),n.type&&this.dialog.classList.add("pe-dialog-type-".concat(n.type)),n.action&&this.dialog.classList.add("pe-dialog-action-".concat(n.action)),n.showCancel||"estimate"!==n.type||this.dialog.classList.add("pe-dialog-notification"),this.backdropElement&&(this.backdropElement.style.display="block"),this.dialog&&(this.dialog.style.display="block"),this.dialog&&this.dialog.classList.add("active"),setTimeout((function(){var e=n.showCancel?t.dialog.querySelector(".pe-dialog-cancel"):t.dialog.querySelector(".pe-dialog-confirm");e&&e.focus()}),100)}},{key:"hide",value:function(){this.backdropElement&&(this.backdropElement.style.display="none"),this.dialog&&(this.dialog.classList.remove("active"),this.dialog.style.display="none")}},{key:"isVisible",value:function(){return this.dialog&&"block"===this.dialog.style.display}},{key:"log",value:function(){if(productEstimatorVars&&productEstimatorVars.debug){for(var e,t=arguments.length,o=new Array(t),i=0;i<t;i++)o[i]=arguments[i];(e=console).log.apply(e,["[ConfirmationDialog]"].concat(o))}}}])}();const B=x;var H,N,M,O,j,V,z=new(function(){return n((function t(){var o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};e(this,t),this.config=Object.assign({debug:!1,selectors:{productToggleButton:".product-details-toggle",notesToggleButton:".product-notes-toggle",includesToggleButton:".product-includes-toggle",productItem:".product-item",similarProductsContainer:".similar-products-container",productIncludes:".product-includes",similarProducts:".product-similar-products",productNotes:".product-notes",notesContainer:".notes-container",includesContainer:".includes-container",suggestionsContainer:".suggestions-container"},i18n:{showProducts:"Similar Products",hideProducts:"Similar Products",showNotes:"Product Notes",hideNotes:"Product Notes",showIncludes:"Product Includes",hideIncludes:"Product Includes",showSuggestions:"Suggested Products",hideSuggestions:"Suggested Products",loading:"Loading..."}},o),this.initialized=!1,this.init()}),[{key:"init",value:function(){var e=this;this.initialized?this.log("Already initialized, skipping"):("loading"===document.readyState?document.addEventListener("DOMContentLoaded",(function(){return e.setup()})):this.setup(),document.addEventListener("product_estimator_modal_loaded",(function(){e.log("Modal content loaded, initializing toggles"),e.setup()})),this.setupMutationObserver(),this.initialized=!0,this.log("ProductDetailsToggle initialized"))}},{key:"prepareSuggestionsToggle",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.accordionContent);this.log("Found ".concat(t.length," accordion content elements to process for suggestions toggle")),t.forEach((function(t){if(!t.classList.contains("suggestions-toggle-processed")){var o=t.querySelector(e.config.selectors.productSuggestions);if(o){e.log("Found suggestions section, processing",o),t.classList.add("has-suggestions");var i=t.querySelector(e.config.selectors.suggestionsContainer);if(!i){if(e.log("Creating new suggestions container"),(i=document.createElement("div")).className="suggestions-container visible",o.parentNode!==i){var n=o.cloneNode(!0);i.appendChild(n),o.parentNode.removeChild(o)}t.appendChild(i)}var a=t.querySelector(e.config.selectors.suggestionsToggleButton);a||(e.log("Adding suggestions toggle button to accordion content"),(a=document.createElement("button")).className="product-suggestions-toggle expanded",a.setAttribute("data-toggle-type","suggestions"),a.innerHTML="\n        ".concat(e.config.i18n.hideSuggestions,'\n        <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n      '),t.insertBefore(a,i)),i.style.display="block",i.classList.add("visible"),t.classList.add("suggestions-toggle-processed"),e.log("Accordion content processed for suggestions toggle")}else e.log("No suggestions section found for accordion content, skipping",t)}}))}},{key:"setupMutationObserver",value:function(){var e=this;new MutationObserver((function(t){var o=!1;t.forEach((function(t){t.addedNodes.length&&Array.from(t.addedNodes).forEach((function(t){t.nodeType===Node.ELEMENT_NODE&&(t.matches(e.config.selectors.productItem)||t.matches(e.config.selectors.productToggleButton)||t.matches(e.config.selectors.notesToggleButton)||t.querySelector(e.config.selectors.productItem)||t.querySelector(e.config.selectors.productToggleButton)||t.querySelector(e.config.selectors.notesToggleButton))&&(o=!0)}))})),o&&(e.log("New toggle-related content detected, re-initializing"),setTimeout((function(){return e.setup()}),100))})).observe(document.body,{childList:!0,subtree:!0}),this.log("Mutation observer set up")}},{key:"setup",value:function(){this.log("Setting up product details toggles"),this.prepareProductsToggle(),this.prepareNotesToggle(),this.prepareIncludesToggle(),this.prepareSuggestionsToggle(),this.bindEvents(),this.initializeAllCarousels()}},{key:"prepareProductsToggle",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.productItem);this.log("Found ".concat(t.length," product items to process for similar products toggle")),t.forEach((function(t){if(!t.classList.contains("products-toggle-processed")){var o=t.querySelector(e.config.selectors.similarProducts);if(o){e.log("Found similar products section, processing",o),t.classList.add("has-similar-products");var i=t.querySelector(e.config.selectors.similarProductsContainer);if(!i){if(e.log("Creating new similar products container"),(i=document.createElement("div")).className="similar-products-container visible",o.parentNode!==i){var n=o.cloneNode(!0);i.appendChild(n),o.parentNode.removeChild(o)}t.appendChild(i)}var a=t.querySelector(e.config.selectors.productToggleButton);if(a){a.classList.add("expanded");var s=a.querySelector(".toggle-icon");s&&(s.classList.remove("dashicons-arrow-down-alt2"),s.classList.add("dashicons-arrow-up-alt2"))}else e.log("Adding similar products toggle button to product item"),(a=document.createElement("button")).className="product-details-toggle expanded",a.setAttribute("data-toggle-type","similar-products"),a.innerHTML="\n        ".concat(e.config.i18n.hideProducts,'\n        <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n      '),t.insertBefore(a,i);i.style.display="block",i.classList.add("visible"),t.classList.add("products-toggle-processed"),e.log("Product item processed for similar products toggle")}else e.log("No similar products section found for product item, skipping",t)}}))}},{key:"prepareNotesToggle",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.productItem);this.log("Found ".concat(t.length," product items to process for notes toggle")),t.forEach((function(t){if(!t.classList.contains("notes-toggle-processed")){var o=t.querySelector(e.config.selectors.productNotes);if(o){e.log("Found notes section, processing",o),t.classList.add("has-notes");var i=t.querySelector(e.config.selectors.notesContainer);if(!i){if(e.log("Creating new notes container"),(i=document.createElement("div")).className="notes-container visible",o.parentNode!==i){var n=o.cloneNode(!0);i.appendChild(n),o.parentNode.removeChild(o)}t.appendChild(i)}var a=t.querySelector(e.config.selectors.notesToggleButton);if(a){a.classList.add("expanded");var s=a.querySelector(".toggle-icon");s&&(s.classList.remove("dashicons-arrow-down-alt2"),s.classList.add("dashicons-arrow-up-alt2"))}else e.log("Adding notes toggle button to product item"),(a=document.createElement("button")).className="product-notes-toggle expanded",a.setAttribute("data-toggle-type","notes"),a.innerHTML="\n        ".concat(e.config.i18n.hideNotes,'\n        <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n      '),t.insertBefore(a,i);i.style.display="block",i.classList.add("visible"),t.classList.add("notes-toggle-processed"),e.log("Product item processed for notes toggle")}else e.log("No notes section found for product item, skipping",t)}}))}},{key:"bindEvents",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.productToggleButton);this.log("Found ".concat(t.length," similar products toggle buttons to bind")),t.forEach((function(t){t._toggleBound||(t._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),e.toggleSimilarProducts(t)},t.addEventListener("click",t._toggleHandler),t._toggleBound=!0)}));var o=document.querySelectorAll(this.config.selectors.notesToggleButton);this.log("Found ".concat(o.length," notes toggle buttons to bind")),o.forEach((function(t){t._toggleBound||(t._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),e.toggleNotes(t)},t.addEventListener("click",t._toggleHandler),t._toggleBound=!0)}));var i=document.querySelectorAll(this.config.selectors.includesToggleButton);this.log("Found ".concat(i.length," includes toggle buttons to bind")),i.forEach((function(t){t._toggleBound||(t._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),e.toggleIncludes(t)},t.addEventListener("click",t._toggleHandler),t._toggleBound=!0)}));var n=document.querySelectorAll(this.config.selectors.suggestionsToggleButton);this.log("Found ".concat(n.length," suggestions toggle buttons to bind")),n.forEach((function(t){t._toggleBound||(t._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),e.toggleSuggestions(t)},t.addEventListener("click",t._toggleHandler),t._toggleBound=!0)})),this.log("All toggle events bound")}},{key:"toggleSuggestions",value:function(e){var t=e.closest(this.config.selectors.accordionContent);if(t){var o=t.querySelector(this.config.selectors.suggestionsContainer);if(o){var i=e.classList.contains("expanded");if(this.log("Suggestions toggle clicked, current expanded state: ".concat(i)),i){o.classList.remove("visible"),o.style.display="none",e.classList.remove("expanded");var n=e.querySelector(".toggle-icon");n&&(n.classList.remove("dashicons-arrow-up-alt2"),n.classList.add("dashicons-arrow-down-alt2")),e.innerHTML=e.innerHTML.replace(this.config.i18n.hideSuggestions,this.config.i18n.showSuggestions),this.log("Suggestions hidden")}else{o.classList.add("visible"),o.style.display="block",e.classList.add("expanded");var a=e.querySelector(".toggle-icon");a&&(a.classList.remove("dashicons-arrow-down-alt2"),a.classList.add("dashicons-arrow-up-alt2")),e.innerHTML=e.innerHTML.replace(this.config.i18n.showSuggestions,this.config.i18n.hideSuggestions),this.initializeCarousels(o),this.log("Suggestions shown")}}else this.log("Suggestions container not found")}else this.log("Accordion content not found for toggle button")}},{key:"toggleSimilarProducts",value:function(e){var t=e.closest(this.config.selectors.productItem);if(t){var o=t.querySelector(this.config.selectors.similarProductsContainer);if(o){var i=e.classList.contains("expanded");this.log("Similar products toggle clicked, current expanded state: ".concat(i));var n=e.querySelector(".toggle-icon");i?(o.classList.remove("visible"),o.style.display="none",e.classList.remove("expanded"),n&&(n.classList.remove("dashicons-arrow-up-alt2"),n.classList.add("dashicons-arrow-down-alt2")),this.log("Similar products hidden")):(o.classList.add("visible"),o.style.display="block",e.classList.add("expanded"),n&&(n.classList.remove("dashicons-arrow-down-alt2"),n.classList.add("dashicons-arrow-up-alt2")),this.log("Similar products shown"),this.initializeCarousels(o))}else this.log("Similar products container not found")}else this.log("Product item not found for toggle button")}},{key:"toggleNotes",value:function(e){var t=e.closest(this.config.selectors.productItem);if(t){var o=t.querySelector(this.config.selectors.notesContainer);if(o){var i=e.classList.contains("expanded");this.log("Notes toggle clicked, current expanded state: ".concat(i));var n=e.querySelector(".toggle-icon");i?(o.classList.remove("visible"),o.style.display="none",e.classList.remove("expanded"),n&&(n.classList.remove("dashicons-arrow-up-alt2"),n.classList.add("dashicons-arrow-down-alt2")),this.log("Notes hidden")):(o.classList.add("visible"),o.style.display="block",e.classList.add("expanded"),n&&(n.classList.remove("dashicons-arrow-down-alt2"),n.classList.add("dashicons-arrow-up-alt2")),this.log("Notes shown"))}else this.log("Notes container not found")}else this.log("Product item not found for notes toggle button")}},{key:"initializeCarousels",value:function(e){"function"==typeof window.initSuggestionsCarousels?(this.log("Initializing carousels in similar products container"),window.initSuggestionsCarousels()):"function"==typeof initSuggestionsCarousels?(this.log("Using local initSuggestionsCarousels function"),initSuggestionsCarousels()):this.log("Carousel initialization function not found",window.initSuggestionsCarousels)}},{key:"initializeAllCarousels",value:function(){"function"==typeof window.initSuggestionsCarousels?(this.log("Initializing all carousels"),window.initSuggestionsCarousels()):"function"==typeof initSuggestionsCarousels&&initSuggestionsCarousels()}},{key:"prepareIncludesToggle",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.productItem);this.log("Found ".concat(t.length," product items to process for includes toggle")),t.forEach((function(t){if(!t.classList.contains("includes-toggle-processed")){var o=t.querySelector(e.config.selectors.productIncludes);if(o){e.log("Found includes section, processing",o),t.classList.add("has-includes");var i=t.querySelector(".includes-container");if(!i){if(e.log("Creating new includes container"),(i=document.createElement("div")).className="includes-container visible",o.parentNode!==i){var n=o.cloneNode(!0);i.appendChild(n),o.parentNode.removeChild(o)}t.appendChild(i)}var a=t.querySelector(".product-includes-toggle");if(a){a.classList.add("expanded");var s=a.querySelector(".toggle-icon");s&&(s.classList.remove("dashicons-arrow-down-alt2"),s.classList.add("dashicons-arrow-up-alt2"))}else e.log("Adding includes toggle button to product item"),(a=document.createElement("button")).className="product-includes-toggle expanded",a.setAttribute("data-toggle-type","includes"),a.innerHTML="\n        ".concat(e.config.i18n.hideIncludes||"Product Includes",'\n        <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n      '),t.insertBefore(a,i);i.style.display="block",i.classList.add("visible"),t.classList.add("includes-toggle-processed"),e.log("Product item processed for includes toggle")}else e.log("No includes section found for product item, skipping",t)}}))}},{key:"toggleIncludes",value:function(e){var t=e.closest(this.config.selectors.productItem);if(t){var o=t.querySelector(".includes-container");if(o){var i=e.classList.contains("expanded");this.log("Includes toggle clicked, current expanded state: ".concat(i));var n=e.querySelector(".toggle-icon");i?(o.classList.remove("visible"),o.style.display="none",e.classList.remove("expanded"),n&&(n.classList.remove("dashicons-arrow-up-alt2"),n.classList.add("dashicons-arrow-down-alt2")),this.log("Includes hidden")):(o.classList.add("visible"),o.style.display="block",e.classList.add("expanded"),n&&(n.classList.remove("dashicons-arrow-down-alt2"),n.classList.add("dashicons-arrow-up-alt2")),this.log("Includes shown"))}else this.log("Includes container not found")}else this.log("Product item not found for includes toggle button")}},{key:"log",value:function(){this.config.debug}}])}())({debug:(null===(H=window.productEstimatorVars)||void 0===H?void 0:H.debug)||!1,i18n:{showProducts:(null===(N=window.productEstimatorVars)||void 0===N||null===(N=N.i18n)||void 0===N?void 0:N.showSimilarProducts)||"Similar Products",hideProducts:(null===(M=window.productEstimatorVars)||void 0===M||null===(M=M.i18n)||void 0===M?void 0:M.hideSimilarProducts)||"Similar Products",showNotes:(null===(O=window.productEstimatorVars)||void 0===O||null===(O=O.i18n)||void 0===O?void 0:O.showNotes)||"Product Notes",hideNotes:(null===(j=window.productEstimatorVars)||void 0===j||null===(j=j.i18n)||void 0===j?void 0:j.hideNotes)||"Product Notes",loading:(null===(V=window.productEstimatorVars)||void 0===V||null===(V=V.i18n)||void 0===V?void 0:V.loading)||"Loading..."}});function U(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}var Q=function(){return n((function t(){var o,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;e(this,t),this.config=Object.assign({debug:!1,selectors:{printButton:".print-estimate, .print-estimate-pdf",requestContactButton:".request-contact-estimate",requestCopyButton:".request-a-copy",scheduleDesignerButton:".schedule-designer-estimate"},i18n:(null===(o=window.productEstimatorVars)||void 0===o?void 0:o.i18n)||{}},i),this.dataService=n,this.initialized=!1,this.processing=!1,this.customerDetails=b(),!1!==i.autoInit&&this.init()}),[{key:"init",value:function(){return this.initialized?(this.log("PrintEstimate already initialized"),this):(this.bindEvents(),this.initialized=!0,this.log("PrintEstimate initialized"),this)}},{key:"bindEvents",value:function(){var e=this;this.log("Binding print events"),document.addEventListener("click",(function(t){e.log("Document click event triggered");var o=t.target.closest(e.config.selectors.printButton);if(o)if(e.log("Print button clicked or is ancestor of click target"),o&&!e.processing)if(e.log("Print button is active and not processing"),t.preventDefault(),e.processing=!0,e.setButtonLoading(o,!0),o.classList.contains("print-estimate-pdf")){e.log("Handling direct PDF link");var i=o.dataset.estimateId;e.checkCustomerDetails(i).then((function(t){var n=[];if(t.name&&""!==t.name.trim()||n.push("name"),t.email&&""!==t.email.trim()||n.push("email"),0===n.length){var a=o.getAttribute("href");a&&"#"!==a&&"javascript:void(0)"!==a?(e.log("Opening PDF URL from href:",a),window.open(a,"_blank")):(e.log("href is missing or invalid, getting secure PDF URL"),e.getSecurePdfUrl(i).then((function(t){e.log("Opening secure PDF URL:",t),window.open(t,"_blank")})).catch((function(t){e.showError("Error generating PDF URL. Please try again.")})))}else e.log("Missing required customer details for PDF link:",n),e.showCustomerDetailsPrompt(i,o,"print")})).catch((function(t){e.showError("Error checking customer details. Please try again.")})).finally((function(){}))}else e.log("Handling JS-based print button"),e.handlePrintEstimate(o);else e.processing&&e.log("Print button clicked but processing is true, ignoring.")})),document.addEventListener("click",(function(t){var o=t.target.closest(e.config.selectors.requestCopyButton);if(o&&!e.processing){e.log("Request copy button clicked"),t.preventDefault(),e.processing=!0,e.setButtonLoading(o,!0);var i=o.dataset.estimateId;e.showContactSelectionPrompt(i,o,"request_copy")}})),document.addEventListener("click",(function(t){var o=t.target.closest(e.config.selectors.requestContactButton);if(o&&!e.processing){e.log("Request contact button clicked"),t.preventDefault(),e.processing=!0,e.setButtonLoading(o,!0);var i=o.dataset.estimateId;e.showContactSelectionPrompt(i,o,"request_contact")}}))}},{key:"handlePrintEstimate",value:function(e){var t=this;this.log("handlePrintEstimate called");var o=e.dataset.estimateId;if(!o)return this.showError("No estimate ID provided"),this.setButtonLoading(e,!1),void(this.processing=!1);this.log("Print estimate requested for estimate ID: ".concat(o)),this.checkCustomerDetails(o).then((function(i){var n=[];return i.name&&""!==i.name.trim()||n.push("name"),i.email&&""!==i.email.trim()||n.push("email"),0===n.length?(t.log("Customer has required details, proceeding to store estimate"),t.storeEstimate(o).then((function(e){if(e&&e.estimate_id)return t.log("Estimate stored, getting secure PDF URL"),t.getSecurePdfUrl(e.estimate_id);throw new Error("Failed to store estimate")})).then((function(o){t.log("Received PDF URL, opening:",o),t.setButtonLoading(e,!1),t.processing=!1,window.open(o,"_blank")}))):(t.log("Missing required customer details for JS print:",n),t.showCustomerDetailsPrompt(o,e,"print"),Promise.reject(new Error("missing_customer_details")))})).catch((function(o){"missing_customer_details"!==o.message&&(t.showError("Error generating PDF. Please try again."),t.setButtonLoading(e,!1),t.processing=!1)}))}},{key:"showCustomerDetailsPrompt",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"print";this.log("showCustomerDetailsPrompt called");var n=this.getMissingFields(this.customerDetails,i);if(0===n.length)return this.log("No missing fields, continuing with action:",i),void this.continueWithAction(i,e,t,this.customerDetails);this.log("Missing fields detected, showing prompt modal:",n);var a=this.createPromptModalHtml(n,i,this.customerDetails),s=document.createElement("div");s.className="email-prompt-modal",s.innerHTML=a,document.body.appendChild(s);var r=s.querySelector(".cancel-email-btn"),c=s.querySelector(".submit-email-btn"),l=s.querySelector(".email-validation-message");r.addEventListener("click",(function(){o.log("Prompt modal cancelled"),s.remove(),o.setButtonLoading(t,!1),o.processing=!1})),c.addEventListener("click",(function(){o.log("Prompt modal submit clicked");var a=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?U(Object(o),!0).forEach((function(t){R(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):U(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}({},o.customerDetails),r=!0;n.forEach((function(e){var t=s.querySelector("#customer-".concat(e,"-input")),i=t?t.value.trim():"";return i?"email"!==e||o.validateEmail(i)?"phone"!==e||o.validatePhone(i)?void(a[e]=i):(l.textContent="Please enter a valid phone number",void(r=!1)):(l.textContent="Please enter a valid email address",void(r=!1)):(l.textContent="".concat(o.getFieldLabel(e)," is required"),void(r=!1))})),r?(o.log("Prompt modal validation successful, saving details:",a),c.disabled=!0,c.textContent="Saving...",o.updateCustomerDetails(e,a).then((function(){o.log("Details saved successfully after prompt"),s.remove(),o.setButtonLoading(t,!0),o.processing=!0,o.continueWithAction(i,e,t,a)})).catch((function(e){o.log("Error saving details after prompt:",e),l.textContent="Error saving details. Please try again.",c.disabled=!1,c.textContent="Continue"}))):o.log("Prompt modal validation failed")})),setTimeout((function(){var e=s.querySelector("input");e&&(e.focus(),s.querySelectorAll("input").forEach((function(e){e.addEventListener("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),c.click())}))})))}),100)}},{key:"getMissingFields",value:function(e,t){var o={print:["name","email"],request_copy_email:["name","email"],request_copy_sms:["name","phone"],request_contact_email:["name","email"],request_contact_phone:["name","phone"]};return(o[t]||o.print).filter((function(t){return!e||!e[t]||""===e[t].trim()}))}},{key:"getFieldLabel",value:function(e){return{name:"Full Name",email:"Email Address",phone:"Phone Number"}[e]||e.charAt(0).toUpperCase()+e.slice(1)}},{key:"createPromptModalHtml",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n="Additional information is required to continue.";"request_copy_email"===t?n="An email address is required to send your estimate copy.":"request_copy_sms"===t?n="A phone number is required to send your estimate via SMS.":"request_contact_email"===t?n="Your details are required for our store to contact you via email.":"request_contact_phone"===t?n="Your details are required for our store to contact you via phone.":e.includes("email")&&!e.includes("name")&&(n="An email address is required to view your estimate.");var a='\n      <div class="email-prompt-overlay"></div>\n      <div class="email-prompt-container">\n        <div class="email-prompt-header">\n          <h3>'.concat("Please Complete Your Details",'</h3>\n        </div>\n        <div class="email-prompt-body">\n          <p>').concat(n,"</p>\n    ");return e.forEach((function(e){var t=o.getFieldLabel(e),n=i[e]||"",s="email"===e?"email":"phone"===e?"tel":"text";a+='\n        <div class="form-group">\n          <label for="customer-'.concat(e,'-input">').concat(t,':</label>\n          <input type="').concat(s,'" id="customer-').concat(e,'-input" value="').concat(n,'" required>\n        </div>\n      ')})),a+='\n          <div class="email-validation-message"></div>\n        </div>\n        <div class="email-prompt-footer">\n          <button type="button" class="button cancel-email-btn">Cancel</button>\n          <button type="button" class="button submit-email-btn">Continue</button>\n        </div>\n      </div>\n    '}},{key:"validateEmail",value:function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}},{key:"validatePhone",value:function(e){return/^[\d\s()+\-]{8,}$/.test(e)}},{key:"continueWithAction",value:function(e,t,o,i){var n=this;switch(this.log("continueWithAction called:",e),e){case"print":this.handlePrintEstimate(o);break;case"request_copy_email":this.requestCopyEstimate(t,o).then((function(e){n.showMessage("Estimate has been emailed to ".concat(i.email),"success",(function(){n.setButtonLoading(o,!1),n.processing=!1}))})).catch((function(e){n.showError("Error sending estimate copy. Please try again."),n.setButtonLoading(o,!1),n.processing=!1}));break;case"request_copy_sms":this.showMessage("SMS option coming soon.","success"),this.setButtonLoading(o,!1),this.processing=!1;break;case"request_contact_email":this.requestStoreContact(t,"email",o,i);break;case"request_contact_phone":this.requestStoreContact(t,"phone",o,i)}}},{key:"showContactSelectionPrompt",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"request_copy";this.log("showContactSelectionPrompt called:",i);var n="How would you like to receive your estimate?",a="Please choose how you'd prefer to receive your estimate:",s="Email",r="SMS";"request_contact"===i&&(n="How would you like to be contacted?",a="Please choose how you'd prefer our store to contact you:",s="Email",r="Phone");var c='\n    <div class="email-prompt-overlay"></div>\n    <div class="email-prompt-container">\n      <div class="email-prompt-header">\n        <h3>'.concat(n,'</h3>\n      </div>\n      <div class="email-prompt-body">\n        <p>').concat(a,'</p>\n      </div>\n      <div class="email-prompt-footer">\n        <button type="button" class="button cancel-email-btn">Cancel</button>\n        <button type="button" class="button submit-email-btn email-choice">').concat(s,'</button>\n        <button type="button" class="button submit-email-btn sms-choice">').concat(r,"</button>\n      </div>\n    </div>\n  "),l=document.createElement("div");l.className="email-prompt-modal",l.innerHTML=c,document.body.appendChild(l);var d=l.querySelector(".cancel-email-btn"),u=l.querySelector(".email-choice"),m=l.querySelector(".sms-choice");d.addEventListener("click",(function(){o.log("Contact selection cancelled"),o.setButtonLoading(t,!1),o.processing=!1,l.remove()})),u.addEventListener("click",(function(){o.log("Email contact method selected"),l.remove();var n="request_contact"===i?"request_contact_email":"request_copy_email",a=b(),s=[];a.name&&""!==a.name.trim()||s.push("name"),a.email&&""!==a.email.trim()||s.push("email"),0===s.length?(o.log("Required details for email contact exist, proceeding"),"request_contact"===i?o.requestStoreContact(e,"email",t,a):o.requestCopyEstimate(e,t).then((function(e){o.showMessage("Estimate has been emailed to ".concat(a.email),"success",(function(){o.setButtonLoading(t,!1),o.processing=!1}))})).catch((function(){o.showError("Error sending estimate copy. Please try again."),o.setButtonLoading(t,!1),o.processing=!1}))):(o.log("Missing details for email contact, showing prompt:",s),o.showCustomerDetailsPrompt(e,t,n))})),m.addEventListener("click",(function(){o.log("Phone contact method selected"),l.remove();var n="request_contact"===i?"request_contact_phone":"request_copy_sms",a=b(),s=[];a.name&&""!==a.name.trim()||s.push("name"),a.phone&&""!==a.phone.trim()||s.push("phone"),0===s.length?(o.log("Required details for phone contact exist, proceeding"),"request_contact"===i?o.requestStoreContact(e,"phone",t,a):(o.showMessage("SMS option coming soon.","success"),o.setButtonLoading(t,!1),o.processing=!1)):(o.log("Missing details for phone contact, showing prompt:",s),o.showCustomerDetailsPrompt(e,t,n))}))}},{key:"requestStoreContact",value:function(e,t,o,i){var n=this;this.log("requestStoreContact called:",{estimateId:e,contactMethod:t,customerDetails:i}),this.storeEstimate(e).then((function(o){if(!o||!o.estimate_id)throw new Error("Failed to store estimate");var a={estimate_id:e,contact_method:t,customer_details:JSON.stringify(i)};return n.log("Sending store contact request with data:",a),n.dataService.request("request_store_contact",a)})).then((function(e){n.log("Store contact request successful:",e);var o;o="email"===t?"Your request has been sent. Our store will contact you at ".concat(i.email," shortly."):"Your request has been sent. Our store will call you at ".concat(i.phone," shortly."),n.showMessage(o,"success")})).catch((function(e){n.log("Error in requestStoreContact:",e),n.showError("Error sending contact request. Please try again.")})).finally((function(){n.setButtonLoading(o,!1),n.processing=!1}))}},{key:"checkCustomerDetails",value:function(e){var t=this;return this.log("checkCustomerDetails called for estimate:",e),new Promise((function(o,i){var n=b();if(n&&n.name&&n.email)return t.customerDetails=n,t.log("Customer details found in local storage."),void o(t.customerDetails);t.log("Customer details not fully available in local storage, fetching from server."),t.dataService.request("check_customer_details",{estimate_id:e}).then((function(e){t.log("Customer details check result from server:",e),e&&e.customer_details?(S(e.customer_details),t.customerDetails=b(),o(t.customerDetails)):(t.log("Server check succeeded but no customer details returned."),S({}),t.customerDetails={},o(t.customerDetails))})).catch((function(e){t.log("Error fetching customer details from server:",e),t.customerDetails={},o(t.customerDetails)}))}))}},{key:"updateCustomerDetails",value:function(e,t){var o=this;return this.log("updateCustomerDetails called:",{estimateId:e,details:t}),new Promise((function(i,n){t.postcode||(t.postcode="0000"),o.dataService.request("update_customer_details",{details:JSON.stringify(t)}).then((function(i){o.log("Server update_customer_details successful:",i);var n=new CustomEvent("customer_details_updated",{bubbles:!0,detail:{details:t}});return document.dispatchEvent(n),o.dataService.request("store_single_estimate",{estimate_id:e})})).then((function(e){o.log("Server store_single_estimate successful:",e),S(t),o.customerDetails=t,i(e)})).catch((function(e){console.error("Error in updateCustomerDetails AJAX chain:",e),n(e)}))}))}},{key:"storeEstimate",value:function(e){return this.log("storeEstimate called:",e),this.dataService.request("store_single_estimate",{estimate_id:e})}},{key:"getSecurePdfUrl",value:function(e){var t=this;return this.log("getSecurePdfUrl called:",e),this.dataService.request("get_secure_pdf_url",{estimate_id:e}).then((function(e){if(e&&e.url)return t.log("Received secure PDF URL:",e),e.url;throw new Error("Failed to get secure PDF URL")}))}},{key:"requestCopyEstimate",value:function(e,t){var o=this;return this.log("requestCopyEstimate called:",e),b().email?this.storeEstimate(e).then((function(t){if(!t||!t.estimate_id)throw new Error("Failed to store estimate");return o.dataService.request("request_copy_estimate",{estimate_id:e})})).catch((function(e){var t;throw"no_email"===(null===(t=e.data)||void 0===t?void 0:t.code)?(o.log("Server returned no_email error for requestCopyEstimate"),new Error("no_email")):(o.log("Error requesting estimate copy:",e),e)})):(this.log("No email found for requestCopyEstimate"),Promise.reject(new Error("no_email")))}},{key:"setButtonLoading",value:function(e,t){if(this.log("setButtonLoading called:",{button:(null==e?void 0:e.id)||(null==e?void 0:e.className),isLoading:t}),e){var o=e.dataset.originalText||e.textContent;t?(e.dataset.originalText||(e.dataset.originalText=e.textContent),e.classList.add("loading"),e.innerHTML='<span class="loading-dots">Processing...</span>',e.disabled=!0):(e.classList.remove("loading"),e.textContent=o,e.disabled=!1)}else this.log("setButtonLoading called with null button")}},{key:"showMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;this.log("showMessage called:",{message:e,type:t}),window.productEstimator&&window.productEstimator.dialog?window.productEstimator.dialog.show({title:"success"===t?"Success":"Error",message:e,type:"estimate",action:"confirm",confirmText:this.config.i18n.confirm||"OK",cancelText:null,onConfirm:function(){"function"==typeof o&&o()}}):(alert(e),"function"==typeof o&&o())}},{key:"showError",value:function(e){this.log("showError called:",e),window.productEstimator&&window.productEstimator.core&&"function"==typeof window.productEstimator.core.showError?window.productEstimator.core.showError(e):alert(e)}},{key:"log",value:function(){if(this.config.debug){for(var e,t=arguments.length,o=new Array(t),i=0;i<t;i++)o[i]=arguments[i];(e=console).log.apply(e,["[PrintEstimate]"].concat(o))}}}])}();const W=Q;function J(){if(console.log("Product Estimator initialization check..."),window._productEstimatorInitialized)console.log("Product Estimator already initialized globally, aborting");else{if(window.productEstimator&&window.productEstimator.initialized)return console.log("Product Estimator initialized property found, aborting"),void(window._productEstimatorInitialized=!0);window._productEstimatorInitialized=!0,console.log("Product Estimator initializing for the first time...");try{K?console.log("Global event handlers already added, skipping"):(console.log("Setting up global event handlers..."),window._productEstimatorCloseHandler=function(e){if(e.target.closest(".product-estimator-modal-close")||e.target.classList.contains("product-estimator-modal-overlay")){console.log("Global close handler triggered");var t=document.querySelector("#product-estimator-modal");t&&(t.style.display="none",document.body.classList.remove("modal-open"),window.productEstimator&&window.productEstimator.core&&window.productEstimator.core.closeModal())}},document.removeEventListener("click",window._productEstimatorCloseHandler),document.addEventListener("click",window._productEstimatorCloseHandler),K=!0,console.log("Global event handlers added")),"undefined"!=typeof jQuery?(window.productEstimator=window.productEstimator||{},window.productEstimator.jQuery=jQuery):console.warn("jQuery not detected, some features may not work");var e=function(){var e=new URLSearchParams(window.location.search);if(e.has("product_estimator_debug")){var t="false"!==e.get("product_estimator_debug");return t?localStorage.setItem("product_estimator_debug","true"):localStorage.removeItem("product_estimator_debug"),t}return"true"===localStorage.getItem("product_estimator_debug")}();"complete"===document.readyState?setTimeout((function(){return G(e)}),10):setTimeout((function(){return G(e)}),500)}catch(e){console.error("Error in Product Estimator initialization:",e)}}}function G(e){try{if(window.productEstimator&&window.productEstimator.initialized)return void console.log("Product Estimator core already initialized, skipping");console.log("Initializing EstimatorCore..."),F.init({debug:e}),window.productEstimator=window.productEstimator||{},window.productEstimator.initialized=!0,window.productEstimator.core=F,window.productEstimator.dialog=new B;var t=window.productEstimator.core.dataService;if(!t)return void console.error("DataService instance not found on EstimatorCore. Cannot initialize PrintEstimate.");window.productEstimator.printEstimate=new W({debug:e},t),window.productEstimator.detailsToggle=z,window.initSuggestionsCarousels=v,function(){try{document.addEventListener("click",(function(e){e.target.closest(".accordion-header")&&setTimeout((function(){z&&"function"==typeof z.setup&&(console.log("Accordion clicked, reinitializing product details toggle"),z.setup()),v()}),300)})),document.body.addEventListener("click",(function(e){if(e.target.closest(".product-details-toggle")){var t=e.target.closest(".product-details-toggle"),o=t.closest(".product-item");if(!o)return;var i=t.classList.contains("expanded"),n=o.querySelector(".similar-products-container");if(!n)return;if(i){t.classList.remove("expanded"),n.style.display="none",n.classList.remove("visible");var a=t.querySelector(".toggle-icon");a&&(a.classList.remove("dashicons-arrow-up-alt2"),a.classList.add("dashicons-arrow-down-alt2"))}else{t.classList.add("expanded"),n.style.display="block",n.classList.add("visible");var s=t.querySelector(".toggle-icon");s&&(s.classList.remove("dashicons-arrow-down-alt2"),s.classList.add("dashicons-arrow-up-alt2")),v()}e.preventDefault(),e.stopPropagation()}if(e.target.closest(".product-notes-toggle")){var r=e.target.closest(".product-notes-toggle"),c=r.closest(".product-item");if(!c)return;var l=r.classList.contains("expanded"),d=c.querySelector(".notes-container");if(!d)return;if(l){r.classList.remove("expanded"),d.style.display="none",d.classList.remove("visible");var u=r.querySelector(".toggle-icon");u&&(u.classList.remove("dashicons-arrow-up-alt2"),u.classList.add("dashicons-arrow-down-alt2"))}else{r.classList.add("expanded"),d.style.display="block",d.classList.add("visible");var m=r.querySelector(".toggle-icon");m&&(m.classList.remove("dashicons-arrow-down-alt2"),m.classList.add("dashicons-arrow-up-alt2"))}e.preventDefault(),e.stopPropagation()}if(e.target.closest(".product-includes-toggle")){var h=e.target.closest(".product-includes-toggle"),g=h.closest(".product-item");if(!g)return;var p=h.classList.contains("expanded"),f=g.querySelector(".includes-container");if(!f)return;if(p){h.classList.remove("expanded"),f.style.display="none",f.classList.remove("visible");var y=h.querySelector(".toggle-icon");y&&(y.classList.remove("dashicons-arrow-up-alt2"),y.classList.add("dashicons-arrow-down-alt2"))}else{h.classList.add("expanded"),f.style.display="block",f.classList.add("visible");var w=h.querySelector(".toggle-icon");w&&(w.classList.remove("dashicons-arrow-down-alt2"),w.classList.add("dashicons-arrow-up-alt2"))}e.preventDefault(),e.stopPropagation()}if(e.target.closest(".product-suggestions-toggle")){var E=e.target.closest(".product-suggestions-toggle"),b=E.closest(".accordion-content");if(!b)return;var S=E.classList.contains("expanded"),L=b.querySelector(".suggestions-container");if(!L)return;if(S){E.classList.remove("expanded"),L.style.display="none",L.classList.remove("visible");var k=E.querySelector(".toggle-icon");k&&(k.classList.remove("dashicons-arrow-up-alt2"),k.classList.add("dashicons-arrow-down-alt2"))}else{E.classList.add("expanded"),L.style.display="block",L.classList.add("visible");var _=E.querySelector(".toggle-icon");_&&(_.classList.remove("dashicons-arrow-down-alt2"),_.classList.add("dashicons-arrow-up-alt2")),v()}e.preventDefault(),e.stopPropagation()}})),console.log("ProductDetailsToggle initialization complete")}catch(e){console.error("Error initializing ProductDetailsToggle:",e)}}(),console.log("Product Estimator initialized".concat(e?" (debug mode)":"")),document.dispatchEvent(new CustomEvent("product_estimator_initialized"))}catch(e){console.error("Error during EstimatorCore initialization:",e)}}window._productEstimatorInitialized=window._productEstimatorInitialized||!1,window._setupInitDone||(window._setupInitDone=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",J,{once:!0}):J());var K=!1;console.log("Product Estimator Frontend initialized")})();
//# sourceMappingURL=product-estimator.bundle.js.map