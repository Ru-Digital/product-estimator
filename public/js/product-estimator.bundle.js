(()=>{"use strict";var e={201:e=>{e.exports="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="}},t={};function o(i){var r=t[i];if(void 0!==r)return r.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,o),a.exports}o.m=e,o.d=(e,t)=>{for(var i in t)o.o(t,i)&&!o.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.b=document.baseURI||self.location.href;var i={};function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function n(e){var t=function(e){if("object"!=a(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var o=t.call(e,"string");if("object"!=a(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==a(t)?t:t+""}function s(e,t){for(var o=0;o<t.length;o++){var i=t[o];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,n(i.key),i)}}function c(e,t,o){return t&&s(e.prototype,t),o&&s(e,o),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,i=Array(t);o<t;o++)i[o]=e[o];return i}function d(e,t){if(e){if("string"==typeof e)return l(e,t);var o={}.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?l(e,t):void 0}}function u(e){return function(e){if(Array.isArray(e))return l(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||d(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(e,t,o){return(t=n(t))in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}function g(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var i,r,a,n,s=[],c=!0,l=!1;try{if(a=(o=o.call(e)).next,0===t){if(Object(o)!==o)return;c=!1}else for(;!(c=(i=a.call(o)).done)&&(s.push(i.value),s.length!==t);c=!0);}catch(e){l=!0,r=e}finally{try{if(!c&&null!=o.return&&(n=o.return(),Object(n)!==n))return}finally{if(l)throw r}}return s}}(e,t)||d(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function h(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?p(Object(o),!0).forEach((function(t){m(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):p(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function f(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"$",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2;if(null==e)return"".concat(t,"0.00");var i="string"==typeof e?parseFloat(e):e;return isNaN(i)?"".concat(t,"0.00"):t+i.toFixed(o)}function v(e,t){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"$",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2,r=null==e?0:"string"==typeof e?parseFloat(e.replace(/[^0-9.-]+/g,"")):e,a=null==t?0:"string"==typeof t?parseFloat(t.replace(/[^0-9.-]+/g,"")):t;return isNaN(r)&&isNaN(a)?"".concat(f(0,o,i)):isNaN(r)?f(a,o,i):isNaN(a)||r===a?f(r,o,i):"".concat(f(r,o,i)," - ").concat(f(a,o,i))}function y(e){var t,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300;return function(){for(var i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];var n=this;clearTimeout(t),t=setTimeout((function(){return e.apply(n,r)}),o)}}function w(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:300,o=0;return function(){var i=Date.now();if(i-o>=t){o=i;for(var r=arguments.length,a=new Array(r),n=0;n<r;n++)a[n]=arguments[n];return e.apply(this,a)}}}function b(e){if(!e)return"";var t=document.createElement("div");return t.textContent=e,t.innerHTML}function E(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=h(h({},{year:"numeric",month:"short",day:"numeric"}),t),i="string"==typeof e?new Date(e):e;return isNaN(i.getTime())?"Invalid date":new Intl.DateTimeFormat(navigator.language,o).format(i)}function S(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"...";return e?e.length<=t?e:e.substring(0,t-o.length)+o:""}function _(e){return Object.entries(e).filter((function(e){var t=g(e,2);return null!=(t[0],t[1])})).map((function(e){var t=g(e,2),o=t[0],i=t[1];return Array.isArray(i)?i.map((function(e){return"".concat(encodeURIComponent(o),"=").concat(encodeURIComponent(e))})).join("&"):"".concat(encodeURIComponent(o),"=").concat(encodeURIComponent(i))})).join("&")}function L(e){return{log:function(){var t;if(null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug){for(var o,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];(o=console).log.apply(o,["[".concat(e,"]")].concat(r))}},warn:function(){var t;if(null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug){for(var o,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];(o=console).warn.apply(o,["[".concat(e,"]")].concat(r))}},error:function(){var t;if(null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug){for(var o,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];(o=console).error.apply(o,["[".concat(e,"]")].concat(r))}},group:function(){var t;if(null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug){for(var o,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];(o=console).group.apply(o,["[".concat(e,"]")].concat(r))}},groupEnd:function(){var t;if(null!==(t=window.productEstimatorVars)&&void 0!==t&&t.debug){for(var o,i=arguments.length,r=new Array(i),a=0;a<i;a++)r[a]=arguments[a];(o=console).groupEnd.apply(o,["[".concat(e,"]")].concat(r))}}}}o.r(i),o.d(i,{debounce:()=>y,formatDate:()=>E,formatPrice:()=>f,formatPriceRange:()=>v,objectToQueryString:()=>_,sanitizeHTML:()=>b,throttle:()=>w,truncateText:()=>S}),L("UtilsAjax"),L("UtilsDom");var P="productEstimatorEstimateData";function I(){try{var e=localStorage.getItem(P);if(e){var t=JSON.parse(e);return console.log("EstimateStorage: loadEstimateData - Data loaded:",t),t}var o=sessionStorage.getItem(P);return o?JSON.parse(o):{}}catch(e){return console.error("Error loading estimate data from localStorage:",e),{}}}function k(e){try{localStorage.setItem(P,JSON.stringify(e))}catch(t){console.warn("localStorage not available, using sessionStorage:",t);try{sessionStorage.setItem(P,JSON.stringify(e))}catch(e){console.error("sessionStorage not available:",e)}}}function C(){try{localStorage.removeItem(P)}catch(e){console.warn("localStorage not available:",e)}try{sessionStorage.removeItem(P)}catch(e){console.warn("sessionStorage not available:",e)}}function D(e,t,o){var i=I();if(!(i.estimates&&i.estimates[t]&&i.estimates[t].rooms&&i.estimates[t].rooms[o]))return null;var r=i.estimates[t].rooms[o];return Array.isArray(e)?(r.product_suggestions=e,k(i),r.product_suggestions):(console.error("Error: suggestedProducts must be an array."),null)}function q(e,t,o){var i=I();if(!(i.estimates&&i.estimates[e]&&i.estimates[e].rooms&&i.estimates[e].rooms[t]))return console.error("EstimateStorage: Estimate or Room not found. E: ".concat(e,", R: ").concat(t)),!1;var r=i.estimates[e].rooms[t];return Array.isArray(r.products)||(r.products=[]),Array.isArray(r.product_suggestions)||(r.product_suggestions=[]),r.products.find((function(e){return e.id===o.id}))?(console.warn("EstimateStorage: Product with ID ".concat(o.id," already exists in room ").concat(t,". Aborting add to room.products.")),!1):(r.products.push(o),k(i),console.log("EstimateStorage: Product ".concat(o.id," added to room ").concat(t,". products:"),r.products),!0)}function A(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,i=Array(t);o<t;o++)i[o]=e[o];return i}function R(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function T(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?R(Object(o),!0).forEach((function(t){m(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):R(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}L("CustomerStorage");var F=L("EstimateStorage"),x=function(){return c((function e(){var t,o,i,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(r(this,e),window._dataServiceInstance)return F.log("Using existing DataService instance"),window._dataServiceInstance;this.config=Object.assign({debug:!1,ajaxUrl:(null===(t=window.productEstimatorVars)||void 0===t?void 0:t.ajax_url)||"/wp-admin/admin-ajax.php",nonce:(null===(o=window.productEstimatorVars)||void 0===o?void 0:o.nonce)||"",i18n:(null===(i=window.productEstimatorVars)||void 0===i?void 0:i.i18n)||{}},a),this.cache={estimatesData:null,estimatesList:null,rooms:{},similarProducts:{}},window._dataServiceLogged||(F.log("DataService initialized"),window._dataServiceLogged=!0),window._dataServiceInstance=this}),[{key:"request",value:function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return F.log("Making request to '".concat(e,"'"),o),new Promise((function(i,r){var a=new FormData;a.append("action",e),a.append("nonce",t.config.nonce),Object.entries(o).forEach((function(e){var t=g(e,2),o=t[0],i=t[1];null!=i&&a.append(o,String(i))})),t.config.debug&&F.log("Request details:",{url:t.config.ajaxUrl,action:e,nonce:t.config.nonce,data:Object.fromEntries(a)}),fetch(t.config.ajaxUrl,{method:"POST",credentials:"same-origin",body:a}).then((function(e){if(!e.ok)throw F.error("Network response error (".concat(e.status,"): ").concat(e.statusText)),new Error("Network response was not ok: ".concat(e.status));return e.json()})).then((function(t){if(t.success)F.log("Request '".concat(e,"' succeeded:"),t.data),i(t.data);else{var o,a=new Error((null===(o=t.data)||void 0===o?void 0:o.message)||"Unknown error");a.data=t.data,F.log("Request '".concat(e,"' failed:"),a),r(a)}})).catch((function(t){F.log("Request '".concat(e,"' error:"),t);var o=new Error("AJAX request failed: ".concat(t.message));o.originalError=t,o.action=e,r(o)}))}))}},{key:"checkEstimatesExist",value:function(){var e=this;return new Promise((function(t){var o=e.loadEstimateData?e.loadEstimateData():I(),i=o&&o.estimates&&Object.keys(o.estimates).length>0;F.log("Checking localStorage for estimates: ".concat(i?"Found":"None found")),t(i)}))}},{key:"getProductUpgrades",value:function(e,t,o,i,r){var a=this,n=arguments.length>5&&void 0!==arguments[5]&&arguments[5];F.log("[DataService.getProductUpgrades] DEBUG: Called with productId: ".concat(e,", estimateId: ").concat(t,", roomId: ").concat(o,", roomArea: ").concat(i,", upgradeType: ").concat(r,", bypassCache: ").concat(n));var s="upgrades_".concat(e,"_").concat(t,"_").concat(o,"_").concat(r);return this.cache.productUpgrades=this.cache.productUpgrades||{},!n&&this.cache.productUpgrades[s]?(F.log("[DataService.getProductUpgrades] DEBUG: Returning cached upgrades for product ".concat(e,".")),Promise.resolve(this.cache.productUpgrades[s])):(F.log("[DataService.getProductUpgrades] DEBUG: Fetching product upgrades from server for product ".concat(e,". Calling this.request('get_product_upgrades', ...).")),this.request("get_product_upgrades",{product_id:e,estimate_id:t,room_id:o,room_area:i,upgrade_type:r}).then((function(e){return F.log("[DataService.getProductUpgrades] DEBUG: Response from this.request for 'get_product_upgrades':",e),e&&Array.isArray(e.upgrades)?(a.cache.productUpgrades[s]=e.upgrades,e.upgrades):(F.warn("[getProductUpgrades] DEBUG: get_product_upgrades did not return expected data structure.",e),[])})).catch((function(e){throw F.error("[getProductUpgrades] DEBUG: Error fetching product upgrades:",e),delete a.cache.productUpgrades[s],e})))}},{key:"getEstimatesData",value:function(){if(!(arguments.length>0&&void 0!==arguments[0]&&arguments[0])&&this.cache.estimatesData)return F.log("Returning cached estimates data from localStorage."),Promise.resolve(this.cache.estimatesData);F.log("Loading estimates data from localStorage.");var e=I(),t=e&&e.estimates?Object.values(e.estimates):[];return this.cache.estimatesData=t,Promise.resolve(t)}},{key:"getRoomsForEstimate",value:function(e){var t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o="estimate_".concat(e);if(!t&&this.cache.rooms[o])return F.log("Returning cached rooms for estimate ".concat(e," from localStorage.")),Promise.resolve(this.cache.rooms[o]);F.log("Loading rooms for estimate ".concat(e," from localStorage."));var i=I(),r=i&&i.estimates?i.estimates[e]:null,a=[],n=!1;r&&r.rooms?(n=(a=(a=Object.values(r.rooms)).map((function(e){var t=parseFloat(e.width)||0,o=parseFloat(e.length)||0;return T(T({},e),{},{dimensions:"".concat(t," x ").concat(o)})}))).length>0,F.log("Found ".concat(a.length," rooms for estimate ").concat(e," in localStorage."))):F.log("Estimate ".concat(e," not found or has no rooms in localStorage."));var s={has_rooms:n,rooms:a};return this.cache.rooms[o]=s,Promise.resolve(s)}},{key:"addProductToRoom",value:function(e,t){var o,i,r=this,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;F.log("DataService: Adding product to room (localStorage first)",{roomId:e,productId:t,estimateId:a});var n=I(),s=n.estimates?n.estimates[a]:null,c=s&&s.rooms?s.rooms[e]:null,l=null,d=null;if(c){if(l=c.width,d=c.length,c.products&&c.products.find((function(e){return e.id==t})))return F.warn("DataService: Product ID ".concat(t," already exists in room ").concat(e," locally. Aborting.")),Promise.reject({message:this.config.i18n.product_already_exists||"This product already exists in the selected room.",data:{duplicate:!0,estimate_id:a,room_id:e}})}else F.warn("DataService: Room ID ".concat(e," not found in local storage for estimate ").concat(a,". Room dimensions will be null for product data fetch."));var m=null!==(o=null==c||null===(i=c.products)||void 0===i?void 0:i.map((function(e){return e.id})))&&void 0!==o?o:[],g=u(new Set([].concat(u(m),[t]))),p=this.request("get_product_data_for_storage",{product_id:t,room_width:l,room_length:d,room_products:g}).then((function(o){if(F.log("DataService: Fetched comprehensive product data (including similar and room suggestions):",o),!o||!o.product_data)return F.warn("Failed to get comprehensive product data from server for local storage."),{success:!1,error:new Error("Failed to fetch complete product data for local storage.")};var i=o.product_data;Array.isArray(i.similar_products)||(i.similar_products=[]);var r=Array.isArray(o.room_suggested_products)?o.room_suggested_products:Array.isArray(i.room_suggested_products)?i.room_suggested_products:[];i.hasOwnProperty("room_suggested_products")&&delete i.room_suggested_products,F.log("DataService: Comprehensive product data to be stored:",i),F.log("DataService: Room suggestions to be stored:",r);try{if(q(a,e,i)){var n,s;F.log("Product ID ".concat(t," (with its similar products) successfully added to room ").concat(e," in localStorage.")),D(r,a,e),F.log("Room suggestions updated in localStorage for room ".concat(e,"."));var c=I();return{success:!0,estimateData:c,estimateId:a,roomId:e,productData:i,estimate_totals:(null===(n=c.estimates)||void 0===n||null===(n=n[a])||void 0===n?void 0:n.totals)||{min_total:0,max_total:0},room_totals:(null===(s=c.estimates)||void 0===s||null===(s=s[a])||void 0===s||null===(s=s.rooms)||void 0===s||null===(s=s[e])||void 0===s?void 0:s.totals)||{min_total:0,max_total:0}}}return F.warn("DataService: Failed to add product ID ".concat(t," to room ").concat(e," in localStorage via addProductToRoomStorage.")),{success:!1,error:new Error("Failed to add to local storage (product might exist or storage function failed).")}}catch(o){return F.error("DataService: Error adding comprehensive product ID ".concat(t," to room ").concat(e," in localStorage:"),o),{success:!1,error:o}}})).catch((function(e){return F.error("Error fetching comprehensive product data (including similar products):",e),{success:!1,error:e}}));return p.then((function(o){if(o.success){F.log("DataService: Local storage update successful, sending asynchronous server request for adding product to session.");var i={room_id:String(e),product_id:String(t)};return null!==a&&(i.estimate_id=String(a)),r.request("add_product_to_room",i)}return F.warn("Local storage update failed, skipping asynchronous server request for adding product to session."),Promise.resolve({server_request_skipped:!0,local_error:o.error})})).then((function(e){e&&!e.server_request_skipped&&(F.log("DataService: Asynchronous server-side product add (to session) successful:",e),r.invalidateCache())})).catch((function(e){F.error("Asynchronous server-side product add (to session) failed:",e)})),p}},{key:"replaceProductInRoom",value:function(e,t,o,i,r){var n,s,c=this,l=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"main";F.log("DataService: Initiating product replacement (localStorage first)",{estimateId:e,roomId:t,oldProductId:o,newProductId:i,parentProductId:r,replaceType:l});var d=null===(n=I().estimates)||void 0===n?void 0:n[e],m=null==d||null===(s=d.rooms)||void 0===s?void 0:s[t],g=null==m?void 0:m.width,p=null==m?void 0:m.length,h=[];if(m&&Array.isArray(m.products)){var f=(h=m.products.map((function(e){return e.id}))).indexOf(o);f>-1?h.splice(f,1,i):h.push(i)}else h.push(i);h=u(new Set(h));var v=this.request("get_product_data_for_storage",{product_id:i,room_width:g,room_length:p,room_products:h}).then((function(n){if(F.log("DataService: Fetched comprehensive product data for storage (for local replacement):",n),!n||!n.product_data)throw new Error("Failed to fetch complete product data for local replacement.");var s=n.product_data,c=Array.isArray(n.room_suggested_products)?n.room_suggested_products:Array.isArray(s.room_suggested_products)?s.room_suggested_products:[];if(s.hasOwnProperty("room_suggested_products")&&delete s.room_suggested_products,F.log("DataService: New product data for replacement:",s),F.log("DataService: New room suggestions to be stored:",c),function(e,t,o,i,r){var n=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"main",s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,c=I();if(!(c.estimates&&c.estimates[e]&&c.estimates[e].rooms&&c.estimates[e].rooms[t]))return console.warn("Estimate or room not found in storedData."),!1;var l=c.estimates[e].rooms[t];if(console.log("Debugging: State of room.products:",l.products,"(Type: ".concat(a(l.products),")"),"(Is Array: ".concat(Array.isArray(l.products),")")),!l.products)return!1;if(console.log("Debugging: Value of replaceType before check:",n,"(Type: ".concat(a(n),")")),"additional_products"===n&&null!==s){console.log("Starting outer loop for main products...");for(var d=null,u=0;u<l.products.length;u++){var m=l.products[u];if(m.id==s){d=m,console.log("Found parent product:",d);break}}if(d&&d.additional_products&&Array.isArray(d.additional_products)){console.log("Searching additional products for parent product ID: ".concat(s));for(var g=0;g<d.additional_products.length;g++){var p=d.additional_products[g];if(p.id==o||p.replacement_chain&&p.replacement_chain.includes(o))return console.log("  Match found for oldProductId ".concat(o," under parent ").concat(s,"! Replacing...")),p.replacement_chain||(p.replacement_chain=[]),p.replacement_chain.includes(p.id)||p.replacement_chain.push(p.id),r.replacement_chain=p.replacement_chain,l.products.find((function(e){return e.id==s})).additional_products[g]=r,k(c),!0}console.warn("Additional product with oldProductId ".concat(o," not found under parent product ID ").concat(s,"."))}else console.warn("Parent product with ID ".concat(s," not found or has no additional products."));return console.warn("Additional product with oldProductId ".concat(o," not found in any additional_products array.")),!1}if("main"===n){for(var h=!1,f=-1,v=0;v<l.products.length;v++)if(l.products[v].id==o){h=!0,f=v;break}return!!(h&&f>=0)&&(l.products.splice(f,1),l.products.push(r),k(c),!0)}}(e,t,o,i,s,l,r)){var d,u;F.log("Product replacement (old ID ".concat(o," -> new ID ").concat(i,") successful in localStorage for room ").concat(t,".")),D(c,e,t),F.log("Room suggestions updated in localStorage for room ".concat(t," after product replacement."));var m=I(),g=null===(d=m.estimates)||void 0===d?void 0:d[e],p=null==g||null===(u=g.rooms)||void 0===u?void 0:u[t];return{success:!0,estimateData:m,estimateId:e,roomId:t,oldProductId:o,newProductId:i,productData:s,estimate_totals:(null==g?void 0:g.totals)||{min_total:0,max_total:0},room_totals:(null==p?void 0:p.totals)||{min_total:0,max_total:0}}}throw new Error("Failed to replace product in local storage. Original product not found or storage function failed.")})).catch((function(e){throw F.error("Error during fetch or local storage replacement attempt:",e),e}));return v.then((function(a){if(a.success){F.log("DataService: Local storage replacement successful, sending asynchronous server request for session update.");var n={estimate_id:String(e),room_id:String(t),product_id:String(i),replace_product_id:String(o),replace_type:l};return null!==r&&(n.parent_product_id=String(r)),c.request("replace_product_in_room",n)}})).then((function(e){F.log("DataService: Asynchronous server-side product replacement (session) successful:",e),c.invalidateCache()})).catch((function(e){F.error("Asynchronous server-side product replacement (session) failed or skipped due to local failure:",e)})),v}},{key:"getSimilarProducts",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r="similar_".concat(e,"_area_").concat(t);if(!i&&this.cache.similarProducts&&this.cache.similarProducts[r])return F.log("Returning cached similar products for product ".concat(e," and area ").concat(t)),Promise.resolve(this.cache.similarProducts[r]);F.log("Attempting to make 'get_similar_products' request for product ID: ".concat(e,", area: ").concat(t,". Cache bypass: ").concat(i));var a={product_id:e,room_area:t};return this.request("get_similar_products",a).then((function(e){return e&&Array.isArray(e.products)?(o.cache.similarProducts=o.cache.similarProducts||{},o.cache.similarProducts[r]=e.products,e.products):(F.warn("get_similar_products did not return expected data structure (expected { products: [...] })",e),[])})).catch((function(e){throw F.error("Error fetching similar products:",e),o.cache.similarProducts=o.cache.similarProducts||{},delete o.cache.similarProducts[r],e}))}},{key:"addNewEstimate",value:function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i={form_data:this.formatFormData(e)};o&&(i.product_id=o);var r=e instanceof FormData?e.get("estimate_name"):e.estimate_name||"Unnamed Estimate",a=I().estimates||{},n=Object.keys(a).length,s=function(e){var t=I();t.estimates||(t.estimates={});var o=e.id;return o||(o="estimate_".concat(Date.now())),t.estimates[o]=e,k(t),o}({id:String(n),name:r,rooms:{}});return F.log("Client-side estimate saved to localStorage with sequential ID: ".concat(s)),this.request("add_new_estimate",i).then((function(e){F.log("DataService: Server-side estimate creation successful:",e),t.invalidateCache()})).catch((function(e){F.error("Server-side estimate creation failed:",e)})),Promise.resolve({estimate_id:s})}},{key:"addNewRoom",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return F.log("DataService: Adding new room",{estimateId:t,productId:i,formData:e instanceof FormData?Object.fromEntries(e):e}),new Promise((function(r,a){var n=I(),s=n.estimates?n.estimates[t]:null;if(!s){var c="Estimate with ID ".concat(t," not found in local storage.");F.error("DataService: Cannot add room - ".concat(c));var l={form_data:o.formatFormData(e),estimate_id:t};return i&&(l.product_id=i),o.request("add_new_room",l).then((function(e){return F.log("DataService: Server add_new_room succeeded despite local estimate not found:",e)})).catch((function(e){return F.error("Server add_new_room failed after local estimate not found:",e)})),void a(new Error(c))}var d=String(Object.keys(s.rooms||{}).length),u=parseFloat(e instanceof FormData?e.get("room_width"):e.room_width)||0,m=parseFloat(e instanceof FormData?e.get("room_length"):e.room_length)||0,g={id:d,name:e instanceof FormData?e.get("room_name")||"Unnamed Room":e.room_name||"Unnamed Room",width:u,length:m,products:[],product_suggestions:[],min_total:0,max_total:0};(function(e,t){var o=I();if(!o.estimates||!o.estimates[e])return!1;var i=o.estimates[e];i.rooms||(i.rooms={});var r=t.id;r||(r="room_".concat(Date.now())),i.rooms[r]=t,k(o)})(t,g),F.log("Room ID ".concat(g.id," added to localStorage for estimate ").concat(t));var p={form_data:o.formatFormData(e),estimate_id:t};i&&(p.product_id=i),o.request("add_new_room",p).then((function(e){F.log("DataService: Server-side room creation successful:",e),o.invalidateCache()})).catch((function(e){F.error("Server-side room creation failed:",e)})),i?(F.log("DataService: Product ID ".concat(i," provided. Fetching its data to add to new room ").concat(d,".")),o.request("get_product_data_for_storage",{product_id:i,room_width:u,room_length:m,room_products:[i]}).then((function(e){if(F.log("DataService: Fetched comprehensive product data for new room product:",e),!e||!e.product_data){var o="Failed to get comprehensive product data for local storage for new room product.";return F.warn("DataService: ".concat(o)),void r(T(T({room_id:d,estimate_id:t},g),{},{product_added_successfully:!1,error:o}))}var n=e.product_data,s=Array.isArray(e.room_suggested_products)?e.room_suggested_products:Array.isArray(n.room_suggested_products)?n.room_suggested_products:[];n.hasOwnProperty("room_suggested_products")&&delete n.room_suggested_products;try{if(q(t,d,n))F.log("Product ID ".concat(i," successfully added to new room ").concat(d," in localStorage.")),D(s,t,d),F.log("Suggestions updated for new room ".concat(d," in localStorage.")),r(T(T({room_id:d,estimate_id:t},g),{},{product_data:n,product_added_successfully:!0}));else{var c="Failed to add product ID ".concat(i," to new room ").concat(d," in localStorage (addProductToRoomStorage returned false).");F.warn("DataService: ".concat(c)),r(T(T({room_id:d,estimate_id:t},g),{},{product_added_successfully:!1,error:c}))}}catch(e){var l="Error adding product ID ".concat(i," to new room ").concat(d," in localStorage: ").concat(e.message);F.error("DataService: ".concat(l),e),a(new Error(l))}})).catch((function(e){var t="DataService: Error fetching product data for new room: ".concat(e.message);F.error(t,e),a(new Error(t))}))):(F.log("No product ID provided for new room. Resolving with room data only."),r(T(T({room_id:d,estimate_id:t},g),{},{product_added_successfully:null})))}))}},{key:"removeProductFromRoom",value:function(e,t,o,i){var r=this;return F.log("[removeProductFromRoom] Initiating product removal process",{estimateId:e,roomId:t,productIndex:o,productId:i}),new Promise((function(a,n){var s,c,l=null===(s=I().estimates)||void 0===s?void 0:s[e],d=null==l||null===(c=l.rooms)||void 0===c?void 0:c[t];if(!d||!Array.isArray(d.products)){var u="Room or products array not found in localStorage for suggestion fetching or removal.";return F.log("[removeProductFromRoom] Error: ".concat(u)),void n(new Error(u))}if(!d.products.find((function(e){return String(e.id)===String(i)}))){var m="Product with ID ".concat(i," not found in room ").concat(t," (localStorage) prior to suggestion fetching.");F.log("[removeProductFromRoom] Warning: ".concat(m))}var g=d.products.filter((function(e){return String(e.id)!==String(i)})).map((function(e){return e.id}));F.log("[removeProductFromRoom] Fetching updated suggestions for room based on post-deletion state."),r.request("fetch_suggestions_for_modified_room",{estimate_id:e,room_id:t,room_product_ids_for_suggestions:JSON.stringify(g)}).then((function(s){var c,l;F.log("[removeProductFromRoom] Successfully fetched updated suggestions:",s),s&&Array.isArray(s.updated_suggestions)?(D(s.updated_suggestions,e,t),F.log("[removeProductFromRoom] Suggestions updated in localStorage.")):(F.log("[removeProductFromRoom] No updated_suggestions array received or invalid format. Clearing local suggestions."),D([],e,t));var d=!1,u=null;try{(d=function(e,t,o,i){var r=I();if(!(r.estimates&&r.estimates[e]&&r.estimates[e].rooms&&r.estimates[e].rooms[t]&&Array.isArray(r.estimates[e].rooms[t].products)))return console.warn("[EstimateStorage.removeProductFromRoom] Attempted to remove product: Path to products array is invalid or products array is missing.",{estimateId:e,roomId:t,receivedProductId:i}),!1;var a=r.estimates[e].rooms[t].products,n=a.findIndex((function(e){return String(e.id)===String(i)}));return-1===n?(console.warn("[EstimateStorage.removeProductFromRoom] Product with ID '<span class=\"math-inline\">{productId}' not found in room '</span>{roomId}' for estimate '".concat(e,"'. Cannot remove.")),!1):(a.splice(n,1),k(r),console.log("[EstimateStorage.removeProductFromRoom] Product with ID '<span class=\"math-inline\">{productId}' successfully removed from localStorage for room '</span>{roomId}', estimate '".concat(e,"'.")),!0)}(e,t,0,i))?F.log("[removeProductFromRoom] Product ID ".concat(i," reported as removed from localStorage by EstimateStorage.")):(u=new Error("Failed to remove product ID ".concat(i," from localStorage (EstimateStorage.removeProductFromRoom returned false).")),F.log("[removeProductFromRoom] Warning: ".concat(u.message)))}catch(e){u=new Error("Error during localStorage product removal for ID ".concat(i,": ").concat(e.message)),F.log("[removeProductFromRoom] Error: ".concat(u.message),e)}if(!u||d){var m=null===(c=I().estimates)||void 0===c?void 0:c[e],g=null==m||null===(l=m.rooms)||void 0===l?void 0:l[t];a({success:!0,message:d?"Product removed locally and suggestions updated.":"Suggestions updated; product removal from local storage might have issues (check logs).",estimateId:e,roomId:t,productId:i,estimate_totals:(null==m?void 0:m.totals)||{min_total:0,max_total:0},room_totals:(null==g?void 0:g.totals)||{min_total:0,max_total:0}}),F.log("[removeProductFromRoom] Initiating asynchronous server call to remove_product_from_room."),r.request("remove_product_from_room",{estimate_id:e,room_id:t,product_index:o,product_id:i}).then((function(e){F.log("[removeProductFromRoom] Async server product removal successful:",e),r.invalidateCache()})).catch((function(e){F.log("[removeProductFromRoom] Async server product removal failed:",e)}))}else n(u)})).catch((function(e){F.log("[removeProductFromRoom] Error fetching suggestions before removal:",e),n(new Error("Failed to fetch updated suggestions before product removal: ".concat(e.message)))}))}))}},{key:"removeRoom",value:function(e,t){var o=this;F.log("DataService: Removing room",{estimateId:e,roomId:t});try{!function(e,t){var o=I();return!!(o.estimates&&o.estimates[e]&&o.estimates[e].rooms&&o.estimates[e].rooms[t])&&(delete o.estimates[e].rooms[t],k(o),!0)}(e,t)?F.warn("Room ID ".concat(t," not found in localStorage for estimate ").concat(e," during removal attempt.")):F.log("Room ID ".concat(t," successfully removed from localStorage for estimate ").concat(e))}catch(e){F.error("Error removing room ID ".concat(t," from localStorage:"),e)}var i={estimate_id:String(e),room_id:String(t)};return this.request("remove_room",i).then((function(e){F.log("DataService: Server-side room removal successful:",e),o.invalidateCache()})).catch((function(e){F.error("Server-side room removal failed:",e)})),Promise.resolve({success:!0})}},{key:"removeEstimate",value:function(e){var t=this;F.log("DataService: Removing estimate ".concat(e));try{!function(e){var t=I();return!(!t.estimates||!t.estimates[e]||(delete t.estimates[e],k(t),0))}(e)?F.warn("Estimate ID ".concat(e," not found in localStorage during removal attempt.")):F.log("Estimate ID ".concat(e," successfully removed from localStorage."))}catch(t){F.error("Error removing estimate ID ".concat(e," from localStorage:"),t)}return this.request("remove_estimate",{estimate_id:e}).then((function(o){F.log("DataService: Server-side estimate removal successful: ".concat(e),o),t.invalidateCache()})).catch((function(t){F.error("DataService: Server-side estimate removal failed: ".concat(e),t)})),Promise.resolve({success:!0})}},{key:"getSuggestedProducts",value:function(e,t){F.log("Getting suggested products for room ".concat(t," in estimate ").concat(e," from localStorage."));var o=function(e,t){var o=I();return o.estimates&&o.estimates[e]&&o.estimates[e].rooms&&o.estimates[e].rooms[t]&&o.estimates[e].rooms[t].product_suggestions||null}(e,t);return o?(F.log("Found suggestions for room ".concat(t,":"),o),Promise.resolve(o)):(F.log("No suggestions found for room ".concat(t," in localStorage.")),Promise.resolve(null))}},{key:"getVariationEstimator",value:function(e){return this.request("get_variation_estimator",{variation_id:e})}},{key:"formatFormData",value:function(e){if("string"==typeof e)return e;if(e instanceof FormData){var t,o=new URLSearchParams,i=function(e,t){var o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=function(e,t){if(e){if("string"==typeof e)return A(e,t);var o={}.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?A(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){o&&(e=o);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,n=!0,s=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return n=e.done,e},e:function(e){s=!0,a=e},f:function(){try{n||null==o.return||o.return()}finally{if(s)throw a}}}}(e.entries());try{for(i.s();!(t=i.n()).done;){var r=g(t.value,2),a=r[0],n=r[1];o.append(a,n)}}catch(e){i.e(e)}finally{i.f()}return o.toString()}return new URLSearchParams(e).toString()}},{key:"invalidateCache",value:function(){F.log("Invalidating caches"),this.cache.estimatesData=null,this.cache.estimatesList=null,this.cache.rooms={}}}])}();const N=x;function O(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function H(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?O(Object(o),!0).forEach((function(t){m(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):O(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}var M=L("ConfirmationDialog"),B=function(){return c((function e(){r(this,e),this.dialog=null,this.backdropElement=null,this.initialized=!1,this.callbacks={confirm:null,cancel:null},this.init()}),[{key:"init",value:function(){this.initialized||(this.createDialogElements(),this.bindEvents(),this.initialized=!0,productEstimatorVars&&productEstimatorVars.debug&&M.log("Initialized"))}},{key:"createDialogElements",value:function(){this.backdropElement=document.createElement("div"),this.backdropElement.className="pe-dialog-backdrop",this.dialog=document.createElement("div"),this.dialog.className="pe-confirmation-dialog",this.dialog.setAttribute("role","dialog"),this.dialog.setAttribute("aria-modal","true"),this.dialog.innerHTML='\n    <div class="dialog-content">\n      <div class="pe-dialog-header">\n        <h3 class="pe-dialog-title">Confirm Action</h3>\n        <button type="button" class="pe-dialog-close" aria-label="Close">\n          <span aria-hidden="true">&times;</span>\n        </button>\n      </div>\n      <div class="pe-dialog-body">\n        <p class="pe-dialog-message">Are you sure you want to proceed?</p>\n      </div>\n      <div class="pe-dialog-footer">\n        <button type="button" class="pe-dialog-btn pe-dialog-cancel">Cancel</button>\n        <button type="button" class="pe-dialog-btn pe-dialog-confirm">Confirm</button>\n      </div>\n    </div>\n  ';var e=document.querySelector(".pe-dialog-backdrop"),t=document.querySelector(".pe-confirmation-dialog");e&&e.remove(),t&&t.remove(),document.body.appendChild(this.backdropElement),document.body.appendChild(this.dialog)}},{key:"bindEvents",value:function(){var e=this,t=this.dialog.querySelector(".pe-dialog-close"),o=this.dialog.querySelector(".pe-dialog-cancel"),i=this.dialog.querySelector(".pe-dialog-confirm");t.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation(),e.hide(),"function"==typeof e.callbacks.cancel&&e.callbacks.cancel()})),o.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation(),e.hide(),"function"==typeof e.callbacks.cancel&&e.callbacks.cancel()})),i.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation(),e.hide(),"function"==typeof e.callbacks.confirm&&e.callbacks.confirm()})),this.backdropElement.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation(),t.target===e.backdropElement&&(e.hide(),"function"==typeof e.callbacks.cancel&&e.callbacks.cancel())})),this.dialog.addEventListener("click",(function(e){e.stopPropagation()})),document.addEventListener("keydown",(function(t){"Escape"===t.key&&e.isVisible()&&(t.preventDefault(),t.stopPropagation(),e.hide(),"function"==typeof e.callbacks.cancel&&e.callbacks.cancel())}))}},{key:"show",value:function(){var e,t=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=(null===(e=window.productEstimatorVars)||void 0===e?void 0:e.i18n)||{},r=H(H({},{title:"Confirm Action",message:"Are you sure you want to proceed?",type:"",confirmText:i.confirm||"Confirm",cancelText:i.cancel||"Cancel",onConfirm:null,onCancel:null,action:"delete",showCancel:!0}),o);null!==o.cancelText&&!1!==o.cancelText||(r.showCancel=!1),this.callbacks.confirm=r.onConfirm,this.callbacks.cancel=r.onCancel;var a=this.dialog.querySelector(".pe-dialog-title"),n=this.dialog.querySelector(".pe-dialog-message"),s=this.dialog.querySelector(".pe-dialog-confirm"),c=this.dialog.querySelector(".pe-dialog-cancel");a&&(a.textContent=r.title),n&&(n.textContent=r.message),s&&(s.textContent=r.confirmText),c&&(r.showCancel?(c.style.display="",c.textContent=r.cancelText):(c.style.display="none",s&&(s.style.width="100%"))),this.dialog.classList.remove("pe-dialog-type-product","pe-dialog-type-room","pe-dialog-type-estimate","pe-dialog-notification"),u(this.dialog.classList).forEach((function(e){/^pe-dialog-action-/.test(e)&&t.dialog.classList.remove(e)})),r.type&&this.dialog.classList.add("pe-dialog-type-".concat(r.type)),r.action&&this.dialog.classList.add("pe-dialog-action-".concat(r.action)),r.showCancel||"estimate"!==r.type||this.dialog.classList.add("pe-dialog-notification"),this.backdropElement&&(this.backdropElement.style.display="block"),this.dialog&&(this.dialog.style.display="block"),this.dialog&&this.dialog.classList.add("active"),setTimeout((function(){var e=r.showCancel?t.dialog.querySelector(".pe-dialog-cancel"):t.dialog.querySelector(".pe-dialog-confirm");e&&e.focus()}),100)}},{key:"hide",value:function(){this.backdropElement&&(this.backdropElement.style.display="none"),this.dialog&&(this.dialog.classList.remove("active"),this.dialog.style.display="none")}},{key:"isVisible",value:function(){return this.dialog&&"block"===this.dialog.style.display}}])}();const j=B;var z=L("SuggestionsCarousel"),U=function(){return c((function e(t){r(this,e),this.id="carousel_"+Math.random().toString(36).substr(2,9),this.container=t,this.itemsContainer=t.querySelector(".suggestions-container"),this.items=t.querySelectorAll(".suggestion-item"),this.prevBtn=t.querySelector(".suggestions-nav.prev"),this.nextBtn=t.querySelector(".suggestions-nav.next"),this.isSimilarProducts=t.classList.contains("similar-products-carousel"),this.itemsContainer&&this.items.length?(t.carouselInstance=this,this.isSimilarProducts?(this.itemWidth=130,this.itemGap=5):(this.itemWidth=200,this.itemGap=15),this.visibleItems=this.calculateVisibleItems(),this.currentPosition=0,this.maxPosition=Math.max(0,this.items.length-this.visibleItems),this.setContainerSize(),this.bindEvents(),this.updateButtons()):z.warn("[".concat(this.id,"] Carousel missing items container or has no items"))}),[{key:"getContainerWidth",value:function(){if(this.isSimilarProducts){var e=this.container.closest(".product-item");if(e)return e.offsetWidth-10}return this.container.offsetWidth}},{key:"setContainerSize",value:function(){if(this.isSimilarProducts){var e=this.container.closest(".product-item");if(e){var t=e.offsetWidth;this.container.style.maxWidth="".concat(t-10,"px")}Array.from(this.items).forEach((function(e){e.style.flexShrink="0",e.style.flexGrow="0"})),this.itemsContainer.style.gap="".concat(this.itemGap,"px")}}},{key:"calculateVisibleItems",value:function(){var e=this.getContainerWidth()-50,t=(this.isSimilarProducts?130:this.itemWidth)+(this.isSimilarProducts?5:this.itemGap);return Math.max(1,Math.floor(e/t))}},{key:"bindEvents",value:function(){var e=this;this.handlePrevClick=this.handlePrevClick.bind(this),this.handleNextClick=this.handleNextClick.bind(this),this.handleResize=this.handleResize.bind(this),this.prevBtn&&(this.prevBtn.removeEventListener("click",this.handlePrevClick),this.prevBtn.addEventListener("click",this.handlePrevClick)),this.nextBtn&&(this.nextBtn.removeEventListener("click",this.handleNextClick),this.nextBtn.addEventListener("click",this.handleNextClick)),this.resizeTimeout=null,window.addEventListener("resize",(function(){clearTimeout(e.resizeTimeout),e.resizeTimeout=setTimeout(e.handleResize,150)}))}},{key:"handlePrevClick",value:function(e){e.preventDefault(),e.stopPropagation(),this.currentPosition>0&&(this.currentPosition--,this.updatePosition(),this.updateButtons())}},{key:"handleNextClick",value:function(e){e.preventDefault(),e.stopPropagation(),this.currentPosition<this.maxPosition&&(this.currentPosition++,this.updatePosition(),this.updateButtons())}},{key:"handleResize",value:function(){this.setContainerSize(),this.visibleItems,this.visibleItems=this.calculateVisibleItems(),this.maxPosition=Math.max(0,this.items.length-this.visibleItems),this.currentPosition>this.maxPosition&&(this.currentPosition=this.maxPosition),this.updatePosition(),this.updateButtons()}},{key:"getAvailableWidth",value:function(){var e=this.container.clientWidth-50;if(this.isSimilarProducts){var t=this.container.closest(".product-item");if(t){var o=window.getComputedStyle(t),i=t.clientWidth-(parseFloat(o.paddingLeft)+parseFloat(o.paddingRight));e=Math.min(e,i)}}else{var r=this.container.closest(".accordion-content");if(r){var a=r.clientWidth-30;e=Math.min(e,a)}}return Math.max(e,100)}},{key:"updatePosition",value:function(){if(this.itemsContainer){var e=this.itemWidth+this.itemGap,t=-this.currentPosition*e;this.itemsContainer.style.transition="transform 0.3s ease",this.itemsContainer.style.transform="translateX(".concat(t,"px)")}}},{key:"updateButtons",value:function(){this.prevBtn&&(this.currentPosition<=0?(this.prevBtn.classList.add("disabled"),this.prevBtn.setAttribute("aria-disabled","true")):(this.prevBtn.classList.remove("disabled"),this.prevBtn.removeAttribute("aria-disabled"))),this.nextBtn&&(this.currentPosition>=this.maxPosition?(this.nextBtn.classList.add("disabled"),this.nextBtn.setAttribute("aria-disabled","true")):(this.nextBtn.classList.remove("disabled"),this.nextBtn.removeAttribute("aria-disabled")))}},{key:"destroy",value:function(){this.prevBtn&&this.prevBtn.removeEventListener("click",this.handlePrevClick),this.nextBtn&&this.nextBtn.removeEventListener("click",this.handleNextClick),window.removeEventListener("resize",this.handleResize),this.container&&delete this.container.carouselInstance}}])}();function V(){var e=document.querySelectorAll(".suggestions-carousel");e.forEach((function(e){e.carouselInstance&&e.carouselInstance.destroy()}));var t=[];return e.forEach((function(e){var o=new U(e);t.push(o)})),t}function Q(e){setTimeout((function(){var t=e.currentTarget.closest(".accordion-item");if(t){var o=t.querySelector(".accordion-content");o&&"none"!==window.getComputedStyle(o).display&&o.querySelectorAll(".suggestions-carousel").forEach((function(e){e.carouselInstance&&e.carouselInstance.destroy(),new U(e)}))}}),300)}document.addEventListener("DOMContentLoaded",(function(){V(),document.querySelectorAll(".accordion-header").forEach((function(e){e.removeEventListener("click",Q),e.addEventListener("click",Q)}))}));var G="productEstimatorCustomerData",W=L("CustomerStorage");function J(){try{var e=localStorage.getItem(G);if(e)return JSON.parse(e);var t=sessionStorage.getItem(G);return t?JSON.parse(t):{}}catch(e){return W.error("Error loading customer details:",e),{}}}function $(e){try{localStorage.setItem(G,JSON.stringify(e))}catch(t){W.warn("localStorage not available, using sessionStorage:",t);try{sessionStorage.setItem(G,JSON.stringify(e))}catch(e){W.error("sessionStorage not available:",e)}}}function Y(){try{localStorage.removeItem(G)}catch(e){W.warn("localStorage not available:",e)}try{sessionStorage.removeItem(G)}catch(e){W.warn("sessionStorage not available:",e)}}var K=L("TemplateEngine");const X=new(function(){return c((function e(){r(this,e),this.templates={},this.templateElements={},this.initialized=!1}),[{key:"init",value:function(){var e=this;return this.initialized?(K.log("[init] Already initialized."),this):(K.log("[init] Initializing TemplateEngine. Templates to process:",Object.keys(this.templates)),Object.entries(this.templates).forEach((function(t){var o=g(t,2),i=o[0],r=o[1];try{var a=document.createElement("div");a.innerHTML=r;var n=a.querySelector("template");if(n)e.templateElements[i]=n,K.log('[init] Template element found in HTML for ID: "'.concat(i,'"'));else{K.error('[init] UNEXPECTED: templateElement was null/undefined for ID: "'.concat(i,'". Creating nested template. Original HTML likely already contained a <template> tag.'));var s=document.createElement("template");s.id=i,s.innerHTML=r,e.templateElements[i]=s,K.log('[init] Created new template element for ID: "'.concat(i,'" (HTML was likely raw, not wrapped in <template>)'))}if(e.templateElements[i]){var c=e.templateElements[i].content||e.templateElements[i];if(K.log('[init] TemplateElement for "'.concat(i,'" created. Inner HTML starts with:'),((null==c?void 0:c.innerHTML)||"No innerHTML or content").substring(0,200)+"..."),"room-item-template"===i){var l=document.createElement("div");null!=c&&c.innerHTML?l.innerHTML=c.innerHTML:Array.from((null==c?void 0:c.childNodes)||[]).forEach((function(e){return l.appendChild(e.cloneNode(!0))})),K.log('[init] Checking "'.concat(i,'" content for .product-list:'),l.querySelector(".product-list")?"Found":"Not Found"),l.querySelector(".product-list")||K.error('[init] CRITICAL: .product-list not found in "'.concat(i,'" template element content after creation.'))}}else K.error('[init] Failed to assign template element for ID: "'.concat(i,'"'))}catch(e){K.error('[init] Error processing template HTML for ID "'.concat(i,'":'),e)}})),K.log("[init] TemplateEngine initialized with ".concat(Object.keys(this.templateElements).length," template elements")),this.initialized=!0,this)}},{key:"registerTemplate",value:function(e,t){return"string"!=typeof t||""===t.trim()?(K.warn('[registerTemplate] Cannot register empty or non-string HTML for template "'.concat(e,'".')),this):(this.templates[e]=t,this.initialized=!1,K.log('[registerTemplate] Registered template "'.concat(e,'". HTML starts with:'),t.substring(0,200)+"..."),this)}},{key:"getTemplate",value:function(e){this.initialized||(K.warn("[getTemplate] TemplateEngine not initialized yet. Calling init()."),this.init());var t=this.templateElements[e]||null;return t||K.error('[getTemplate] Template element not found for ID: "'.concat(e,'".')),t}},{key:"create",value:function(e){var t,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this.getTemplate(e);if(!i)return K.error('[create] Cannot create element. Template element not found for ID: "'.concat(e,'"')),document.createDocumentFragment();if(K.log('[DEBUG][TemplateEngine.create] Found template element for "'.concat(e,'":'),i),K.log('[DEBUG][TemplateEngine.create] Template "'.concat(e,'" direct innerHTML (first 200 chars):'),i.innerHTML.substring(0,200)),i.content){K.log('[DEBUG][TemplateEngine.create] Template "'.concat(e,'" has .content property:'),i.content),K.log('[DEBUG][TemplateEngine.create] Template "'.concat(e,'" .content.childNodes count:'),i.content.childNodes.length);for(var r=i.content.childNodes,a=0;a<Math.min(r.length,3);a++){var n=r[a],s=n.textContent?n.textContent.trim().substring(0,50):"[No textContent]";K.log("[DEBUG][TemplateEngine.create] Node[".concat(a,"] type: ").concat(n.nodeType,", name: ").concat(n.nodeName,", text: ").concat(s,"..."))}var c=i.content.firstElementChild;K.log('[DEBUG][TemplateEngine.create] Template "'.concat(e,'" .content.firstElementChild:'),c)}else K.error('[DEBUG][TemplateEngine.create] CRITICAL: Template "'.concat(e,'" DOES NOT HAVE a .content property!'));try{if(!i.content)return K.error('[create] Cannot clone template content for ID: "'.concat(e,'" - .content is missing.')),document.createDocumentFragment();if(!(t=i.content.cloneNode(!0)))return K.error('[create] Failed to clone template content for ID: "'.concat(e,'". cloneNode returned null/undefined.')),document.createDocumentFragment();K.log('[create] Cloned template content for "'.concat(e,'". Result is a DocumentFragment.'));var l=document.createElement("div");l.appendChild(t.cloneNode(!0)),K.log('[DEBUG][TemplateEngine.create] Cloned fragment structure for "'.concat(e,'" (first 200 chars): ').concat(l.innerHTML.substring(0,200),"..."))}catch(t){return K.error('[create] Error during template.content.cloneNode(true) for ID "'.concat(e,'":'),t),document.createDocumentFragment()}try{this.populateElement(t,o),K.log('[create] Populated fragment for "'.concat(e,'".'))}catch(t){K.error('[create] Error populating fragment for ID "'.concat(e,'":'),t)}if("room-item-template"===e){var d=t.querySelector(".product-list");K.log('[create] Created fragment for "'.concat(e,'". Checking for .product-list before returning:'),d?"Found":"Not Found"),d||K.error('[create] CRITICAL: .product-list not found in "'.concat(e,'" fragment before returning. This fragment will not render products correctly.'))}return t}},{key:"populateElement",value:function(e,t){var o=this;if(Object.entries(t).forEach((function(o){var i=g(o,2),r=i[0],n=i[1];"object"===a(n)||Array.isArray(n)||(e.querySelectorAll(".".concat(r)).forEach((function(e){"IMG"===e.tagName&&"image"===r?(e.src=n||"",t.name&&(e.alt=t.name)):"INPUT"===e.tagName||"SELECT"===e.tagName||"TEXTAREA"===e.tagName?e.value=n:e.textContent=n})),"name"===r&&e.querySelectorAll(".suggestion-name").forEach((function(e){e.textContent=n})),"image"===r&&e.querySelectorAll("img.similar-product-thumbnail").forEach((function(e){var o;e.src=n||"data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",e.alt=t.name||"Similar Product Image";var i=null===(o=e.closest(".suggestion-image"))||void 0===o?void 0:o.querySelector(".no-image");n&&""!==n.trim()?(e.style.display="",i&&(i.style.display="none")):(e.style.display="none",i&&(i.style.display=""))})),e.querySelectorAll("[data-".concat(r,"]")).forEach((function(e){e.setAttribute("data-".concat(r),n)})))})),void 0!==t.product_index&&e.querySelectorAll(".remove-product").forEach((function(e){e.dataset.productIndex=t.product_index,void 0!==t.estimate_id&&(e.dataset.estimateId=t.estimate_id),void 0!==t.room_id&&(e.dataset.roomId=t.room_id),K.log("Setting removal button data attributes: estimate=".concat(t.estimate_id,", room=").concat(t.room_id,", product=").concat(t.product_index))})),t.estimate_id&&e.querySelectorAll("[data-estimate-id]").forEach((function(e){e.setAttribute("data-estimate-id",t.estimate_id)})),t.room_id&&e.querySelectorAll("[data-room-id]").forEach((function(e){e.setAttribute("data-room-id",t.room_id)})),(t.name||t.room_name)&&e.querySelectorAll(".room-name").forEach((function(e){e.textContent=t.name||t.room_name||"Unnamed Room"})),t.id?(e.querySelectorAll("[data-product-id]").forEach((function(e){e.setAttribute("data-product-id",t.id)})),e.classList&&e.classList.contains("product-item")&&e.setAttribute("data-product-id",t.id)):t.product_id&&e.querySelectorAll("[data-product-id]").forEach((function(e){e.setAttribute("data-product-id",t.product_id)})),void 0!==t.product_index&&(e.querySelectorAll("[data-product-index]").forEach((function(e){e.setAttribute("data-product-index",t.product_index)})),e.classList&&e.classList.contains("product-item")&&e.setAttribute("data-product-index",t.product_index)),t.image&&e.querySelectorAll("img.product-thumbnail, img.product-img").forEach((function(e){e.src=t.image,e.alt=t.name||"Product"})),void 0!==t.min_total&&void 0!==t.max_total&&e.querySelectorAll(".estimate-price").forEach((function(e){e.textContent="".concat(f(t.min_total)," - ").concat(f(t.max_total))})),void 0!==t.min_price_total&&void 0!==t.max_price_total&&e.querySelectorAll(".product-price").forEach((function(e){e.textContent="".concat(f(t.min_price_total)," - ").concat(f(t.max_price_total))})),void 0!==t.min_price_total&&void 0!==t.max_price_total&&e.querySelectorAll(".suggestion-price").forEach((function(e){t.min_price_total===t.max_price_total?e.textContent=f?f(t.min_price_total):t.min_price_total:e.textContent="".concat(f?f(t.min_price_total):t.min_price_total," - ").concat(f?f(t.max_price_total):t.max_price_total)})),t.name&&e.querySelectorAll(".price-title, .product-name").forEach((function(e){e.textContent=t.name})),Object.entries(t).forEach((function(t){var i=g(t,2),r=i[0],a=i[1];if(Array.isArray(a)&&a.length>0){var n=e.querySelector(".".concat(r))||e.querySelector(".".concat(r,"-container"))||e.querySelector(".".concat(r,"-items"));if(n&&a[0].template){var s=a[0].template;a.forEach((function(e){var t=o.create(s,e);n.appendChild(t)}))}}})),t.additional_products){var i=e.querySelector(".includes-container"),r=e.querySelector(".product-includes-items");if(i&&r){r.innerHTML="";var n=Array.isArray(t.additional_products)?t.additional_products.filter((function(e){return e&&e.id})):[];if(n.length>0){i.style.display="block",i.classList.add("visible"),n.forEach((function(e){if(o.getTemplate("include-item-template")){var t={product_id:e.id,include_item_name:e.name||"Additional Product"};void 0!==e.min_price_total&&void 0!==e.max_price_total&&(t.include_item_total_price=f(e.min_price_total)+" - "+f(e.max_price_total),e.total_price=f(e.min_price_total)+" - "+f(e.max_price_total)),K.log("include item product:: ",e);var i=o.create("include-item-template",t),a=i.querySelector(".include-item-name");a&&(a.textContent=e.name||"");var n=i.querySelector(".include-item-total-price");n&&(n.textContent=e.total_price||""),r.appendChild(i)}}));var s=e.querySelector(".product-includes-toggle");s&&(s.style.display="")}else{i.style.display="none",i.classList.remove("visible");var c=e.querySelector(".product-includes-toggle");c&&(c.style.display="none")}}}if(t.additional_notes&&Array.isArray(t.additional_notes)){var l=e.querySelector(".notes-container"),d=e.querySelector(".product-notes-items");if(l&&d){d.innerHTML="";var u=t.additional_notes.filter((function(e){return e&&(e.note_text||e.text)&&""!==(e.note_text||e.text).trim()}));if(u.length>0)l.style.display="block",l.classList.add("visible"),u.forEach((function(e){if(o.getTemplate("note-item-template")){var t=o.create("note-item-template",{}),i=t.querySelector(".note-text");i&&(i.textContent=e.note_text||e.text||""),d.appendChild(t)}}));else{l.style.display="none",l.classList.remove("visible");var m=e.querySelector(".product-notes-toggle");m&&(m.style.display="none")}}}if(void 0!==t.replace_product_id){var p=e.querySelector(".replace-product-in-room");p&&(p.dataset.replaceProductId=t.replace_product_id,K.log("TemplateEngine: Set data-replace-product-id on button to: ".concat(t.replace_product_id)))}if(void 0!==t.pricing_method){var h=e.querySelector(".replace-product-in-room");h&&(h.dataset.pricingMethod=t.pricing_method,K.log("TemplateEngine: Set data-pricing-method on button to: ".concat(t.pricing_method)))}}},{key:"insert",value:function(e,t,o){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"append",r=this.create(e,t);if("string"==typeof o&&(o=document.querySelector(o)),!o)return K.error('[insert] Container not found for template: "'.concat(e,'"')),null;try{switch(i){case"prepend":o.prepend(r);break;case"before":o.parentNode.insertBefore(r,o);break;case"after":o.parentNode.insertBefore(r,o.nextSibling);break;case"replace":K.warn('[insert] "replace" position used for template "'.concat(e,"\". Replacing container with fragment's children.")),Array.from(r.childNodes),o.parentNode.replaceChild(r,o);break;default:o.appendChild(r)}return K.log('[insert] Inserted template "'.concat(e,'" into container. Position: ').concat(i)),r}catch(t){return K.error('[insert] Error inserting template "'.concat(e,'" into container. Position: ').concat(i),t),null}}},{key:"showMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:".product-estimator-modal-form-container";if(document.querySelectorAll(".modal-message").forEach((function(e){return e.remove()})),!this.getTemplate("modal-messages-template")){var i=document.createElement("div");return i.className="modal-message modal-".concat(t,"-message"),i.textContent=e,"string"==typeof o&&(o=document.querySelector(o)),void(o&&(o.prepend(i),setTimeout((function(){i.parentNode&&i.remove()}),5e3)))}var r=document.createElement("div");r.className="modal-message modal-".concat(t,"-message"),r.innerHTML='<div class="message-content">'.concat(e,"</div>"),"string"==typeof o&&(o=document.querySelector(o)),o&&(o.prepend(r),setTimeout((function(){r.parentNode&&r.remove()}),5e3))}},{key:"debugTemplates",value:function(){K.group("TemplateEngine Debug"),K.log("Registered template IDs:",Object.keys(this.templates)),K.log("Template elements:",Object.keys(this.templateElements)),Object.entries(this.templateElements).forEach((function(e){var t=g(e,2),o=t[0],i=t[1];K.log("Template ".concat(o,":"),i),i.content?K.log("- Has content: ".concat(i.content.childNodes.length," child nodes")):K.warn("- No content for template ".concat(o))})),K.groupEnd()}},{key:"debugNoteData",value:function(e,t){K.log("Note data processing:",{hasNotes:!(!t.additional_notes||!Array.isArray(t.additional_notes)),notesCount:t.additional_notes?t.additional_notes.length:0,notesContainer:e.querySelector(".notes-container")?"found":"missing",notesItems:e.querySelector(".product-notes-items")?"found":"missing",noteTemplate:this.getTemplate("note-item-template")?"found":"missing",firstNote:t.additional_notes&&t.additional_notes.length>0?t.additional_notes[0]:null})}},{key:"verifyTemplates",value:function(){K.group("Template Verification"),K.log("Registered templates:",Object.keys(this.templates)),K.log("Template elements:",Object.keys(this.templateElements)),this.templates["note-item-template"]?K.log("Note template HTML:",this.templates["note-item-template"].substring(0,100)+"..."):K.warn("Note template not registered!"),this.templateElements["note-item-template"]?K.log("Note template element exists"):K.warn("Note template element not created!"),K.groupEnd()}}])}());function Z(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,i=Array(t);o<t;o++)i[o]=e[o];return i}function ee(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}function te(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?ee(Object(o),!0).forEach((function(t){m(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):ee(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}var oe=L("ModalManager"),ie=function(){return c((function e(){var t,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0;r(this,e),this.config=Object.assign({debug:!1,selectors:{modalContainer:"#product-estimator-modal",estimatorButtons:".product-estimator-button, .single_add_to_estimator_button",modalOverlay:".product-estimator-modal-overlay",closeButton:".product-estimator-modal-close",contentContainer:".product-estimator-modal-form-container",loadingIndicator:".product-estimator-modal-loading",estimatesList:"#estimates",estimateSelection:"#estimate-selection-wrapper",roomSelection:"#room-selection-form-wrapper",newEstimateForm:"#new-estimate-form-wrapper",newRoomForm:"#new-room-form-wrapper"},i18n:(null===(t=window.productEstimatorVars)||void 0===t?void 0:t.i18n)||{}},o),this.dataService=i,this.loadCustomerDetails=J,this.saveCustomerDetails=$,this.clearCustomerDetails=Y,this.loadEstimateData=I,this.clearEstimateData=C,this.saveEstimateData=k,this.modal=null,this.overlay=null,this.closeButton=null,this.contentContainer=null,this.loadingIndicator=null,this.estimatesList=null,this.estimateSelection=null,this.estimateSelectionForm=null,this.roomSelectionForm=null,this.newEstimateForm=null,this.newRoomForm=null,this.isOpen=!1,this.currentView=null,this.currentProductId=null,this.initialized=!1,this.eventHandlers={},this.escKeyHandler=null,this.init()}),[{key:"init",value:function(){var e=this;this.initialized?oe.log("ModalManager already initialized"):(this.modal=document.querySelector(this.config.selectors.modalContainer),this.modal?oe.log("Found existing modal in DOM, initializing elements"):oe.log("Warning: Modal element not found in DOM. The PHP partial may not be included."),this.modal&&(this.initializeElements(),this.bindEvents(),this.setupLoaderSafety(),setTimeout((function(){e.ensureLoaderHidden()}),500)),this.initializeJQueryAccordions(),this.initialized=!0,oe.log("ModalManager initialized"))}},{key:"initializeElements",value:function(){this.modal?(this.overlay=this.modal.querySelector(this.config.selectors.modalOverlay),this.closeButton=this.modal.querySelector(this.config.selectors.closeButton),this.contentContainer=this.modal.querySelector(this.config.selectors.contentContainer),this.loadingIndicator=this.modal.querySelector(this.config.selectors.loadingIndicator),this.estimatesList=this.modal.querySelector("#estimates"),this.estimateSelection=this.modal.querySelector("#estimate-selection-wrapper"),this.estimateSelectionForm=this.modal.querySelector("#estimate-selection-form-wrapper"),this.roomSelectionForm=this.modal.querySelector("#room-selection-form-wrapper"),this.newEstimateForm=this.modal.querySelector("#new-estimate-form-wrapper"),this.newRoomForm=this.modal.querySelector("#new-room-form-wrapper"),this.estimatesList||oe.error("Critical: #estimates div not found in modal template!"),this.loadingIndicator||(oe.warn("Loading indicator not found, creating one"),this.loadingIndicator=document.createElement("div"),this.loadingIndicator.className="product-estimator-modal-loading",this.loadingIndicator.innerHTML='\n      <div class="loading-spinner"></div>\n      <div class="loading-text">'.concat(this.config.i18n.loading||"Loading...","</div>\n    "),this.modal.appendChild(this.loadingIndicator))):oe.error("Modal element not available for initializing elements")}},{key:"showLoading",value:function(){if(this.loadingIndicator)this.loadingIndicator.style.display="flex";else if(oe.warn("Loading indicator not available - creating one"),this.modal){var e=document.createElement("div");e.className="product-estimator-modal-loading",e.style.display="flex",e.innerHTML='\n        <div class="loading-spinner"></div>\n        <div class="loading-text">'.concat(this.config.i18n.loading||"Loading...","</div>\n      "),this.modal.appendChild(e),this.loadingIndicator=e}else oe.error("Cannot create loading indicator - modal not available")}},{key:"hideLoading",value:function(){this.loadingStartTime=0,this.loadingIndicator?this.loadingIndicator.style.display="none":oe.warn("Loading indicator not available during hide operation")}},{key:"initializeCarousels",value:function(){oe.log("Initializing carousels in modal");var e=this.modal.querySelectorAll(".suggestions-carousel");if(e.length>0){oe.log("Found ".concat(e.length," carousel containers in modal"));var t=this.modal.querySelectorAll(".product-suggestions .suggestions-carousel").length,o=this.modal.querySelectorAll(".product-similar-products .suggestions-carousel").length;oe.log("Carousel types: ".concat(t," suggestion carousels, ").concat(o," similar product carousels")),initSuggestionsCarousels()}else oe.log("No carousel containers found in modal")}},{key:"bindEvents",value:function(){var e=this;if(this.modal){this._modalClickHandler&&this.modal.removeEventListener("click",this._modalClickHandler),this._modalClickHandler=function(t){t.target.closest(e.config.selectors.closeButton)&&(t.preventDefault(),t.stopPropagation(),oe.log("Close button clicked"),e.closeModal()),t.target.classList.contains("product-estimator-modal-overlay")&&(t.preventDefault(),t.stopPropagation(),oe.log("Overlay clicked"),e.closeModal())},this.modal.addEventListener("click",this._modalClickHandler);var t=function(t){"Escape"===t.key&&e.isOpen&&(oe.log("Escape key pressed"),e.closeModal())};document.removeEventListener("keydown",this.escKeyHandler),document.addEventListener("keydown",t),this.escKeyHandler=t}else oe.log("Modal element not available, cannot bind events")}},{key:"openModal",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(oe.log("MODAL OPEN CALLED WITH:",{productId:t,forceListView:o,typeOfProductId:a(t)}),!this.modal)return oe.error("Cannot open modal - not found in DOM"),void this.showError("Modal element not found. Please contact support.");this.resetModalState(),this.currentProductId=t,t?this.modal.dataset.productId=t:delete this.modal.dataset.productId,this.showLoading(),this.modal.style.display="block",document.body.classList.add("modal-open"),this.isOpen=!0;var i=this.modal.querySelector(".product-estimator-modal-form-container");if(!i)return oe.error("Form container not found in modal"),this.hideLoading(),void this.showError("Modal structure missing. Please contact support.");if(t&&!o)oe.log("STARTING PRODUCT FLOW with product ID:",t),this.dataService.checkEstimatesExist().then((function(t){if(oe.log("Has estimates check result:",t),t){oe.log("Estimates found, showing estimate selection.");var o=i.querySelector("#estimate-selection-wrapper");if(!o)return oe.error("Estimate selection wrapper not found in template!"),e.showError("Modal structure incomplete. Please contact support."),void e.hideLoading();e.forceElementVisibility(o);try{o.innerHTML="",X.insert("estimate-selection-template",{},o),oe.log("Estimate selection template inserted into wrapper."),e.estimateSelectionForm=o.querySelector("#estimate-selection-form-wrapper")}catch(t){return oe.error("Error inserting estimate selection template:",t),e.showError("Error loading selection form template. Please try again."),void e.hideLoading()}e.estimateSelectionForm?(e.forceElementVisibility(e.estimateSelectionForm),e.estimateSelectionForm.querySelector("form")?(oe.log("Estimate selection form element found after template insertion, populating dropdown and binding events."),e.loadEstimatesData(),e.bindEstimateSelectionFormEvents()):(oe.error("Form element (#estimate-selection-form) not found inside the template after insertion!"),e.showError("Error rendering form template. Please try again."),e.hideLoading())):(oe.error("Estimate selection form wrapper not found in template AFTER INSERTION!"),e.showError("Modal structure incomplete. Please contact support."),e.hideLoading())}else{if(oe.log("No estimates found, showing new estimate form."),!X.getTemplate("new-estimate-form-template"))return oe.error("Template not found: new-estimate-form-template"),e.showError("Template not found. Please refresh and try again."),void e.hideLoading();e.showNewEstimateForm()}})).catch((function(t){oe.error("Error checking estimates:",t),i&&X.showMessage("Error checking estimates. Please try again.","error",i),e.hideLoading()}));else{if(oe.log("STARTING LIST VIEW FLOW"),!this.estimatesList)return oe.error("Estimates list container not found in template!"),this.showError("Modal structure incomplete. Please contact support."),void this.hideLoading();this.forceElementVisibility(this.estimatesList),this.bindEstimateListEventHandlers(),this.loadEstimatesList().catch((function(t){oe.error("Error loading estimates list:",t),e.estimatesList?X.showMessage("Error loading estimates. Please try again.","error",e.estimatesList):e.showError("Error loading estimates. Please try again.")})).finally((function(){e.hideLoading()}))}}},{key:"bindNewRoomFormEvents",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(e){oe.log("Binding events to new room form:",e),e.dataset.estimateId=t,oe.log("Set estimate ID on new room form:",t),null!=i?(e.dataset.productId=i,oe.log("Set product ID on new room form:",i)):(delete e.dataset.productId,oe.log("Removed product ID from new room form dataset.")),e._submitHandler&&e.removeEventListener("submit",e._submitHandler),e._submitHandler=function(t){t.preventDefault(),oe.log("New room form submitted via template"),o.handleNewRoomSubmission(e,t)},e.addEventListener("submit",e._submitHandler),oe.log("New room form submit event bound.");var r=e.querySelector(".cancel-btn");r?(r._clickHandler&&r.removeEventListener("click",r._clickHandler),r._clickHandler=function(){oe.log("New room form cancel button clicked"),o.cancelForm("room")},r.addEventListener("click",r._clickHandler),oe.log("New room form cancel button bound.")):oe.warn("Cancel button not found in new room form.")}else oe.error("Cannot bind events - new room form element not provided")}},{key:"forceElementVisibility",value:function(e){if(!e)return oe.error("Cannot show null element"),null;oe.log("Forcing visibility for:",e.id||e.tagName),e.style.cssText+="display: block !important; visibility: visible !important; opacity: 1 !important; height: auto !important;",["hidden","hide","invisible","d-none","display-none"].forEach((function(t){e.classList.contains(t)&&e.classList.remove(t)})),e.classList.add("visible","d-block");for(var t=e.parentElement,o=new Set;t&&t!==document.body&&!o.has(t);)o.add(t),"none"===window.getComputedStyle(t).display&&(t.style.cssText+="display: block !important;"),t=t.parentElement;return"undefined"!=typeof jQuery&&jQuery(e).show(),e}},{key:"closeModal",value:function(){this.isOpen&&(this.modal?(this.modal.style.display="none",delete this.modal.dataset.productId,this.ensureLoaderHidden(),document.body.classList.remove("modal-open"),this.isOpen=!1,this.currentProductId=null,this.currentView=null,this.resetModalState(),this.emit("modal:closed")):oe.log("Cannot close modal - element not found"))}},{key:"setupLoaderSafety",value:function(){var e=this;setInterval((function(){if(e.isOpen&&e.loadingIndicator&&"none"!==window.getComputedStyle(e.loadingIndicator).display){var t=e.loadingStartTime||0,o=(new Date).getTime();t&&o-t>1e4&&(oe.warn("Loading indicator has been visible for more than 10 seconds, hiding it."),e.hideLoading(),e.showError("The operation is taking longer than expected or may have failed silently."))}}),2e3);var t=this.showLoading;this.showLoading=function(){return e.loadingStartTime=(new Date).getTime(),t.call(e)};var o=this.hideLoading;this.hideLoading=function(){return e.loadingStartTime=0,o.call(e)},oe.log("Loader safety system installed")}},{key:"ensureLoaderHidden",value:function(){this.loadingIndicator&&"none"!==window.getComputedStyle(this.loadingIndicator).display&&(oe.log("Force hiding loader that was left visible"),this.hideLoading());var e=document.querySelectorAll(".product-estimator-modal-loading");if(e.length>1){oe.warn("Found ".concat(e.length," loading indicators, cleaning up duplicates"));for(var t=1;t<e.length;t++)e[t].remove()}e.forEach((function(e){e.style.display="none"}))}},{key:"resetModalState",value:function(){var e=function(e){e&&(e.style.display="none","undefined"!=typeof jQuery&&jQuery(e).hide())};e(this.estimatesList),e(this.estimateSelection),e(this.estimateSelectionForm),e(this.roomSelectionForm),e(this.newEstimateForm),e(this.newRoomForm),this.roomSelectionForm&&this.roomSelectionForm.removeAttribute("data-estimate-id"),this.newRoomForm&&(this.newRoomForm.removeAttribute("data-estimate-id"),this.newRoomForm.removeAttribute("data-product-id"))}},{key:"loadEstimatesList",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return oe.log("[loadEstimatesList] Function started",{expandRoomId:t,expandEstimateId:o}),new Promise((function(i,r){if(e.showLoading(),!e.estimatesList)return oe.error("[loadEstimatesList] Estimates list container not found!"),e.hideLoading(),void r(new Error("Estimates list container not found"));e.forceElementVisibility(e.estimatesList);try{var a=e.loadEstimateData(),n=a.estimates||{};if(oe.log("[loadEstimatesList] Loaded estimate data from LocalStorage:",a),e.estimatesList.innerHTML="",0===Object.keys(n).length){oe.log("[loadEstimatesList] No estimates found, showing empty template."),X.insert("estimates-empty-template",{},e.estimatesList);var s=e.estimatesList.querySelector("#create-estimate-btn");s&&s.addEventListener("click",(function(){return e.showNewEstimateForm()}))}else oe.log("[loadEstimatesList] Found ".concat(Object.keys(n).length," estimates, rendering.")),Object.entries(n).forEach((function(t){var o=g(t,2),i=o[0],r=o[1];try{var a,n;oe.log("[loadEstimatesList] Rendering estimate: ".concat(i)),X.insert("estimate-item-template",{estimate_id:i,name:r.name||"Unnamed Estimate",min_total:(null===(a=r.totals)||void 0===a?void 0:a.min_total)||r.min_total||0,max_total:(null===(n=r.totals)||void 0===n?void 0:n.max_total)||r.max_total||0,default_markup:r.default_markup||0},e.estimatesList);var s=e.estimatesList.querySelector('.estimate-section[data-estimate-id="'.concat(i,'"]'));if(s){var c=s.querySelector(".rooms-container");c?r.rooms&&Object.keys(r.rooms).length>0?Object.entries(r.rooms||{}).forEach((function(t){var o,r,a=g(t,2),n=a[0],s=a[1];oe.log("[loadEstimatesList] Rendering room: ".concat(n," in estimate ").concat(i)),X.insert("room-item-template",{room_id:n,estimate_id:i,name:s.name||"Unnamed Room",room_name:s.name||"Unnamed Room",width:s.width||0,length:s.length||0,min_total:(null===(o=s.totals)||void 0===o?void 0:o.min_total)||s.min_total||0,max_total:(null===(r=s.totals)||void 0===r?void 0:r.max_total)||s.max_total||0},c);var l=c.querySelector('.accordion-item[data-room-id="'.concat(n,'"]')),d=l?l.querySelector(".product-list"):null;if(d)(s.products||[]).forEach((function(e,t){if(e&&void 0!==e.id)try{if(oe.log("[loadEstimatesList] Rendering product ".concat(e.id," at index ").concat(t," for room ").concat(n,".")),oe.log("[DEBUG] Product ".concat(e.id,": Target productListContainer is:"),d),!d)return void oe.error("[DEBUG] CRITICAL: productListContainer is NULL for product ".concat(e.id,". Skipping insertion."));if(!X.insert("product-item-template",te(te({},e),{},{product_index:t,room_id:n,estimate_id:i}),d,!0))return void oe.error("[loadEstimatesList] TemplateEngine.insert failed for product ".concat(e.id,"."));var o=d.lastElementChild;if(o&&o.matches&&o.matches(".product-item")||(oe.error("[loadEstimatesList] Failed to find the appended .product-item element for product ".concat(e.id,". Last child was:"),o),function(){throw new TypeError('"productItemElement" is read-only')}()),o){var r;oe.log("[loadEstimatesList] Successfully found appended productItemElement for product ".concat(e.id));var a=o.querySelector(".similar-products-container"),s=o.querySelector(".similar-products-list"),c=o.querySelector(".product-details-toggle.similar-products-toggle"),l=o.querySelector(".similar-products-carousel"),u=l?l.querySelectorAll(".suggestions-nav"):[];if(oe.log("[DEBUG] Product ".concat(e.id,": Checking pre-load conditions.")),oe.log("  - Has similar_products array?",e.similar_products&&Array.isArray(e.similar_products)),oe.log("  - similar_products length:",null===(r=e.similar_products)||void 0===r?void 0:r.length),oe.log("  - similarProductsListInProductItem found?",!!s),oe.log("  - Other required elements found?",!!a&&!!c&&!!l),e.similar_products&&Array.isArray(e.similar_products)&&e.similar_products.length>0&&s&&a&&c&&l){if(oe.log("[loadEstimatesList] Product ".concat(e.id," has ").concat(e.similar_products.length," pre-loaded similar products. Rendering...")),s.innerHTML="",e.similar_products.forEach((function(t){var o=te(te({},t),{},{estimate_id:i,room_id:n,replace_product_id:e.id});oe.log("[DEBUG] Preparing to insert similar-product-item-template for similar product ID ".concat(t.id));try{X.insert("similar-product-item-template",o,s),oe.log("[DEBUG] Successfully inserted template for similar product ID ".concat(t.id))}catch(e){oe.error("[DEBUG] Error inserting similar-product-item-template for similar product ID ".concat(t.id,":"),e)}})),a.style.display="block",a.classList.add("visible"),c){c.style.display="",c.classList.add("expanded");var m=c.querySelector(".toggle-icon");m&&(m.classList.remove("dashicons-arrow-down-alt2"),m.classList.add("dashicons-arrow-up-alt2"))}o.dataset.similarProductsLoaded="true",oe.log("[loadEstimatesList] Set similarProductsLoaded flag for product ".concat(e.id," after pre-load.")),u.forEach((function(e){return e.style.display=""})),l&&(l.carouselInstance&&l.carouselInstance.destroy(),void 0!==U?(new U(l),oe.log("[loadEstimatesList] Initialized similar products carousel for product ".concat(e.id,"."))):oe.error("SuggestionsCarousel class is not defined/imported."))}else{if(oe.log("[loadEstimatesList] Pre-loading criteria not met for ".concat(e.id,". Hiding section and setting flag.")),c){c.style.display="none",c.classList.remove("expanded");var g=c.querySelector(".toggle-icon");g&&(g.classList.remove("dashicons-arrow-up-alt2"),g.classList.add("dashicons-arrow-down-alt2"))}a&&(a.style.display="none"),u.forEach((function(e){return e.style.display="none"})),o.dataset.similarProductsLoaded="true",oe.log("[loadEstimatesList] Set similarProductsLoaded flag for product ".concat(e.id," because pre-load criteria not met."))}}else oe.warn("[loadEstimatesList] Could not find the appended .product-item element for product ".concat(e.id,". Similar products might load via fallback."))}catch(o){oe.error("[loadEstimatesList] Error rendering product ".concat((null==e?void 0:e.id)||"unknown"," at index ").concat(t," for room ").concat(n,":"),o)}else oe.warn("[loadEstimatesList] Invalid product data found in room ".concat(n," at index ").concat(t,":"),e)})),s.products&&0!==s.products.length||(oe.log("[loadEstimatesList] Room ".concat(n," has no products, showing empty template.")),X.insert("products-empty-template",{},d));else{oe.error("[loadEstimatesList] .product-list container not found for room ".concat(n,". Cannot render products."));var u=l?l.querySelector(".accordion-content"):null;u&&X.insert("products-empty-template",{},u)}var m=l?l.querySelector(".product-suggestions"):null,p=l?l.querySelector(".product-suggestions .suggestions-container"):null,h=l?l.querySelector(".product-suggestions .suggestions-carousel"):null,f=s.products||[];m&&p&&h?(oe.log("[loadEstimatesList] Found suggestions container for room ".concat(n,". Fetching suggestions...")),p.innerHTML='<div class="loading-text">Loading suggestions...</div>',m.style.display="none",e.dataService.getSuggestedProducts(i,n,f).then((function(e){var t=e?e.length:0;oe.log("[loadEstimatesList] Fetched ".concat(t," suggestions for room ").concat(n,".")),p.innerHTML="",e&&e.length>0?(m.style.display="block",h.querySelectorAll(".suggestions-nav").forEach((function(e){return e.style.display=""})),e.forEach((function(e){var t=te(te({},e),{},{estimate_id:i,room_id:n});X.insert("suggestion-item-template",t,p)})),h.carouselInstance&&h.carouselInstance.destroy(),void 0!==U?new U(h):oe.error("SuggestionsCarousel class is not defined/imported.")):(m.style.display="none",h.querySelectorAll(".suggestions-nav").forEach((function(e){return e.style.display="none"})),h.carouselInstance&&(h.carouselInstance.destroy(),h.carouselInstance=null))})).catch((function(e){oe.error("[loadEstimatesList] Error fetching suggestions for room ".concat(n,":"),e),p.innerHTML='<p class="error-message">Error loading suggestions.</p>',m.style.display="none",h.querySelectorAll(".suggestions-nav").forEach((function(e){return e.style.display="none"})),h.carouselInstance&&(h.carouselInstance.destroy(),h.carouselInstance=null)}))):oe.warn("[loadEstimatesList] Suggestions elements not found for room ".concat(n,"."))})):(oe.log("[loadEstimatesList] Estimate ".concat(i," has no rooms, showing empty template.")),X.insert("rooms-empty-template",{},c)):oe.warn("[loadEstimatesList] Rooms container not found for estimate ".concat(i,"."))}else oe.error("[loadEstimatesList] Estimate section element not found for estimate ".concat(i,"."))}catch(e){oe.error("[loadEstimatesList] Error rendering estimate ".concat(i,":"),e)}}));setTimeout((function(){oe.log("[loadEstimatesList] Initializing accordions and events after content rendering"),e.initializeEstimateAccordions(t,o),e.initializeAccordions(t,o),e.bindProductRemovalEvents(),e.bindRoomRemovalEvents(),e.bindEstimateListEventHandlers(),e.bindDirectEstimateRemovalEvents(),e.bindReplaceProductButtons(),e.bindSuggestedProductButtons(),e.bindSuggestionsToggle(),e.bindSimilarProductsToggle(),window.productEstimator&&window.productEstimator.detailsToggle?window.productEstimator.detailsToggle.setup():oe.warn("[loadEstimatesList] Product details toggle setup not available."),e.hideLoading(),oe.log("[loadEstimatesList] Loading complete."),i(e.estimatesList.innerHTML)}),250)}catch(t){oe.error("[loadEstimatesList] Error during rendering process:",t),e.showError("Error rendering estimates. Please try again."),e.hideLoading(),r(t)}}))}},{key:"bindSimilarProductsToggle",value:function(){oe.log("Binding similar products toggle buttons"),this.estimatesList?(this._similarProductsToggleHandler&&this.estimatesList.removeEventListener("click",this._similarProductsToggleHandler),this._similarProductsToggleHandler=function(e){var t=e.target.closest(".similar-products-toggle");if(t){e.preventDefault(),e.stopPropagation(),oe.log("Similar products toggle button clicked.");var o=t.closest(".product-item");if(!o)return void oe.warn("Could not find parent .product-item for similar products toggle.");var i=o.querySelector(".similar-products-container"),r=t.querySelector(".toggle-icon");if(i)if(t.classList.toggle("expanded"),r&&(r.classList.toggle("dashicons-arrow-down-alt2"),r.classList.toggle("dashicons-arrow-up-alt2")),"none"!==window.getComputedStyle(i).display&&i.classList.contains("visible"))oe.log("Collapsing similar products section."),i.classList.remove("visible"),"undefined"!=typeof jQuery?jQuery(i).slideUp(200):i.style.display="none";else if(oe.log("Expanding similar products section."),i.classList.add("visible"),"undefined"!=typeof jQuery)jQuery(i).slideDown(200,(function(){var e=i.querySelector(".similar-products-carousel");e&&!e.carouselInstance&&new U(e)}));else{i.style.display="block";var a=i.querySelector(".similar-products-carousel");a&&!a.carouselInstance&&new U(a)}else oe.warn("Similar products container not found for toggling.")}},this.estimatesList.addEventListener("click",this._similarProductsToggleHandler),oe.log("Similar products toggle events bound to #estimates element.")):oe.warn("Estimates list container not available for binding similar products toggle.")}},{key:"bindDirectEstimateRemovalEvents",value:function(){var e=this;if(oe.log(">>> Entered bindDirectEstimateRemovalEvents function (Direct Binding)"),this.estimatesList){var t=this.estimatesList.querySelectorAll(".remove-estimate");t.length>0?(oe.log(">>> Found ".concat(t.length," remove estimate buttons for direct binding")),t.forEach((function(t){t._directEstimateRemovalHandler&&t.removeEventListener("click",t._directEstimateRemovalHandler),t._directEstimateRemovalHandler=function(o){oe.log(">>> Direct click handler fired for remove estimate button.",t),o.preventDefault(),o.stopPropagation();var i=t.dataset.estimateId;oe.log(">>> Direct handler extracted estimateId:",i,"Type:",a(i)),null!=i&&""!==i?(oe.log(">>> Direct handler found valid estimate ID. Calling confirmDelete."),e.confirmDelete("estimate",i)):(oe.error(">>> Direct handler found invalid estimate ID.",t),e.showError("Cannot remove estimate: Missing ID."))},t.addEventListener("click",t._directEstimateRemovalHandler)})),oe.log(">>> Direct estimate removal events bound successfully.")):oe.log(">>> No remove estimate buttons found for direct binding.")}else oe.error("Estimates list not available for direct binding.")}},{key:"bindNewEstimateFormEvents",value:function(e){var t=this,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(e){oe.log("Binding events to new estimate form:",e),null!=o?(e.dataset.productId=o,oe.log("Set product ID on new estimate form:",o)):(delete e.dataset.productId,oe.log("Removed product ID from new estimate form dataset.")),e._submitHandler&&e.removeEventListener("submit",e._submitHandler),e._submitHandler=function(o){o.preventDefault(),oe.log("New estimate form submitted via template"),t.handleNewEstimateSubmission(e)},e.addEventListener("submit",e._submitHandler),oe.log("New estimate form submit event bound.");var i=e.querySelector(".cancel-btn");i?(i._clickHandler&&i.removeEventListener("click",i._clickHandler),i._clickHandler=function(){oe.log("New estimate form cancel button clicked"),t.cancelForm("estimate")},i.addEventListener("click",i._clickHandler),oe.log("New estimate form cancel button bound.")):oe.warn("Cancel button not found in new estimate form."),window.productEstimator&&window.productEstimator.core&&window.productEstimator.core.customerDetailsManager&&setTimeout((function(){"function"==typeof window.productEstimator.core.customerDetailsManager.init?(window.productEstimator.core.customerDetailsManager.init(t.newEstimateForm),oe.log("CustomerDetailsManager init called for new estimate form.")):(oe.warn("CustomerDetailsManager init method does not accept a form element argument."),window.productEstimator.core.customerDetailsManager.init(),oe.log("CustomerDetailsManager init called without form element for new estimate form."))}),50)}else oe.error("Cannot bind events - new estimate form element not provided")}},{key:"handleProductRemoval",value:function(e,t,o,i){var r=this;this.showLoading(),oe.log("[handleProductRemoval] Removing product at index ".concat(o," from room ").concat(t," in estimate ").concat(e));var a=this.modal.querySelector('.accordion-item[data-room-id="'.concat(t,'"][data-estimate-id="').concat(e,'"]'));if(!a)return oe.warn("[handleProductRemoval] Could not find room element for room ID ".concat(t," and estimate ID ").concat(e)),this.showError("Room element not found. Please refresh and try again."),void this.hideLoading();var n=a.querySelector('.product-item[data-product-id="'.concat(i,'"]'));if(!n)return oe.warn("[handleProductRemoval] Could not find product element with id ".concat(i," in the DOM")),this.showError("Product element not found. Please refresh and try again."),void this.hideLoading();this.dataService.removeProductFromRoom(e,t,o,i).then((function(o){oe.log("[handleProductRemoval] Product removal successful:",o);var i=n.parentElement;if(n.remove(),i&&0===i.children.length){oe.log("[handleProductRemoval] Last product in room removed, updating room UI. Inserting products-empty-template."),X&&"function"==typeof X.insert?X.insert("products-empty-template",{},i):oe.error("[handleProductRemoval] TemplateEngine or TemplateEngine.insert is not available.");var s=a.querySelector(".product-suggestions");if(s){s.style.display="none";var c=s.querySelector(".suggestions-container");c&&(c.innerHTML="");var l=s.querySelector(".suggestions-carousel");l&&l.carouselInstance&&(l.carouselInstance.destroy(),l.carouselInstance=null)}}else oe.log("[handleProductRemoval] Products still exist in room ".concat(t,". Checking for updated suggestions.")),r.updateRoomSuggestions(e,t,a);o.room_totals&&r.updateRoomTotals(e,t,o.room_totals),o.estimate_totals&&r.updateEstimateTotals(e,o.estimate_totals),r.showMessage("Product removed successfully","success")})).catch((function(e){oe.error("[handleProductRemoval] Error removing product:",e),r.showError(e.message||"Error removing product. Please try again.")})).finally((function(){r.hideLoading()}))}},{key:"updateRoomTotals",value:function(e,t,o){if(o){var i=this.modal.querySelector('.accordion-item[data-room-id="'.concat(t,'"][data-estimate-id="').concat(e,'"]'));if(i){var r=i.querySelector(".room-price");if(r&&void 0!==o.min_total&&void 0!==o.max_total){var a="".concat(f(o.min_total)," - ").concat(f(o.max_total));r.textContent=a,oe.log("Updated room price display to ".concat(a))}var n=i.querySelector(".price-graph-range");if(n&&o.max_total){var s=1.5*o.max_total,c=o.max_total/s*100;n.style.width="".concat(Math.min(c,100),"%")}}}}},{key:"updateEstimateTotals",value:function(e,t){if(t){var o=this.modal.querySelector('.estimate-section[data-estimate-id="'.concat(e,'"]'));if(o){var i=o.querySelector(".estimate-price");if(i&&void 0!==t.min_total&&void 0!==t.max_total){var r="".concat(f(t.min_total)," - ").concat(f(t.max_total));i.textContent=r,oe.log("Updated estimate price display to ".concat(r))}var a=o.querySelector(".price-graph-range");if(a&&t.max_total){var n=1.5*t.max_total,s=t.max_total/n*100;a.style.width="".concat(Math.min(s,100),"%")}}}}},{key:"handleAddSuggestedProduct",value:function(e,t,o,i){var r=this;oe.log("[handleAddSuggestedProduct] Function called with:",{productId:e,estimateId:t,roomId:o,buttonElement:i}),this.showLoading(),i&&(i.disabled=!0,i.classList.add("loading"),i.innerHTML='<span class="loading-dots">Adding...</span>'),oe.log("[handleAddSuggestedProduct] Adding suggested product ".concat(e," to room ").concat(o," in estimate ").concat(t," via DataService")),this.dataService.addProductToRoom(o,e,t).then((function(e){if(oe.log("[handleAddSuggestedProduct] DataService.addProductToRoom local storage attempt result:",e),e.success){oe.log("[handleAddSuggestedProduct] Local storage add successful.");var a=i?i.closest(".suggestion-item"):null;if(a){oe.log("[handleAddSuggestedProduct] Removing suggestion item from DOM:",a),a.remove();var n=a.closest(".suggestions-carousel");n&&n.carouselInstance&&(oe.log("[handleAddSuggestedProduct] Reinitializing carousel after item removal."),n.carouselInstance.destroy(),n.carouselInstance=new U(n))}else oe.warn("[handleAddSuggestedProduct] Could not find suggestion item element to remove.");r.estimateSelection&&(r.estimateSelection.style.display="none"),r.roomSelectionForm&&(r.roomSelectionForm.style.display="none"),delete r.modal.dataset.productId,r.currentProductId=null;var s=e.estimate_id||t,c=e.room_id||o;return oe.log("[handleAddSuggestedProduct] Product added to estimate ".concat(s,", room ").concat(c," (based on local storage). Refreshing list.")),r.loadEstimatesList(c,s).then((function(){oe.log("[handleAddSuggestedProduct] Estimates list refreshed.");var e=r.modal.querySelector('.accordion-item[data-room-id="'.concat(c,'"][data-estimate-id="').concat(s,'"]'));e?(oe.log("[handleAddSuggestedProduct] List reloaded. Triggering suggestion update for room:",c),r.updateRoomSuggestions(s,c,e)):oe.warn("[handleAddSuggestedProduct] Could not find room element after list reload to update suggestions."),r.showMessage("Product added successfully!","success")}))}var l;if(oe.error("[handleAddSuggestedProduct] Error during local storage add:",e.error),r.showError(e.error.message||"Failed to add product locally. Please try again."),null!==(l=e.error)&&void 0!==l&&null!==(l=l.data)&&void 0!==l&&l.duplicate){var d=e.error.data.estimate_id,u=e.error.data.room_id;oe.log("[handleAddSuggestedProduct] Duplicate detected, navigating to estimate ".concat(d,", room ").concat(u)),r.loadEstimatesList(u,d)}})).catch((function(e){var t;if(oe.error("[handleAddSuggestedProduct] Error adding suggested product via DataService promise rejection:",e),null!==(t=e.data)&&void 0!==t&&t.duplicate){oe.log("[handleAddSuggestedProduct] Duplicate suggested product detected by DataService promise rejection:",e.data),r.estimateSelection&&(r.estimateSelection.style.display="none"),r.roomSelectionForm&&(r.roomSelectionForm.style.display="none"),delete r.modal.dataset.productId,r.currentProductId=null;var o=e.data.estimate_id,i=e.data.room_id;r.showError(e.data.message||"This product already exists in the selected room."),r.loadEstimatesList(i,o).then((function(){oe.log("[handleAddSuggestedProduct] Estimates list refreshed to show duplicate product location")})).catch((function(e){oe.error("[handleAddSuggestedProduct] Error refreshing estimates list:",e)}))}else r.showError(e.message||"Error adding product. Please try again.")})).finally((function(){i&&(i.disabled=!1,i.classList.remove("loading"),i.textContent="Add"),r.hideLoading()}))}},{key:"bindSuggestedProductButtons",value:function(){var e=this;oe.log("[bindSuggestedProductButtons] Binding suggested product buttons");var t=this.modal.querySelector("#estimates");if(t){t._suggestionButtonHandler&&t.removeEventListener("click",t._suggestionButtonHandler),t._suggestionButtonHandler=function(t){var o=t.target.closest(".add-suggestion-to-room");if(o){oe.log("[bindSuggestedProductButtons] Click handler triggered for button:",o),t.preventDefault(),t.stopPropagation();var i=o.dataset.productId,r=o.dataset.estimateId,a=o.dataset.roomId;oe.log("[bindSuggestedProductButtons] Data attributes read:",{productId:i,estimateId:r,roomId:a}),i&&r&&a?(oe.log("[bindSuggestedProductButtons] Data attributes are valid, calling handleAddSuggestedProduct"),e.handleAddSuggestedProduct(i,r,a,o)):(oe.error("[bindSuggestedProductButtons] Missing required data attributes for adding suggested product on button:",o),e.showError("Cannot add product: Missing required information."))}},t.addEventListener("click",t._suggestionButtonHandler),oe.log("[bindSuggestedProductButtons] Suggestion button click event handler bound to #estimates element.");var o=t.querySelectorAll(".add-suggestion-to-room");o.length>0?oe.log("[bindSuggestedProductButtons] Found ".concat(o.length," suggestion buttons initially in the DOM.")):oe.log("[bindSuggestedProductButtons] No suggestion buttons found initially in the DOM.")}else oe.error("[bindSuggestedProductButtons] Estimates list container (#estimates) not found. Cannot bind suggestion button events.")}},{key:"updateRoomSuggestions",value:function(e,t,o){var i;if(oe.log("[updateRoomSuggestions] Updating suggestions for room ".concat(t," in estimate ").concat(e)),o){var r=o.querySelector(".product-suggestions"),a=o.querySelector(".product-suggestions .suggestions-container"),n=o.querySelector(".suggestions-container-wrapper"),s=o.querySelector(".suggestions-carousel"),c=o.querySelectorAll(".suggestions-nav");if(r&&a&&n&&s){var l=null===(i=this.loadEstimateData().estimates)||void 0===i||null===(i=i[e])||void 0===i||null===(i=i.rooms)||void 0===i?void 0:i[t],d=(null==l?void 0:l.products)||[];if(oe.log("[updateRoomSuggestions] Room ".concat(t," has ").concat(d.length," products."),d),0===d.length)return oe.log("[updateRoomSuggestions] Room ".concat(t," has no products. Hiding suggestions section.")),r.style.display="none",a.innerHTML="",c.forEach((function(e){return e.style.display="none"})),void(s.carouselInstance&&(s.carouselInstance.destroy(),s.carouselInstance=null));a.innerHTML='<div class="loading-text">Loading suggestions...</div>',r.style.display="block",this.dataService.getSuggestedProducts(e,t,d).then((function(o){oe.log("[updateRoomSuggestions] Fetched ".concat(o.length," suggestions for room ").concat(t,". Rendering...")),oe.log("[updateRoomSuggestions] Suggestions data received:",o),a.innerHTML="",o&&o.length>0?(oe.log("[updateRoomSuggestions] Suggestions found, showing section and rendering items."),r.style.display="block",c.forEach((function(e){return e.style.display=""})),o.forEach((function(o){oe.log("[updateRoomSuggestions] Rendering suggestion item:",o);var i=te(te({},o),{},{estimate_id:e,room_id:t}),r=X.create("suggestion-item-template",i);r?a.appendChild(r):oe.warn("[updateRoomSuggestions] Failed to create suggestion element from template for suggestion:",o)})),oe.log("[updateRoomSuggestions] Rendered ".concat(o.length," suggestion items.")),oe.log("[updateRoomSuggestions] Initializing carousel for room ".concat(t,".")),s.carouselInstance&&s.carouselInstance.destroy(),s.carouselInstance=new U(s)):(oe.log("[updateRoomSuggestions] No suggestions found. Hiding suggestions section."),r.style.display="none",a.innerHTML="",c.forEach((function(e){return e.style.display="none"})),s.carouselInstance&&(s.carouselInstance.destroy(),s.carouselInstance=null))})).catch((function(e){oe.error("[updateRoomSuggestions] Error fetching suggestions:",e),a.innerHTML='<p class="error-message">Error loading suggestions.</p>',r.style.display="none",c.forEach((function(e){return e.style.display="none"})),s.carouselInstance&&(s.carouselInstance.destroy(),s.carouselInstance=null)}))}else oe.warn("[updateRoomSuggestions] Required suggestion elements not found in room element.",{suggestionsSection:!!r,suggestionsContainer:!!a,suggestionsWrapper:!!n,carouselWrapper:!!s})}else oe.error("[updateRoomSuggestions] Room element not provided.")}},{key:"bindSuggestionsToggle",value:function(){oe.log("Binding suggestions toggle buttons"),this.estimatesList?(this._suggestionsToggleHandler&&this.estimatesList.removeEventListener("click",this._suggestionsToggleHandler),this._suggestionsToggleHandler=function(e){var t=e.target.closest(".product-suggestions-toggle");if(t){e.preventDefault(),e.stopPropagation(),oe.log("Suggestions toggle button clicked.");var o=t.closest(".product-suggestions"),i=o?o.querySelector(".suggestions-container-wrapper"):null,r=t.querySelector(".toggle-icon");if(i)if(t.classList.toggle("expanded"),r&&(r.classList.toggle("dashicons-arrow-down-alt2"),r.classList.toggle("dashicons-arrow-up-alt2")),"none"!==window.getComputedStyle(i).display&&i.classList.contains("visible"))oe.log("Collapsing suggestions section."),i.classList.remove("visible"),"undefined"!=typeof jQuery?jQuery(i).slideUp(200):i.style.display="none";else if(oe.log("Expanding suggestions section."),i.classList.add("visible"),"undefined"!=typeof jQuery)jQuery(i).slideDown(200,(function(){var e=i.querySelectorAll(".suggestions-carousel");e.length&&(oe.log("Initializing carousels in suggestions section after toggle."),e.forEach((function(e){e.carouselInstance&&e.carouselInstance.destroy(),new U(e)})))}));else{i.style.display="block";var a=i.querySelectorAll(".suggestions-carousel");a.length&&(oe.log("Initializing carousels in suggestions section after toggle."),a.forEach((function(e){e.carouselInstance&&e.carouselInstance.destroy(),new U(e)})))}else oe.warn("Suggestions container wrapper not found for toggling.")}},this.estimatesList.addEventListener("click",this._suggestionsToggleHandler),oe.log("Suggestions toggle events bound to #estimates element.")):oe.warn("Estimates list container not available for binding suggestions toggle.")}},{key:"handleRoomRemoval",value:function(e,t){var o,i=this,r=this.modal.querySelector('.accordion-item[data-room-id="'.concat(t,'"]')),a=r&&(null===(o=r.querySelector(".room-name"))||void 0===o?void 0:o.textContent)||"room";this.showLoading(),oe.log("Removing room with parameters:",{estimate_id:e,room_id:t}),this.dataService.removeRoom(e,t).then((function(t){oe.log("Room removal response:",t),i.loadEstimatesList(null,e).then((function(){if(i.showMessage("".concat(a," removed successfully"),"success"),!1===t.has_rooms){oe.log("Estimate has no rooms left after removal");var o=i.modal.querySelector('.estimate-section[data-estimate-id="'.concat(e,'"] .add-room'));o&&(o.classList.add("highlight-btn"),setTimeout((function(){o.classList.remove("highlight-btn")}),2e3))}})).catch((function(e){oe.log("Error refreshing estimates list:",e),i.showError("Error refreshing estimates list. Please try again.")}))})).catch((function(e){oe.log("Error removing room:",e),i.showError(e.message||"Error removing room. Please try again.")})).finally((function(){i.hideLoading()}))}},{key:"handleEstimateRemoval",value:function(e){var t=this;this.showLoading(),oe.log("Attempting to remove estimate ID: ".concat(e)),this.dataService.removeEstimate(e).then((function(e){oe.log("Estimate removal response:",e),t.loadEstimatesList().then((function(){t.showMessage("Estimate removed successfully","success")})).catch((function(e){oe.error("Error refreshing estimates list:",e),t.showError("Error refreshing estimates list. Please try again.")}))})).catch((function(e){oe.error("Error removing estimate:",e),t.showError(e.message||"Error removing estimate. Please try again.")})).finally((function(){t.hideLoading()}))}},{key:"bindProductRemovalEvents",value:function(){var e=this;oe.log("Binding product removal events"),this.estimatesList?(this._productRemovalHandler&&this.estimatesList.removeEventListener("click",this._productRemovalHandler),this._productRemovalHandler=function(t){var o=t.target.closest(".remove-product");if(o){t.preventDefault(),t.stopPropagation();var i=o.dataset.estimateId,r=o.dataset.roomId,a=o.dataset.productIndex,n=o.dataset.productId;oe.log("Remove product button clicked:",{estimateId:i,roomId:r,productIndex:a,button:o}),i&&r&&void 0!==a?e.confirmDelete("product",i,r,a,n):oe.error("Missing data attributes for product removal:",{estimateId:i,roomId:r,productIndex:a,buttonData:o.dataset})}},this.estimatesList.addEventListener("click",this._productRemovalHandler),oe.log("Product removal events bound to #estimates element")):oe.error("Estimates list not available for binding product removal events")}},{key:"bindRoomRemovalEvents",value:function(){var e=this;this.estimatesList&&(this._roomRemovalHandler&&this.estimatesList.removeEventListener("click",this._roomRemovalHandler),this._roomRemovalHandler=function(t){var o=t.target.closest(".remove-room");if(o){t.preventDefault(),t.stopPropagation();var i=o.dataset.estimateId,r=o.dataset.roomId;oe.log("Remove room button clicked:",{estimateId:i,roomId:r}),i&&r&&e.confirmDelete("room",i,r)}},this.estimatesList.addEventListener("click",this._roomRemovalHandler))}},{key:"confirmDelete",value:function(e,t,o,i){var r,a=this,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,s=(null===(r=window.productEstimatorVars)||void 0===r?void 0:r.i18n)||{},c=s.dialog_titles||{},l=s.dialog_messages||{},d="",u="",m="";switch(e){case"estimate":d=c.estimate||"Delete Estimate",u=l.estimate||"Are you sure you want to delete this estimate and all its rooms?",m=s.delete||"Delete";break;case"room":d=c.room||"Delete Room",u=l.room||"Are you sure you want to delete this room and all its products?",m=s.delete||"Delete";break;case"product":d=c.product||"Remove Product",u=l.product||"Are you sure you want to remove this product from the room?",m=s.remove||"Remove"}if(oe.log("Confirming deletion of ".concat(e," - ID: ").concat("product"===e?i:"room"===e?o:t)),window.productEstimator&&window.productEstimator.dialog)oe.log("Using custom dialog for deletion confirmation"),window.productEstimator.dialog.show({title:d,message:u,type:e,confirmText:m,onConfirm:function(){switch(oe.log("User confirmed deletion of ".concat(e)),e){case"estimate":a.handleEstimateRemoval(t);break;case"room":a.handleRoomRemoval(t,o);break;case"product":a.handleProductRemoval(t,o,i,n)}},onCancel:function(){oe.log("User cancelled deletion of ".concat(e))}});else if(oe.log("Custom dialog not available, using browser confirm"),confirm(u))switch(oe.log("User confirmed deletion of ".concat(e," via browser confirm")),e){case"estimate":this.handleEstimateRemoval(t);break;case"room":this.handleRoomRemoval(t,o);break;case"product":this.handleProductRemoval(t,o,i)}else oe.log("User cancelled deletion of ".concat(e," via browser confirm"))}},{key:"loadEstimateSelectionForm",value:function(){var e=this;return new Promise((function(t,o){e.estimateSelectionForm?(e.showLoading(),jQuery.ajax({url:productEstimatorVars.ajax_url,type:"POST",data:{action:"get_estimate_selection_form",nonce:productEstimatorVars.nonce},success:function(i){if(i.success&&i.data.html)e.estimateSelectionForm.innerHTML=i.data.html,e.loadEstimatesData(),e.bindEstimateSelectionFormEvents(),t(i.data.html);else{var r=new Error("Failed to load estimate selection form");oe.error(r),o(r)}},error:function(e){oe.error("Error loading estimate selection form:",e),o(e)},complete:function(){e.hideLoading()}})):o(new Error("Estimate selection form container not found"))}))}},{key:"bindEstimateSelectionFormEvents",value:function(){var e=this;oe.log("Binding estimate selection form events");var t=this.estimateSelectionForm.querySelector("form");if(t){oe.log("Form found:",t),this._estimateFormSubmitHandler&&t.removeEventListener("submit",this._estimateFormSubmitHandler),this._estimateFormSubmitHandler=function(o){o.preventDefault(),oe.log("Estimate selection form submitted"),e.handleEstimateSelection(t)},t.addEventListener("submit",this._estimateFormSubmitHandler);var o=t.querySelector("#create-estimate-btn");o&&(this._createEstimateHandler&&o.removeEventListener("click",this._createEstimateHandler),this._createEstimateHandler=function(){oe.log("Create estimate button clicked"),e.showNewEstimateForm()},o.addEventListener("click",this._createEstimateHandler)),oe.log("Form events bound successfully")}else oe.error("Cannot bind events - form not found in estimate selection form")}},{key:"loadEstimatesData",value:function(){var e=this;this.showLoading(),this.dataService.getEstimatesData().then((function(t){e.estimateSelectionForm.querySelector("#estimate-dropdown")?(e.populateEstimateDropdown(t),e.hideLoading()):e.loadEstimateSelectionForm().then((function(){return e.populateEstimateDropdown(t)})).catch((function(t){oe.log("Error loading estimate selection form:",t),e.showError("Error loading estimate selection form. Please try again.")})).finally((function(){e.hideLoading()}))})).catch((function(t){oe.log("Error loading estimates data:",t),e.showError("Error loading estimates data. Please try again."),e.hideLoading()}))}},{key:"populateEstimateDropdown",value:function(e){var t=this.estimateSelectionForm?this.estimateSelectionForm.querySelector("#estimate-dropdown"):null;if(t){t.innerHTML="";var o=document.createElement("option");o.value="",o.textContent=productEstimatorVars.i18n.select_estimate||"-- Select an Estimate --",t.appendChild(o),Array.isArray(e)&&e.forEach((function(e){if(e){var o=e.rooms?Object.keys(e.rooms).length:0,i=1===o?"1 room":"".concat(o," rooms"),r=document.createElement("option");r.value=e.id,r.textContent="".concat(e.name||"Unnamed Estimate"," (").concat(i,")"),t.appendChild(r)}})),oe.log("Populated dropdown with ".concat(e?e.length:0," estimates"))}else oe.log("Estimate dropdown not found, cannot populate")}},{key:"showNewEstimateForm",value:function(){if(oe.log("Showing new estimate form using template"),this.estimatesList&&(this.estimatesList.style.display="none"),this.estimateSelection&&(this.estimateSelection.style.display="none"),this.roomSelectionForm&&(this.roomSelectionForm.style.display="none"),!this.newEstimateForm)return oe.error("New estimate form wrapper (#new-estimate-form-wrapper) not found in modal template!"),this.showError("Modal structure incomplete. Cannot show new estimate form."),void this.hideLoading();this.forceElementVisibility(this.newEstimateForm),this.showLoading(),this.newEstimateForm.innerHTML="";try{X.insert("new-estimate-form-template",{},this.newEstimateForm),oe.log("New estimate form template inserted into wrapper.");var e=this.newEstimateForm.querySelector("form#new-estimate-form");e?(this.bindNewEstimateFormEvents(e,this.currentProductId),oe.log("Called bindNewEstimateFormEvents for the new form.")):(oe.error("Form element with ID #new-estimate-form not found inside #new-estimate-form-wrapper after template insertion!"),this.showError("Error rendering form template. Please try again."))}catch(e){oe.error("Error inserting new estimate form template:",e),this.showError("Error loading form template. Please try again.")}finally{this.hideLoading()}}},{key:"showNewRoomForm",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(oe.log("Showing new room form using template for estimate:",e,"with product:",t),this.estimatesList&&(this.estimatesList.style.display="none"),this.estimateSelection&&(this.estimateSelection.style.display="none"),this.roomSelectionForm&&(this.roomSelectionForm.style.display="none"),this.newEstimateForm&&(this.newEstimateForm.style.display="none"),!this.newRoomForm)return oe.error("New room form wrapper (#new-room-form-wrapper) not found in modal template!"),this.showError("Modal structure incomplete. Cannot show new room form."),void this.hideLoading();this.forceElementVisibility(this.newRoomForm),this.showLoading(),this.newRoomForm.innerHTML="";try{X.insert("new-room-form-template",{estimate_id:e,product_id:t},this.newRoomForm),oe.log("New room form template inserted into wrapper.");var o=this.newRoomForm.querySelector("form#new-room-form");o?(this.bindNewRoomFormEvents(o,e,t),oe.log("Called bindNewRoomFormEvents for the new room form.")):(oe.error("Form element with ID #new-room-form not found inside #new-room-form-wrapper after template insertion!"),this.showError("Error rendering form template. Please try again."))}catch(e){oe.error("Error inserting new room form template:",e),this.showError("Error loading form template. Please try again.")}finally{this.hideLoading()}}},{key:"bindEstimateListEventHandlers",value:function(){var e=this;this.estimatesList?(this._addRoomButtonHandler&&this.estimatesList.removeEventListener("click",this._addRoomButtonHandler),this._addRoomButtonHandler=function(t){var o=t.target.closest(".add-room");if(o){t.preventDefault(),t.stopPropagation();var i=o.dataset.estimateId;oe.log("Add room button clicked for estimate:",i);var r=e.currentProductId;null!=i&&""!==i?e.showNewRoomForm(i,r):(oe.error("No estimate ID found for add room button"),e.showError("Cannot add room: Missing estimate ID."))}},this.estimatesList.addEventListener("click",this._addRoomButtonHandler),oe.log("Add room button event handler bound")):oe.error("Cannot bind events - estimates list container not found")}},{key:"bindRoomSelectionFormEvents",value:function(){var e=this;if(oe.log("Binding room selection form events"),this.roomSelectionForm){var t=this.roomSelectionForm.querySelector("form");if(t){this._roomFormSubmitHandler&&t.removeEventListener("submit",this._roomFormSubmitHandler),this._roomFormSubmitHandler=function(o){o.preventDefault(),oe.log("Room selection form submitted"),e.handleRoomSelection(t)},t.addEventListener("submit",this._roomFormSubmitHandler);var o=t.querySelector(".cancel-btn");o&&(this._backButtonHandler&&o.removeEventListener("click",this._backButtonHandler),this._backButtonHandler=function(){oe.log("Back button clicked in room selection form"),e.forceElementVisibility(e.estimateSelectionForm),e.forceElementVisibility(e.estimateSelection),e.roomSelectionForm.style.display="none"},o.addEventListener("click",this._backButtonHandler));var i=t.querySelector("#add-new-room-from-selection");i?(this._addNewRoomHandler&&i.removeEventListener("click",this._addNewRoomHandler),this._addNewRoomHandler=function(){oe.log("Add new room button clicked in room selection form");var t=e.roomSelectionForm.dataset.estimateId,o=e.currentProductId;oe.log("Estimate ID for new room:",t,"Product ID:",o),t?e.showNewRoomForm(t,o):(oe.error("No estimate ID found for add new room button in room selection form"),e.showError("Cannot add room: Missing estimate ID."))},i.addEventListener("click",this._addNewRoomHandler),oe.log("Add new room button handler bound in room selection form")):oe.warn("Add new room button not found in room selection form"),oe.log("Room selection form events bound successfully")}else oe.warn("Cannot bind events - form not found in room selection form")}else oe.warn("Cannot bind events - room selection form container not found")}},{key:"handleEstimateSelection",value:function(e){var t=this,o=e.querySelector("#estimate-dropdown"),i=String(o&&o.value||"").trim(),r=String(this.currentProductId||"").trim();i?(this.showLoading(),this.dataService.getRoomsForEstimate(i,r).then((function(e){t.estimateSelectionForm?t.estimateSelectionForm.style.display="none":oe.warn("Estimate selection form wrapper not found when trying to hide it."),setTimeout((function(){var o=t.modal.querySelector("#room-selection-form-wrapper");if(!o)return oe.error("Room selection form wrapper not found in modal template!"),t.showError("Modal structure incomplete. Cannot proceed."),void t.hideLoading();if(t.roomSelectionForm=o,e.has_rooms){oe.log("Estimate has rooms, showing room selection form."),t.forceElementVisibility(t.roomSelectionForm);var a=t.roomSelectionForm.querySelector("#room-dropdown");if(a){a.innerHTML="";var n=document.createElement("option");n.value="",n.textContent=productEstimatorVars.i18n.select_room||"-- Select a Room --",a.appendChild(n),Array.isArray(e.rooms)?(e.rooms.forEach((function(e){if(e&&void 0!==e.id&&void 0!==e.name&&void 0!==e.dimensions){var t=document.createElement("option");t.value=e.id,t.textContent="".concat(e.name," (").concat(e.dimensions,")"),a.appendChild(t)}else oe.warn("Skipping invalid room data received:",e)})),oe.log("Populated room dropdown with ".concat(e.rooms.length," rooms."))):oe.warn("Received non-array data for rooms:",e.rooms),t.roomSelectionForm.dataset.estimateId=i;var s=t.roomSelectionForm.querySelector("#add-new-room-from-selection");s?(s.dataset.estimateId=i,oe.log("Set estimate ID on Add New Room button:",i)):oe.warn("Add New Room button not found in room selection form."),t.bindRoomSelectionFormEvents()}else oe.error("Room dropdown element (#room-dropdown) not found inside the room selection form wrapper!"),t.showError("Modal structure incomplete. Cannot show room selection form."),t.hideLoading()}else oe.log("No rooms found for this estimate, showing new room form."),t.showNewRoomForm(i,r)}),0)})).catch((function(e){oe.log("Error getting rooms for estimate:",e),t.showError(e.message||"Error loading rooms. Please try again.")})).finally((function(){t.hideLoading()}))):this.showError("Please select an estimate to continue.")}},{key:"updateCustomerDetailsDisplay",value:function(e){var t,o=null===(t=this.modal)||void 0===t?void 0:t.querySelectorAll(".customer-details-confirmation");o&&0!==o.length&&o.forEach((function(t){var o=t.querySelector(".saved-customer-details p");if(o){var i="";e.name&&""!==e.name.trim()&&(i+="<strong>".concat(e.name,"</strong><br>")),e.email&&""!==e.email.trim()&&(i+="".concat(e.email,"<br>")),e.phone&&""!==e.phone.trim()&&(i+="".concat(e.phone,"<br>")),i+=e.postcode||"",o.innerHTML=i;var r=t.querySelector("#edit-customer-name"),a=t.querySelector("#edit-customer-email"),n=t.querySelector("#edit-customer-phone"),s=t.querySelector("#edit-customer-postcode");r&&e.name&&(r.value=e.name),a&&e.email&&(a.value=e.email),n&&e.phone&&(n.value=e.phone),s&&e.postcode&&(s.value=e.postcode)}}))}},{key:"handleRoomSelection",value:function(e){var t=this,o=e.querySelector("#room-dropdown"),i=String(o&&o.value||"").trim(),r=String(this.currentProductId||"").trim(),a=String(this.roomSelectionForm.dataset.estimateId||"").trim();return null==i||""===i?(this.showError("Please select a room"),void oe.error("[handleRoomSelection] Room selection requires a valid room ID but it was empty or invalid")):null==r||""===r||"0"===r?(this.showError("No product selected"),void oe.error("[handleRoomSelection] Room selection requires a valid product ID but it was empty or invalid")):(oe.log("[handleRoomSelection] Room selection validated with:",{roomId:i,productId:r,estimateId:a}),this.showLoading(),void this.dataService.addProductToRoom(i,r,a).then((function(e){if(oe.log("[handleRoomSelection] Room selection add product local storage attempt result:",e),e.success){oe.log("[handleRoomSelection] Local storage add successful. Refreshing list."),t.estimateSelection.style.display="none",t.roomSelectionForm.style.display="none",delete t.modal.dataset.productId,t.currentProductId=null;var o=e.estimate_id||a,r=e.room_id||i;oe.log("[handleRoomSelection] Product added to estimate ".concat(o,", room ").concat(r," (based on local storage)")),t.loadEstimatesList(r,o).then((function(){var e=t.modal.querySelector('.accordion-item[data-room-id="'.concat(r,'"][data-estimate-id="').concat(o,'"]'));e?(oe.log("[handleRoomSelection] List reloaded. Triggering suggestion update for room:",r),t.updateRoomSuggestions(o,r,e)):oe.warn("[handleRoomSelection] Could not find room element after list reload to update suggestions."),t.showMessage("Product added successfully!","success")})).catch((function(e){oe.error("[handleRoomSelection] Error refreshing estimates list:",e),t.showError("Error refreshing estimates list. Please try again.")}))}else oe.error("[handleRoomSelection] Error during local storage add:",e.error),t.showError(e.error.message||"Failed to add product locally. Please try again.")})).catch((function(e){var o;if(oe.error("[handleRoomSelection] Error adding product from room selection via DataService:",e),null!==(o=e.data)&&void 0!==o&&o.duplicate){oe.log("[handleRoomSelection] Duplicate product detected from room selection by DataService:",e.data),t.estimateSelection.style.display="none",t.roomSelectionForm.style.display="none",delete t.modal.dataset.productId,t.currentProductId=null;var i=e.data.estimate_id,r=e.data.room_id;t.showError(e.data.message||"This product already exists in the selected room."),t.loadEstimatesList(r,i).then((function(){oe.log("[handleRoomSelection] Estimates list refreshed to show duplicate product location")})).catch((function(e){oe.error("[handleRoomSelection] Error refreshing estimates list:",e)}))}else{var a=e.message||"Error adding product to room. Please try again.";t.showError(a),oe.error("[handleRoomSelection] DataService error:",e)}})).finally((function(){t.hideLoading()})))}},{key:"handleNewEstimateSubmission",value:function(e){var t=this,o=new FormData(e),i=this.currentProductId;o.get("estimate_name"),this.showLoading(),oe.log("Submitting new estimate form"),oe.log(o),this.dataService.addNewEstimate(o,i).then((function(r){oe.log("New estimate created with ID:",r.estimate_id);var a={name:o.get("customer_name")||"",email:o.get("customer_email")||"",phone:o.get("customer_phone")||"",postcode:o.get("customer_postcode")||""};if($(a),oe.log("Customer details from new estimate form saved to localStorage:",a),e.reset(),t.newEstimateForm.style.display="none",i){var n=r.estimate_id;oe.log("New estimate created in product flow, showing new room form for estimate ID:",n,"with product ID:",i),t.showNewRoomForm(n,i)}else oe.log("New estimate created in general flow, refreshing estimates list."),t.loadEstimatesList().catch((function(e){oe.log("Error refreshing estimates list:",e),t.showError("Error refreshing estimates list. Please try again.")})).finally((function(){t.hideLoading()}))})).catch((function(e){oe.log("Error creating estimate:",e),t.showError(e.message||"Error creating estimate. Please try again."),t.hideLoading()}))}},{key:"handleNewRoomSubmission",value:function(e,t){var o=this;if(oe.log("[handleNewRoomSubmission] Processing new room form submission via DataService"),t?t.preventDefault():void 0!==window.event&&window.event.preventDefault(),!e.checkValidity())return oe.error("[handleNewRoomSubmission] Form validation failed"),void e.reportValidity();var i=new FormData(e),r=e.dataset.estimateId,a=this.currentProductId||e.dataset.productId;oe.log("[handleNewRoomSubmission] Room form submission data:",{formElement:e,formDataset:e.dataset,containerDataset:this.newRoomForm.dataset,estimateId:r,productId:a,formData:Object.fromEntries(i)}),null!=r&&""!==r?(this.showLoading(),oe.log("[handleNewRoomSubmission] Calling DataService.addNewRoom for estimate ID:",r),this.dataService.addNewRoom(i,r,a).then((function(t){oe.log("[handleNewRoomSubmission] DataService.addNewRoom response:",t),e.reset(),o.newRoomForm.style.display="none",delete o.modal.dataset.productId,o.currentProductId=null;var i=t.estimate_id||r,a=t.room_id||"0";oe.log("[handleNewRoomSubmission] New room added to estimate ".concat(i,", room ").concat(a)),o.loadEstimatesList(a,i).then((function(){o.showMessage("Room added successfully!","success");var e=o.modal.querySelector('.accordion-item[data-room-id="'.concat(a,'"][data-estimate-id="').concat(i,'"]'));e?(oe.log("[handleNewRoomSubmission] List reloaded. Triggering suggestion update for room:",a),o.updateRoomSuggestions(i,a,e)):oe.warn("[handleNewRoomSubmission] Could not find room element after list reload to update suggestions.")})).catch((function(e){oe.error("[handleNewRoomSubmission] Error refreshing estimates list:",e),o.showError("Error refreshing estimates list. Please try again.")}))})).catch((function(e){oe.error("[handleNewRoomSubmission] Error adding room via DataService:",e),o.showError(e.message||"Error adding room. Please try again.")})).finally((function(){o.hideLoading()}))):this.showError("No estimate selected for this room.")}},{key:"cancelForm",value:function(e){var t=this;switch(oe.log("Canceling form type: ".concat(e)),e){case"estimate":this.newEstimateForm&&(this.newEstimateForm.style.display="none"),this.currentProductId?this.dataService.checkEstimatesExist().then((function(e){e?(t.forceElementVisibility(t.estimateSelectionForm),t.forceElementVisibility(t.estimateSelection)):t.forceElementVisibility(t.estimatesList)})).catch((function(e){oe.error("Error checking estimates:",e),t.forceElementVisibility(t.estimatesList)})):this.forceElementVisibility(this.estimatesList);break;case"room":if(this.newRoomForm){this.newRoomForm.style.display="none",this.newRoomForm.removeAttribute("data-estimate-id"),this.newRoomForm.removeAttribute("data-product-id");var o=this.newRoomForm.querySelector("form");o&&(o.removeAttribute("data-estimate-id"),o.removeAttribute("data-product-id"))}this.currentProductId&&this.roomSelectionForm&&this.roomSelectionForm.dataset.estimateId?(oe.log("Canceling room form, returning to room selection."),this.forceElementVisibility(this.roomSelectionForm),this.estimateSelection&&this.forceElementVisibility(this.estimateSelection)):this.currentProductId&&this.estimateSelection&&this.estimateSelection.dataset.estimateId?(oe.log("Canceling room form, returning to estimate selection (no rooms existed)."),this.forceElementVisibility(this.estimateSelection),this.estimateSelectionForm&&this.forceElementVisibility(this.estimateSelectionForm)):(oe.log("Canceling room form, returning to estimates list."),this.forceElementVisibility(this.estimatesList));break;default:oe.warn("Unknown form type: ".concat(e)),this.forceElementVisibility(this.estimatesList)}}},{key:"initializeEstimateAccordions",value:function(){oe.log("Initializing estimate accordions");var e=this.modal.querySelectorAll(".estimate-header");oe.log("Found ".concat(e.length," estimate headers to initialize")),e.forEach((function(e){var t=e.cloneNode(!0);e.parentNode.replaceChild(t,e),t.addEventListener("click",(function(e){if(e.target.closest(".remove-estimate"))e.stopPropagation();else{oe.log("Estimate header clicked");var o=t.closest(".estimate-section");if(o){o.classList.toggle("collapsed"),oe.log("Toggled collapsed class on estimate section");var i=o.querySelector(".estimate-content");i?o.classList.contains("collapsed")?i.style.display="none":i.style.display="block":oe.error("No estimate content element found")}else oe.error("No parent estimate section found")}}))})),oe.log("Estimate accordions initialization complete")}},{key:"initializeAccordions",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(this.modal){if(this.accordionHandler&&this.estimatesList.removeEventListener("click",this.accordionHandler),this.accordionHandler=function(t){var o=t.target.closest(".accordion-header");if(o){t.preventDefault(),t.stopPropagation(),oe.log("Accordion header clicked via delegation"),e.toggleAccordionItem(o);var i=o.closest(".accordion-item");if(i){var r=i.querySelector(".accordion-content");r&&"none"!==window.getComputedStyle(r).display&&setTimeout((function(){var t=r.querySelectorAll(".product-suggestions .suggestions-carousel");t.length&&(oe.log("Found ".concat(t.length," suggestion carousels in opened accordion")),"function"==typeof initSuggestionsCarousels&&initSuggestionsCarousels());var o=r.querySelectorAll(".product-item"),a=i.dataset.estimateId,n=i.dataset.roomId;o.length>0&&a&&n?(oe.log("Found ".concat(o.length," product items in room ").concat(n,", loading similar products.")),o.forEach((function(t){t.dataset.similarProductsLoaded?oe.log("Similar products already loaded for product item ".concat(t.dataset.productId||"unknown",".")):t.classList.contains("product-note-item")?t.dataset.similarProductsLoaded="true":e.loadSimilarProductsForProduct(t,a,n)}))):oe.log("No product items found in room ".concat(n," or missing estimate/room ID. Skipping similar products load."))}),100)}}},this.estimatesList)if(this.estimatesList.addEventListener("click",this.accordionHandler),oe.log("Accordion event handler (re)attached"),t){var i='.accordion-item[data-room-id="'.concat(t,'"]');o&&(i='.estimate-section[data-estimate-id="'.concat(o,'"] ').concat(i)),oe.log("[initializeAccordions] Looking for room with selector: ".concat(i," for auto-expansion"));var r=this.modal.querySelector(i);if(r){oe.log("[initializeAccordions] Found room element to expand: ".concat(i));var a=r.closest(".estimate-section");if(a){oe.log("[initializeAccordions] Found parent estimate section for room ".concat(t,", ensuring visibility.")),a.style.display="block",a.classList.remove("collapsed");var n=a.querySelector(".estimate-content");n&&(oe.log("[initializeAccordions] Ensuring estimate content for ".concat(o," is visible.")),n.style.display="block","undefined"!=typeof jQuery&&jQuery(n).show(0));var s=a.querySelector(".estimate-header");s&&"undefined"!=typeof jQuery&&jQuery(s).addClass("active")}else oe.warn("[initializeAccordions] Parent estimate section not found for room ".concat(t," using closest('.estimate-section')"));var c=r.querySelector(".accordion-header");if(c){oe.log("[initializeAccordions] Found room header for room ".concat(t,", expanding.")),c.classList.add("active");var l=r.querySelector(".accordion-content");if(l)if(oe.log("[initializeAccordions] Found room content for room ".concat(t,", showing.")),l.style.display="block","undefined"!=typeof jQuery)jQuery(l).slideDown(300,function(){var e=this;oe.log("[initializeAccordions] jQuery slideDown complete for room ".concat(t,", attempting to scroll.")),r.scrollIntoView({behavior:"smooth",block:"center"});var o=l.querySelectorAll(".product-item"),i=r.dataset.estimateId,a=r.dataset.roomId;o.length>0&&i&&a?(oe.log("Found ".concat(o.length," product items in room ").concat(a," after slideDown, loading similar products.")),o.forEach((function(t){t.dataset.similarProductsLoaded||(t.classList.contains("product-note-item")?t.dataset.similarProductsLoaded="true":e.loadSimilarProductsForProduct(t,i,a))}))):oe.log("No product items found in room ".concat(a," or missing estimate/room ID after slideDown. Skipping similar products load."));var n=l.querySelectorAll(".product-suggestions .suggestions-carousel");n.length&&(oe.log("Found ".concat(n.length," suggestion carousels in auto-opened accordion after slideDown.")),"function"==typeof initSuggestionsCarousels&&initSuggestionsCarousels())}.bind(this));else{oe.log("[initializeAccordions] No jQuery, setting display: block for room ".concat(t,".")),l.style.display="block",r.scrollIntoView({behavior:"smooth",block:"center"});var d=l.querySelectorAll(".product-item"),u=r.dataset.estimateId,m=r.dataset.roomId;d.length>0&&u&&m?(oe.log("Found ".concat(d.length," product items in room ").concat(m," immediately, loading similar products.")),d.forEach((function(t){t.dataset.similarProductsLoaded||(t.classList.contains("product-note-item")?t.dataset.similarProductsLoaded="true":e.loadSimilarProductsForProduct(t,u,m))}))):oe.log("No product items found in room ".concat(m," or missing estimate/room ID immediately. Skipping similar products load.")),setTimeout((function(){"function"==typeof initSuggestionsCarousels?(initSuggestionsCarousels(),oe.log("[initializeAccordions] Initialized carousels in room ".concat(t," content."))):oe.warn("[initializeAccordions] initSuggestionsCarousels function not available.")}),150)}else oe.warn("[initializeAccordions] Room content (.accordion-content) not found for room ID ".concat(t));oe.log("[initializeAccordions] Auto-expanded logic completed for room ID: ".concat(t," in estimate: ").concat(o||"any"))}}else{oe.log("[initializeAccordions] Room ID ".concat(t," not found for auto-expansion using selector: ").concat(i));var g=this.modal.querySelectorAll(".accordion-item[data-room-id]");oe.log("[initializeAccordions] Available room elements found in modal: ".concat(Array.from(g).map((function(e){return e.dataset.roomId})).join(", ")))}}else if(o){oe.log("[initializeAccordions] expandRoomId not provided, checking if only estimate ".concat(o," needs expansion."));var p=this.modal.querySelector('.estimate-section[data-estimate-id="'.concat(o,'"]'));if(p){oe.log("[initializeAccordions] Found estimate section ".concat(o,", expanding.")),p.classList.remove("collapsed");var h=p.querySelector(".estimate-content");h&&(h.style.display="block","undefined"!=typeof jQuery&&jQuery(h).show(0)),setTimeout((function(){p.scrollIntoView({behavior:"smooth",block:"center"})}),150)}else oe.warn("[initializeAccordions] Estimate ID ".concat(o," not found for auto-expansion."))}else oe.log("[initializeAccordions] No specific room or estimate ID provided for auto-expansion.")}else oe.error("Modal not available for initializing accordions")}},{key:"toggleAccordionItem",value:function(e){oe.log("Toggling accordion item"),e.classList.toggle("active");var t=e.closest(".accordion-item");if(t){var o=t.querySelector(".accordion-content");o?e.classList.contains("active")?(oe.log("Opening accordion content"),"undefined"!=typeof jQuery?jQuery(o).slideDown(200):o.style.display="block"):(oe.log("Closing accordion content"),"undefined"!=typeof jQuery?jQuery(o).slideUp(200):o.style.display="none"):oe.log("No accordion content found")}else oe.log("No parent accordion item found")}},{key:"initializeJQueryAccordions",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;"undefined"!=typeof jQuery?(jQuery(document).off("click",".accordion-header"),jQuery(document).on("click",".accordion-header",(function(e){e.preventDefault(),e.stopPropagation(),oe.log("jQuery accordion handler triggered");var t=jQuery(this);t.toggleClass("active");var o=t.closest(".accordion-item").find(".accordion-content");o.length&&(t.hasClass("active")?o.slideDown(200,(function(){var e=o.find(".suggestions-carousel");e.length&&(oe.log("[initializeJQueryAccordions] Initializing carousels in opened accordion via slideDown callback."),e.each((function(){var e=this;e.carouselInstance&&e.carouselInstance.destroy(),new U(e)})))})):o.slideUp(200))})),e&&setTimeout((function(){var o='.accordion-item[data-room-id="'.concat(e,'"]');t&&(o='.estimate-section[data-estimate-id="'.concat(t,'"] ').concat(o)),oe.log("Looking for room with selector: ".concat(o));var i=jQuery(o);if(i.length){oe.log("Found room element using jQuery: ".concat(o));var r=i.closest(".estimate-section");r.length&&r.show();var a=i.find(".accordion-header");if(a.length){a.addClass("active");var n=i.find(".accordion-content");n.length&&n.slideDown(300,(function(){i[0].scrollIntoView({behavior:"smooth",block:"center"});var e=n.find(".suggestions-carousel");e.length&&(oe.log("[initializeJQueryAccordions] Initializing carousels in auto-opened room via slideDown callback."),e.each((function(){var e=this;e.carouselInstance&&e.carouselInstance.destroy(),new U(e)})))})),oe.log("jQuery auto-expanded room ID: ".concat(e," in estimate: ").concat(t||"any"))}}else oe.warn("Room element not found with jQuery using selector: ".concat(o)),oe.log("Available room elements:",jQuery(".accordion-item[data-room-id]").map((function(){return jQuery(this).data("roomId")})).get())}),300)):oe.log("jQuery not available for fallback")}},{key:"bindReplaceProductButtons",value:function(){var e=this,t=this.modal.querySelectorAll(".replace-product-in-room");t.length?(t.forEach((function(t,o){oe.log("[BUTTON BINDING] Button #".concat(o+1," attributes:"),{productId:t.dataset.productId,estimateId:t.dataset.estimateId,roomId:t.dataset.roomId,replaceProductId:t.dataset.replaceProductId,replaceType:t.dataset.replaceType||"main"}),t._replaceButtonHandler&&t.removeEventListener("click",t._replaceButtonHandler),t._replaceButtonHandler=function(o){o.preventDefault(),o.stopPropagation();var i=t.dataset.productId,r=t.dataset.estimateId,a=t.dataset.roomId,n=t.dataset.replaceProductId,s=t.dataset.parentProductId||null,c=t.hasAttribute("data-replace-type")?t.getAttribute("data-replace-type"):"main";oe.log("[BUTTON CLICKED] Replace product button clicked:",{estimateId:r,roomId:a,oldProductId:n,newProductId:i,replaceType:c}),e.handleReplaceProduct(r,a,n,i,s,t,c)},t.addEventListener("click",t._replaceButtonHandler)})),oe.log("[BUTTON BINDING] Replace product buttons bound successfully")):oe.log("[BUTTON BINDING] No replace product buttons found to bind")}},{key:"updateAllReplacementChains",value:function(e){e&&window._productReplacementChains&&(oe.log("[REPLACEMENT CHAINS] Updating all buttons with replacement chains"),e.querySelectorAll('button.replace-product-in-room[data-replace-type="additional_products"]').forEach((function(e){var t=e.dataset.productId,o=e.dataset.roomId,i=(e.dataset.replaceProductId,"".concat(o,"_").concat(t)),r=window._productReplacementChains[i];r&&(oe.log("[REPLACEMENT CHAINS] Found chain for ".concat(i,":"),r),e.dataset.replacementChain=JSON.stringify(r),oe.log("[REPLACEMENT CHAINS] Updated button ".concat(e.textContent," with chain data")))})))}},{key:"updateAdditionalProductUpgradeButtons",value:function(e,t,o){if(e){oe.log("Updating additional product upgrade buttons: newProductId=".concat(t,", oldProductId=").concat(o));var i=e.querySelectorAll('button.replace-product-in-room[data-replace-product-id="'.concat(o,'"][data-replace-type="additional_products"]'));i.length>0?(oe.log("Found ".concat(i.length," additional product upgrade buttons to update")),i.forEach((function(e){oe.log("Updating button data-replace-product-id from ".concat(o," to ").concat(t)),e.dataset.replaceProductId=t}))):oe.log("No additional product upgrade buttons found that need updating"),e.querySelectorAll('.product-upgrades[data-product-id="'.concat(o,'"]')).forEach((function(e){e.dataset.productId=t,oe.log("Updated product-upgrades container data-product-id from ".concat(o," to ").concat(t))}))}}},{key:"loadSimilarProductsForProduct",value:function(e,t,o){if("true"!==e.dataset.similarProductsLoaded){var i=e.dataset.productId,r=e.querySelector(".similar-products-container"),a=e.querySelector(".similar-products-list"),n=e.querySelector(".similar-products-toggle"),s=e.querySelector(".similar-products-carousel"),c=s?s.querySelectorAll(".suggestions-nav"):[];if(!(i&&r&&a&&n&&s))return oe.log("Skipping similar products (fallback path, should not be common now) for product ID ".concat(i," because elements missing or ID invalid.")),e.dataset.similarProductsLoaded="true",n&&(n.style.display="none"),r&&(r.style.display="none"),void c.forEach((function(e){return e.style.display="none"}));oe.log("[EstimatorCore] Fallback Loading (should be rare): Fetching similar products for product ID: ".concat(i," in room ").concat(o))}else{oe.log("Similar products already processed (pre-loaded or fallback skipped) for product item in room ".concat(o,"."));var l=e.querySelector(".similar-products-container"),d=e.querySelector(".similar-products-list"),u=e.querySelector(".similar-products-toggle");l&&d&&d.children.length>0?(l.style.display="block",u&&(u.style.display="")):l&&d&&0===d.children.length&&(u&&(u.style.display="none"),l&&(l.style.display="none"),oe.log("[EstimatorCore] No similar products were pre-loaded for product ".concat(e.dataset.productId||"unknown",". Hiding container and toggle as fallback is removed.")))}}},{key:"handleReplaceProduct",value:function(e,t,o,i,r,a){var n=this,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"main";oe.log("[PRODUCT REPLACEMENT] Starting product replacement process\n    Type: ".concat(s,"\n    Old Product ID: ").concat(o,"\n    New Product ID: ").concat(i,"\n    Parent Product ID: ").concat(r," // Log parent product ID\n    Room ID: ").concat(t,"\n    Estimate ID: ").concat(e,"\n  "));var c="this product",l="the selected product";try{if(a){var d=a.closest(".suggestion-item, .upgrade-tile, .similar-product-item");if(d){var u=d.querySelector(".suggestion-name, .tile-label");u&&(l=u.textContent.trim())}if("additional_products"===s){oe.log("Looking for additional product name to replace");var m=a.closest(".product-item");if(m){var g=m.querySelectorAll(".include-item");oe.log("Found ".concat(g.length," include items to search through"));var p,h=function(e,t){var o="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=function(e,t){if(e){if("string"==typeof e)return Z(e,t);var o={}.toString.call(e).slice(8,-1);return"Object"===o&&e.constructor&&(o=e.constructor.name),"Map"===o||"Set"===o?Array.from(e):"Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o)?Z(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){o&&(e=o);var i=0,r=function(){};return{s:r,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,n=!0,s=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return n=e.done,e},e:function(e){s=!0,a=e},f:function(){try{n||null==o.return||o.return()}finally{if(s)throw a}}}}(g);try{for(h.s();!(p=h.n()).done;){var f=p.value,v=f.querySelector(".include-item-name");if(v){var y=f.closest("[data-product-id]");if(y&&y.dataset.productId===o){c=v.textContent.trim(),oe.log("Found matching additional product: ".concat(c));break}c=v.textContent.trim()}}}catch(e){h.e(e)}finally{h.f()}}}else{var w=a.closest(".product-item");if(w){var b=w.querySelector(".product-name, .price-title");b&&(c=b.textContent.trim(),oe.log("Found main product name: ".concat(c)))}}}}catch(e){oe.warn("Could not determine product names for confirmation dialog:",e)}var E="Confirm Upgrade",S="Upgrade",_="upgrade_product";a&&a.closest(".similar-product-item")&&(E="Confirm Replacement",S="Replace",_="replace_product");var L='Are you sure you want to replace "'.concat(c,'" with "').concat(l,'"?');window.productEstimator&&window.productEstimator.dialog?window.productEstimator.dialog.show({title:E,message:L,type:"product",action:_,confirmText:S,cancelText:"Cancel",onConfirm:function(){n.executeProductReplacement(e,t,o,i,r,a,s)},onCancel:function(){a&&(a.disabled=!1,a.classList.remove("loading"),a.textContent=a.closest(".similar-product-item")?"Replace":"Upgrade"),oe.log("Product replacement cancelled")}}):confirm(L)?this.executeProductReplacement(e,t,o,i,r,a,s):a&&(a.disabled=!1,a.classList.remove("loading"),a.textContent=a.closest(".similar-product-item")?"Replace":"Upgrade")}},{key:"executeProductReplacement",value:function(e,t,o,i,r,a){var n=this,s=arguments.length>6&&void 0!==arguments[6]?arguments[6]:"main";if(this.showLoading(),a){a.disabled=!0,a.classList.add("loading");var c="additional_products"===s?"Upgrading...":"Replacing...";a.innerHTML='<span class="loading-dots">'.concat(c,"</span>")}oe.log("[PRODUCT REPLACEMENT] Executing replacement via DataService (waiting for local update):\n  Type: ".concat(s,"\n  Old Product ID: ").concat(o,"\n  New Product ID: ").concat(i,"\n  Room ID: ").concat(t,"\n  Parent Product ID: ").concat(r,"\n  Estimate ID: ").concat(e)),this.dataService.replaceProductInRoom(e,t,o,i,r,s).then((function(e){oe.log("[PRODUCT REPLACEMENT] DataService.replaceProductInRoom local storage attempt successful:",e),oe.log("[PRODUCT REPLACEMENT] Local storage update successful, attempting to load estimates list..."),n.loadEstimatesList(e.roomId,e.estimateId).then((function(){oe.log("[PRODUCT REPLACEMENT] Estimates list refreshed");var t=n.modal.querySelector('.accordion-item[data-room-id="'.concat(e.roomId,'"][data-estimate-id="').concat(e.estimateId,'"]'))||n.modal.querySelector('.accordion-item[data-room-id="'.concat(e.roomId,'"]'));if(t){oe.log("[PRODUCT REPLACEMENT] Found updated room element after refresh, performing post-refresh updates.");var o=t.closest(".estimate-section");if(o){oe.log("[PRODUCT REPLACEMENT] Found parent estimate section, ensuring it is not collapsed."),o.classList.remove("collapsed");var i=o.querySelector(".estimate-content");i&&("undefined"!=typeof jQuery?jQuery(i).slideDown(200):i.style.display="block")}var r=t.querySelector(".accordion-header");r&&r.classList.add("active");var a=t.querySelector(".accordion-content");a?("undefined"!=typeof jQuery?jQuery(a).slideDown(300,(function(){t.scrollIntoView({behavior:"smooth",block:"center"})})):(a.style.display="block",t.scrollIntoView({behavior:"smooth",block:"center"})),"additional_products"===s&&n.updateAdditionalProductUpgradeButtons(t,e.newProductId,e.oldProductId),setTimeout((function(){oe.log("[PRODUCT REPLACEMENT] Initializing carousels and rebinding events after list refresh."),"function"==typeof initSuggestionsCarousels&&initSuggestionsCarousels(),n.bindReplaceProductButtons(),n.bindSuggestedProductButtons(),n.updateAllReplacementChains(t),e.room_totals&&n.updateRoomTotals(e.estimateId,e.roomId,e.room_totals),e.estimate_totals&&n.updateEstimateTotals(e.estimateId,e.estimate_totals),n.showMessage("Product updated successfully!","success")}),300)):(oe.warn("[PRODUCT REPLACEMENT] Room content element not found after refresh."),n.showMessage("Product updated successfully!","success"))}else oe.warn("[PRODUCT REPLACEMENT] Could not find updated room element for room ID ".concat(e.roomId," after refresh.")),n.showMessage("Product updated successfully!","success")})).catch((function(e){oe.error("[PRODUCT REPLACEMENT] Error refreshing estimates list after local update:",e),n.showError("Error refreshing list after update. Please try again.")}))})).catch((function(e){oe.error("[PRODUCT REPLACEMENT] DataService local update attempt failed:",e),n.showError(e.message||"Error updating product. Please try again.")})).finally((function(){a&&(a.disabled=!1,a.classList.remove("loading"),a.textContent="additional_products"===s?"Upgrade":"Replace"),n.hideLoading()}))}},{key:"showMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=this.contentContainer||document.querySelector(".product-estimator-modal-form-container");if(o){document.querySelectorAll(".modal-message").forEach((function(e){return e.remove()}));var i="error"===t?"modal-error-message":"modal-success-message",r=document.createElement("div");r.className="modal-message ".concat(i),r.textContent=e;try{o.prepend(r)}catch(e){oe.error("Error adding message to container:",e)}setTimeout((function(){r.parentNode&&r.remove()}),5e3)}else oe.error("Form container not found for message display:",e)}},{key:"showError",value:function(e){this.showMessage(e,"error")}},{key:"on",value:function(e,t){return this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t),this}},{key:"emit",value:function(e,t){return this.eventHandlers[e]&&this.eventHandlers[e].forEach((function(e){return e(t)})),this}}])}();const re=ie;var ae=L("VariationHandler");const ne=function(){return c((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,e),this.config=Object.assign({debug:!0,selectors:{variationsForm:".variations_form",estimatorButton:".single_add_to_estimator_button, .button.alt.open-estimator-modal, .product-estimator-button, [data-product-id]",variationIdInput:'input[name="variation_id"]'}},t),this.variationsForm=document.querySelector(this.config.selectors.variationsForm),this.estimatorButton=document.querySelector(this.config.selectors.estimatorButton),this.variationIdInput=this.variationsForm?this.variationsForm.querySelector(this.config.selectors.variationIdInput):null,this.variationsData=window.product_estimator_variations||{},this.currentVariationId=null,this.initialized=!1,this.eventHandlers={},this.variationsForm?this.init():ae.log("No variations form found, VariationHandler not initialized")}),[{key:"init",value:function(){if(this.initialized)return ae.log("VariationHandler already initialized"),this;if(ae.log("Initializing VariationHandler with variations data:",this.variationsData),ae.log("Estimator button found:",!!this.estimatorButton),this.estimatorButton){ae.log("Initial button data-product-id:",this.estimatorButton.dataset.productId);var e=this.estimatorButton.dataset.productId;e&&this.isParentEstimatorEnabled(e)&&(ae.log("Parent product has estimator enabled, ensuring button is visible"),this.estimatorButton.style.display="",this.estimatorButton.classList.remove("hidden"))}return this.bindEvents(),this.checkCurrentVariation(),this.initialized=!0,ae.log("VariationHandler initialized"),this.emit("initialized"),this}},{key:"ensureEstimatorButton",value:function(e){if(ae.log("Ensuring estimator button exists for variation: ".concat(e)),document.querySelector(this.config.selectors.estimatorButton))return ae.log("Estimator button already exists, updating visibility"),void this.updateEstimatorButton(!0,e);if(this.isEstimatorEnabled(e)){ae.log("Creating estimator button dynamically");var t=document.querySelector(".single_add_to_cart_button");if(t){var o=document.createElement("button");o.type="button",o.className="single_add_to_estimator_button button alt open-estimator-modal",o.dataset.productId=e,o.textContent="Add to Estimate",t.insertAdjacentElement("afterend",o),ae.log("Estimator button created and inserted")}else ae.log("Cannot find add to cart button to insert after")}else ae.log("Estimator not enabled for this variation, not creating button")}},{key:"isParentEstimatorEnabled",value:function(e){if(document.querySelector(".single_add_to_estimator_button"))return!0;var t=document.querySelector('input[name="_enable_estimator"], [data-enable-estimator]');return!!t&&("yes"===t.value||"yes"===t.dataset.enableEstimator)}},{key:"bindEvents",value:function(){var e=this;this.variationsForm&&(ae.log("Binding variation events"),this.variationsForm.addEventListener("found_variation",this.handleFoundVariation.bind(this)),this.variationsForm.addEventListener("reset_data",this.handleResetVariation.bind(this)),this.variationsForm.addEventListener("check_variations",this.handleCheckVariations.bind(this)),document.addEventListener("woocommerce_variation_has_changed",this.checkCurrentVariation.bind(this)),this.variationIdInput&&this.variationIdInput.addEventListener("change",(function(){var t=e.variationIdInput.value;if(t){ae.log("Variation ID input changed to: ".concat(t)),e.currentVariationId=t;var o=e.isEstimatorEnabled(t);e.updateEstimatorButton(o,t)}})),"undefined"!=typeof jQuery&&jQuery(this.variationsForm).on("change",'input[name="variation_id"]',(function(t){var o=t.target.value;if(o){ae.log("jQuery variation ID change detected: ".concat(o)),e.currentVariationId=o;var i=e.isEstimatorEnabled(o);e.updateEstimatorButton(i,o)}})))}},{key:"handleFoundVariation",value:function(e){var t=void 0!==e.detail?e.detail:e.target.variation;if(t&&t.variation_id){var o=t.variation_id;this.currentVariationId=o,ae.log("Found variation: ".concat(o));var i=this.isEstimatorEnabled(o);ae.log("Variation ".concat(o," has estimator enabled: ").concat(i)),this.ensureEstimatorButton(o),this.updateEstimatorButton(i,o),this.emit("variation:changed",{variationId:o,enableEstimator:i,variation:t})}else ae.log("Found variation event received but no valid variation data")}},{key:"handleResetVariation",value:function(){ae.log("Reset variation"),this.currentVariationId=null,this.updateEstimatorButton(!1),this.emit("variation:reset")}},{key:"handleCheckVariations",value:function(){ae.log("Check variations"),this.checkCurrentVariation()}},{key:"checkCurrentVariation",value:function(){if(this.variationsForm){var e=document.querySelectorAll(this.config.selectors.estimatorButton);ae.log("Found ".concat(e.length," estimator buttons during checkCurrentVariation")),e.length>1&&(ae.log("WARNING: Found multiple estimator buttons - this may cause issues. Check for duplicates."),e.forEach((function(e,t){ae.log("Button ".concat(t+1," HTML: ").concat(e.outerHTML))})));var t=this.getCurrentVariation();if(t){ae.log("Current variation detected: ".concat(t.variation_id)),this.currentVariationId=t.variation_id;var o=this.isEstimatorEnabled(t.variation_id);this.updateEstimatorButton(o,t.variation_id)}else ae.log("No current variation detected"),this.currentVariationId=null,this.updateEstimatorButton(this.isParentProductEstimatorEnabled())}}},{key:"isParentProductEstimatorEnabled",value:function(){return void 0===window.product_estimator_variations||!window.product_estimator_variations._parent_enabled||"yes"===window.product_estimator_variations._parent_enabled}},{key:"getCurrentVariation",value:function(){if(!this.variationsForm)return null;if(this.variationsForm.currentVariation)return this.variationsForm.currentVariation;var e=this.variationsForm.querySelector('input[name="variation_id"]');if(e&&e.value)return{variation_id:e.value};var t=this.variationsForm.dataset.productVariations;if(t)return{variation_id:t};if("undefined"!=typeof jQuery){var o=jQuery(this.variationsForm),i=(o.data("product_variations"),o.find('input[name="variation_id"]').val());if(i)return{variation_id:i}}return null}},{key:"isEstimatorEnabled",value:function(e){if(!e)return!1;if(ae.log("Checking if estimator is enabled for variation: ".concat(e)),ae.log("Available variations data:",this.variationsData),this.variationsData[e]){var t="yes"===this.variationsData[e].enable_estimator;return ae.log("Found variation data, estimator enabled: ".concat(t)),t}var o=document.querySelector(".single_add_to_estimator_button[data-product-id]:not([data-variation-id])");if(o){var i=!o.classList.contains("hidden")&&"none"!==getComputedStyle(o).display;return ae.log("Using parent product as fallback, estimator enabled: ".concat(i)),i}return ae.log("No variation or parent data found, estimator disabled by default"),!1}},{key:"updateEstimatorButton",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,o=document.querySelector(".single_add_to_estimator_button");o?(ae.log("Updating button visibility: ".concat(e?"show":"hide",", variation ID: ").concat(t)),e?(o.style.display="",t&&(ae.log("Setting button data-product-id to variation ID: ".concat(t)),o.dataset.productId=t)):(o.style.display="none",ae.log("Hiding estimator button"))):ae.log("Estimator button not found")}},{key:"on",value:function(e,t){return this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t),this}},{key:"emit",value:function(e,t){return this.eventHandlers[e]&&this.eventHandlers[e].forEach((function(e){return e(t)})),this}}])}();var se=L("CustomerDetailsManager"),ce=function(){return c((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=arguments.length>1?arguments[1]:void 0;r(this,e),this.config=Object.assign({debug:!1,selectors:{editButton:"#edit-customer-details-btn",deleteButton:"#delete-customer-details-btn",saveButton:"#save-customer-details-btn",cancelButton:"#cancel-edit-customer-details-btn",detailsContainer:".saved-customer-details",detailsHeader:".customer-details-header",editForm:".customer-details-edit-form",formContainer:".product-estimator-modal-form-container"},i18n:{}},t),this.dataService=o,this.initialized=!1,this.eventHandlers={},!1!==t.autoInit&&this.init()}),[{key:"init",value:function(){return this.initialized?(se.log("CustomerDetailsManager already initialized"),this):(this.bindEvents(),document.addEventListener("customer_details_updated",this.onCustomerDetailsUpdated.bind(this)),this.initialized=!0,se.log("CustomerDetailsManager initialized"),this)}},{key:"onCustomerDetailsUpdated",value:function(e){e.detail&&e.detail.details&&(se.log("Received customer_details_updated event",e.detail),this.updateDisplayedDetails(e.detail.details),this.checkAndUpdateEmailField(e.detail.details))}},{key:"checkAndUpdateEmailField",value:function(e){var t=e&&e.email&&""!==e.email.trim();se.log("Checking for email field updates: hasEmail=".concat(t)),document.querySelectorAll(this.config.selectors.editForm).forEach((function(o){var i=o.querySelector("#edit-customer-email");if(!i&&t){se.log("Adding email field to edit form");var r=document.createElement("div");r.className="form-group";var a=document.createElement("label");a.setAttribute("for","edit-customer-email"),a.textContent="Email Address",(i=document.createElement("input")).type="email",i.id="edit-customer-email",i.name="edit_customer_email",i.value=e.email,r.appendChild(a),r.appendChild(i);var n=o.querySelector("#edit-customer-name");if(n){var s=n.closest(".form-group");s?s.parentNode.insertBefore(r,s.nextSibling):o.querySelector("h4").after(r)}}else i&&t&&(i.value=e.email);var c=o.querySelector("#edit-customer-name");c&&e.name&&(c.value=e.name);var l=o.querySelector("#edit-customer-phone");l&&e.phone&&(l.value=e.phone);var d=o.querySelector("#edit-customer-postcode");d&&e.postcode&&(d.value=e.postcode)})),document.querySelectorAll("#new-estimate-form").forEach((function(e){e.setAttribute("data-has-email",t?"true":"false")}))}},{key:"bindEvents",value:function(){var e=document.querySelector(this.config.selectors.editButton),t=document.querySelector(this.config.selectors.deleteButton),o=document.querySelector(this.config.selectors.saveButton),i=document.querySelector(this.config.selectors.cancelButton);e?(this.bindButtonWithHandler(e,"click",this.handleEditClick.bind(this)),t&&this.bindButtonWithHandler(t,"click",this.handleDeleteClick.bind(this)),o&&this.bindButtonWithHandler(o,"click",this.handleSaveClick.bind(this)),i&&this.bindButtonWithHandler(i,"click",this.handleCancelClick.bind(this))):se.log("Edit button not found, skipping event binding")}},{key:"bindButtonWithHandler",value:function(e,t,o){if(e){var i="_".concat(t,"Handler");e[i]&&e.removeEventListener(t,e[i]),e[i]=o,e.addEventListener(t,o)}}},{key:"handleEditClick",value:function(e){e.preventDefault(),e.stopPropagation();var t=document.querySelector(this.config.selectors.detailsContainer),o=document.querySelector(this.config.selectors.detailsHeader),i=document.querySelector(this.config.selectors.editForm);t&&(t.style.display="none"),o&&(o.style.display="none"),i&&(i.style.display="block"),se.log("Edit form displayed")}},{key:"handleCancelClick",value:function(e){e.preventDefault(),e.stopPropagation();var t=document.querySelector(this.config.selectors.detailsContainer),o=document.querySelector(this.config.selectors.detailsHeader),i=document.querySelector(this.config.selectors.editForm);i&&(i.style.display="none"),t&&(t.style.display="block"),o&&(o.style.display="flex"),se.log("Edit form hidden")}},{key:"handleSaveClick",value:function(e){var t,o,i=this;e.preventDefault(),e.stopPropagation();var r=e.target,a=r.textContent;r.textContent=this.config.i18n&&this.config.i18n.saving||"Saving...",r.disabled=!0;var n={name:(null===(t=document.getElementById("edit-customer-name"))||void 0===t?void 0:t.value)||"",postcode:(null===(o=document.getElementById("edit-customer-postcode"))||void 0===o?void 0:o.value)||""},s=document.getElementById("edit-customer-email");s&&(n.email=s.value||"");var c=document.getElementById("edit-customer-phone");c&&(n.phone=c.value||"");try{$(n),se.log("Customer details saved to localStorage:",n),this.dataService.request("update_customer_details",{details:JSON.stringify(n)}).then((function(e){se.log("Customer details updated on server successfully:",e),i.handleSaveSuccess(e,n)})).catch((function(e){i.handleSaveError(e)})).finally((function(){r.textContent=a,r.disabled=!1}))}catch(e){se.log("Error saving to localStorage using imported function:",e),this.showError("Could not save details locally."),this.dataService.request("update_customer_details",{details:JSON.stringify(n)}).then((function(e){se.log("Customer details updated on server successfully (after local storage error):",e),i.handleSaveSuccess(e,n)})).catch((function(e){i.handleSaveError(e)})).finally((function(){r.textContent=a,r.disabled=!1}))}}},{key:"handleSaveSuccess",value:function(e,t){this.updateDisplayedDetails(t),this.checkAndUpdateEmailField(t),this.showMessage("success",e.message||"Details updated successfully!");var o=document.querySelector(this.config.selectors.detailsContainer),i=document.querySelector(this.config.selectors.detailsHeader),r=document.querySelector(this.config.selectors.editForm);r&&(r.style.display="none"),o&&(o.style.display="block"),i&&(i.style.display="flex");var a=new CustomEvent("customer_details_updated",{bubbles:!0,detail:{details:t}});document.dispatchEvent(a),se.log("Customer details updated successfully",e)}},{key:"handleSaveError",value:function(e){this.showMessage("error",e.message||"Error updating details. Please try again."),se.log("Error saving customer details:",e)}},{key:"handleDeleteClick",value:function(e){var t=this;e.preventDefault(),e.stopPropagation(),window.productEstimator&&window.productEstimator.dialog?window.productEstimator.dialog.show({title:this.config.i18n&&this.config.i18n.delete_customer_details||"Delete Customer Details",message:this.config.i18n&&this.config.i18n.confirm_delete_details||"Are you sure you want to delete your saved details?",confirmText:this.config.i18n&&this.config.i18n.delete||"Delete",action:"delete",cancelText:this.config.i18n.cancel||"Cancel",onConfirm:function(){t.deleteCustomerDetails()}}):confirm(this.config.i18n.confirm_delete_details||"Are you sure you want to delete your saved details?")&&this.deleteCustomerDetails()}},{key:"deleteCustomerDetails",value:function(){var e,t,o=this,i=document.querySelector(".customer-details-confirmation");i&&i.classList.add("loading");try{Y(),se.log("Customer details removed from localStorage using imported function"),this.handleDeleteSuccess({message:"Details deleted successfully from local storage"},i)}catch(e){se.log("localStorage error on delete using imported function",e)}this.dataService&&"function"==typeof this.dataService.request?this.dataService.request("delete_customer_details").then((function(e){o.handleDeleteSuccess(e,i)})).catch((function(e){o.handleDeleteError(e,i)})):fetch((null===(e=window.productEstimatorVars)||void 0===e?void 0:e.ajax_url)||"/wp-admin/admin-ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({action:"delete_customer_details",nonce:(null===(t=window.productEstimatorVars)||void 0===t?void 0:t.nonce)||""})}).then((function(e){return e.json()})).then((function(e){var t;e.success?o.handleDeleteSuccess(e.data,i):o.handleDeleteError(new Error((null===(t=e.data)||void 0===t?void 0:t.message)||"Error deleting details"),i)})).catch((function(e){o.handleDeleteError(e,i)}))}},{key:"handleDeleteSuccess",value:function(e,t){if(t&&e.html){var o=document.createElement("div");o.innerHTML=e.html,t.parentNode.replaceChild(o.firstElementChild,t)}this.showMessage("success",e.message||"Details deleted successfully!");var i=document.querySelector("#new-estimate-form");i&&i.setAttribute("data-has-email","false");var r=new CustomEvent("customer_details_deleted",{bubbles:!0});document.dispatchEvent(r),se.log("Customer details deleted")}},{key:"handleDeleteError",value:function(e,t){this.showMessage("error",e.message||"Error deleting details!"),se.log("Error deleting details:",e),t&&t.classList.remove("loading")}},{key:"updateDisplayedDetails",value:function(e){var t=document.querySelectorAll(this.config.selectors.detailsContainer);t.length?(se.log("Updating ".concat(t.length," customer details containers")),t.forEach((function(t){var o="<p>";e.name&&""!==e.name.trim()&&(o+="<strong>".concat(e.name,"</strong><br>")),e.email&&""!==e.email.trim()&&(o+="".concat(e.email,"<br>")),e.phone&&""!==e.phone.trim()&&(o+="".concat(e.phone,"<br>")),o+=e.postcode||"",o+="</p>",t.innerHTML=o}))):se.log("No customer details containers found for updating")}},{key:"showMessage",value:function(e,t){document.querySelectorAll(".modal-message").forEach((function(e){return e.remove()}));var o="error"===e?"modal-error-message":"modal-success-message",i=document.createElement("div");i.className="modal-message ".concat(o),i.textContent=t;var r=document.querySelector(this.config.selectors.formContainer);r&&(r.prepend(i),setTimeout((function(){i.remove()}),5e3))}}])}();const le=ce;var de=L("EstimatorCore"),ue=function(){return c((function e(){var t,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,e),this.config=Object.assign({debug:!1,selectors:{estimatorButtons:".product-estimator-button, .single_add_to_estimator_button, .open-estimator-modal",estimatorMenuButtons:".product-estimator-menu-item a, a.product-estimator-menu-item",modalContainer:"#product-estimator-modal"},autoInit:!0,i18n:(null===(t=window.productEstimatorVars)||void 0===t?void 0:t.i18n)||{}},o),this.dataService=null,this.modalManager=null,this.variationHandler=null,this.customerDetailsManager=null,this.initialized=!1,this.eventHandlers={},this.config.autoInit&&this.init()}),[{key:"init",value:function(){var e=this;if(this.initialized)return de.log("already initialized - aborting"),this;if(window._productEstimatorInitialized&&window.productEstimator&&window.productEstimator.core)return de.log("detected as already initialized globally - aborting"),this.initialized=!0,this;de.log("Initializing EstimatorCore");try{if("undefined"==typeof jQuery)return de.error("jQuery is not loaded, cannot initialize EstimatorCore"),this;this.dataService||(this.dataService=new N({debug:this.config.debug})),de.log("%c=== PRODUCT ESTIMATOR INITIALIZATION START ===","background: #f0f0f0; color: #333; padding: 3px; border-radius: 3px;");var t=function(){e.modalManager?de.log("Components already initialized - skipping"):(e.modalManager=new re({debug:e.config.debug,selectors:e.config.selectors},e.dataService),e.customerDetailsManager=new le({debug:e.config.debug},e.dataService),e.isWooCommerceProductPage()&&(de.log("WooCommerce product page detected, initializing VariationHandler"),e.variationHandler=new ne({debug:e.config.debug})),e.bindGlobalEvents(),e.initialized=!0,de.log("initialized successfully"),e.emit("core:initialized"),de.log("%c=== PRODUCT ESTIMATOR INITIALIZATION COMPLETE ===","background: #f0f0f0; color: #333; padding: 3px; border-radius: 3px;"))};"complete"===document.readyState?t():window.addEventListener("load",t,{once:!0})}catch(e){de.error("EstimatorCore initialization error:",e)}return this}},{key:"bindGlobalEvents",value:function(){var e=this;try{this._clickHandler&&document.removeEventListener("click",this._clickHandler),this._clickHandler=function(t){var o=t.target.closest(e.config.selectors.estimatorMenuButtons);if(o)return t.preventDefault(),t.stopPropagation(),de.log("Menu button clicked - opening modal in list view"),void(e.modalManager&&e.modalManager.openModal(null,!0));var i=t.target.closest(e.config.selectors.estimatorButtons);if(i&&!o){t.preventDefault(),t.stopPropagation();var r=i.dataset.productId||null;de.log("PRODUCT BUTTON CLICKED:",{productId:r,buttonElement:i,dataAttribute:i.dataset}),e.modalManager&&(de.log("OPENING MODAL WITH:",{productId:r,forceListView:!1}),e.modalManager.openModal(r,!1))}},document.addEventListener("click",this._clickHandler),this.emit("core:eventsbound")}catch(e){de.error("Error binding global events:",e)}}},{key:"closeModal",value:function(){this.modalManager&&this.modalManager.closeModal()}},{key:"isWooCommerceProductPage",value:function(){return document.body.classList.contains("single-product")||document.body.classList.contains("product-template-default")||!!document.querySelector(".product.type-product")}},{key:"on",value:function(e,t){return this.eventHandlers[e]||(this.eventHandlers[e]=[]),this.eventHandlers[e].push(t),this}},{key:"emit",value:function(e,t){return this.eventHandlers[e]&&this.eventHandlers[e].forEach((function(e){return e(t)})),this}}])}();const me=new ue({debug:!0});var ge,pe,he,fe,ve,ye,we=L("ProductDetailsToggle"),be=new(function(){return c((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};r(this,e),this.config=Object.assign({debug:!1,selectors:{productToggleButton:".product-details-toggle",notesToggleButton:".product-notes-toggle",includesToggleButton:".product-includes-toggle",productItem:".product-item",similarProductsContainer:".similar-products-container",productIncludes:".product-includes",similarProducts:".product-similar-products",productNotes:".product-notes",notesContainer:".notes-container",includesContainer:".includes-container",suggestionsContainer:".suggestions-container"},i18n:{showProducts:"Similar Products",hideProducts:"Similar Products",showNotes:"Product Notes",hideNotes:"Product Notes",showIncludes:"Product Includes",hideIncludes:"Product Includes",showSuggestions:"Suggested Products",hideSuggestions:"Suggested Products",loading:"Loading..."}},t),this.initialized=!1,this.init()}),[{key:"init",value:function(){var e=this;this.initialized?we.log("Already initialized, skipping"):("loading"===document.readyState?document.addEventListener("DOMContentLoaded",(function(){return e.setup()})):this.setup(),document.addEventListener("product_estimator_modal_loaded",(function(){we.log("Modal content loaded, initializing toggles"),e.setup()})),this.setupMutationObserver(),this.initialized=!0,we.log("ProductDetailsToggle initialized"))}},{key:"prepareSuggestionsToggle",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.accordionContent);we.log("Found ".concat(t.length," accordion content elements to process for suggestions toggle")),t.forEach((function(t){if(!t.classList.contains("suggestions-toggle-processed")){var o=t.querySelector(e.config.selectors.productSuggestions);if(o){we.log("Found suggestions section, processing",o),t.classList.add("has-suggestions");var i=t.querySelector(e.config.selectors.suggestionsContainer);if(!i){if(we.log("Creating new suggestions container"),(i=document.createElement("div")).className="suggestions-container visible",o.parentNode!==i){var r=o.cloneNode(!0);i.appendChild(r),o.parentNode.removeChild(o)}t.appendChild(i)}var a=t.querySelector(e.config.selectors.suggestionsToggleButton);a||(we.log("Adding suggestions toggle button to accordion content"),(a=document.createElement("button")).className="product-suggestions-toggle expanded",a.setAttribute("data-toggle-type","suggestions"),a.innerHTML="\n        ".concat(e.config.i18n.hideSuggestions,'\n        <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n      '),t.insertBefore(a,i)),i.style.display="block",i.classList.add("visible"),t.classList.add("suggestions-toggle-processed"),we.log("Accordion content processed for suggestions toggle")}else we.log("No suggestions section found for accordion content, skipping",t)}}))}},{key:"setupMutationObserver",value:function(){var e=this;new MutationObserver((function(t){var o=!1;t.forEach((function(t){t.addedNodes.length&&Array.from(t.addedNodes).forEach((function(t){t.nodeType===Node.ELEMENT_NODE&&(t.matches(e.config.selectors.productItem)||t.matches(e.config.selectors.productToggleButton)||t.matches(e.config.selectors.notesToggleButton)||t.querySelector(e.config.selectors.productItem)||t.querySelector(e.config.selectors.productToggleButton)||t.querySelector(e.config.selectors.notesToggleButton))&&(o=!0)}))})),o&&(we.log("New toggle-related content detected, re-initializing"),setTimeout((function(){return e.setup()}),100))})).observe(document.body,{childList:!0,subtree:!0}),we.log("Mutation observer set up")}},{key:"setup",value:function(){we.log("Setting up product details toggles"),this.prepareProductsToggle(),this.prepareNotesToggle(),this.prepareIncludesToggle(),this.prepareSuggestionsToggle(),this.bindEvents(),this.initializeAllCarousels()}},{key:"prepareProductsToggle",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.productItem);we.log("Found ".concat(t.length," product items to process for similar products toggle")),t.forEach((function(t){t.classList.contains("products-toggle-processed")||(t.querySelector(e.config.selectors.similarProducts)?(t.classList.add("has-similar-products"),t.querySelector(e.config.selectors.similarProductsContainer),t.querySelector(e.config.selectors.productToggleButton),t.classList.add("products-toggle-processed"),we.log("Product item processed for similar products toggle (visibility managed elsewhere).")):t.classList.add("products-toggle-processed"))}))}},{key:"prepareNotesToggle",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.productItem);we.log("Found ".concat(t.length," product items to process for notes toggle")),t.forEach((function(t){if(!t.classList.contains("notes-toggle-processed")){var o=t.querySelector(e.config.selectors.productNotes);if(o){var i=!1,r=o.querySelectorAll(".product-note-item");if(r&&r.length>0&&(i=!0),t.dataset.additionalNotes)try{var a=JSON.parse(t.dataset.additionalNotes);Array.isArray(a)&&a.length>0&&a.some((function(e){return e&&(e.note_text||e.text)}))&&(i=!0)}catch(e){}if(o.querySelector(".product-notes-items")&&""!==o.querySelector(".product-notes-items").textContent.trim()&&(i=!0),!i){we.log("No valid notes found for product, skipping",t),t.classList.add("notes-toggle-processed");var n=t.querySelector(e.config.selectors.notesToggleButton),s=t.querySelector(e.config.selectors.notesContainer);return n&&(n.style.display="none"),void(s&&(s.style.display="none"))}we.log("Found notes section with content, processing",o),t.classList.add("has-notes");var c=t.querySelector(e.config.selectors.notesContainer);if(!c){if(we.log("Creating new notes container"),(c=document.createElement("div")).className="notes-container visible",o.parentNode!==c){var l=o.cloneNode(!0);c.appendChild(l),o.parentNode.removeChild(o)}t.appendChild(c)}var d=t.querySelector(e.config.selectors.notesToggleButton);if(d){d.classList.add("expanded");var u=d.querySelector(".toggle-icon");u&&(u.classList.remove("dashicons-arrow-down-alt2"),u.classList.add("dashicons-arrow-up-alt2"))}else we.log("Adding notes toggle button to product item"),(d=document.createElement("button")).className="product-notes-toggle expanded",d.setAttribute("data-toggle-type","notes"),d.innerHTML="\n      ".concat(e.config.i18n.hideNotes,'\n      <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n    '),t.insertBefore(d,c);c.style.display="block",c.classList.add("visible"),t.classList.add("notes-toggle-processed"),we.log("Product item processed for notes toggle")}else we.log("No notes section found for product item, skipping",t)}}))}},{key:"bindEvents",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.productToggleButton);we.log("Found ".concat(t.length," similar products toggle buttons to bind")),t.forEach((function(t){t._toggleBound||(t._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),e.toggleSimilarProducts(t)},t.addEventListener("click",t._toggleHandler),t._toggleBound=!0)}));var o=document.querySelectorAll(this.config.selectors.notesToggleButton);we.log("Found ".concat(o.length," notes toggle buttons to bind")),o.forEach((function(t){t._toggleBound||(t._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),e.toggleNotes(t)},t.addEventListener("click",t._toggleHandler),t._toggleBound=!0)}));var i=document.querySelectorAll(this.config.selectors.includesToggleButton);we.log("Found ".concat(i.length," includes toggle buttons to bind")),i.forEach((function(t){t._toggleBound||(t._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),e.toggleIncludes(t)},t.addEventListener("click",t._toggleHandler),t._toggleBound=!0)}));var r=document.querySelectorAll(this.config.selectors.suggestionsToggleButton);we.log("Found ".concat(r.length," suggestions toggle buttons to bind")),r.forEach((function(t){t._toggleBound||(t._toggleHandler=function(o){o.preventDefault(),o.stopPropagation(),e.toggleSuggestions(t)},t.addEventListener("click",t._toggleHandler),t._toggleBound=!0)})),we.log("All toggle events bound")}},{key:"toggleSuggestions",value:function(e){var t=e.closest(this.config.selectors.accordionContent);if(t){var o=t.querySelector(this.config.selectors.suggestionsContainer);if(o){var i=e.classList.contains("expanded");if(we.log("Suggestions toggle clicked, current expanded state: ".concat(i)),i){o.classList.remove("visible"),o.style.display="none",e.classList.remove("expanded");var r=e.querySelector(".toggle-icon");r&&(r.classList.remove("dashicons-arrow-up-alt2"),r.classList.add("dashicons-arrow-down-alt2")),e.innerHTML=e.innerHTML.replace(this.config.i18n.hideSuggestions,this.config.i18n.showSuggestions),we.log("Suggestions hidden")}else{o.classList.add("visible"),o.style.display="block",e.classList.add("expanded");var a=e.querySelector(".toggle-icon");a&&(a.classList.remove("dashicons-arrow-down-alt2"),a.classList.add("dashicons-arrow-up-alt2")),e.innerHTML=e.innerHTML.replace(this.config.i18n.showSuggestions,this.config.i18n.hideSuggestions),this.initializeCarousels(o),we.log("Suggestions shown")}}else we.log("Suggestions container not found")}else we.log("Accordion content not found for toggle button")}},{key:"toggleSimilarProducts",value:function(e){var t=e.closest(this.config.selectors.productItem);if(t){var o=t.querySelector(this.config.selectors.similarProductsContainer);if(o){var i=e.classList.contains("expanded");we.log("Similar products toggle clicked, current expanded state: ".concat(i));var r=e.querySelector(".toggle-icon");i?(o.classList.remove("visible"),o.style.display="none",e.classList.remove("expanded"),r&&(r.classList.remove("dashicons-arrow-up-alt2"),r.classList.add("dashicons-arrow-down-alt2")),we.log("Similar products hidden")):(o.classList.add("visible"),o.style.display="block",e.classList.add("expanded"),r&&(r.classList.remove("dashicons-arrow-down-alt2"),r.classList.add("dashicons-arrow-up-alt2")),we.log("Similar products shown"),this.initializeCarousels(o))}else we.log("Similar products container not found")}else we.log("Product item not found for toggle button")}},{key:"toggleNotes",value:function(e){var t=e.closest(this.config.selectors.productItem);if(t){var o=t.querySelector(this.config.selectors.notesContainer);if(o){var i=e.classList.contains("expanded");we.log("Notes toggle clicked, current expanded state: ".concat(i));var r=e.querySelector(".toggle-icon");i?(o.classList.remove("visible"),o.style.display="none",e.classList.remove("expanded"),r&&(r.classList.remove("dashicons-arrow-up-alt2"),r.classList.add("dashicons-arrow-down-alt2")),we.log("Notes hidden")):(o.classList.add("visible"),o.style.display="block",e.classList.add("expanded"),r&&(r.classList.remove("dashicons-arrow-down-alt2"),r.classList.add("dashicons-arrow-up-alt2")),we.log("Notes shown"))}else we.log("Notes container not found")}else we.log("Product item not found for notes toggle button")}},{key:"initializeCarousels",value:function(e){"function"==typeof window.initSuggestionsCarousels?(we.log("Initializing carousels in similar products container"),window.initSuggestionsCarousels()):"function"==typeof initSuggestionsCarousels?(we.log("Using local initSuggestionsCarousels function"),initSuggestionsCarousels()):we.log("Carousel initialization function not found",window.initSuggestionsCarousels)}},{key:"initializeAllCarousels",value:function(){"function"==typeof window.initSuggestionsCarousels?(we.log("Initializing all carousels"),window.initSuggestionsCarousels()):"function"==typeof initSuggestionsCarousels&&initSuggestionsCarousels()}},{key:"prepareIncludesToggle",value:function(){var e=this,t=document.querySelectorAll(this.config.selectors.productItem);we.log("Found ".concat(t.length," product items to process for includes toggle")),t.forEach((function(t){if(!t.classList.contains("includes-toggle-processed")){var o=t.querySelector(e.config.selectors.productIncludes);if(o){we.log("Found includes section, processing",o),t.classList.add("has-includes");var i=t.querySelector(".includes-container");if(!i){if(we.log("Creating new includes container"),(i=document.createElement("div")).className="includes-container visible",o.parentNode!==i){var r=o.cloneNode(!0);i.appendChild(r),o.parentNode.removeChild(o)}t.appendChild(i)}var a=t.querySelector(".product-includes-toggle");if(a){a.classList.add("expanded");var n=a.querySelector(".toggle-icon");n&&(n.classList.remove("dashicons-arrow-down-alt2"),n.classList.add("dashicons-arrow-up-alt2"))}else we.log("Adding includes toggle button to product item"),(a=document.createElement("button")).className="product-includes-toggle expanded",a.setAttribute("data-toggle-type","includes"),a.innerHTML="\n        ".concat(e.config.i18n.hideIncludes||"Product Includes",'\n        <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span>\n      '),t.insertBefore(a,i);i.style.display="block",i.classList.add("visible"),t.classList.add("includes-toggle-processed"),we.log("Product item processed for includes toggle")}else we.log("No includes section found for product item, skipping",t)}}))}},{key:"toggleIncludes",value:function(e){var t=e.closest(this.config.selectors.productItem);if(t){var o=t.querySelector(".includes-container");if(o){var i=e.classList.contains("expanded");we.log("Includes toggle clicked, current expanded state: ".concat(i));var r=e.querySelector(".toggle-icon");i?(o.classList.remove("visible"),o.style.display="none",e.classList.remove("expanded"),r&&(r.classList.remove("dashicons-arrow-up-alt2"),r.classList.add("dashicons-arrow-down-alt2")),we.log("Includes hidden")):(o.classList.add("visible"),o.style.display="block",e.classList.add("expanded"),r&&(r.classList.remove("dashicons-arrow-down-alt2"),r.classList.add("dashicons-arrow-up-alt2")),we.log("Includes shown"))}else we.log("Includes container not found")}else we.log("Product item not found for includes toggle button")}}])}())({debug:(null===(ge=window.productEstimatorVars)||void 0===ge?void 0:ge.debug)||!1,i18n:{showProducts:(null===(pe=window.productEstimatorVars)||void 0===pe||null===(pe=pe.i18n)||void 0===pe?void 0:pe.showSimilarProducts)||"Similar Products",hideProducts:(null===(he=window.productEstimatorVars)||void 0===he||null===(he=he.i18n)||void 0===he?void 0:he.hideSimilarProducts)||"Similar Products",showNotes:(null===(fe=window.productEstimatorVars)||void 0===fe||null===(fe=fe.i18n)||void 0===fe?void 0:fe.showNotes)||"Product Notes",hideNotes:(null===(ve=window.productEstimatorVars)||void 0===ve||null===(ve=ve.i18n)||void 0===ve?void 0:ve.hideNotes)||"Product Notes",loading:(null===(ye=window.productEstimatorVars)||void 0===ye||null===(ye=ye.i18n)||void 0===ye?void 0:ye.loading)||"Loading..."}});function Ee(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,i)}return o}var Se=L("PrintEstimate"),_e=function(){return c((function e(){var t,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1?arguments[1]:void 0;r(this,e),this.config=Object.assign({debug:!1,selectors:{printButton:".print-estimate, .print-estimate-pdf",requestContactButton:".request-contact-estimate",requestCopyButton:".request-a-copy",scheduleDesignerButton:".schedule-designer-estimate"},i18n:(null===(t=window.productEstimatorVars)||void 0===t?void 0:t.i18n)||{}},o),this.dataService=i,this.initialized=!1,this.processing=!1,this.customerDetails=J(),!1!==o.autoInit&&this.init()}),[{key:"init",value:function(){return this.initialized?(Se.log("PrintEstimate already initialized"),this):(this.bindEvents(),this.initialized=!0,Se.log("PrintEstimate initialized"),this)}},{key:"bindEvents",value:function(){var e=this;Se.log("Binding print events"),document.addEventListener("click",(function(t){Se.log("Document click event triggered");var o=t.target.closest(e.config.selectors.printButton);if(o)if(Se.log("Print button clicked or is ancestor of click target"),o&&!e.processing)if(Se.log("Print button is active and not processing"),t.preventDefault(),e.processing=!0,e.setButtonLoading(o,!0),o.classList.contains("print-estimate-pdf")){Se.log("Handling direct PDF link");var i=o.dataset.estimateId;e.checkCustomerDetails(i).then((function(t){var r=[];if(t.name&&""!==t.name.trim()||r.push("name"),t.email&&""!==t.email.trim()||r.push("email"),0===r.length){var a=o.getAttribute("href");a&&"#"!==a&&"javascript:void(0)"!==a?(Se.log("Opening PDF URL from href:",a),window.open(a,"_blank")):(Se.log("href is missing or invalid, getting secure PDF URL"),e.getSecurePdfUrl(i).then((function(e){Se.log("Opening secure PDF URL:",e),window.open(e,"_blank")})).catch((function(t){e.showError("Error generating PDF URL. Please try again.")})))}else Se.log("Missing required customer details for PDF link:",r),e.showCustomerDetailsPrompt(i,o,"print")})).catch((function(t){e.showError("Error checking customer details. Please try again.")})).finally((function(){}))}else Se.log("Handling JS-based print button"),e.handlePrintEstimate(o);else e.processing&&Se.log("Print button clicked but processing is true, ignoring.")})),document.addEventListener("click",(function(t){var o=t.target.closest(e.config.selectors.requestCopyButton);if(o&&!e.processing){Se.log("Request copy button clicked"),t.preventDefault(),e.processing=!0,e.setButtonLoading(o,!0);var i=o.dataset.estimateId;e.showContactSelectionPrompt(i,o,"request_copy")}})),document.addEventListener("click",(function(t){var o=t.target.closest(e.config.selectors.requestContactButton);if(o&&!e.processing){Se.log("Request contact button clicked"),t.preventDefault(),e.processing=!0,e.setButtonLoading(o,!0);var i=o.dataset.estimateId;e.showContactSelectionPrompt(i,o,"request_contact")}}))}},{key:"handlePrintEstimate",value:function(e){var t=this;Se.log("handlePrintEstimate called");var o=e.dataset.estimateId;if(!o)return this.showError("No estimate ID provided"),this.setButtonLoading(e,!1),void(this.processing=!1);Se.log("Print estimate requested for estimate ID: ".concat(o)),this.checkCustomerDetails(o).then((function(i){var r=[];return i.name&&""!==i.name.trim()||r.push("name"),i.email&&""!==i.email.trim()||r.push("email"),0===r.length?(Se.log("Customer has required details, proceeding to store estimate"),t.storeEstimate(o).then((function(e){if(e&&e.estimate_id)return Se.log("Estimate stored, getting secure PDF URL"),t.getSecurePdfUrl(e.estimate_id);throw new Error("Failed to store estimate")})).then((function(o){Se.log("Received PDF URL, opening:",o),t.setButtonLoading(e,!1),t.processing=!1,window.open(o,"_blank")}))):(Se.log("Missing required customer details for JS print:",r),t.showCustomerDetailsPrompt(o,e,"print"),Promise.reject(new Error("missing_customer_details")))})).catch((function(o){"missing_customer_details"!==o.message&&(t.showError("Error generating PDF. Please try again."),t.setButtonLoading(e,!1),t.processing=!1)}))}},{key:"showCustomerDetailsPrompt",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"print";Se.log("showCustomerDetailsPrompt called");var r=this.getMissingFields(this.customerDetails,i);if(0===r.length)return Se.log("No missing fields, continuing with action:",i),void this.continueWithAction(i,e,t,this.customerDetails);Se.log("Missing fields detected, showing prompt modal:",r);var a=this.createPromptModalHtml(r,i,this.customerDetails),n=document.createElement("div");n.className="email-prompt-modal",n.innerHTML=a,document.body.appendChild(n);var s=n.querySelector(".cancel-email-btn"),c=n.querySelector(".submit-email-btn"),l=n.querySelector(".email-validation-message");s.addEventListener("click",(function(){Se.log("Prompt modal cancelled"),n.remove(),o.setButtonLoading(t,!1),o.processing=!1})),c.addEventListener("click",(function(){Se.log("Prompt modal submit clicked");var a=function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?Ee(Object(o),!0).forEach((function(t){m(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):Ee(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}({},o.customerDetails),s=!0;r.forEach((function(e){var t=n.querySelector("#customer-".concat(e,"-input")),i=t?t.value.trim():"";return i?"email"!==e||o.validateEmail(i)?"phone"!==e||o.validatePhone(i)?void(a[e]=i):(l.textContent="Please enter a valid phone number",void(s=!1)):(l.textContent="Please enter a valid email address",void(s=!1)):(l.textContent="".concat(o.getFieldLabel(e)," is required"),void(s=!1))})),s?(Se.log("Prompt modal validation successful, saving details:",a),c.disabled=!0,c.textContent="Saving...",o.updateCustomerDetails(e,a).then((function(){Se.log("Details saved successfully after prompt"),n.remove(),o.setButtonLoading(t,!0),o.processing=!0,o.continueWithAction(i,e,t,a)})).catch((function(e){Se.log("Error saving details after prompt:",e),l.textContent="Error saving details. Please try again.",c.disabled=!1,c.textContent="Continue"}))):Se.log("Prompt modal validation failed")})),setTimeout((function(){var e=n.querySelector("input");e&&(e.focus(),n.querySelectorAll("input").forEach((function(e){e.addEventListener("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),c.click())}))})))}),100)}},{key:"getMissingFields",value:function(e,t){var o={print:["name","email"],request_copy_email:["name","email"],request_copy_sms:["name","phone"],request_contact_email:["name","email"],request_contact_phone:["name","phone"]};return(o[t]||o.print).filter((function(t){return!e||!e[t]||""===e[t].trim()}))}},{key:"getFieldLabel",value:function(e){return{name:"Full Name",email:"Email Address",phone:"Phone Number"}[e]||e.charAt(0).toUpperCase()+e.slice(1)}},{key:"createPromptModalHtml",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r="Additional information is required to continue.";"request_copy_email"===t?r="An email address is required to send your estimate copy.":"request_copy_sms"===t?r="A phone number is required to send your estimate via SMS.":"request_contact_email"===t?r="Your details are required for our store to contact you via email.":"request_contact_phone"===t?r="Your details are required for our store to contact you via phone.":e.includes("email")&&!e.includes("name")&&(r="An email address is required to view your estimate.");var a='\n      <div class="email-prompt-overlay"></div>\n      <div class="email-prompt-container">\n        <div class="email-prompt-header">\n          <h3>'.concat("Please Complete Your Details",'</h3>\n        </div>\n        <div class="email-prompt-body">\n          <p>').concat(r,"</p>\n    ");return e.forEach((function(e){var t=o.getFieldLabel(e),r=i[e]||"",n="email"===e?"email":"phone"===e?"tel":"text";a+='\n        <div class="form-group">\n          <label for="customer-'.concat(e,'-input">').concat(t,':</label>\n          <input type="').concat(n,'" id="customer-').concat(e,'-input" value="').concat(r,'" required>\n        </div>\n      ')})),a+='\n          <div class="email-validation-message"></div>\n        </div>\n        <div class="email-prompt-footer">\n          <button type="button" class="button cancel-email-btn">Cancel</button>\n          <button type="button" class="button submit-email-btn">Continue</button>\n        </div>\n      </div>\n    '}},{key:"validateEmail",value:function(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}},{key:"validatePhone",value:function(e){return/^[\d\s()+\-]{8,}$/.test(e)}},{key:"continueWithAction",value:function(e,t,o,i){var r=this;switch(Se.log("continueWithAction called:",e),e){case"print":this.handlePrintEstimate(o);break;case"request_copy_email":this.requestCopyEstimate(t,o).then((function(e){r.showMessage("Estimate has been emailed to ".concat(i.email),"success",(function(){r.setButtonLoading(o,!1),r.processing=!1}))})).catch((function(e){r.showError("Error sending estimate copy. Please try again."),r.setButtonLoading(o,!1),r.processing=!1}));break;case"request_copy_sms":this.showMessage("SMS option coming soon.","success"),this.setButtonLoading(o,!1),this.processing=!1;break;case"request_contact_email":this.requestStoreContact(t,"email",o,i);break;case"request_contact_phone":this.requestStoreContact(t,"phone",o,i)}}},{key:"showContactSelectionPrompt",value:function(e,t){var o=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"request_copy";Se.log("showContactSelectionPrompt called:",i);var r="How would you like to receive your estimate?",a="Please choose how you'd prefer to receive your estimate:",n="Email",s="SMS";"request_contact"===i&&(r="How would you like to be contacted?",a="Please choose how you'd prefer our store to contact you:",n="Email",s="Phone");var c='\n    <div class="email-prompt-overlay"></div>\n    <div class="email-prompt-container">\n      <div class="email-prompt-header">\n        <h3>'.concat(r,'</h3>\n      </div>\n      <div class="email-prompt-body">\n        <p>').concat(a,'</p>\n      </div>\n      <div class="email-prompt-footer">\n        <button type="button" class="button cancel-email-btn">Cancel</button>\n        <button type="button" class="button submit-email-btn email-choice">').concat(n,'</button>\n        <button type="button" class="button submit-email-btn sms-choice">').concat(s,"</button>\n      </div>\n    </div>\n  "),l=document.createElement("div");l.className="email-prompt-modal",l.innerHTML=c,document.body.appendChild(l);var d=l.querySelector(".cancel-email-btn"),u=l.querySelector(".email-choice"),m=l.querySelector(".sms-choice");d.addEventListener("click",(function(){Se.log("Contact selection cancelled"),o.setButtonLoading(t,!1),o.processing=!1,l.remove()})),u.addEventListener("click",(function(){Se.log("Email contact method selected"),l.remove();var r="request_contact"===i?"request_contact_email":"request_copy_email",a=J(),n=[];a.name&&""!==a.name.trim()||n.push("name"),a.email&&""!==a.email.trim()||n.push("email"),0===n.length?(Se.log("Required details for email contact exist, proceeding"),"request_contact"===i?o.requestStoreContact(e,"email",t,a):o.requestCopyEstimate(e,t).then((function(e){o.showMessage("Estimate has been emailed to ".concat(a.email),"success",(function(){o.setButtonLoading(t,!1),o.processing=!1}))})).catch((function(){o.showError("Error sending estimate copy. Please try again."),o.setButtonLoading(t,!1),o.processing=!1}))):(Se.log("Missing details for email contact, showing prompt:",n),o.showCustomerDetailsPrompt(e,t,r))})),m.addEventListener("click",(function(){Se.log("Phone contact method selected"),l.remove();var r="request_contact"===i?"request_contact_phone":"request_copy_sms",a=J(),n=[];a.name&&""!==a.name.trim()||n.push("name"),a.phone&&""!==a.phone.trim()||n.push("phone"),0===n.length?(Se.log("Required details for phone contact exist, proceeding"),"request_contact"===i?o.requestStoreContact(e,"phone",t,a):(o.showMessage("SMS option coming soon.","success"),o.setButtonLoading(t,!1),o.processing=!1)):(Se.log("Missing details for phone contact, showing prompt:",n),o.showCustomerDetailsPrompt(e,t,r))}))}},{key:"requestStoreContact",value:function(e,t,o,i){var r=this;Se.log("requestStoreContact called:",{estimateId:e,contactMethod:t,customerDetails:i}),this.storeEstimate(e).then((function(o){if(!o||!o.estimate_id)throw new Error("Failed to store estimate");var a={estimate_id:e,contact_method:t,customer_details:JSON.stringify(i)};return Se.log("Sending store contact request with data:",a),r.dataService.request("request_store_contact",a)})).then((function(e){Se.log("Store contact request successful:",e);var o;o="email"===t?"Your request has been sent. Our store will contact you at ".concat(i.email," shortly."):"Your request has been sent. Our store will call you at ".concat(i.phone," shortly."),r.showMessage(o,"success")})).catch((function(e){Se.log("Error in requestStoreContact:",e),r.showError("Error sending contact request. Please try again.")})).finally((function(){r.setButtonLoading(o,!1),r.processing=!1}))}},{key:"checkCustomerDetails",value:function(e){var t=this;return Se.log("checkCustomerDetails called for estimate:",e),new Promise((function(o,i){var r=J();if(r&&r.name&&r.email)return t.customerDetails=r,Se.log("Customer details found in local storage."),void o(t.customerDetails);Se.log("Customer details not fully available in local storage, fetching from server."),t.dataService.request("check_customer_details",{estimate_id:e}).then((function(e){Se.log("Customer details check result from server:",e),e&&e.customer_details?($(e.customer_details),t.customerDetails=J(),o(t.customerDetails)):(Se.log("Server check succeeded but no customer details returned."),$({}),t.customerDetails={},o(t.customerDetails))})).catch((function(e){Se.log("Error fetching customer details from server:",e),t.customerDetails={},o(t.customerDetails)}))}))}},{key:"updateCustomerDetails",value:function(e,t){var o=this;return Se.log("updateCustomerDetails called:",{estimateId:e,details:t}),new Promise((function(i,r){t.postcode||(t.postcode="0000"),o.dataService.request("update_customer_details",{details:JSON.stringify(t)}).then((function(i){Se.log("Server update_customer_details successful:",i);var r=new CustomEvent("customer_details_updated",{bubbles:!0,detail:{details:t}});return document.dispatchEvent(r),o.dataService.request("store_single_estimate",{estimate_id:e})})).then((function(e){Se.log("Server store_single_estimate successful:",e),$(t),o.customerDetails=t,i(e)})).catch((function(e){Se.error("Error in updateCustomerDetails AJAX chain:",e),r(e)}))}))}},{key:"storeEstimate",value:function(e){return Se.log("storeEstimate called:",e),this.dataService.request("store_single_estimate",{estimate_id:e})}},{key:"getSecurePdfUrl",value:function(e){return Se.log("getSecurePdfUrl called:",e),this.dataService.request("get_secure_pdf_url",{estimate_id:e}).then((function(e){if(e&&e.url)return Se.log("Received secure PDF URL:",e),e.url;throw new Error("Failed to get secure PDF URL")}))}},{key:"requestCopyEstimate",value:function(e,t){var o=this;return Se.log("requestCopyEstimate called:",e),J().email?this.storeEstimate(e).then((function(t){if(!t||!t.estimate_id)throw new Error("Failed to store estimate");return o.dataService.request("request_copy_estimate",{estimate_id:e})})).catch((function(e){var t;throw"no_email"===(null===(t=e.data)||void 0===t?void 0:t.code)?(Se.log("Server returned no_email error for requestCopyEstimate"),new Error("no_email")):(Se.log("Error requesting estimate copy:",e),e)})):(Se.log("No email found for requestCopyEstimate"),Promise.reject(new Error("no_email")))}},{key:"setButtonLoading",value:function(e,t){if(Se.log("setButtonLoading called:",{button:(null==e?void 0:e.id)||(null==e?void 0:e.className),isLoading:t}),e){var o=e.dataset.originalText||e.textContent;t?(e.dataset.originalText||(e.dataset.originalText=e.textContent),e.classList.add("loading"),e.innerHTML='<span class="loading-dots">Processing...</span>',e.disabled=!0):(e.classList.remove("loading"),e.textContent=o,e.disabled=!1)}else Se.log("setButtonLoading called with null button")}},{key:"showMessage",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"success",o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;Se.log("showMessage called:",{message:e,type:t}),window.productEstimator&&window.productEstimator.dialog?window.productEstimator.dialog.show({title:"success"===t?"Success":"Error",message:e,type:"estimate",action:"confirm",confirmText:this.config.i18n.confirm||"OK",cancelText:null,onConfirm:function(){"function"==typeof o&&o()}}):(alert(e),"function"==typeof o&&o())}},{key:"showError",value:function(e){Se.log("showError called:",e),window.productEstimator&&window.productEstimator.core&&"function"==typeof window.productEstimator.core.showError?window.productEstimator.core.showError(e):alert(e)}}])}();const Le=_e,Pe=`<template id="product-item-template"> <div class="product-item" data-product-index="" data-product-id=""> <div class="product-wrapper"> <img src="${new URL(o(201),o.b)}" alt="Product" class="product-thumbnail"> <div class="product-details-wrapper"> <div class="product-details"> <div class="price-graph-container"> <div class="price-range-title"> <span class="price-title"></span> <span class="price-dimensions"></span> <span class="product-price"></span> </div> <div class="price-graph-bar"> <div class="price-graph-range"></div> </div> <div class="price-graph-labels"></div> </div> <button class="remove-product" data-estimate-id="" data-room-id="" data-product-index="" data-product-id=""> <span class="dashicons dashicons-trash"></span> </button> </div> </div> </div> <button class="product-includes-toggle expanded"> <span>Product Includes</span> <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span> </button> <div class="includes-container visible"> <div class="product-includes"> <div class="product-includes-items"></div> </div> </div> <button class="product-notes-toggle expanded"> <span>Product Notes</span> <span class="toggle-icon dashicons dashicons-arrow-up-alt2"></span> </button> <div class="notes-container visible"> <div class="product-notes"> <div class="product-notes-items"></div> </div> </div> <div class="product-upgrades-container" style="display:none"> <button class="product-details-toggle product-upgrades-toggle"> <span>Product Upgrades</span> <span class="toggle-icon dashicons dashicons-arrow-down-alt2"></span> </button> <div class="product-upgrades"> <div class="product-upgrades-list"></div> </div> </div> <button class="product-details-toggle similar-products-toggle"> <span>Similar Products</span> <span class="toggle-icon dashicons dashicons-arrow-down-alt2"></span> </button> <div class="similar-products-container" style="display:none" data-product-id=""> <div class="product-similar-products"> <div class="suggestions-carousel similar-products-carousel"> <div class="suggestions-nav prev" aria-label="Previous"> <span class="dashicons dashicons-arrow-left-alt2"></span> </div> <div class="suggestions-container similar-products-list"> </div> <div class="suggestions-nav next" aria-label="Next"> <span class="dashicons dashicons-arrow-right-alt2"></span> </div> </div> </div> </div> </div> </template> `,Ie=`<template id="suggestion-item-template"> <div class="suggestion-item"> <div class="suggestion-image"> <img src="${new URL(o(201),o.b)}" alt="" class="suggestion-img product-img"> </div> <div class="suggestion-details"> <div class="suggestion-name product-name"></div> <div class="suggestion-price product-price"></div> <div class="suggestion-actions"> <button type="button" class="add-suggestion-to-room" data-product-id="" data-estimate-id="" data-room-id=""> Add </button> </div> </div> </div> </template> `,ke=`<template id="similar-product-item-template"> <div class="suggestion-item similar-product-item" data-product-id="" data-estimate-id="" data-room-id="" data-replace-product-id="" data-pricing-method=""> <div class="suggestion-image"> <img src="${new URL(o(201),o.b)}" alt="Similar Product Image" class="similar-product-thumbnail product-img"> <div class="no-image" style="display:none"></div> </div> <div class="suggestion-details"> <div class="suggestion-name product-name"></div> <div class="suggestion-price product-price"></div> <div class="suggestion-actions"> <button type="button" class="replace-product-in-room" data-product-id="" data-estimate-id="" data-room-id="" data-replace-product-id="" data-pricing-method=""> Replace </button> </div> </div> </div> </template> `,Ce=`<template id="product-upgrade-item-template"> <div class="upgrade-tile"> <img src="${new URL(o(201),o.b)}" alt="" class="tile-image product-img"> <span class="tile-label product-name"></span> <div class="upgrade-price product-price"></div> <button type="button" class="replace-product-in-room" data-product-id="" data-estimate-id="" data-room-id="" data-replace-product-id="" data-pricing-method="" data-replace-type=""> Upgrade </button> </div> </template> `;var De=L("TemplateLoader"),qe={"product-item-template":Pe,"room-item-template":'<template id="room-item-template"> <div class="accordion-item" data-room-id="" data-estimate-id=""> <div class="accordion-header-wrapper"> <button class="accordion-header"> <div class="price-graph-container"> <div class="price-range-title"> <span class="price-title room-name"></span> <span class="price-dimensions"></span> <span class="room-price"></span> </div> <div class="price-graph-bar"> <div class="price-graph-range"></div> </div> <div class="price-graph-labels"></div> </div> </button> <button class="remove-room" data-estimate-id="" data-room-id="" title="Remove Room"> <span class="dashicons dashicons-trash"></span> </button> </div> <div class="accordion-content"> <div class="room-products"> <h5>Products</h5> <div class="product-list"></div> </div> <div class="product-suggestions" style="display:none"> <button class="product-suggestions-toggle"> Suggested Products <span class="toggle-icon dashicons dashicons-arrow-down-alt2"></span> </button> <div class="suggestions-container-wrapper"> <div class="suggestions-carousel"> <div class="suggestions-nav prev" aria-label="Previous Suggestions">&#10094;</div> <div class="suggestions-container"> </div> <div class="suggestions-nav next" aria-label="Next Suggestions">&#10095;</div> </div> </div> </div> </div> </div> </template> ',"estimate-item-template":'<template id="estimate-item-template"> <div class="estimate-section collapsed" data-estimate-id=""> <div class="estimate-header"> <h3 class="estimate-name"> <div class="price-graph-container"> <div class="price-range-title"> <span class="price-title name"></span> <span class="estimate-price min_total max_total"></span> </div> <div class="price-graph-bar"> <div class="price-graph-range"></div> </div> <div class="price-graph-labels"></div> </div> </h3> <button class="remove-estimate" data-estimate-id="" title="Delete Estimate"> <span class="dashicons dashicons-trash"></span> </button> </div> <div class="estimate-content"> <div id="rooms"> <div class="room-header"> <h4>Rooms</h4> <button class="add-room" data-estimate-id="">Add New Room</button> </div> <div class="rooms-container"></div> </div> </div> <div class="estimate-actions"> <ul> <li> <a class="print-estimate" data-estimate-id="" title="Print Estimate"> <span class="dashicons dashicons-pdf"></span> Print estimate </a> </li> <li> <a class="request-contact-estimate" data-estimate-id="" title="Request contact from store"> <span class="dashicons dashicons-businessperson"></span> Request contact from store </a> </li> <li> <a class="request-a-copy" data-estimate-id="" title="Request a copy"> <span class="dashicons dashicons-email"></span> Request a copy </a> </li> </ul> </div> </div> </template> ',"suggestion-item-template":Ie,"note-item-template":'<template id="note-item-template"> <div class="include-item note-item"> <span class="product-includes-icon"> <span class="dashicons dashicons-sticky"></span> </span> <div class="include-item-note"> <p class="note-text">r</p> </div> </div> </template> ',"include-item-template":'<template id="include-item-template"> <div class="include-item" data-product-id=""> <span class="product-includes-icon"> <span class="dashicons dashicons-plus-alt"></span> </span> <div class="include-item-name product-name"></div> <div class="include-item-prices"> <div class="include-item-total-price product-price"> </div> </div> <div class="product-upgrades-container" style="display:none"> <div class="product-upgrades-list"> </div> </div> </div> </template> ',"similar-product-item-template":ke,"product-upgrade-item-template":Ce,"new-estimate-form-template":'<template id="new-estimate-form-template"> <div id="new-estimate-form-wrapper"> <h2>Create New Estimate</h2> <form id="new-estimate-form" method="post" data-has-email="false"> <div class="form-group"> <label for="estimate-name">Estimate Name</label> <input type="text" id="estimate-name" name="estimate_name" placeholder="e.g. Home Renovation" required> </div> <div class="customer-details-section"> <h4>Your Details</h4> <div class="form-group"> <label for="customer-postcode">Postcode</label> <input type="text" id="customer-postcode" name="customer_postcode" placeholder="Your postcode" required> </div> </div> <div class="button-group"> <button type="submit" class="submit-btn">Create Estimate</button> <button type="button" class="cancel-btn" data-form-type="estimate">Cancel</button> </div> </form> </div> </template> ',"new-room-form-template":'<template id="new-room-form-template"> <div id="new-room-form-wrapper"> <h2>Add New Room</h2> <form id="new-room-form" method="post" data-estimate-id="" data-product-id=""> <div class="form-group"> <label for="room-name">Room Name</label> <input type="text" id="room-name" name="room_name" placeholder="e.g. Living Room" required> </div> <div class="inline-group"> <div class="form-group"> <label for="room-width">Width (m)</label> <input type="number" id="room-width" name="room_width" placeholder="Width" required step="0.01" min="0.1"> </div> <div class="form-group"> <label for="room-length">Length (m)</label> <input type="number" id="room-length" name="room_length" placeholder="Length" required step="0.01" min="0.1"> </div> </div> <div class="button-group"> <button type="submit" class="submit-btn">Add Room</button> <button type="button" class="cancel-btn" data-form-type="room">Cancel</button> </div> </form> </div> </template> ',"room-selection-form-template":'<template id="room-selection-form-template"> <h2>Select a Room</h2> <form id="room-selection-form"> <div class="form-group"> <label for="room-dropdown">Choose a room:</label> <select id="room-dropdown" name="room_id" required> <option value="">-- Select a Room --</option> </select> </div> <div class="form-actions"> <button type="submit" class="button submit-btn">Add Product to Room</button> <button type="button" class="button cancel-btn back-btn" data-target="estimate-selection">Back</button> <button type="button" class="button add-room" id="add-new-room-from-selection" data-estimate-id="">Add New Room</button> </div> </form> </template> ',"estimate-selection-template":'<template id="estimate-selection-template"> <div id="estimate-selection-wrapper"> <div id="estimate-selection-form-wrapper"> <h2>Select an Estimate</h2> <form id="estimate-selection-form"> <div class="form-group"> <label for="estimate-dropdown">Choose an estimate:</label> <select id="estimate-dropdown" name="estimate_id" required> <option value="">-- Select an Estimate --</option> </select> </div> <div class="form-actions"> <button type="submit" class="button submit-btn">Continue</button> <button type="button" class="button cancel-btn" id="create-estimate-btn"> Create New Estimate </button> </div> </form> </div> <div id="room-selection-form-wrapper" style="display:none"> <h2>Select a Room</h2> <form id="room-selection-form"> <div class="form-group"> <label for="room-dropdown">Choose a room:</label> <select id="room-dropdown" name="room_id" required> <option value="">-- Select a Room --</option> </select> </div> <div class="form-actions"> <button type="submit" class="button submit-btn">Add Product to Room</button> <button type="button" class="button cancel-btn back-btn" data-target="estimate-selection">Back</button> <button type="button" class="button add-room" id="add-new-room-from-selection" data-estimate="">Add New Room</button> </div> </form> </div> </div> </template> ',"estimates-empty-template":'<template id="estimates-empty-template"> <div class="no-estimates"> <p>You don\'t have any estimates yet.</p> <button id="create-estimate-btn" class="button">Create New Estimate</button> </div> </template> ',"rooms-empty-template":'<template id="rooms-empty-template"> <div class="no-rooms"> <p>You don\'t have any rooms in this estimate.</p> </div> </template> ',"products-empty-template":'<template id="products-empty-template"> <div class="products"> <p>You don\'t have any products in this room.</p> </div> </template> ',"modal-messages-template":'<template id="modal-messages-template"> <div class="modal-message modal-success-message"> <div class="message-content"></div> </div> <div class="modal-message modal-error-message"> <div class="message-content"></div> </div> </template> '};De.group("Initializing templates"),De.log("Registering templates:",Object.keys(qe)),Object.entries(qe).forEach((function(e){var t=g(e,2),o=t[0],i=t[1];i&&""!==i.trim()?(De.log("Registering template: ".concat(o," (").concat(i.length," characters)")),X.registerTemplate(o,i)):console.warn("Template ".concat(o," has empty HTML content!"))})),De.log("Initialized template engine with ".concat(Object.keys(qe).length," templates")),De.groupEnd();var Ae=L("FrontEndIndex");function Re(){if(Ae.log("Product Estimator initialization check..."),window._productEstimatorInitialized)Ae.log("Product Estimator already initialized globally, aborting");else{if(window.productEstimator&&window.productEstimator.initialized)return Ae.log("Product Estimator initialized property found, aborting"),void(window._productEstimatorInitialized=!0);window._productEstimatorInitialized=!0,Ae.log("Product Estimator initializing for the first time...");try{Fe?Ae.log("Global event handlers already added, skipping"):(Ae.log("Setting up global event handlers..."),window._productEstimatorCloseHandler=function(e){if(e.target.closest(".product-estimator-modal-close")||e.target.classList.contains("product-estimator-modal-overlay")){Ae.log("Global close handler triggered");var t=document.querySelector("#product-estimator-modal");t&&(t.style.display="none",document.body.classList.remove("modal-open"),window.productEstimator&&window.productEstimator.core&&window.productEstimator.core.closeModal())}},document.removeEventListener("click",window._productEstimatorCloseHandler),document.addEventListener("click",window._productEstimatorCloseHandler),Fe=!0,Ae.log("Global event handlers added")),"undefined"!=typeof jQuery?(window.productEstimator=window.productEstimator||{},window.productEstimator.jQuery=jQuery):Ae.warn("jQuery not detected, some features may not work");var e=function(){var e=new URLSearchParams(window.location.search);if(e.has("product_estimator_debug")){var t="false"!==e.get("product_estimator_debug");return t?localStorage.setItem("product_estimator_debug","true"):localStorage.removeItem("product_estimator_debug"),t}return"true"===localStorage.getItem("product_estimator_debug")}();"complete"===document.readyState?setTimeout((function(){return Te(e)}),10):setTimeout((function(){return Te(e)}),500)}catch(e){Ae.error("Error in Product Estimator initialization:",e)}}}function Te(e){try{if(window.productEstimator&&window.productEstimator.initialized)return void Ae.log("Product Estimator core already initialized, skipping");Ae.log("Initializing EstimatorCore..."),me.init({debug:e}),window.productEstimator=window.productEstimator||{},window.productEstimator.initialized=!0,window.productEstimator.core=me,window.productEstimator.dialog=new j;var t=window.productEstimator.core.dataService;if(!t)return void Ae.error("[DataService] instance not found on EstimatorCore. Cannot initialize PrintEstimate.");window.productEstimator.printEstimate=new Le({debug:e},t),window.productEstimator.detailsToggle=be,window.initSuggestionsCarousels=V,function(){try{document.addEventListener("click",(function(e){e.target.closest(".accordion-header")&&setTimeout((function(){be&&"function"==typeof be.setup&&(Ae.log("Accordion clicked, reinitializing product details toggle"),be.setup()),V()}),300)})),document.body.addEventListener("click",(function(e){if(e.target.closest(".product-details-toggle")){var t=e.target.closest(".product-details-toggle"),o=t.closest(".product-item");if(!o)return;var i=t.classList.contains("expanded"),r=o.querySelector(".similar-products-container");if(!r)return;if(i){t.classList.remove("expanded"),r.style.display="none",r.classList.remove("visible");var a=t.querySelector(".toggle-icon");a&&(a.classList.remove("dashicons-arrow-up-alt2"),a.classList.add("dashicons-arrow-down-alt2"))}else{t.classList.add("expanded"),r.style.display="block",r.classList.add("visible");var n=t.querySelector(".toggle-icon");n&&(n.classList.remove("dashicons-arrow-down-alt2"),n.classList.add("dashicons-arrow-up-alt2")),V()}e.preventDefault(),e.stopPropagation()}if(e.target.closest(".product-notes-toggle")){var s=e.target.closest(".product-notes-toggle"),c=s.closest(".product-item");if(!c)return;var l=s.classList.contains("expanded"),d=c.querySelector(".notes-container");if(!d)return;if(l){s.classList.remove("expanded"),d.style.display="none",d.classList.remove("visible");var u=s.querySelector(".toggle-icon");u&&(u.classList.remove("dashicons-arrow-up-alt2"),u.classList.add("dashicons-arrow-down-alt2"))}else{s.classList.add("expanded"),d.style.display="block",d.classList.add("visible");var m=s.querySelector(".toggle-icon");m&&(m.classList.remove("dashicons-arrow-down-alt2"),m.classList.add("dashicons-arrow-up-alt2"))}e.preventDefault(),e.stopPropagation()}if(e.target.closest(".product-includes-toggle")){var g=e.target.closest(".product-includes-toggle"),p=g.closest(".product-item");if(!p)return;var h=g.classList.contains("expanded"),f=p.querySelector(".includes-container");if(!f)return;if(h){g.classList.remove("expanded"),f.style.display="none",f.classList.remove("visible");var v=g.querySelector(".toggle-icon");v&&(v.classList.remove("dashicons-arrow-up-alt2"),v.classList.add("dashicons-arrow-down-alt2"))}else{g.classList.add("expanded"),f.style.display="block",f.classList.add("visible");var y=g.querySelector(".toggle-icon");y&&(y.classList.remove("dashicons-arrow-down-alt2"),y.classList.add("dashicons-arrow-up-alt2"))}e.preventDefault(),e.stopPropagation()}if(e.target.closest(".product-suggestions-toggle")){var w=e.target.closest(".product-suggestions-toggle"),b=w.closest(".accordion-content");if(!b)return;var E=w.classList.contains("expanded"),S=b.querySelector(".suggestions-container");if(!S)return;if(E){w.classList.remove("expanded"),S.style.display="none",S.classList.remove("visible");var _=w.querySelector(".toggle-icon");_&&(_.classList.remove("dashicons-arrow-up-alt2"),_.classList.add("dashicons-arrow-down-alt2"))}else{w.classList.add("expanded"),S.style.display="block",S.classList.add("visible");var L=w.querySelector(".toggle-icon");L&&(L.classList.remove("dashicons-arrow-down-alt2"),L.classList.add("dashicons-arrow-up-alt2")),V()}e.preventDefault(),e.stopPropagation()}})),Ae.log("[ProductDetailsToggle] initialization complete")}catch(e){Ae.error("Error initializing ProductDetailsToggle:",e)}}(),Ae.log("Product Estimator initialized".concat(e?" (debug mode)":"")),document.dispatchEvent(new CustomEvent("product_estimator_initialized"))}catch(e){Ae.error("Error during EstimatorCore initialization:",e)}}window._productEstimatorInitialized=window._productEstimatorInitialized||!1,window._setupInitDone||(window._setupInitDone=!0,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",Re,{once:!0}):Re());var Fe=!1;console.log("Product Estimator Frontend initialized")})();
//# sourceMappingURL=product-estimator.bundle.js.map