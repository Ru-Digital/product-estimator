<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Dialog Access</title>
    <link rel="stylesheet" href="public/css/product-estimator-frontend-bundled.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .test-button {
            padding: 10px 20px;
            background: #007cba;
            color: white;
            border: none;
            cursor: pointer;
            margin: 10px;
        }
        .console-output {
            background: #f5f5f5;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        .status.waiting {
            background: #cce5ff;
            color: #004085;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>Test Dialog Access Timing</h1>
    
    <div id="status" class="status waiting">Loading...</div>
    
    <button class="test-button print-estimate" data-estimate-id="test-123">Test Print (Standard)</button>
    <button class="test-button print-estimate-pdf" data-estimate-id="test-456">Test Print (PDF)</button>
    <button class="test-button" onclick="checkDialogStatus()">Check Dialog Status</button>
    <button class="test-button" onclick="clearStorage()">Clear Storage</button>
    
    <h3>Console Output:</h3>
    <div id="console" class="console-output"></div>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Set debug mode
        localStorage.setItem('product_estimator_debug', 'true');
        
        // Clear customer data to test prompt
        localStorage.removeItem('productEstimatorCustomerData');
        
        // Mock WordPress globals
        window.productEstimatorVars = {
            ajax_url: '/wp-admin/admin-ajax.php',
            nonce: 'test-nonce',
            i18n: {
                errors: {
                    generic: 'An error occurred'
                }
            }
        };
        
        // Override console.log to display in our div
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        const originalError = console.error;
        
        function logMessage(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = `[${timestamp}] [${type}] ` + args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ') + '\n';
            
            consoleDiv.textContent += message;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            logMessage('LOG', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            logMessage('ERROR', ...args);
        };
        
        function updateStatus(msg, type = 'waiting') {
            const status = document.getElementById('status');
            status.className = 'status ' + type;
            status.textContent = msg;
        }
        
        function checkDialogStatus() {
            console.log('=== CHECKING DIALOG STATUS ===');
            console.log('window.productEstimator:', window.productEstimator);
            
            if (window.productEstimator) {
                console.log('- dialog:', window.productEstimator.dialog);
                console.log('- core:', window.productEstimator.core);
                
                if (window.productEstimator.core) {
                    console.log('- core.modalManager:', window.productEstimator.core.modalManager);
                    
                    if (window.productEstimator.core.modalManager) {
                        console.log('- modalManager.confirmationDialog:', window.productEstimator.core.modalManager.confirmationDialog);
                    }
                }
            }
            
            console.log('=== END DIALOG STATUS ===');
        }
        
        function clearStorage() {
            localStorage.removeItem('productEstimatorCustomerData');
            console.log('Storage cleared');
        }
        
        // Track initialization stages
        const initStages = {
            scriptLoaded: false,
            estimatorInitialized: false,
            dialogAvailable: false,
            modalManagerAvailable: false
        };
        
        // Monitor initialization
        function monitorInitialization() {
            const checkInterval = setInterval(() => {
                // Check script load
                if (!initStages.scriptLoaded && window.productEstimator) {
                    initStages.scriptLoaded = true;
                    console.log('✓ Script loaded - window.productEstimator exists');
                }
                
                // Check initialization
                if (!initStages.estimatorInitialized && window.productEstimator && window.productEstimator.initialized) {
                    initStages.estimatorInitialized = true;
                    console.log('✓ Estimator initialized');
                }
                
                // Check dialog availability
                if (!initStages.dialogAvailable && window.productEstimator && window.productEstimator.dialog) {
                    initStages.dialogAvailable = true;
                    console.log('✓ Dialog available at window.productEstimator.dialog');
                }
                
                // Check modal manager
                if (!initStages.modalManagerAvailable && 
                    window.productEstimator && 
                    window.productEstimator.core && 
                    window.productEstimator.core.modalManager) {
                    initStages.modalManagerAvailable = true;
                    console.log('✓ ModalManager available');
                }
                
                // Check if all ready
                if (initStages.scriptLoaded && initStages.estimatorInitialized && 
                    (initStages.dialogAvailable || initStages.modalManagerAvailable)) {
                    clearInterval(checkInterval);
                    updateStatus('All components ready', 'ready');
                    console.log('=== ALL COMPONENTS READY ===');
                    checkDialogStatus();
                }
            }, 100);
            
            // Timeout after 10 seconds
            setTimeout(() => {
                clearInterval(checkInterval);
                if (!initStages.dialogAvailable && !initStages.modalManagerAvailable) {
                    updateStatus('Timeout: Some components did not initialize', 'error');
                    console.log('=== INITIALIZATION TIMEOUT ===');
                    checkDialogStatus();
                }
            }, 10000);
        }
        
        // Start monitoring
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, starting monitoring...');
            updateStatus('Monitoring initialization...', 'waiting');
            
            // Start monitoring
            monitorInitialization();
            
            // Load the script
            setTimeout(() => {
                console.log('Loading product-estimator.bundle.js...');
                const script = document.createElement('script');
                script.src = 'public/js/product-estimator.bundle.js';
                script.onload = () => {
                    console.log('Script loaded successfully');
                };
                script.onerror = () => {
                    console.error('Failed to load script');
                    updateStatus('Failed to load script', 'error');
                };
                document.body.appendChild(script);
            }, 100);
        });
    </script>
</body>
</html>